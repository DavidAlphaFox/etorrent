<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head><title>/usr/home/jlouis/hacking/test_server/stdlib_test/supervisor_SUITE.erl</title></head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
    1:<i>%% ``The contents of this file are subject to the Erlang Public License,</i>
    2:<i>%% Version 1.1, (the "License"); you may not use this file except in</i>
    3:<i>%% compliance with the License. You should have received a copy of the</i>
    4:<i>%% Erlang Public License along with this software. If not, it can be</i>
    5:<i>%% retrieved via the world wide web at http://www.erlang.org/.</i>
    6:<i>%% </i>
    7:<i>%% Software distributed under the License is distributed on an "AS IS"</i>
    8:<i>%% basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See</i>
    9:<i>%% the License for the specific language governing rights and limitations</i>
<a name="10"></a>   10:<i>%% under the License.</i>
   11:<i>%% </i>
   12:<i>%% The Initial Developer of the Original Code is Ericsson Utvecklings AB.</i>
   13:<i>%% Portions created by Ericsson are Copyright 1999, Ericsson Utvecklings</i>
   14:<i>%% AB. All Rights Reserved.''</i>
   15:<i>%% </i>
   16:<i>%%     $Id$</i>
   17:<i>%%</i>
   18:<i>%% Description: Tests supervisor.erl</i>
   19:
<a name="20"></a>   20:-<b>module</b>(supervisor_SUITE).
   21:
   22:-<b>include</b>("test_server.hrl").
   23:
   24:<i>%% Testserver specific export</i>
   25:-<b>export</b>([all/1]).
   26:
   27:<i>%% Indirect spawn export</i>
   28:-<b>export</b>([init/1]).
   29:
<a name="30"></a>   30:<i>%% API tests</i>
   31:-<b>export</b>([sup_start/1, sup_start_normal/1, sup_start_ignore_init/1, 
   32:	 sup_start_ignore_child/1, sup_start_error_return/1, 
   33:	 sup_start_fail/1, sup_stop/1, sup_stop_infinity/1, 
   34:	 sup_stop_timeout/1, sup_stop_brutal_kill/1, child_adm/1,
   35:	 child_adm_simple/1, child_specs/1, extra_return/1]).
   36:
   37:<i>%% Tests concept permanent, transient and temporary </i>
   38:-<b>export</b>([normal_termination/1, permanent_normal/1, transient_normal/1,
   39:	 temporary_normal/1, abnormal_termination/1,
<a name="40"></a>   40:	 permanent_abnormal/1, transient_abnormal/1,
   41:	 temporary_abnormal/1]).
   42:
   43:<i>%% Restart strategy tests </i>
   44:-<b>export</b>([restart_one_for_one/1, one_for_one/1,
   45:	 one_for_one_escalation/1, restart_one_for_all/1, one_for_all/1,
   46:	 one_for_all_escalation/1, restart_simple_one_for_one/1,
   47:	 simple_one_for_one/1, simple_one_for_one_escalation/1,
   48:	 restart_rest_for_one/1, rest_for_one/1, rest_for_one_escalation/1,
   49:	 simple_one_for_one_extra/1]).
<a name="50"></a>   50:
   51:<i>%% Misc tests</i>
   52:-<b>export</b>([child_unlink/1, tree/1]).
   53:
   54:<i>%-------------------------------------------------------------------------</i>
   55:
<a name=all>   56:<b>all</b></a>(suite) -&gt; 
   57:    {req,[stdlib], 
   58:     [sup_start, sup_stop, child_adm,
   59:      child_adm_simple, extra_return, child_specs,
<a name="60"></a>   60:      restart_one_for_one, restart_one_for_all,
   61:      restart_simple_one_for_one, restart_rest_for_one,
   62:      normal_termination, abnormal_termination, child_unlink, tree]}.
   63:
   64:
<a name=start>   65:<b>start</b></a>(InitResult) -&gt;
   66:    supervisor:start_link({local, sup_test}, ?MODULE, InitResult).
   67:
   68:<i>%% Simulate different supervisors callback.  </i>
<a name=init>   69:<b>init</b></a>(fail) -&gt;
<a name="70"></a>   70:    1 = 2;
<a name=init>   71:<b>init</b></a>(InitResult) -&gt;
   72:    InitResult.
   73:
   74:<i>%-------------------------------------------------------------------------</i>
   75:<i>%</i>
   76:<i>% Test cases starts here.</i>
   77:<i>%</i>
   78:<i>%-------------------------------------------------------------------------</i>
   79:
<a name=sup_start><a name="80"></a>   80:<b>sup_start</b></a>(doc) -&gt;
   81:    ["Test start of a supervisor."];
<a name=sup_start>   82:<b>sup_start</b></a>(suite) -&gt;
   83:    [sup_start_normal, sup_start_ignore_init, sup_start_ignore_child,
   84:     sup_start_error_return, sup_start_fail].
   85:
   86:<i>%-------------------------------------------------------------------------</i>
<a name=sup_start_normal>   87:<b>sup_start_normal</b></a>(doc) -&gt;
   88:    ["Tests that the supervisor process starts correctly and that it "
   89:    "can be terminated gracefully."];
<a name=sup_start_normal><a name="90"></a>   90:<b>sup_start_normal</b></a>(suite) -&gt; [];
<a name=sup_start_normal>   91:<b>sup_start_normal</b></a>(Config) when list(Config) -&gt;
   92:    process_flag(trap_exit, true),
   93:    ?line {ok, Pid} = start({ok, {{one_for_one, 2, 3600}, []}}),
   94:    ?line exit(Pid, shutdown),
   95:    receive
   96:	{'EXIT', Pid, shutdown} -&gt;
   97:	    ok;
   98:	{'EXIT', Pid, Else} -&gt;
   99:	    ?line test_server:fail({bad_exit_reason, Else})
<a name="100"></a>  100:    after
  101:	2000 -&gt;
  102:	    ?line test_server:fail(no_exit_reason)
  103:    end,
  104:    ok.
  105:<i>%-------------------------------------------------------------------------</i>
<a name=sup_start_ignore_init>  106:<b>sup_start_ignore_init</b></a>(doc) -&gt;
  107:    ["Tests what happens if init-callback returns ignore"];
<a name=sup_start_ignore_init>  108:<b>sup_start_ignore_init</b></a>(suite) -&gt; [];
<a name=sup_start_ignore_init>  109:<b>sup_start_ignore_init</b></a>(Config) when list(Config) -&gt;
<a name="110"></a>  110:    process_flag(trap_exit, true),
  111:    ?line ignore = start(ignore),
  112:
  113:    receive
  114:	{'EXIT', Pid, normal} -&gt;
  115:	    ok;
  116:	{'EXIT', Pid, Else} -&gt;
  117:	    ?line test_server:fail({bad_exit_reason, Else})
  118:    after
  119:	2000 -&gt;
<a name="120"></a>  120:	    ?line test_server:fail(no_exit_reason)
  121:    end,
  122:    ok.
  123:
  124:
  125:<i>%-------------------------------------------------------------------------</i>
<a name=sup_start_ignore_child>  126:<b>sup_start_ignore_child</b></a>(doc) -&gt;
  127:    ["Tests what happens if init-callback returns ignore"];
<a name=sup_start_ignore_child>  128:<b>sup_start_ignore_child</b></a>(suite) -&gt; [];
<a name=sup_start_ignore_child>  129:<b>sup_start_ignore_child</b></a>(Config) when list(Config) -&gt;
<a name="130"></a>  130:    process_flag(trap_exit, true),
  131:    ?line {ok, Pid}  = start({ok, {{one_for_one, 2, 3600}, []}}),
  132:    Child1 = {child1, {supervisor_1, start_child, [ignore]}, 
  133:	      permanent, 1000, worker, []},
  134:    Child2 = {child2, {supervisor_1, start_child, []}, permanent,
  135:	      1000, worker, []},
  136:    
  137:    ?line {ok, undefined} = supervisor:start_child(sup_test, Child1),
  138:    ?line {ok, CPid2} = supervisor:start_child(sup_test, Child2),
  139:
<a name="140"></a>  140:    ?line [{child2, CPid2, worker, []},{child1, undefined, worker, []}] 
  141:	= supervisor:which_children(sup_test),
  142:    ok.
  143:
  144:<i>%-------------------------------------------------------------------------</i>
<a name=sup_start_error_return>  145:<b>sup_start_error_return</b></a>(doc) -&gt;
  146:    ["Tests what happens if init-callback returns a invalid value"];
<a name=sup_start_error_return>  147:<b>sup_start_error_return</b></a>(suite) -&gt; [];
<a name=sup_start_error_return>  148:<b>sup_start_error_return</b></a>(Config) when list(Config) -&gt;
  149:    process_flag(trap_exit, true),
<a name="150"></a>  150:    ?line {error, Term} = start(invalid),
  151:
  152:    receive
  153:	{'EXIT', Pid, Term} -&gt;
  154:	    ok;
  155:	{'EXIT', Pid, Else} -&gt;
  156:	    ?line test_server:fail({bad_exit_reason, Else})
  157:    after
  158:	2000 -&gt;
  159:	    ?line test_server:fail(no_exit_reason)
<a name="160"></a>  160:    end,
  161:    ok.
  162:
  163:<i>%-------------------------------------------------------------------------</i>
<a name=sup_start_fail>  164:<b>sup_start_fail</b></a>(doc) -&gt;
  165:    ["Tests what happens if init-callback fails"];
<a name=sup_start_fail>  166:<b>sup_start_fail</b></a>(suite) -&gt; [];
<a name=sup_start_fail>  167:<b>sup_start_fail</b></a>(Config) when list(Config) -&gt;
  168:    process_flag(trap_exit, true),
  169:    ?line {error, Term} = start(fail),
<a name="170"></a>  170:
  171:    receive
  172:	{'EXIT', Pid, Term} -&gt;
  173:	    ok;
  174:	{'EXIT', Pid, Else} -&gt;
  175:	    ?line test_server:fail({bad_exit_reason, Else})
  176:    after
  177:	2000 -&gt;
  178:	    ?line test_server:fail(no_exit_reason)
  179:    end,
<a name="180"></a>  180:    ok.
  181:<i>%-------------------------------------------------------------------------</i>
<a name=sup_stop>  182:<b>sup_stop</b></a>(doc) -&gt;
  183:    ["Tests that the supervisor shoutdowns its children if it is " 
  184:     "shutdown itself."];
<a name=sup_stop>  185:<b>sup_stop</b></a>(suite) -&gt; [sup_stop_infinity, sup_stop_timeout, sup_stop_brutal_kill].
  186:
  187:<i>%-------------------------------------------------------------------------</i>
  188:
<a name=sup_stop_infinity>  189:<b>sup_stop_infinity</b></a>(doc) -&gt;
<a name="190"></a>  190:    ["See sup_stop/1 when Shutdown = infinity, this walue is only allowed "
  191:    "for children of type supervisor"];
<a name=sup_stop_infinity>  192:<b>sup_stop_infinity</b></a>(suite) -&gt; [];
  193:
<a name=sup_stop_infinity>  194:<b>sup_stop_infinity</b></a>(Config) when list(Config) -&gt;
  195:    process_flag(trap_exit, true),
  196:    ?line {ok, Pid} = start({ok, {{one_for_one, 2, 3600}, []}}),
  197:    Child1 = {child1, {supervisor_1, start_child, []}, 
  198:	      permanent, infinity, supervisor, []},
  199:    Child2 = {child2, {supervisor_1, start_child, []}, permanent,
<a name="200"></a>  200:	       infinity, worker, []},
  201:    ?line {ok, CPid1} = supervisor:start_child(sup_test, Child1),
  202:    link(CPid1),
  203:    ?line {error, {invalid_shutdown,infinity}} = 
  204:	supervisor:start_child(sup_test, Child2),    
  205:
  206:    ?line exit(Pid, shutdown),
  207:
  208:    receive
  209:	{'EXIT', Pid, shutdown} -&gt;
<a name="210"></a>  210:	    ok;
  211:	{'EXIT', Pid, Else} -&gt;
  212:	    ?line test_server:fail({bad_exit_reason, Else})
  213:    after
  214:	5000 -&gt;
  215:	    ?line test_server:fail(no_exit_reason)
  216:    end,
  217:    receive
  218:	{'EXIT', CPid1, shutdown} -&gt; ok;
  219:	{'EXIT', CPid1, Reason} -&gt;
<a name="220"></a>  220:	    ?line test_server:fail(bad_exit_reason)
  221:    after
  222:	2000 -&gt; ?line test_server:fail(no_exit_reason)
  223:    end,
  224:    ok.
  225:
  226:<i>%-------------------------------------------------------------------------</i>
  227:
<a name=sup_stop_timeout>  228:<b>sup_stop_timeout</b></a>(doc) -&gt;
  229:    ["See sup_stop/1 when Shutdown = 1000"];
<a name=sup_stop_timeout><a name="230"></a>  230:<b>sup_stop_timeout</b></a>(suite) -&gt; [];
  231:
<a name=sup_stop_timeout>  232:<b>sup_stop_timeout</b></a>(Config) when list(Config) -&gt;
  233:    process_flag(trap_exit, true),
  234:    ?line {ok, Pid} = start({ok, {{one_for_one, 2, 3600}, []}}),
  235:    Child1 = {child1, {supervisor_1, start_child, []}, 
  236:	      permanent, 1000, worker, []},
  237:    Child2 = {child2, {supervisor_1, start_child, []}, permanent,
  238:	      1000, worker, []},
  239:    ?line {ok, CPid1} = supervisor:start_child(sup_test, Child1),
<a name="240"></a>  240:    link(CPid1),
  241:    ?line {ok, CPid2} = supervisor:start_child(sup_test, Child2),    
  242:    link(CPid2),
  243:   
  244:    CPid2 ! {sleep, 200000},
  245:
  246:    ?line exit(Pid, shutdown),
  247:
  248:    receive
  249:	{'EXIT', Pid, shutdown} -&gt;
<a name="250"></a>  250:	    ok;
  251:	{'EXIT', Pid, Else} -&gt;
  252:	    ?line test_server:fail({bad_exit_reason, Else})
  253:    after
  254:	5000 -&gt;
  255:	    ?line test_server:fail(no_exit_reason)
  256:    end,
  257:
  258:    receive
  259:	{'EXIT', CPid1, shutdown} -&gt; ok;
<a name="260"></a>  260:	{'EXIT', CPid1, Reason} -&gt;
  261:	    ?line test_server:fail(bad_exit_reason)
  262:    after
  263:	2000 -&gt; ?line test_server:fail(no_exit_reason)
  264:    end,
  265:   
  266:    receive
  267:	{'EXIT', CPid2, killed} -&gt; ok;
  268:	{'EXIT', CPid2, Reason2} -&gt;
  269:	    ?line test_server:fail(bad_exit_reason)
<a name="270"></a>  270:    after
  271:	2000 -&gt; ?line test_server:fail(no_exit_reason)
  272:    end,
  273:    ok.
  274:
  275:<i>%-------------------------------------------------------------------------</i>
<a name=sup_stop_brutal_kill>  276:<b>sup_stop_brutal_kill</b></a>(doc) -&gt;
  277:    ["See sup_stop/1 when Shutdown = brutal_kill"];
<a name=sup_stop_brutal_kill>  278:<b>sup_stop_brutal_kill</b></a>(suite) -&gt; [];
  279:
<a name=sup_stop_brutal_kill><a name="280"></a>  280:<b>sup_stop_brutal_kill</b></a>(Config) when list(Config) -&gt;
  281:    process_flag(trap_exit, true),
  282:    ?line {ok, Pid} = start({ok, {{one_for_one, 2, 3600}, []}}),
  283:    Child1 = {child1, {supervisor_1, start_child, []}, 
  284:	      permanent, 1000, worker, []},
  285:    Child2 = {child2, {supervisor_1, start_child, []}, permanent,
  286:	      brutal_kill, worker, []},
  287:    ?line {ok, CPid1} = supervisor:start_child(sup_test, Child1),
  288:    link(CPid1),
  289:    ?line {ok, CPid2} = supervisor:start_child(sup_test, Child2),    
<a name="290"></a>  290:    link(CPid2),
  291:
  292:    ?line exit(Pid, shutdown),
  293:
  294:    receive
  295:	{'EXIT', Pid, shutdown} -&gt;
  296:	    ok;
  297:	{'EXIT', Pid, Else} -&gt;
  298:	    ?line test_server:fail({bad_exit_reason, Else})
  299:    after
<a name="300"></a>  300:	5000 -&gt;
  301:	    ?line test_server:fail(no_exit_reason)
  302:    end,
  303:
  304:    receive
  305:	{'EXIT', CPid1, shutdown} -&gt; ok;
  306:	{'EXIT', CPid1, Reason} -&gt;
  307:	    ?line test_server:fail(bad_exit_reason)
  308:    after
  309:	2000 -&gt; ?line test_server:fail(no_exit_reason)
<a name="310"></a>  310:    end,
  311:    receive
  312:	{'EXIT', CPid2, killed} -&gt; ok;
  313:	{'EXIT', CPid2, Reason2} -&gt;
  314:	    ?line test_server:fail(bad_exit_reason)
  315:    after
  316:	2000 -&gt; ?line test_server:fail(no_exit_reason)
  317:    end,
  318:    ok.
  319:
<a name="320"></a>  320:<i>%-------------------------------------------------------------------------</i>
<a name=extra_return>  321:<b>extra_return</b></a>(doc) -&gt; 
  322:    ["The start function provided to start a child may " 
  323:     "return {ok, Pid} or {ok, Pid, Info}, if it returns "
  324:     "the later check that the supervisor ignores the Info, "
  325:     "and includes it unchanged in return from start_child/2 "
  326:     "and restart_child/2"];
<a name=extra_return>  327:<b>extra_return</b></a>(suite) -&gt; [];
  328:
<a name=extra_return>  329:<b>extra_return</b></a>(Config) when list(Config) -&gt;
<a name="330"></a>  330:    process_flag(trap_exit, true),
  331:    Child = {child1, {supervisor_1, start_child, [extra_return]}, 
  332:	     permanent, 1000,
  333:	     worker, []},
  334:    ?line {ok, Pid} = start({ok, {{one_for_one, 2, 3600}, [Child]}}),
  335:    ?line [{child1, CPid, worker, []}] = supervisor:which_children(sup_test),
  336:    link(CPid),
  337:    ?line {error, not_found} = supervisor:terminate_child(sup_test, hej),
  338:    ?line {error, not_found} = supervisor:delete_child(sup_test, hej),
  339:    ?line {error, not_found} = supervisor:restart_child(sup_test, hej),
<a name="340"></a>  340:    ?line {error, running} = supervisor:delete_child(sup_test, child1),
  341:    ?line {error, running} = supervisor:restart_child(sup_test, child1),
  342:    ?line [{child1, CPid, worker, []}] = supervisor:which_children(sup_test),
  343:    ?line ok = supervisor:terminate_child(sup_test, child1),
  344:    receive
  345:	{'EXIT', CPid, shutdown} -&gt; ok;
  346:	{'EXIT', CPid, Reason} -&gt;
  347:	    ?line test_server:fail({bad_reason, Reason})
  348:    after 1000 -&gt;
  349:	    ?line test_server:fail(no_child_termination)
<a name="350"></a>  350:    end,
  351:    ?line [{child1,undefined,worker,[]}] = supervisor:which_children(sup_test),
  352:    ?line {ok, CPid2,extra_return} = 
  353:	supervisor:restart_child(sup_test, child1),
  354:    ?line [{child1, CPid2, worker, []}] = supervisor:which_children(sup_test),
  355:    ?line ok = supervisor:terminate_child(sup_test, child1),
  356:    ?line ok = supervisor:terminate_child(sup_test, child1),
  357:    ?line ok = supervisor:delete_child(sup_test, child1),
  358:    ?line {error, not_found} = supervisor:restart_child(sup_test, child1),
  359:    ?line [] = supervisor:which_children(sup_test),
<a name="360"></a>  360:    ?line {ok, CPid3, extra_return} = supervisor:start_child(sup_test, Child),
  361:    ?line [{child1, CPid3, worker, []}] = supervisor:which_children(sup_test),
  362:    ok.
  363:<i>%-------------------------------------------------------------------------</i>
<a name=child_adm>  364:<b>child_adm</b></a>(doc)-&gt;
  365:    ["Test API functions start_child/2, terminate_child/2, delete_child/2 "
  366:     "restart_child/2, which_children/1. Only correct childspecs are used, "
  367:     "handling of incorrect childspecs is tested in child_specs/1"];
<a name=child_adm>  368:<b>child_adm</b></a>(suite) -&gt; [];
<a name=child_adm>  369:<b>child_adm</b></a>(Config) when list(Config) -&gt;
<a name="370"></a>  370:    process_flag(trap_exit, true),
  371:    Child = {child1, {supervisor_1, start_child, []}, permanent, 1000,
  372:	     worker, []},
  373:    ?line {ok, Pid} = start({ok, {{one_for_one, 2, 3600}, [Child]}}),
  374:    ?line [{child1, CPid, worker, []}] = supervisor:which_children(sup_test),
  375:    link(CPid),
  376:
  377:    %% Start of an already runnig process 
  378:    ?line {error,{already_started, CPid}} =
  379:	supervisor:start_child(sup_test, Child),
<a name="380"></a>  380:    
  381:    %% Termination
  382:    ?line {error, not_found} = supervisor:terminate_child(sup_test, hej),
  383:    ?line  {'EXIT',{noproc,{gen_server,call, _}}} = 
  384:	(catch supervisor:terminate_child(foo, child1)),
  385:    ?line ok = supervisor:terminate_child(sup_test, child1),
  386:    receive
  387:	{'EXIT', CPid, shutdown} -&gt; ok;
  388:	{'EXIT', CPid, Reason} -&gt;
  389:	    ?line test_server:fail({bad_reason, Reason})
<a name="390"></a>  390:    after 1000 -&gt;
  391:	    ?line test_server:fail(no_child_termination)
  392:    end,
  393:    ?line [{child1,undefined,worker,[]}] = supervisor:which_children(sup_test),
  394:    %% Like deleting something that does not exist, it will succeed!
  395:    ?line ok = supervisor:terminate_child(sup_test, child1),
  396:
  397:    %% Start of already existing but not running process 
  398:    ?line {error,already_present} =
  399:	supervisor:start_child(sup_test, Child),
<a name="400"></a>  400:
  401:    %% Restart
  402:    ?line {ok, CPid2} = supervisor:restart_child(sup_test, child1),
  403:    ?line [{child1, CPid2, worker, []}] = supervisor:which_children(sup_test),
  404:    ?line {error, running} = supervisor:restart_child(sup_test, child1),
  405:    ?line {error, not_found} = supervisor:restart_child(sup_test, child2),
  406:    
  407:    %% Deletion
  408:    ?line {error, running} = supervisor:delete_child(sup_test, child1),
  409:    ?line {error, not_found} = supervisor:delete_child(sup_test, hej),
<a name="410"></a>  410:    ?line  {'EXIT',{noproc,{gen_server,call, _}}} = 
  411:	(catch supervisor:delete_child(foo, child1)),
  412:    ?line ok = supervisor:terminate_child(sup_test, child1),
  413:    ?line ok = supervisor:delete_child(sup_test, child1),
  414:    ?line {error, not_found} = supervisor:restart_child(sup_test, child1),
  415:    ?line [] = supervisor:which_children(sup_test),
  416:    
  417:    %% Start
  418:    ?line {'EXIT',{noproc,{gen_server,call, _}}} =
  419:	(catch supervisor:start_child(foo, Child)),
<a name="420"></a>  420:    ?line {ok, CPid3} = supervisor:start_child(sup_test, Child),
  421:    ?line [{child1, CPid3, worker, []}] = supervisor:which_children(sup_test),
  422:
  423:    ?line {'EXIT',{noproc,{gen_server,call,[foo,which_children,infinity]}}}
  424:	= (catch supervisor:which_children(foo)),
  425:    ok.
  426:<i>%-------------------------------------------------------------------------</i>
<a name=child_adm_simple>  427:<b>child_adm_simple</b></a>(doc) -&gt;
  428:    ["The API functions terminate_child/2, delete_child/2 "
  429:     "restart_child/2 are not valid for a simple_one_for_one supervisor "
<a name="430"></a>  430:    "check that the correct error message is returned."];
<a name=child_adm_simple>  431:<b>child_adm_simple</b></a>(suite) -&gt; [];
<a name=child_adm_simple>  432:<b>child_adm_simple</b></a>(Config) when list(Config) -&gt;
  433:    Child = {child, {supervisor_1, start_child, []}, permanent, 1000,
  434:	     worker, []},
  435:    ?line {ok, Pid} = start({ok, {{simple_one_for_one, 2, 3600}, [Child]}}),
  436:    %% In simple_one_for_one all children are added dynamically 
  437:    ?line [] = supervisor:which_children(sup_test), 
  438:    
  439:    %% Start
<a name="440"></a>  440:    ?line {'EXIT',{noproc,{gen_server,call, _}}} =
  441:	(catch supervisor:start_child(foo, [])),
  442:    ?line {ok, CPid1} = supervisor:start_child(sup_test, []),
  443:    ?line [{undefined, CPid1, worker, []}] = 
  444:	supervisor:which_children(sup_test),
  445:    
  446:    ?line {ok, CPid2} = supervisor:start_child(sup_test, []),
  447:    ?line [{undefined, CPid2, worker,[]}, {undefined, CPid1, worker, []}] = 
  448:	supervisor:which_children(sup_test),
  449:
<a name="450"></a>  450:    %% Termination
  451:    ?line {error, simple_one_for_one} =
  452:	supervisor:terminate_child(sup_test, child1),
  453:
  454:    %% Restart
  455:    ?line {error, simple_one_for_one} = 
  456:	supervisor:restart_child(sup_test, child1),
  457:    
  458:    %% Deletion
  459:    ?line {error, simple_one_for_one} = 
<a name="460"></a>  460:	supervisor:delete_child(sup_test, child1),
  461:    ok.
  462:    
  463:<i>%-------------------------------------------------------------------------</i>
<a name=child_specs>  464:<b>child_specs</b></a>(doc) -&gt;
  465:    ["Tests child specs, invalid formats should be rejected."];
<a name=child_specs>  466:<b>child_specs</b></a>(suite) -&gt; [];
<a name=child_specs>  467:<b>child_specs</b></a>(Config) when list(Config) -&gt;
  468:    process_flag(trap_exit, true),
  469:    Child = {child1, {supervisor_1, start_child, []}, permanent, 1000,
<a name="470"></a>  470:	     worker, []},
  471:    ?line {ok, Pid} = start({ok, {{one_for_one, 2, 3600}, []}}),
  472:    ?line {error, _} = supervisor:start_child(sup_test, hej),
  473:
  474:    %% Bad child specs 
  475:    B1 = {child, mfa, permanent, 1000, worker, []},
  476:    B2 = {child, {m,f,[a]}, prmanent, 1000, worker, []}, 
  477:    B3 = {child, {m,f,[a]}, permanent, -10, worker, []},
  478:    B4 = {child, {m,f,[a]}, permanent, 10, wrker, []},
  479:    B5 = {child, {m,f,[a]}, permanent, infinity, worker, []},
<a name="480"></a>  480:    B6 = {child, {m,f,[a]}, permanent, 1000, worker, dy},
  481:    B7 = {child, {m,f,[a]}, permanent, 1000, worker, [1,2,3]},
  482:				       
  483:    %% Correct child specs!
  484:    %% &lt;Modules&gt; (last parameter in a child spec) can be [] as we do 
  485:    %% not test code upgrade here.  
  486:    C1 = {child, {m,f,[a]}, permanent, infinity, supervisor, []},
  487:    C2 = {child, {m,f,[a]}, permanent, 1000, supervisor, []},
  488:    C3 = {child, {m,f,[a]}, temporary, 1000, worker, dynamic},
  489:    C4 = {child, {m,f,[a]}, transient, 1000, worker, [m]},
<a name="490"></a>  490:
  491:    ?line {error, {invalid_mfa,mfa}} = supervisor:start_child(sup_test, B1),
  492:    ?line {error, {invalid_restart_type, prmanent}} =  
  493:	supervisor:start_child(sup_test, B2),
  494:    ?line {error,  {invalid_shutdown,-10}} 
  495:	= supervisor:start_child(sup_test, B3), 
  496:    ?line {error, {invalid_child_type,wrker}} 
  497:	= supervisor:start_child(sup_test, B4),
  498:    ?line {error, _} = supervisor:start_child(sup_test, B5),
  499:    ?line {error, {invalid_modules,dy}} 
<a name="500"></a>  500:	= supervisor:start_child(sup_test, B6),
  501:    
  502:    ?line {error, {invalid_mfa,mfa}} = supervisor:check_childspecs([B1]),
  503:    ?line {error, {invalid_restart_type,prmanent}} = 
  504:	supervisor:check_childspecs([B2]),
  505:    ?line {error, {invalid_shutdown,-10}} = supervisor:check_childspecs([B3]),
  506:    ?line {error, {invalid_child_type,wrker}} 
  507:	= supervisor:check_childspecs([B4]),
  508:    ?line {error, _} = supervisor:check_childspecs([B5]),
  509:    ?line {error, {invalid_modules,dy}} = supervisor:check_childspecs([B6]),
<a name="510"></a>  510:    ?line {error, {invalid_module, 1}} = 
  511:	supervisor:check_childspecs([B7]),
  512:
  513:    ?line ok = supervisor:check_childspecs([C1]),
  514:    ?line ok = supervisor:check_childspecs([C2]),
  515:    ?line ok = supervisor:check_childspecs([C3]),
  516:    ?line ok = supervisor:check_childspecs([C4]),
  517:    ok.
  518:<i>%-------------------------------------------------------------------------</i>
<a name=normal_termination>  519:<b>normal_termination</b></a>(doc) -&gt;
<a name="520"></a>  520:    ["Testes the supervisors behaviour if a child dies with reason normal"];
<a name=normal_termination>  521:<b>normal_termination</b></a>(suite) -&gt; 
  522:    [permanent_normal, transient_normal, temporary_normal].
  523:
  524:<i>%-------------------------------------------------------------------------</i>
<a name=permanent_normal>  525:<b>permanent_normal</b></a>(doc) -&gt;
  526:    ["A permanent child should always be restarted"];
<a name=permanent_normal>  527:<b>permanent_normal</b></a>(suite) -&gt; [];
<a name=permanent_normal>  528:<b>permanent_normal</b></a>(Config) when list(Config) -&gt;
  529:    ?line  {ok, SupPid} = start({ok, {{one_for_one, 2, 3600}, []}}),
<a name="530"></a>  530:    Child1 = {child1, {supervisor_1, start_child, []}, permanent, 1000,
  531:	      worker, []},
  532:    
  533:    ?line {ok, CPid1} = supervisor:start_child(sup_test, Child1),
  534:    
  535:    CPid1 ! stop,
  536:    test_server:sleep(100),
  537:    ?line [{child1, Pid ,worker,[]}] = supervisor:which_children(sup_test),
  538:    case is_pid(Pid) of
  539:	true -&gt;
<a name="540"></a>  540:	    ok;
  541:	false -&gt;
  542:	    ?line test_server:fail({permanent_child_not_restarted, Child1})
  543:    end.
  544:
  545:<i>%------------------------------------------------------------------------- </i>
<a name=transient_normal>  546:<b>transient_normal</b></a>(doc) -&gt;
  547:    ["A transient child should not be restarted if it exits with " 
  548:     "reason normal"];
<a name=transient_normal>  549:<b>transient_normal</b></a>(suite) -&gt; [];
<a name=transient_normal><a name="550"></a>  550:<b>transient_normal</b></a>(Config) when list(Config) -&gt;
  551:    ?line  {ok, SupPid} = start({ok, {{one_for_one, 2, 3600}, []}}),
  552:    Child1 = {child1, {supervisor_1, start_child, []}, transient, 1000,
  553:	      worker, []},
  554:    
  555:    ?line {ok, CPid1} = supervisor:start_child(sup_test, Child1),
  556:   
  557:    CPid1 ! stop,
  558:    test_server:sleep(100),
  559:    
<a name="560"></a>  560:    ?line [{child1,undefined,worker,[]}] = supervisor:which_children(sup_test).
  561:
  562:<i>%-------------------------------------------------------------------------    </i>
<a name=temporary_normal>  563:<b>temporary_normal</b></a>(doc) -&gt;
  564:    ["A temporary process should never be restarted"];
<a name=temporary_normal>  565:<b>temporary_normal</b></a>(suite) -&gt; [];
<a name=temporary_normal>  566:<b>temporary_normal</b></a>(Config) when list(Config) -&gt;
  567:     ?line  {ok, SupPid} = start({ok, {{one_for_one, 2, 3600}, []}}),
  568:    Child1 = {child1, {supervisor_1, start_child, []}, temporary, 1000,
  569:	      worker, []},
<a name="570"></a>  570:    
  571:    ?line {ok, CPid1} = supervisor:start_child(sup_test, Child1),
  572:    
  573:    CPid1 ! stop,
  574:    test_server:sleep(100),
  575:    
  576:    ?line [{child1,undefined,worker,[]}] = supervisor:which_children(sup_test).
  577:
  578:<i>%-------------------------------------------------------------------------</i>
<a name=abnormal_termination>  579:<b>abnormal_termination</b></a>(doc) -&gt;
<a name="580"></a>  580:    ["Testes the supervisors behaviour if a child dies with reason abnormal"];
<a name=abnormal_termination>  581:<b>abnormal_termination</b></a>(suite) -&gt; 
  582:    [permanent_abnormal, transient_abnormal, temporary_abnormal].
  583:
  584:<i>%-------------------------------------------------------------------------</i>
<a name=permanent_abnormal>  585:<b>permanent_abnormal</b></a>(doc) -&gt;
  586:    ["A permanent child should always be restarted"];
<a name=permanent_abnormal>  587:<b>permanent_abnormal</b></a>(suite) -&gt; [];
<a name=permanent_abnormal>  588:<b>permanent_abnormal</b></a>(Config) when list(Config) -&gt;
  589:    ?line  {ok, SupPid} = start({ok, {{one_for_one, 2, 3600}, []}}),
<a name="590"></a>  590:    Child1 = {child1, {supervisor_1, start_child, []}, permanent, 1000,
  591:	      worker, []},
  592:    
  593:    ?line {ok, CPid1} = supervisor:start_child(sup_test, Child1),
  594:    
  595:    CPid1 ! die,
  596:    test_server:sleep(100),
  597:    ?line [{child1, Pid ,worker,[]}] = supervisor:which_children(sup_test),
  598:    case is_pid(Pid) of
  599:	true -&gt;
<a name="600"></a>  600:	    ok;
  601:	false -&gt;
  602:	    ?line test_server:fail({permanent_child_not_restarted, Child1})
  603:    end.
  604:
  605:<i>%------------------------------------------------------------------------- </i>
<a name=transient_abnormal>  606:<b>transient_abnormal</b></a>(doc) -&gt;
  607:    ["A transient child should be restarted if it exits with " 
  608:     "reason abnormal"];
<a name=transient_abnormal>  609:<b>transient_abnormal</b></a>(suite) -&gt; [];
<a name=transient_abnormal><a name="610"></a>  610:<b>transient_abnormal</b></a>(Config) when list(Config) -&gt;
  611:    ?line  {ok, SupPid} = start({ok, {{one_for_one, 2, 3600}, []}}),
  612:    Child1 = {child1, {supervisor_1, start_child, []}, transient, 1000,
  613:	      worker, []},
  614:    
  615:    ?line {ok, CPid1} = supervisor:start_child(sup_test, Child1),
  616:   
  617:    CPid1 ! die,
  618:    test_server:sleep(100),
  619:    
<a name="620"></a>  620:    ?line [{child1, Pid ,worker,[]}] = supervisor:which_children(sup_test),
  621:    case is_pid(Pid) of
  622:	true -&gt;
  623:	    ok;
  624:	false -&gt;
  625:	    ?line test_server:fail({transient_child_not_restarted, Child1})
  626:    end.
  627:
  628:
  629:<i>%-------------------------------------------------------------------------    </i>
<a name=temporary_abnormal><a name="630"></a>  630:<b>temporary_abnormal</b></a>(doc) -&gt;
  631:    ["A temporary process should never be restarted"];
<a name=temporary_abnormal>  632:<b>temporary_abnormal</b></a>(suite) -&gt; [];
<a name=temporary_abnormal>  633:<b>temporary_abnormal</b></a>(Config) when list(Config) -&gt;
  634:     ?line  {ok, SupPid} = start({ok, {{one_for_one, 2, 3600}, []}}),
  635:    Child1 = {child1, {supervisor_1, start_child, []}, temporary, 1000,
  636:	      worker, []},
  637:    
  638:    ?line {ok, CPid1} = supervisor:start_child(sup_test, Child1),
  639:    
<a name="640"></a>  640:    CPid1 ! die,
  641:    test_server:sleep(100),
  642:    
  643:    ?line [{child1,undefined,worker,[]}] = supervisor:which_children(sup_test).
  644:
  645:<i>%-------------------------------------------------------------------------</i>
<a name=restart_one_for_one>  646:<b>restart_one_for_one</b></a>(doc) -&gt;
  647:    ["Test that the one_for_one strategy works."];
  648:
<a name=restart_one_for_one>  649:<b>restart_one_for_one</b></a>(suite) -&gt; [one_for_one, one_for_one_escalation].
<a name="650"></a>  650:
  651:<i>%-------------------------------------------------------------------------</i>
<a name=one_for_one>  652:<b>one_for_one</b></a>(doc) -&gt;
  653:    ["Test the one_for_one base case."];
<a name=one_for_one>  654:<b>one_for_one</b></a>(suite) -&gt; [];
<a name=one_for_one>  655:<b>one_for_one</b></a>(Config) when list(Config) -&gt;
  656:    process_flag(trap_exit, true),
  657:    Child1 = {child1, {supervisor_1, start_child, []}, permanent, 1000,
  658:	     worker, []},
  659:    Child2 = {child2, {supervisor_1, start_child, []}, permanent, 1000,
<a name="660"></a>  660:	     worker, []},
  661:    ?line {ok, Pid} = start({ok, {{one_for_one, 2, 3600}, []}}),
  662:    ?line {ok, CPid1} = supervisor:start_child(sup_test, Child1),
  663:    link(CPid1),
  664:    ?line {ok, CPid2} = supervisor:start_child(sup_test, Child2),    
  665:    link(CPid2),
  666:    CPid1 ! die,
  667:    receive
  668:	{'EXIT', CPid1, died} -&gt; ok;
  669:	{'EXIT', CPid1, Reason} -&gt;
<a name="670"></a>  670:	    ?line test_server:fail(bad_exit_reason)
  671:    end,
  672:    test_server:sleep(100),
  673:    Children = supervisor:which_children(sup_test),
  674:    if length(Children) == 2 -&gt;
  675:	    case lists:keysearch(CPid2, 2, Children) of
  676:		{value, _} -&gt; ok;
  677:		_ -&gt; ?line test_server:fail(bad_child)
  678:	    end;
  679:       true -&gt; ?line test_server:fail({bad_child_list, Children})
<a name="680"></a>  680:    end,
  681:    
  682:    %% Test restart frequency property
  683:    CPid2 ! die,
  684:    receive
  685:	{'EXIT', CPid2, _} -&gt; ok
  686:    end,
  687:    test_server:sleep(100),
  688:    [{_, Pid4, _, _}|_] = supervisor:which_children(sup_test),
  689:    Pid4 ! die,
<a name="690"></a>  690:    receive
  691:	{'EXIT', Pid, _} -&gt; ok
  692:    after 3000 -&gt; ?line test_server:fail(restart_failed)
  693:    end,
  694:    ok.
  695:<i>%-------------------------------------------------------------------------</i>
<a name=one_for_one_escalation>  696:<b>one_for_one_escalation</b></a>(doc) -&gt;
  697:    ["Test restart escalation on a one_for_one supervisor."];
<a name=one_for_one_escalation>  698:<b>one_for_one_escalation</b></a>(suite) -&gt; [];
<a name=one_for_one_escalation>  699:<b>one_for_one_escalation</b></a>(Config) when list(Config) -&gt;
<a name="700"></a>  700:    process_flag(trap_exit, true),
  701:    Child1 = {child1, {supervisor_1, start_child, [error]},
  702:	      permanent, 1000,
  703:	     worker, []},
  704:    Child2 = {child2, {supervisor_1, start_child, []}, permanent, 1000,
  705:	     worker, []},
  706:    ?line {ok, Pid} = start({ok, {{one_for_one, 4, 3600}, []}}),
  707:    ?line {ok, CPid1} = supervisor:start_child(sup_test, Child1),
  708:    link(CPid1),
  709:    ?line {ok, CPid2} = supervisor:start_child(sup_test, Child2),    
<a name="710"></a>  710:    link(CPid2),
  711:    CPid1 ! die,
  712:    receive
  713:	{'EXIT', CPid1, died} -&gt; ok;
  714:	{'EXIT', CPid1, Reason} -&gt;
  715:	    ?line test_server:fail(bad_exit_reason)
  716:    end,
  717:    receive
  718:	{'EXIT', Pid, X} -&gt; {ok, X}
  719:    after
<a name="720"></a>  720:	2000 -&gt; ?line test_server:fail(supervisor_alive)
  721:    end,
  722:    receive
  723:	{'EXIT', CPid2, _} -&gt; ok
  724:    after
  725:	4000 -&gt; ?line test_server:fail(all_not_terminated)
  726:    end,
  727:    ok.
  728:<i>%-------------------------------------------------------------------------</i>
<a name=restart_one_for_all>  729:<b>restart_one_for_all</b></a>(doc) -&gt;
<a name="730"></a>  730:    ["Test that the one_for_all strategy works."];
  731:
<a name=restart_one_for_all>  732:<b>restart_one_for_all</b></a>(suite) -&gt; 
  733:    [one_for_all, one_for_all_escalation].
  734:
  735:<i>%-------------------------------------------------------------------------</i>
<a name=one_for_all>  736:<b>one_for_all</b></a>(doc) -&gt;
  737:    ["Test the one_for_all base case."];
<a name=one_for_all>  738:<b>one_for_all</b></a>(suite) -&gt; [];
<a name=one_for_all>  739:<b>one_for_all</b></a>(Config) when list(Config) -&gt;
<a name="740"></a>  740:    process_flag(trap_exit, true),
  741:    Child1 = {child1, {supervisor_1, start_child, []}, permanent, 1000,
  742:	     worker, []},
  743:    Child2 = {child2, {supervisor_1, start_child, []}, permanent, 1000,
  744:	     worker, []},
  745:    ?line {ok, Pid} = start({ok, {{one_for_all, 2, 3600}, []}}),
  746:    ?line {ok, CPid1} = supervisor:start_child(sup_test, Child1),
  747:    link(CPid1),
  748:    ?line {ok, CPid2} = supervisor:start_child(sup_test, Child2),    
  749:    link(CPid2),
<a name="750"></a>  750:    CPid1 ! die,
  751:    receive
  752:	{'EXIT', CPid1, died} -&gt; ok;
  753:	{'EXIT', CPid1, Reason} -&gt;
  754:	    ?line test_server:fail(bad_exit_reason)
  755:    end,
  756:    receive
  757:	{'EXIT', CPid2, _} -&gt; ok
  758:    end,
  759:    test_server:sleep(100),
<a name="760"></a>  760:    Children = supervisor:which_children(sup_test),
  761:    if length(Children) == 2 -&gt; ok;
  762:       true -&gt; ?line test_server:fail({bad_child_list, Children})
  763:    end,
  764:    %% Test that no old children is still alive
  765:    SCh = lists:map(fun({_,P,_,_}) -&gt; P end, Children),
  766:    case lists:member(CPid1, SCh) of
  767:	true -&gt; ?line test_server:fail(bad_child);
  768:	false -&gt; ok
  769:    end,
<a name="770"></a>  770:    case lists:member(CPid2, SCh) of
  771:	true -&gt; ?line test_server:fail(bad_child);
  772:	false -&gt; ok
  773:    end,
  774:    %%% Test restart frequency property
  775:    [{_, Pid3, _, _}|_] = supervisor:which_children(sup_test),
  776:    Pid3 ! die,
  777:    test_server:sleep(100),
  778:    [{_, Pid4, _, _}|_] = supervisor:which_children(sup_test),
  779:    Pid4 ! die,
<a name="780"></a>  780:    receive
  781:	{'EXIT', Pid, _} -&gt; ok
  782:    after 3000 -&gt; ?line test_server:fail(restart_failed)
  783:    end,
  784:    exit(Pid, shutdown).
  785:
  786:<i>%-------------------------------------------------------------------------</i>
<a name=one_for_all_escalation>  787:<b>one_for_all_escalation</b></a>(doc) -&gt; 
  788:    ["Test restart escalation on a one_for_all supervisor."];
<a name=one_for_all_escalation>  789:<b>one_for_all_escalation</b></a>(suite) -&gt; [];
<a name=one_for_all_escalation><a name="790"></a>  790:<b>one_for_all_escalation</b></a>(Config) when list(Config) -&gt;
  791:    process_flag(trap_exit, true),
  792:    Child1 = {child1, {supervisor_1, start_child, []}, permanent, 1000,
  793:	     worker, []},
  794:    Child2 = {child2, {supervisor_1, start_child, [error]},
  795:	      permanent, 1000,
  796:	     worker, []},
  797:    ?line {ok, Pid} = start({ok, {{one_for_all, 4, 3600}, []}}),
  798:    ?line {ok, CPid1} = supervisor:start_child(sup_test, Child1),
  799:    link(CPid1),
<a name="800"></a>  800:    ?line {ok, CPid2} = supervisor:start_child(sup_test, Child2),    
  801:    link(CPid2),
  802:    CPid1 ! die,
  803:    receive
  804:	{'EXIT', CPid1, died} -&gt; ok;
  805:	{'EXIT', CPid1, Reason} -&gt;
  806:	    ?line test_server:fail(bad_exit_reason)
  807:    end,
  808:    receive
  809:	{'EXIT', CPid2, _} -&gt; ok
<a name="810"></a>  810:    after
  811:	2000 -&gt; ?line test_server:fail(all_not_terminated)
  812:    end,
  813:    receive
  814:	{'EXIT', Pid, Reason1} -&gt; {ok, Reason1}
  815:    after
  816:	4000 -&gt; ?line test_server:fail(supervisor_alive)
  817:    end,
  818:    ok.
  819:
<a name="820"></a>  820:<i>%-------------------------------------------------------------------------</i>
<a name=restart_simple_one_for_one>  821:<b>restart_simple_one_for_one</b></a>(doc) -&gt;
  822:    ["Test that the simple_one_for_one strategy works."];
  823:
<a name=restart_simple_one_for_one>  824:<b>restart_simple_one_for_one</b></a>(suite) -&gt; 
  825:    [simple_one_for_one, simple_one_for_one_extra,
  826:     simple_one_for_one_escalation].
  827:
  828:<i>%-------------------------------------------------------------------------</i>
<a name=simple_one_for_one>  829:<b>simple_one_for_one</b></a>(doc) -&gt;
<a name="830"></a>  830:    ["Test the simple_one_for_one base case."];
<a name=simple_one_for_one>  831:<b>simple_one_for_one</b></a>(suite) -&gt; [];
<a name=simple_one_for_one>  832:<b>simple_one_for_one</b></a>(Config) when list(Config) -&gt;
  833:    process_flag(trap_exit, true),
  834:    Child = {child, {supervisor_1, start_child, []}, permanent, 1000,
  835:	     worker, []},
  836:    ?line {ok, Pid} = start({ok, {{simple_one_for_one, 2, 3600}, [Child]}}),
  837:    ?line {ok, CPid1} = supervisor:start_child(sup_test, []),
  838:    link(CPid1),
  839:    ?line {ok, CPid2} = supervisor:start_child(sup_test, []),    
<a name="840"></a>  840:    link(CPid2),
  841:    CPid1 ! die,
  842:    receive
  843:	{'EXIT', CPid1, died} -&gt; ok;
  844:	{'EXIT', CPid1, Reason} -&gt;
  845:	    ?line test_server:fail(bad_exit_reason)
  846:    end,
  847:    test_server:sleep(100),
  848:    Children = supervisor:which_children(sup_test),
  849:    if length(Children) == 2 -&gt;
<a name="850"></a>  850:	    case lists:keysearch(CPid2, 2, Children) of
  851:		{value, _} -&gt; ok;
  852:		_ -&gt; ?line test_server:fail(bad_child)
  853:	    end;
  854:       true -&gt; ?line test_server:fail({bad_child_list, Children})
  855:    end,
  856:    %% Test restart frequency property
  857:    CPid2 ! die,
  858:    receive
  859:	{'EXIT', CPid2, _} -&gt; ok
<a name="860"></a>  860:    end,
  861:    test_server:sleep(100),
  862:    [{_, Pid4, _, _}|_] = supervisor:which_children(sup_test),
  863:    Pid4 ! die,
  864:    receive
  865:	{'EXIT', Pid, _} -&gt; ok
  866:    after 3000 -&gt; ?line test_server:fail(restart_failed)
  867:    end,
  868:    ok.
  869:<i>%-------------------------------------------------------------------------</i>
<a name=simple_one_for_one_extra><a name="870"></a>  870:<b>simple_one_for_one_extra</b></a>(doc) -&gt; 
  871:    ["Tests automatic restart of children " 
  872:     "who's start function return extra info."];
<a name=simple_one_for_one_extra>  873:<b>simple_one_for_one_extra</b></a>(suite) -&gt; [];
<a name=simple_one_for_one_extra>  874:<b>simple_one_for_one_extra</b></a>(Config) when list(Config) -&gt;
  875:    process_flag(trap_exit, true),
  876:    Child = {child, {supervisor_1, start_child, [extra_info]}, 
  877:	     permanent, 1000, worker, []},
  878:    ?line {ok, Pid} = start({ok, {{simple_one_for_one, 2, 3600}, [Child]}}),
  879:    ?line {ok, CPid1, extra_info} = supervisor:start_child(sup_test, []),
<a name="880"></a>  880:    link(CPid1),
  881:    ?line {ok, CPid2, extra_info} = supervisor:start_child(sup_test, []),    
  882:    link(CPid2),
  883:    CPid1 ! die,
  884:    receive
  885:	{'EXIT', CPid1, died} -&gt; ok;
  886:	{'EXIT', CPid1, Reason} -&gt;
  887:	    ?line test_server:fail(bad_exit_reason)
  888:    end,
  889:    test_server:sleep(100),
<a name="890"></a>  890:    Children = supervisor:which_children(sup_test),
  891:    if length(Children) == 2 -&gt;
  892:	    case lists:keysearch(CPid2, 2, Children) of
  893:		{value, _} -&gt; ok;
  894:		_ -&gt; ?line test_server:fail(bad_child)
  895:	    end;
  896:       true -&gt; ?line test_server:fail({bad_child_list, Children})
  897:    end,
  898:    CPid2 ! die,
  899:    receive
<a name="900"></a>  900:	{'EXIT', CPid2, _} -&gt; ok
  901:    end,
  902:    test_server:sleep(100),
  903:    [{_, Pid4, _, _}|_] = supervisor:which_children(sup_test),
  904:    Pid4 ! die,
  905:    receive
  906:	{'EXIT', Pid, _} -&gt; ok
  907:    after 3000 -&gt; ?line test_server:fail(restart_failed)
  908:    end,
  909:    ok.
<a name="910"></a>  910:<i>%-------------------------------------------------------------------------</i>
<a name=simple_one_for_one_escalation>  911:<b>simple_one_for_one_escalation</b></a>(doc) -&gt;
  912:    ["Test restart escalation on a simple_one_for_one supervisor."];
<a name=simple_one_for_one_escalation>  913:<b>simple_one_for_one_escalation</b></a>(suite) -&gt; [];
<a name=simple_one_for_one_escalation>  914:<b>simple_one_for_one_escalation</b></a>(Config) when list(Config) -&gt;
  915:    process_flag(trap_exit, true),
  916:    Child = {child, {supervisor_1, start_child, []}, permanent, 1000,
  917:	     worker, []},
  918:    ?line {ok, Pid} = start({ok, {{simple_one_for_one, 4, 3600}, [Child]}}),
  919:    ?line {ok, CPid1} = supervisor:start_child(sup_test, [error]),
<a name="920"></a>  920:    link(CPid1),
  921:    ?line {ok, CPid2} = supervisor:start_child(sup_test, []),    
  922:    link(CPid2),
  923:    CPid1 ! die,
  924:    receive
  925:	{'EXIT', CPid1, died} -&gt; ok;
  926:	{'EXIT', CPid1, Reason} -&gt;
  927:	    ?line test_server:fail(bad_exit_reason)
  928:    end,
  929:    receive
<a name="930"></a>  930:	{'EXIT', Pid, Reason1} -&gt; {ok, Reason1}
  931:    after
  932:	2000 -&gt; ?line test_server:fail(supervisor_alive)
  933:    end,
  934:    receive
  935:	{'EXIT', CPid2, _} -&gt; ok
  936:    after
  937:	2000 -&gt; ?line test_server:fail(all_not_terminated)
  938:    end,
  939:    ok.
<a name="940"></a>  940:<i>%-------------------------------------------------------------------------</i>
<a name=restart_rest_for_one>  941:<b>restart_rest_for_one</b></a>(doc) -&gt;
  942:    ["Test that the rest_for_one strategy works."];
<a name=restart_rest_for_one>  943:<b>restart_rest_for_one</b></a>(suite) -&gt; [rest_for_one, rest_for_one_escalation].
  944:
  945:<i>%-------------------------------------------------------------------------</i>
<a name=rest_for_one>  946:<b>rest_for_one</b></a>(doc) -&gt;
  947:    ["Test the rest_for_one base case."];
<a name=rest_for_one>  948:<b>rest_for_one</b></a>(suite) -&gt; [];
<a name=rest_for_one>  949:<b>rest_for_one</b></a>(Config) when list(Config) -&gt;
<a name="950"></a>  950:    process_flag(trap_exit, true),
  951:    Child1 = {child1, {supervisor_1, start_child, []}, permanent, 1000,
  952:	     worker, []},
  953:    Child2 = {child2, {supervisor_1, start_child, []}, permanent, 1000,
  954:	     worker, []},
  955:    Child3 = {child3, {supervisor_1, start_child, []}, permanent, 1000,
  956:	     worker, []},
  957:    ?line {ok, Pid} = start({ok, {{rest_for_one, 2, 3600}, []}}),
  958:    ?line {ok, CPid1} = supervisor:start_child(sup_test, Child1),
  959:    link(CPid1),
<a name="960"></a>  960:    ?line {ok, CPid2} = supervisor:start_child(sup_test, Child2),    
  961:    link(CPid2),
  962:    ?line {ok, CPid3} = supervisor:start_child(sup_test, Child3),    
  963:    link(CPid3),
  964:    CPid2 ! die,
  965:    receive
  966:	{'EXIT', CPid2, died} -&gt; ok;
  967:	{'EXIT', CPid2, Reason} -&gt;
  968:	    ?line test_server:fail(bad_exit_reason)
  969:    after 2000 -&gt;
<a name="970"></a>  970:	    ?line test_server:fail(no_exit)
  971:    end,
  972:    %% Check that Cpid3 did die
  973:    receive
  974:	{'EXIT', CPid3, _} -&gt; ok
  975:    after 2000 -&gt;
  976:	    ?line test_server:fail(no_exit)
  977:    end,
  978:    %% Check that Cpid1 didn't die
  979:    receive
<a name="980"></a>  980:	{'EXIT', Cpid1, _} -&gt;
  981:	    ?line test_server:fail(bad_exit)
  982:    after
  983:	100 -&gt; ok
  984:    end,
  985:    Children = supervisor:which_children(sup_test),
  986:    if length(Children) == 3 -&gt; ok;
  987:       true -&gt; ?line test_server:fail({bad_child_list, Children})
  988:    end,
  989:    %% Test that no old children is still alive
<a name="990"></a>  990:    SCh = lists:map(fun({_,P,_,_}) -&gt; P end, Children),
  991:    case lists:member(CPid1, SCh) of
  992:	true -&gt; ok;
  993:	false -&gt; ?line test_server:fail(bad_child)
  994:    end,
  995:    case lists:member(CPid2, SCh) of
  996:	true -&gt; ?line test_server:fail(bad_child);
  997:	false -&gt; ok
  998:    end,
  999:    case lists:member(CPid3, SCh) of
<a name="1000"></a> 1000:	true -&gt; ?line test_server:fail(bad_child);
 1001:	false -&gt; ok
 1002:    end,
 1003:   
 1004:    %% Test restart frequency property
 1005:    [{child3, Pid3, _, _}|_] = supervisor:which_children(sup_test),
 1006:    Pid3 ! die,
 1007:    test_server:sleep(100),
 1008:    [_,{child2, Pid4, _, _}|_] = supervisor:which_children(sup_test),
 1009:    Pid4 ! die,
<a name="1010"></a> 1010:    receive
 1011:	{'EXIT', Pid, _} -&gt; ok
 1012:    after 3000 -&gt; ?line test_server:fail(restart_failed)
 1013:    end,
 1014:    exit(Pid, shutdown).
 1015:
 1016:<i>%-------------------------------------------------------------------------</i>
<a name=rest_for_one_escalation> 1017:<b>rest_for_one_escalation</b></a>(doc) -&gt;
 1018:    ["Test restart escalation on a rest_for_one supervisor."];
<a name=rest_for_one_escalation> 1019:<b>rest_for_one_escalation</b></a>(suite) -&gt; [];
<a name=rest_for_one_escalation><a name="1020"></a> 1020:<b>rest_for_one_escalation</b></a>(Config) when list(Config) -&gt;
 1021:    process_flag(trap_exit, true),
 1022:    Child1 = {child1, {supervisor_1, start_child, []}, permanent, 1000,
 1023:	     worker, []},
 1024:    Child2 = {child2, {supervisor_1, start_child, [error]},
 1025:	      permanent, 1000,
 1026:	     worker, []},
 1027:    Child3 = {child3, {supervisor_1, start_child, [error]},
 1028:	      permanent, 1000,
 1029:	     worker, []},
<a name="1030"></a> 1030:    ?line {ok, Pid} = start({ok, {{rest_for_one, 4, 3600}, []}}),
 1031:    ?line {ok, CPid1} = supervisor:start_child(sup_test, Child1),
 1032:    link(CPid1),
 1033:    ?line {ok, CPid2} = supervisor:start_child(sup_test, Child2),    
 1034:    link(CPid2),
 1035:    CPid1 ! die,
 1036:    receive
 1037:	{'EXIT', CPid1, died} -&gt; ok;
 1038:	{'EXIT', CPid1, Reason} -&gt;
 1039:	    ?line test_server:fail(bad_exit_reason)
<a name="1040"></a> 1040:    end,
 1041:    receive
 1042:	{'EXIT', CPid2, _} -&gt; ok
 1043:    after
 1044:	2000 -&gt; ?line test_server:fail(not_terminated)
 1045:    end,
 1046:    receive
 1047:	{'EXIT', Pid, Reason1} -&gt; {ok, Reason1}
 1048:    after
 1049:	4000 -&gt; ?line test_server:fail(supervisor_alive)
<a name="1050"></a> 1050:    end,
 1051:    ok.
 1052:
 1053:<i>%-------------------------------------------------------------------------</i>
<a name=child_unlink> 1054:<b>child_unlink</b></a>(doc)-&gt; ["Test that the supervisor does not hang forever if "
 1055:    "the child unliks and then is terminated by the supervisor."];
<a name=child_unlink> 1056:<b>child_unlink</b></a>(suite) -&gt; [];
<a name=child_unlink> 1057:<b>child_unlink</b></a>(Config) when list(Config) -&gt;
 1058:    
 1059:    ?line {ok, SupPid} = start({ok, {{one_for_one, 2, 3600}, []}}),
<a name="1060"></a> 1060:    
 1061:    Child = {naughty_child, {naughty_child, 
 1062:			     start_link, [SupPid]}, permanent, 
 1063:	     1000, worker, [supervisor_SUITE]},
 1064:    
 1065:    ?line {ok, ChildPid} = supervisor:start_child(sup_test, Child),
 1066:
 1067:    Pid = spawn(supervisor, terminate_child, [SupPid, naughty_child]),
 1068:
 1069:    SupPid ! foo,
<a name="1070"></a> 1070:    timer:sleep(5000),
 1071:    %% If the supervisor did not hang it will have got rid of the 
 1072:    %% foo message that we sent.
 1073:    case erlang:process_info(SupPid, message_queue_len) of
 1074:	{message_queue_len, 0}-&gt;
 1075:	    ok;
 1076:	_ -&gt;
 1077:	    exit(Pid, kill),
 1078:	    ?line test_server:fail(supervisor_hangs)
 1079:    end.
<a name="1080"></a> 1080:<i>%-------------------------------------------------------------------------</i>
 1081:
<a name=tree> 1082:<b>tree</b></a>(doc) -&gt;
 1083:    ["Test a basic supervison tree."];
<a name=tree> 1084:<b>tree</b></a>(suite) -&gt;
 1085:    [];
<a name=tree> 1086:<b>tree</b></a>(Config) when list(Config) -&gt;
 1087:    process_flag(trap_exit, true),
 1088:    
 1089:    Child1 = {child1, {supervisor_1, start_child, []},
<a name="1090"></a> 1090:	      permanent, 1000,
 1091:	      worker, []},
 1092:    Child2 = {child2, {supervisor_1, start_child, []},
 1093:	      permanent, 1000,
 1094:	      worker, []},
 1095:    Child3 = {child3, {supervisor_1, start_child, [error]},
 1096:	      permanent, 1000,
 1097:	      worker, []},
 1098:    Child4 = {child4, {supervisor_1, start_child, []},
 1099:	      permanent, 1000,
<a name="1100"></a> 1100:	      worker, []},
 1101:
 1102:    ChildSup1 = {supchild1, 
 1103:		 {supervisor, start_link,
 1104:		  [?MODULE, {ok, {{one_for_one, 4, 3600}, [Child1, Child2]}}]},
 1105:		 permanent, infinity,
 1106:		 supervisor, []},
 1107:    ChildSup2 = {supchild2, 
 1108:		 {supervisor, start_link, 
 1109:		  [?MODULE, {ok, {{one_for_one, 4, 3600}, []}}]},
<a name="1110"></a> 1110:		 permanent, infinity,
 1111:		 supervisor, []},
 1112:
 1113:    %% Top supervisor
 1114:    ?line {ok, Pid} = start({ok, {{one_for_all, 4, 3600}, []}}),
 1115:    
 1116:    %% Child supervisors  
 1117:    ?line {ok, Sup1} = supervisor:start_child(Pid, ChildSup1),
 1118:    ?line {ok, Sup2} = supervisor:start_child(Pid, ChildSup2),
 1119:    
<a name="1120"></a> 1120:    %% Workers
 1121:    
 1122:     ?line [{_, CPid2, _, _},{_, CPid1, _, _}] = 
 1123:	supervisor:which_children(Sup1),
 1124:   
 1125:    %% Dynamic children
 1126:    ?line {ok, CPid3} = supervisor:start_child(Sup2, Child3),
 1127:    ?line {ok, CPid4} = supervisor:start_child(Sup2, Child4),
 1128:    
 1129:    link(Sup1),
<a name="1130"></a> 1130:    link(Sup2),
 1131:    link(CPid1),
 1132:    link(CPid2),
 1133:    link(CPid3),
 1134:    link(CPid4),
 1135: 
 1136:    %% Test that the only the process that dies is restarted
 1137:    CPid4 ! die,
 1138: 
 1139:    receive
<a name="1140"></a> 1140:	{'EXIT', CPid4, _} -&gt; ?line ok
 1141:    after 10000 -&gt;
 1142:	    ?line test_server:fail(child_was_not_killed)
 1143:    end,
 1144:    
 1145:    test_server:sleep(100),
 1146:    
 1147:    ?line [{_, CPid2, _, _},{_, CPid1, _, _}] = 
 1148:	supervisor:which_children(Sup1),
 1149:    
<a name="1150"></a> 1150:    ?line [{_, NewCPid4, _, _},{_, Cpid3, _, _}] = 
 1151:	supervisor:which_children(Sup2),
 1152:    
 1153:    link(NewCPid4),
 1154:
 1155:    %% Test that supervisor tree is restarted, but not dynamic children.
 1156:    CPid3 ! die,
 1157:
 1158:    receive
 1159:	{'EXIT', CPid3, died} -&gt; ?line ok;
<a name="1160"></a> 1160:	{'EXIT', CPid3, Reason} -&gt;
 1161:	    ?line test_server:fail(bad_exit_reason)
 1162:    after 1000 -&gt;
 1163:	    ?line test_server:fail(child_was_not_killed)
 1164:    end,
 1165:
 1166:    test_server:sleep(1000),
 1167:
 1168:    receive
 1169: 	{'EXIT', NewCPid4, _} -&gt;  ?line ok
<a name="1170"></a> 1170:    after 1000 -&gt;
 1171: 	    ?line test_server:fail(child_was_not_killed)
 1172:    end,
 1173:    
 1174:    receive
 1175:	{'EXIT', Sup2, _} -&gt; ?line  ok
 1176:    after 1000 -&gt;
 1177:	    ?line test_server:fail(child_was_not_killed)
 1178:    end,
 1179:    
<a name="1180"></a> 1180:    receive
 1181:	{'EXIT', CPid1, _} -&gt;  ?line ok
 1182:    after 1000 -&gt;
 1183:	    ?line test_server:fail(child_was_not_killed)
 1184:    end,
 1185:    
 1186:    receive
 1187:	{'EXIT', CPid2, _} -&gt; ?line  ok
 1188:    after 1000 -&gt;
 1189:	  ?line test_server:fail(child_was_not_killed)
<a name="1190"></a> 1190:    end,
 1191:    
 1192:    receive
 1193:	{'EXIT', Sup1, _} -&gt; ?line  ok
 1194:    after 1000 -&gt;
 1195:	    ?line test_server:fail(child_was_not_killed)
 1196:    end,
 1197:        
 1198:    ?line [{supchild2, NewSup2, _, _},{supchild1, NewSup1, _, _}] =
 1199:	supervisor:which_children(Pid),
<a name="1200"></a> 1200:    
 1201:    ?line [{child2, _, _, _},{child1, _, _, _}]  =
 1202:	supervisor:which_children(NewSup1),
 1203:    ?line [] = supervisor:which_children(NewSup2),
 1204:    
 1205:    ok.
</pre>
<hr size=1><i>The transformation of this file (1206 lines) took 0.03 seconds</i><br>
</body>
</html>
