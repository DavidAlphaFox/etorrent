<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head><title>/usr/home/jlouis/hacking/test_server/stdlib_test/ms_transform_SUITE.erl</title></head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
    1:-<b>module</b>(ms_transform_SUITE).
    2:-<b>author</b>('pan@erix.ericsson.se').
    3:
    4:-<b>include</b>("test_server.hrl").
    5:
    6:-<b>export</b>([all/1]).
    7:-<b>export</b>([basic_ets/1]).
    8:-<b>export</b>([basic_dbg/1]).
    9:-<b>export</b>([from_shell/1]).
<a name="10"></a>   10:-<b>export</b>([records/1]).
   11:-<b>export</b>([record_index/1]).
   12:-<b>export</b>([multipass/1]).
   13:-<b>export</b>([top_match/1]).
   14:-<b>export</b>([init_per_testcase/2, fin_per_testcase/2]).
   15:
<a name=init_per_testcase>   16:<b>init_per_testcase</b></a>(Func, Config) -&gt;
   17:    Dog=test_server:timetrap(test_server:seconds(360)),
   18:    [{watchdog, Dog}|Config].
   19:
<a name=fin_per_testcase><a name="20"></a>   20:<b>fin_per_testcase</b></a>(Func, Config) -&gt;
   21:    Dog=?config(watchdog, Config),
   22:    test_server:timetrap_cancel(Dog).
   23:
<a name=all>   24:<b>all</b></a>(suite) -&gt; [from_shell,basic_ets,basic_dbg,records,record_index,multipass,
   25:	       top_match].
   26:
<a name=basic_ets>   27:<b>basic_ets</b></a>(suite) -&gt;
   28:    [];
<a name=basic_ets>   29:<b>basic_ets</b></a>(doc) -&gt;
<a name="30"></a>   30:    ["Tests basic ets:fun2ms"];
<a name=basic_ets>   31:<b>basic_ets</b></a>(Config) when list(Config) -&gt;
   32:    ?line setup(Config),
   33:    ?line [{{a,b},[],[true]}] = compile_and_run(
   34:				  &lt;&lt;"ets:fun2ms(fun({a,b}) -&gt; true end)"&gt;&gt;),
   35:    ?line [{{'$1',foo},[{is_list,'$1'}],[{{{hd,'$1'},'$_'}}]},
   36:     {{'$1','$1'},[{is_tuple,'$1'}],[{{{element,1,'$1'},'$*'}}]}] =
   37:	compile_and_run(&lt;&lt;"ets:fun2ms(fun({X,foo}) when is_list(X) -&gt; ",
   38:			                     "{hd(X),object()};",
   39:			                "({X,X}) when is_tuple(X) -&gt;",
<a name="40"></a>   40:			                     "{element(1,X),bindings()}",
   41:			             "end)"&gt;&gt;),
   42:    ?line [{{'$1','$2'},[],[{{'$2','$1'}}]}] =
   43:	compile_and_run(&lt;&lt;"ets:fun2ms(fun({A,B}) -&gt; {B,A} end)"&gt;&gt;),
   44:    ?line [{{'$1','$2'},[],[['$2','$1']]}] =
   45:	compile_and_run(&lt;&lt;"ets:fun2ms(fun({A,B}) -&gt; [B,A] end)"&gt;&gt;),
   46:    ok.
   47:
<a name=basic_dbg>   48:<b>basic_dbg</b></a>(suite) -&gt;
   49:    [];
<a name=basic_dbg><a name="50"></a>   50:<b>basic_dbg</b></a>(doc) -&gt;
   51:    ["Tests basic ets:fun2ms"];
<a name=basic_dbg>   52:<b>basic_dbg</b></a>(Config) when list(Config) -&gt;
   53:    ?line setup(Config),
   54:    ?line [{[a,b],[],[{message,banan},{return_trace}]}] =
   55:	compile_and_run(&lt;&lt;"dbg:fun2ms(fun([a,b]) -&gt; message(banan), ",
   56:			"return_trace() end)"&gt;&gt;),
   57:    ?line [{['$1','$2'],[],[{{'$2','$1'}}]}] = 
   58:	compile_and_run(&lt;&lt;"dbg:fun2ms(fun([A,B]) -&gt; {B,A} end)"&gt;&gt;),
   59:    ?line [{['$1','$2'],[],[['$2','$1']]}] =
<a name="60"></a>   60:	compile_and_run(&lt;&lt;"dbg:fun2ms(fun([A,B]) -&gt; [B,A] end)"&gt;&gt;),
   61:    ?line [{['$1','$2'],[],['$*']}] =
   62:	compile_and_run(&lt;&lt;"dbg:fun2ms(fun([A,B]) -&gt; bindings() end)"&gt;&gt;),
   63:    ?line [{['$1','$2'],[],['$_']}] =
   64:	compile_and_run(&lt;&lt;"dbg:fun2ms(fun([A,B]) -&gt; object() end)"&gt;&gt;),
   65:    ok.
   66:
<a name=from_shell>   67:<b>from_shell</b></a>(suite) -&gt;
   68:    [];
<a name=from_shell>   69:<b>from_shell</b></a>(doc) -&gt;
<a name="70"></a>   70:    ["Test calling of ets/dbg:fun2ms from the shell"]; 
<a name=from_shell>   71:<b>from_shell</b></a>(Config) when list(Config) -&gt;
   72:    ?line setup(Config),
   73:    ?line Fun = do_eval("fun({a,b}) -&gt; true end"),
   74:    ?line [{{a,b},[],[true]}] = apply(ets,fun2ms,[Fun]),
   75:    ?line [{{a,b},[],[true]}] = do_eval("ets:fun2ms(fun({a,b}) -&gt; true end)"),
   76:    ?line Fun2 = do_eval("fun([a,b]) -&gt; message(banan), return_trace() end"),
   77:    ?line [{[a,b],[],[{message,banan},{return_trace}]}]
   78:	= apply(dbg,fun2ms,[Fun2]),
   79:    ?line [{[a,b],[],[{message,banan},{return_trace}]}] =
<a name="80"></a>   80:	do_eval(
   81:	  "dbg:fun2ms(fun([a,b]) -&gt; message(banan), return_trace() end)"),
   82:    ok.
   83:
<a name=records>   84:<b>records</b></a>(suite) -&gt;
   85:    [];
<a name=records>   86:<b>records</b></a>(doc) -&gt;
   87:    ["Tests expansion of records in fun2ms"];
<a name=records>   88:<b>records</b></a>(Config) when list(Config) -&gt;
   89:    ?line setup(Config),
<a name="90"></a>   90:    ?line RD = &lt;&lt;"-record(t, {"
   91:	             "t1 = [],"
   92:	             "t2 = foo,"
   93:	             "t3,"
   94:	             "t4"
   95:	            "})."&gt;&gt;,
   96:    ?line [{{t,'$1','$2',foo,'_'},[{is_list,'$1'}],[{{{hd,'$1'},'$_'}}]},
   97:     {{t,'_','_','_','_'},[{'==',{element,2,'$_'},nisse}],[{{'$*'}}]}] =
   98:	compile_and_run(RD,&lt;&lt;
   99:   "ets:fun2ms(fun(#t{t1 = X, t2 = Y, t3 = foo}) when is_list(X) -&gt; 
<a name="100"></a>  100: 		       {hd(X),object()}; 
  101: 		  (#t{}) when (object())#t.t1 == nisse -&gt; 
  102: 		       {bindings()}  
  103: 	       end)"&gt;&gt;),
  104:    ?line [{{t,'$1','$2','_',foo},
  105:      [{'==',{element,4,'$_'},7},{is_list,'$1'}],
  106:      [{{{hd,'$1'},'$_'}}]},
  107:     {'$1',[{is_record,'$1',t,5}],
  108:      [{{{element,2,'$1'},
  109:	 {{t,'$1',foo,undefined,undefined}},
<a name="110"></a>  110:	 {{t,{element,2,'$1'},{element,3,'$1'},{element,4,'$1'},boooo}}}}]}] =
  111:	compile_and_run(RD,&lt;&lt;
  112:    "ets:fun2ms(fun(#t{t1 = X, t2 = Y, t4 = foo}) when 
  113:			 (object())#t.t3==7,is_list(X) -&gt; 
  114: 		       {hd(X),object()}; 
  115: 		  (A) when is_record(A,t) -&gt; 
  116: 		       {A#t.t1
  117:			,#t{t1=A}
  118:			,A#t{t4=boooo}
  119:		       }  
<a name="120"></a>  120: 	       end)"
  121:			&gt;&gt;),
  122:    ?line [{[{t,'$1','$2',foo,'_'}],[{is_list,'$1'}],[{{{hd,'$1'},'$_'}}]},
  123:     {[{t,'_','_','_','_'}],[{'==',{element,2,{hd,'$_'}},nisse}],[{{'$*'}}]}]=
  124:	compile_and_run(RD,&lt;&lt;
  125:    "dbg:fun2ms(fun([#t{t1 = X, t2 = Y, t3 = foo}]) when is_list(X) -&gt; 
  126: 		       {hd(X),object()}; 
  127: 		  ([#t{}]) when (hd(object()))#t.t1 == nisse -&gt; 
  128: 		       {bindings()}  
  129: 	       end)"
<a name="130"></a>  130:			&gt;&gt;),
  131:    ok.
  132:
  133:
<a name=record_index>  134:<b>record_index</b></a>(suite) -&gt;
  135:    [];
<a name=record_index>  136:<b>record_index</b></a>(doc) -&gt;
  137:    ["Tests expansion of records in fun2ms, part 2"];
<a name=record_index>  138:<b>record_index</b></a>(Config) when list(Config) -&gt;
  139:    ?line setup(Config),
<a name="140"></a>  140:    ?line RD = &lt;&lt;"-record(a,{a,b})."&gt;&gt;,
  141:    ?line [{{2},[],[true]}] = compile_and_run(RD,
  142:			  &lt;&lt;"ets:fun2ms(fun({#a.a}) -&gt; true end)"&gt;&gt;),
  143:    ?line [{{2},[],[2]}] = compile_and_run(RD,
  144:			  &lt;&lt;"ets:fun2ms(fun({#a.a}) -&gt; #a.a end)"&gt;&gt;),
  145:    ?line [{{2,'$1'},[{'&gt;','$1',2}],[2]}] = compile_and_run(RD,
  146:		    &lt;&lt;"ets:fun2ms(fun({#a.a,A}) when A &gt; #a.a -&gt; #a.a end)"&gt;&gt;),
  147:    ok.
  148:
<a name=top_match>  149:<b>top_match</b></a>(suite) -&gt;
<a name="150"></a>  150:    [];
<a name=top_match>  151:<b>top_match</b></a>(doc) -&gt;
  152:    ["Tests matching on top level in head to give alias for object()"];
<a name=top_match>  153:<b>top_match</b></a>(Config) when list(Config) -&gt;
  154:    ?line setup(Config),
  155:    ?line RD = &lt;&lt;"-record(a,{a,b})."&gt;&gt;,
  156:    ?line [{{a,3,'_'},[],['$_']}] = 
  157:	compile_and_run(RD,
  158:			&lt;&lt;"ets:fun2ms(fun(A = #a{a=3}) -&gt; A end)"&gt;&gt;),
  159:    ?line [{{a,3,'_'},[],['$_']}] = 
<a name="160"></a>  160:	compile_and_run(RD,
  161:			&lt;&lt;"ets:fun2ms(fun(#a{a=3} = A) -&gt; A end)"&gt;&gt;),
  162:    ?line [{[a,b],[],['$_']}] = 
  163:	compile_and_run(RD,
  164:			&lt;&lt;"dbg:fun2ms(fun(A = [a,b]) -&gt; A end)"&gt;&gt;),
  165:    ?line [{[a,b],[],['$_']}] = 
  166:	compile_and_run(RD,
  167:			&lt;&lt;"dbg:fun2ms(fun([a,b] = A) -&gt; A end)"&gt;&gt;),
  168:    ?line expect_failure(RD,
  169:			 &lt;&lt;"ets:fun2ms(fun({a,A = {_,b}}) -&gt; A end)"&gt;&gt;),
<a name="170"></a>  170:    ?line expect_failure(RD,
  171:			 &lt;&lt;"dbg:fun2ms(fun([a,A = {_,b}]) -&gt; A end)"&gt;&gt;),
  172:    ?line expect_failure(RD,
  173:			 &lt;&lt;"ets:fun2ms(fun(A#a{a = 2}) -&gt; A end)"&gt;&gt;),
  174:    ok.
  175:
<a name=multipass>  176:<b>multipass</b></a>(suite) -&gt;
  177:    [];
<a name=multipass>  178:<b>multipass</b></a>(doc) -&gt;
  179:    ["Tests that multi-defined fields in records give errors."];
<a name=multipass><a name="180"></a>  180:<b>multipass</b></a>(Config) when list(Config) -&gt;
  181:    ?line setup(Config),
  182:    ?line RD = &lt;&lt;"-record(a,{a,b})."&gt;&gt;,
  183:    ?line expect_failure(RD,&lt;&lt;"ets:fun2ms(fun(A) -&gt; #a{a=2,a=3} end)"&gt;&gt;), 
  184:    ?line expect_failure(RD,&lt;&lt;"ets:fun2ms(fun(A) -&gt; A#a{a=2,a=3} end)"&gt;&gt;),
  185:    ?line expect_failure(RD,&lt;&lt;"ets:fun2ms(fun(A) when A =:= #a{a=2,a=3} -&gt;",
  186:			 " true end)"&gt;&gt;), 
  187:    ?line expect_failure(RD,&lt;&lt;"ets:fun2ms(fun({A,B})when A =:= B#a{a=2,a=3}-&gt;",
  188:			 "true end)"&gt;&gt;),
  189:    ?line expect_failure(RD,&lt;&lt;"ets:fun2ms(fun(#a{a=3,a=3}) -&gt; true end)"&gt;&gt;),
<a name="190"></a>  190:    ?line compile_and_run(RD,&lt;&lt;"ets:fun2ms(fun(A) -&gt; #a{a=2,b=3} end)"&gt;&gt;), 
  191:    ?line compile_and_run(RD,&lt;&lt;"ets:fun2ms(fun(A) -&gt; A#a{a=2,b=3} end)"&gt;&gt;),
  192:    ?line compile_and_run(RD,&lt;&lt;"ets:fun2ms(fun(A) when A =:= #a{a=2,b=3} -&gt;",
  193:			 " true end)"&gt;&gt;), 
  194:    ?line compile_and_run(RD,&lt;&lt;"ets:fun2ms(fun({A,B})when A=:= B#a{a=2,b=3}-&gt;",
  195:			 "true end)"&gt;&gt;),
  196:    ?line compile_and_run(RD,&lt;&lt;"ets:fun2ms(fun(#a{a=3,b=3}) -&gt; true end)"&gt;&gt;),
  197:    ok.
  198:
  199:<i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="200"></a>  200:<i>% Helpers</i>
  201:<i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
  202:
<a name=setup>  203:<b>setup</b></a>(Config) -&gt;
  204:    put(mts_config,Config),
  205:    put(mts_tf_counter,0).
  206:
<a name=temp_name>  207:<b>temp_name</b></a>() -&gt;
  208:    Conf = get(mts_config),
  209:    C = get(mts_tf_counter),
<a name="210"></a>  210:    put(mts_tf_counter,C+1),
  211:    filename:join([?config(priv_dir,Conf),
  212:		   "tempfile"++integer_to_list(C)++".tmp"]).
  213:
  214:
<a name=expect_failure>  215:<b>expect_failure</b></a>(Recs,Code) -&gt;
  216:    case (catch compile_and_run(Recs,Code)) of
  217:	      {'EXIT',_Foo} -&gt;
  218:		  %erlang:display(_Foo),
  219:		  ok;
<a name="220"></a>  220:	      Other -&gt;
  221:		  exit({expected,failure,got,Other})
  222:	  end.
  223: 
<a name=compile_and_run>  224:<b>compile_and_run</b></a>(Expr) -&gt;
  225:    compile_and_run(&lt;&lt;&gt;&gt;,Expr).
<a name=compile_and_run>  226:<b>compile_and_run</b></a>(Records,Expr) -&gt;
  227:    Prog = &lt;&lt;
  228:	"-module(tmp).\n",
  229:    "-include_lib(\"stdlib/include/ms_transform.hrl\").\n",
<a name="230"></a>  230:    "-export([tmp/0]).\n",
  231:    Records/binary,"\n",
  232:    "tmp() -&gt;\n",
  233:    Expr/binary,".\n"&gt;&gt;,
  234:    FN=temp_name(),
  235:    file:write_file(FN,Prog),
  236:    {ok,Forms} = epp:parse_file(FN,"",""),
  237:    {ok,tmp,Bin} = compile:forms(Forms),
  238:    code:load_binary(tmp,FN,Bin),
  239:    tmp:tmp().
<a name="240"></a>  240:
<a name=do_eval>  241:<b>do_eval</b></a>(String) -&gt;
  242:    {done,{ok,T,_},[]} = erl_scan:tokens(
  243:			   [],
  244:			   String++".\n",1),
  245:    {ok,Tree} = erl_parse:parse_exprs(T),
  246:    {value,Res,[]} =  erl_eval:exprs(Tree,[]),
  247:    Res.
</pre>
<hr size=1><i>The transformation of this file (248 lines) took 0.01 seconds</i><br>
</body>
</html>
