<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head><title>/usr/home/jlouis/hacking/test_server/stdlib_test/gen_fsm_SUITE.erl</title></head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
    1:<i>%% ``The contents of this file are subject to the Erlang Public License,</i>
    2:<i>%% Version 1.1, (the "License"); you may not use this file except in</i>
    3:<i>%% compliance with the License. You should have received a copy of the</i>
    4:<i>%% Erlang Public License along with this software. If not, it can be</i>
    5:<i>%% retrieved via the world wide web at http://www.erlang.org/.</i>
    6:<i>%% </i>
    7:<i>%% Software distributed under the License is distributed on an "AS IS"</i>
    8:<i>%% basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See</i>
    9:<i>%% the License for the specific language governing rights and limitations</i>
<a name="10"></a>   10:<i>%% under the License.</i>
   11:<i>%% </i>
   12:<i>%% The Initial Developer of the Original Code is Ericsson Utvecklings AB.</i>
   13:<i>%% Portions created by Ericsson are Copyright 1999, Ericsson Utvecklings</i>
   14:<i>%% AB. All Rights Reserved.''</i>
   15:<i>%% </i>
   16:<i>%%     $Id$</i>
   17:<i>%%</i>
   18:-<b>module</b>(gen_fsm_SUITE).
   19:
<a name="20"></a>   20:-<b>include</b>("test_server.hrl").
   21:
   22:<i>%% Test cases</i>
   23:-<b>export</b>([all/1]).
   24:
   25:-<b>export</b>([start/1, start1/1, start2/1, start3/1, start4/1 , start5/1, start6/1,
   26:	 start7/1, start8/1, start9/1, start10/1, start11/1]).
   27:
   28:-<b>export</b>([abnormal/1, abnormal1/1, abnormal2/1]).
   29:
<a name="30"></a>   30:-<b>export</b>([sys/1, sys1/1]).
   31:
   32:<i>%% Exports for apply</i>
   33:-<b>export</b>([do_msg/1, do_sync_msg/1]).
   34:
   35:<i>% The gen_fsm behaviour</i>
   36:-<b>export</b>([init/1, handle_event/3, handle_sync_event/4, terminate/3,
   37:	 handle_info/3]).
   38:-<b>export</b>([idle/2,	idle/3,
   39:	 timeout/2,
<a name="40"></a>   40:	 wfor_conf/2,	wfor_conf/3,
   41:	 connected/2,	connected/3]).
   42:	 
   43:
   44:<i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
   45:
   46:
<a name=all>   47:<b>all</b></a>(suite) -&gt; {req,[stdlib],[start, abnormal, sys]}.
   48:
   49:
<a name=start><a name="50"></a>   50:<b>start</b></a>(suite) -&gt; [start1, start2, start3, start4, start5, start6, start7,
   51:		 start8, start9, start10, start11].
   52:
   53:<i>%% anonymous</i>
<a name=start1>   54:<b>start1</b></a>(suite) -&gt; {req,{time,5}};
<a name=start1>   55:<b>start1</b></a>(Config) when list(Config) -&gt;
   56:    %%OldFl = process_flag(trap_exit, true),
   57:
   58:    ?line {ok, Pid0} = gen_fsm:start_link(gen_fsm_SUITE, [], []),
   59:    ?line ok = do_func_test(Pid0),
<a name="60"></a>   60:    ?line ok = do_sync_func_test(Pid0),
   61:    stop_it(Pid0),
   62:<i>%%    ?line stopped = gen_fsm:sync_send_all_state_event(Pid0, stop),</i>
   63:<i>%%    ?line {'EXIT', {timeout,_}} = </i>
   64:<i>%%	(catch gen_fsm:sync_send_event(Pid0, hej)),</i>
   65:
   66:    ?line test_server:messages_get(),
   67:    %%process_flag(trap_exit, OldFl),
   68:   ok.
   69:
<a name="70"></a>   70:<i>%% anonymous w. shutdown</i>
<a name=start2>   71:<b>start2</b></a>(suite) -&gt; {req,{time,5}};
<a name=start2>   72:<b>start2</b></a>(Config) when list(Config) -&gt;
   73:    %% Dont link when shutdown
   74:    ?line {ok, Pid0} = gen_fsm:start(gen_fsm_SUITE, [], []),
   75:    ?line ok = do_func_test(Pid0),
   76:    ?line ok = do_sync_func_test(Pid0),
   77:    ?line shutdown_stopped = 
   78:	gen_fsm:sync_send_all_state_event(Pid0, stop_shutdown),
   79:    ?line {'EXIT', {noproc,_}} = 
<a name="80"></a>   80:	(catch gen_fsm:sync_send_event(Pid0, hej)),
   81:
   82:    ?line test_server:messages_get(),
   83:    ok.
   84:
   85:<i>%% anonymous with timeout</i>
<a name=start3>   86:<b>start3</b></a>(suite) -&gt; {req,{time,5}};
<a name=start3>   87:<b>start3</b></a>(Config) when list(Config) -&gt;
   88:    %%OldFl = process_flag(trap_exit, true),
   89:
<a name="90"></a>   90:    ?line {ok, Pid0} = gen_fsm:start(gen_fsm_SUITE, [], [{timeout,5}]),
   91:    ?line ok = do_func_test(Pid0),
   92:    ?line ok = do_sync_func_test(Pid0),
   93:    ?line stop_it(Pid0),
   94:    
   95:    ?line {error, timeout} = gen_fsm:start(gen_fsm_SUITE, sleep,
   96:					   [{timeout,5}]),
   97:
   98:    test_server:messages_get(),
   99:    %%process_flag(trap_exit, OldFl),
<a name="100"></a>  100:    ok.
  101:
  102:<i>%% anonymous with ignore</i>
<a name=start4>  103:<b>start4</b></a>(suite) -&gt; [];
<a name=start4>  104:<b>start4</b></a>(Config) when list(Config) -&gt;
  105:    OldFl = process_flag(trap_exit, true),
  106:
  107:    ?line ignore = gen_fsm:start(gen_fsm_SUITE, ignore, []),
  108:
  109:    test_server:messages_get(),
<a name="110"></a>  110:    process_flag(trap_exit, OldFl),
  111:    ok.
  112:
  113:<i>%% anonymous with stop</i>
<a name=start5>  114:<b>start5</b></a>(suite) -&gt; [];
<a name=start5>  115:<b>start5</b></a>(Config) when list(Config) -&gt;
  116:    OldFl = process_flag(trap_exit, true),
  117:
  118:    ?line {error, stopped} = gen_fsm:start(gen_fsm_SUITE, stop, []),
  119:
<a name="120"></a>  120:    test_server:messages_get(),
  121:    process_flag(trap_exit, OldFl),
  122:    ok.
  123:
  124:<i>%% anonymous linked</i>
<a name=start6>  125:<b>start6</b></a>(suite) -&gt; {req,{time,5}};
<a name=start6>  126:<b>start6</b></a>(Config) when list(Config) -&gt;
  127:    %%OldFl = process_flag(trap_exit, true),
  128:
  129:    ?line {ok, Pid} = gen_fsm:start_link(gen_fsm_SUITE, [], []),
<a name="130"></a>  130:    ?line ok = do_func_test(Pid),
  131:    ?line ok = do_sync_func_test(Pid),
  132:    ?line stop_it(Pid),
  133:    
  134:    test_server:messages_get(),
  135:    %%process_flag(trap_exit, OldFl),
  136:    ok.
  137:
  138:<i>%% global register linked</i>
<a name=start7>  139:<b>start7</b></a>(suite) -&gt; {req,{time,5}};
<a name=start7><a name="140"></a>  140:<b>start7</b></a>(Config) when list(Config) -&gt;
  141:    %%OldFl = process_flag(trap_exit, true),
  142:    
  143:    ?line {ok, Pid} = 
  144:	gen_fsm:start_link({global, my_fsm}, gen_fsm_SUITE, [], []),
  145:    ?line {error, {already_started, Pid}} =
  146:	gen_fsm:start_link({global, my_fsm}, gen_fsm_SUITE, [], []),
  147:<i>%%    ?line {error, {already_started, Pid}} =</i>
  148:<i>%%	gen_fsm:start_link({local, my_fsm}, gen_fsm_SUITE, [], []),</i>
  149:    ?line {error, {already_started, Pid}} =
<a name="150"></a>  150:	gen_fsm:start({global, my_fsm}, gen_fsm_SUITE, [], []),
  151:<i>%%    ?line {error, {already_started, Pid}} =</i>
  152:<i>%%	gen_fsm:start({local, my_fsm}, gen_fsm_SUITE, [], []),</i>
  153:    
  154:    ?line ok = do_func_test(Pid),
  155:    ?line ok = do_sync_func_test(Pid),
  156:    ?line ok = do_func_test({global, my_fsm}),
  157:    ?line ok = do_sync_func_test({global, my_fsm}),
  158:    ?line stop_it({global, my_fsm}),
  159:    
<a name="160"></a>  160:    test_server:messages_get(),
  161:    %%process_flag(trap_exit, OldFl),
  162:    ok.
  163:
  164:
  165:<i>%% local register</i>
<a name=start8>  166:<b>start8</b></a>(suite) -&gt; {req,{time,5}};
<a name=start8>  167:<b>start8</b></a>(Config) when list(Config) -&gt;
  168:    %%OldFl = process_flag(trap_exit, true),
  169:
<a name="170"></a>  170:    ?line {ok, Pid} = 
  171:	gen_fsm:start({local, my_fsm}, gen_fsm_SUITE, [], []),
  172:    ?line {error, {already_started, Pid}} =
  173:	gen_fsm:start({local, my_fsm}, gen_fsm_SUITE, [], []),
  174:
  175:    ?line ok = do_func_test(Pid),
  176:    ?line ok = do_sync_func_test(Pid),
  177:    ?line ok = do_func_test(my_fsm),
  178:    ?line ok = do_sync_func_test(my_fsm),
  179:    ?line stop_it(Pid),
<a name="180"></a>  180:    
  181:    test_server:messages_get(),
  182:    %%process_flag(trap_exit, OldFl),
  183:    ok.
  184:
  185:<i>%% local register linked</i>
<a name=start9>  186:<b>start9</b></a>(suite) -&gt; {req,{time,5}};
<a name=start9>  187:<b>start9</b></a>(Config) when list(Config) -&gt;
  188:    %%OldFl = process_flag(trap_exit, true),
  189:
<a name="190"></a>  190:    ?line {ok, Pid} = 
  191:	gen_fsm:start_link({local, my_fsm}, gen_fsm_SUITE, [], []),
  192:    ?line {error, {already_started, Pid}} =
  193:	gen_fsm:start({local, my_fsm}, gen_fsm_SUITE, [], []),
  194:
  195:    ?line ok = do_func_test(Pid),
  196:    ?line ok = do_sync_func_test(Pid),
  197:    ?line ok = do_func_test(my_fsm),
  198:    ?line ok = do_sync_func_test(my_fsm),
  199:    ?line stop_it(Pid),
<a name="200"></a>  200:    
  201:    test_server:messages_get(),
  202:    %%process_flag(trap_exit, OldFl),
  203:    ok.
  204:
  205:<i>%% global register</i>
<a name=start10>  206:<b>start10</b></a>(suite) -&gt; {req,{time,5}};
<a name=start10>  207:<b>start10</b></a>(Config) when list(Config) -&gt;
  208:    %%OldFl = process_flag(trap_exit, true),
  209:    
<a name="210"></a>  210:    ?line {ok, Pid} = 
  211:	gen_fsm:start({global, my_fsm}, gen_fsm_SUITE, [], []),
  212:    ?line {error, {already_started, Pid}} =
  213:	gen_fsm:start({global, my_fsm}, gen_fsm_SUITE, [], []),
  214:<i>%%    ?line {error, {already_started, Pid}} =</i>
  215:<i>%%	gen_fsm:start({local, my_fsm}, gen_fsm_SUITE, [], []),</i>
  216:    ?line {error, {already_started, Pid}} =
  217:	gen_fsm:start_link({global, my_fsm}, gen_fsm_SUITE, [], []),
  218:<i>%%    ?line {error, {already_started, Pid}} =</i>
  219:<i>%%	gen_fsm:start_link({local, my_fsm}, gen_fsm_SUITE, [], []),</i>
<a name="220"></a>  220:    
  221:    ?line ok = do_func_test(Pid),
  222:    ?line ok = do_sync_func_test(Pid),
  223:    ?line ok = do_func_test({global, my_fsm}),
  224:    ?line ok = do_sync_func_test({global, my_fsm}),
  225:    ?line stop_it({global, my_fsm}),
  226:    
  227:    test_server:messages_get(),
  228:    %%process_flag(trap_exit, OldFl),
  229:    ok.
<a name="230"></a>  230:
  231:
  232:<i>%% Stop registered processes</i>
<a name=start11>  233:<b>start11</b></a>(suite) -&gt; {req,{time,15}};
<a name=start11>  234:<b>start11</b></a>(Config) when list(Config) -&gt;
  235:    ?line {ok, Pid} = 
  236:	gen_fsm:start_link({local, my_fsm}, gen_fsm_SUITE, [], []),
  237:    ?line stop_it(Pid),
  238:
  239:    ?line {ok, Pid1} = 
<a name="240"></a>  240:	gen_fsm:start_link({local, my_fsm}, gen_fsm_SUITE, [], []),
  241:    ?line stop_it(my_fsm),
  242:    
  243:    ?line {ok, Pid2} = 
  244:	gen_fsm:start({global, my_fsm}, gen_fsm_SUITE, [], []),
  245:    ?line stop_it(Pid2),
  246:    receive after 1 -&gt; true end,
  247:    ?line Result = 
  248:	gen_fsm:start({global, my_fsm}, gen_fsm_SUITE, [], []),
  249:    io:format("Result = ~p~n",[Result]),
<a name="250"></a>  250:    ?line {ok, Pid3} = Result, 
  251:    ?line stop_it({global, my_fsm}),
  252:
  253:    test_server:messages_get(),
  254:    ok.
  255:
<a name=abnormal>  256:<b>abnormal</b></a>(suite) -&gt; [abnormal1, abnormal2].
  257:
  258:<i>%% Check that time outs in calls work</i>
<a name=abnormal1>  259:<b>abnormal1</b></a>(suite) -&gt; [];
<a name=abnormal1><a name="260"></a>  260:<b>abnormal1</b></a>(Config) when list(Config) -&gt;
  261:    ?line {ok, Pid} = 
  262:	gen_fsm:start({local, my_fsm}, gen_fsm_SUITE, [], []),
  263:
  264:    %% timeout call.
  265:    case os:type() of
  266:	vxworks -&gt;
  267:	    %% timeout call for VxWorks must be in 16ms increments.
  268:	    ?line delayed = gen_fsm:sync_send_event(my_fsm, {delayed_answer,1}, 17),
  269:	    ?line {'EXIT',{timeout,_}} =
<a name="270"></a>  270:		(catch gen_fsm:sync_send_event(my_fsm, {delayed_answer,17}, 1));
  271:	_ -&gt;
  272:	    ?line delayed = gen_fsm:sync_send_event(my_fsm, {delayed_answer,1}, 100),
  273:	    ?line {'EXIT',{timeout,_}} =
  274:		(catch gen_fsm:sync_send_event(my_fsm, {delayed_answer,10}, 1))
  275:    end,
  276:    test_server:messages_get(),
  277:    ok.
  278:
  279:<i>%% Check that bad return values makes the fsm crash. Note that we must</i>
<a name="280"></a>  280:<i>%% trap exit since we must link to get the real bad_return_ error</i>
<a name=abnormal2>  281:<b>abnormal2</b></a>(suite) -&gt; [];
<a name=abnormal2>  282:<b>abnormal2</b></a>(Config) when list(Config) -&gt;
  283:    OldFl = process_flag(trap_exit, true),
  284:    ?line {ok, Pid} = 
  285:	gen_fsm:start_link(gen_fsm_SUITE, [], []),
  286:
  287:    %% bad return value in the gen_fsm loop
  288:    ?line {'EXIT',{{bad_return_value, badreturn},_}} =
  289:	(catch gen_fsm:sync_send_event(Pid, badreturn)),
<a name="290"></a>  290:    
  291:    test_server:messages_get(),
  292:    process_flag(trap_exit, OldFl),
  293:    ok.
  294:
<a name=sys>  295:<b>sys</b></a>(suite) -&gt; [sys1].
  296:
<a name=sys1>  297:<b>sys1</b></a>(suite) -&gt; {req,{time,10}};
<a name=sys1>  298:<b>sys1</b></a>(Config) when list(Config) -&gt;
  299:    ?line {ok, Pid} = 
<a name="300"></a>  300:	gen_fsm:start(gen_fsm_SUITE, [], []),
  301:    ?line {status, Pid, {module,gen_fsm}, _} = sys:get_status(Pid),
  302:    ?line sys:suspend(Pid),
  303:    ?line {'EXIT', {timeout,_}} = 
  304:	(catch gen_fsm:sync_send_event(Pid, hej)),
  305:    ?line sys:resume(Pid),
  306:    ?line stop_it(Pid).
  307:
  308:
  309:
<a name="310"></a>  310:
  311:<i>%%sys1(suite) -&gt; [];</i>
  312:<i>%%sys1(_) -&gt;</i>
  313:
  314:
  315:
  316:
  317:<i>%%</i>
  318:<i>%% Functionality check</i>
  319:<i>%%</i>
<a name="320"></a>  320:
<a name=wfor>  321:<b>wfor</b></a>(Msg) -&gt;
  322:    receive 
  323:	Msg -&gt; ok
  324:    after 5000 -&gt; 
  325:	    throw(timeout)
  326:    end.
  327:
  328:
<a name=stop_it>  329:<b>stop_it</b></a>(FSM) -&gt;
<a name="330"></a>  330:    ?line stopped = 
  331:	gen_fsm:sync_send_all_state_event(FSM, stop),
  332:    if  pid(FSM) -&gt;
  333:	    ?line {'EXIT', {noproc,_}} = 
  334:		(catch gen_fsm:sync_send_event(FSM, hej));
  335:	true -&gt;
  336:	    ?line {'EXIT', _} = 
  337:		(catch gen_fsm:sync_send_event(FSM, hej))
  338:    end,
  339:    ok.
<a name="340"></a>  340:
  341:
  342:
<a name=do_func_test>  343:<b>do_func_test</b></a>(FSM) -&gt;
  344:    ok = gen_fsm:send_all_state_event(FSM, {'alive?', self()}),
  345:    wfor(yes),
  346:    ok = do_connect(FSM),
  347:    ok = gen_fsm:send_all_state_event(FSM, {'alive?', self()}),
  348:    wfor(yes),
  349:    test_server:do_times(3, ?MODULE, do_msg, [FSM]),
<a name="350"></a>  350:    ok = gen_fsm:send_all_state_event(FSM, {'alive?', self()}),
  351:    wfor(yes),
  352:    ok = do_disconnect(FSM),
  353:    ok = gen_fsm:send_all_state_event(FSM, {'alive?', self()}),
  354:    wfor(yes),
  355:    ok.
  356:
  357:
<a name=do_connect>  358:<b>do_connect</b></a>(FSM) -&gt;
  359:    check_state(FSM, idle),
<a name="360"></a>  360:    gen_fsm:send_event(FSM, {connect, self()}),
  361:    wfor(accept),
  362:    check_state(FSM, wfor_conf),
  363:    gen_fsm:send_event(FSM, confirmation),
  364:    check_state(FSM, connected),
  365:    ok.
  366:
<a name=do_msg>  367:<b>do_msg</b></a>(FSM) -&gt;
  368:    check_state(FSM, connected),
  369:    R = make_ref(),
<a name="370"></a>  370:    ok = gen_fsm:send_event(FSM, {msg, R, self(), hej_pa_dig_quasimodo}),
  371:    wfor({ak, R}).
  372:
  373:
<a name=do_disconnect>  374:<b>do_disconnect</b></a>(FSM) -&gt;
  375:    ok = gen_fsm:send_event(FSM, disconnect),
  376:    check_state(FSM, idle).
  377:
<a name=check_state>  378:<b>check_state</b></a>(FSM, State) -&gt;
  379:    case gen_fsm:sync_send_all_state_event(FSM, {get, self()}) of
<a name="380"></a>  380:	{state, State, _} -&gt; ok
  381:    end.
  382:
<a name=do_sync_func_test>  383:<b>do_sync_func_test</b></a>(FSM) -&gt;
  384:    yes = gen_fsm:sync_send_all_state_event(FSM, 'alive?'),
  385:    ok = do_sync_connect(FSM),
  386:    yes = gen_fsm:sync_send_all_state_event(FSM, 'alive?'),
  387:    test_server:do_times(3, ?MODULE, do_sync_msg, [FSM]),
  388:    yes = gen_fsm:sync_send_all_state_event(FSM, 'alive?'),
  389:    ok = do_sync_disconnect(FSM),
<a name="390"></a>  390:    yes = gen_fsm:sync_send_all_state_event(FSM, 'alive?'),
  391:    check_state(FSM, idle),
  392:    ok = gen_fsm:sync_send_event(FSM, {timeout,200}),
  393:    yes = gen_fsm:sync_send_all_state_event(FSM, 'alive?'),
  394:    check_state(FSM, idle),
  395:    ok.
  396:
  397:
<a name=do_sync_connect>  398:<b>do_sync_connect</b></a>(FSM) -&gt;
  399:    check_state(FSM, idle),
<a name="400"></a>  400:    accept = gen_fsm:sync_send_event(FSM, {connect, self()}),
  401:    check_state(FSM, wfor_conf),
  402:    yes = gen_fsm:sync_send_event(FSM, confirmation),
  403:    check_state(FSM, connected),
  404:    ok.
  405:
<a name=do_sync_msg>  406:<b>do_sync_msg</b></a>(FSM) -&gt;
  407:    check_state(FSM, connected),
  408:    R = make_ref(),
  409:    Res = gen_fsm:sync_send_event(FSM, {msg, R, self(), hej_pa_dig_quasimodo}),
<a name="410"></a>  410:    if  Res == {ak, R} -&gt;
  411:	    ok
  412:    end.
  413:
<a name=do_sync_disconnect>  414:<b>do_sync_disconnect</b></a>(FSM) -&gt;
  415:    yes = gen_fsm:sync_send_event(FSM, disconnect),
  416:    check_state(FSM, idle).
  417:
  418:    
  419:
<a name="420"></a>  420:<i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
  421:<i>%%</i>
  422:<i>%% The Finite State Machine</i>
  423:<i>%%</i>
  424:<i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
  425:
<a name=init>  426:<b>init</b></a>(ignore) -&gt;
  427:    ignore;
<a name=init>  428:<b>init</b></a>(stop) -&gt;
  429:    {stop, stopped};
<a name=init><a name="430"></a>  430:<b>init</b></a>(stop_shutdown) -&gt;
  431:    {stop, shutdown};
<a name=init>  432:<b>init</b></a>(sleep) -&gt;
  433:    test_server:sleep(1000),
  434:    {ok, idle, data};
<a name=init>  435:<b>init</b></a>({timeout, T}) -&gt;
  436:    {ok, idle, state, T};
<a name=init>  437:<b>init</b></a>(_) -&gt;
  438:    {ok, idle, state_data}.
  439:
<a name="440"></a>  440:
<a name=terminate>  441:<b>terminate</b></a>({From, stopped}, State, Data) -&gt;
  442:    From ! {self(), {stopped, State}},
  443:    ok;
<a name=terminate>  444:<b>terminate</b></a>(Reason, State, Data) -&gt;
  445:    ok.
  446:
  447:
<a name=idle>  448:<b>idle</b></a>({connect, Pid}, Data) -&gt;
  449:    Pid ! accept,
<a name="450"></a>  450:    {next_state, wfor_conf, Data};
<a name=idle>  451:<b>idle</b></a>(badreturn, Data) -&gt;
  452:    badreturn;
<a name=idle>  453:<b>idle</b></a>(_, Data) -&gt;
  454:    {next_state, idle, Data}.
  455:
<a name=idle>  456:<b>idle</b></a>({connect, Pid}, From, Data) -&gt;
  457:    {reply, accept, wfor_conf, Data};
<a name=idle>  458:<b>idle</b></a>({delayed_answer, T}, From, Data) -&gt;
  459:    test_server:sleep(T),
<a name="460"></a>  460:    {reply, delayed, idle, Data};
<a name=idle>  461:<b>idle</b></a>(badreturn, From, Data) -&gt;
  462:    badreturn;
<a name=idle>  463:<b>idle</b></a>({timeout,Time}, From, _Data) -&gt;
  464:    gen_fsm:send_event_after(Time, {timeout,Time}),
  465:    {next_state, timeout, From};
<a name=idle>  466:<b>idle</b></a>(_, From, Data) -&gt;
  467:    {reply, 'eh?', idle, Data}.
  468:
<a name=timeout>  469:<b>timeout</b></a>({timeout,Time}, From) -&gt;
<a name="470"></a>  470:    Ref = gen_fsm:start_timer(Time, {timeout,Time}),
  471:    {next_state, timeout, {From,Ref}};
<a name=timeout>  472:<b>timeout</b></a>({timeout,Ref,{timeout,Time}}, {From,Ref}) -&gt;
  473:    Ref2 = gen_fsm:start_timer(Time, ok),
  474:    Cref = gen_fsm:start_timer(Time, cancel),
  475:    Time4 = Time*4,
  476:    receive after Time4 -&gt; ok end,
  477:    gen_fsm:cancel_timer(Cref),
  478:    {next_state, timeout, {From,Ref2}};
<a name=timeout>  479:<b>timeout</b></a>({timeout,Ref2,ok},{From,Ref2}) -&gt;
<a name="480"></a>  480:    gen_fsm:reply(From, ok),
  481:    {next_state, idle, state}.
  482:
<a name=wfor_conf>  483:<b>wfor_conf</b></a>(confirmation, Data) -&gt;
  484:    {next_state, connected, Data};
<a name=wfor_conf>  485:<b>wfor_conf</b></a>(_, Data) -&gt;
  486:    {next_state, idle, Data}.
  487:
<a name=wfor_conf>  488:<b>wfor_conf</b></a>(confirmation, From, Data) -&gt;
  489:    {reply, yes, connected, Data};
<a name=wfor_conf><a name="490"></a>  490:<b>wfor_conf</b></a>(_, From, Data) -&gt;
  491:    {reply, 'eh?', idle, Data}.
  492:
<a name=connected>  493:<b>connected</b></a>({msg, Ref, From, Msg}, Data) -&gt;
  494:    From ! {ak, Ref},
  495:    {next_state, connected, Data};
<a name=connected>  496:<b>connected</b></a>(disconnect, Data) -&gt;
  497:    {next_state, idle, Data};
<a name=connected>  498:<b>connected</b></a>(_, Data) -&gt;
  499:    {next_state, connected, Data}.
<a name="500"></a>  500:
<a name=connected>  501:<b>connected</b></a>({msg, Ref, From, Msg}, _, Data) -&gt;
  502:    {reply, {ak, Ref}, connected, Data};
<a name=connected>  503:<b>connected</b></a>(disconnect, From, Data) -&gt;
  504:    {reply, yes, idle, Data};
<a name=connected>  505:<b>connected</b></a>(_, _, Data) -&gt;
  506:    {reply, 'eh?', connected, Data}.
  507:
<a name=handle_info>  508:<b>handle_info</b></a>(Info, State, Data) -&gt;
  509:    {stop, {unexpected,Info}, Data}.
<a name="510"></a>  510:
<a name=handle_event>  511:<b>handle_event</b></a>({get, Pid}, State, Data) -&gt;
  512:    Pid ! {state, State, Data},
  513:    {next_state, State, Data};
<a name=handle_event>  514:<b>handle_event</b></a>(stop, State, Data) -&gt;
  515:    {stop, normal, Data};
<a name=handle_event>  516:<b>handle_event</b></a>(stop_shutdown, State, Data) -&gt;
  517:    {stop, shutdown, Data};
<a name=handle_event>  518:<b>handle_event</b></a>({'alive?', Pid}, State, Data) -&gt;
  519:    Pid ! yes,
<a name="520"></a>  520:    {next_state, State, Data}.
  521:
<a name=handle_sync_event>  522:<b>handle_sync_event</b></a>('alive?', From, State, Data) -&gt;
  523:    {reply, yes, State, Data};
<a name=handle_sync_event>  524:<b>handle_sync_event</b></a>(stop, From, State, Data) -&gt;
  525:    {stop, normal, stopped, Data};
<a name=handle_sync_event>  526:<b>handle_sync_event</b></a>(stop_shutdown, From, State, Data) -&gt;
  527:    {stop, shutdown, shutdown_stopped, Data};
<a name=handle_sync_event>  528:<b>handle_sync_event</b></a>({get, Pid}, From, State, Data) -&gt;
  529:    {reply, {state, State, Data}, State, Data}.
<a name="530"></a>  530:    
  531:    
  532:
  533:
  534:
  535:
  536:
  537:
  538:
  539:
<a name="540"></a>  540:
  541:
</pre>
<hr size=1><i>The transformation of this file (542 lines) took 0.02 seconds</i><br>
</body>
</html>
