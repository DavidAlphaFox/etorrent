<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head><title>/usr/home/jlouis/hacking/test_server/stdlib_test/epp_SUITE.erl</title></head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
    1:<i>%% ``The contents of this file are subject to the Erlang Public License,</i>
    2:<i>%% Version 1.1, (the "License"); you may not use this file except in</i>
    3:<i>%% compliance with the License. You should have received a copy of the</i>
    4:<i>%% Erlang Public License along with this software. If not, it can be</i>
    5:<i>%% retrieved via the world wide web at http://www.erlang.org/.</i>
    6:<i>%% </i>
    7:<i>%% Software distributed under the License is distributed on an "AS IS"</i>
    8:<i>%% basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See</i>
    9:<i>%% the License for the specific language governing rights and limitations</i>
<a name="10"></a>   10:<i>%% under the License.</i>
   11:<i>%% </i>
   12:<i>%% The Initial Developer of the Original Code is Ericsson Utvecklings AB.</i>
   13:<i>%% Portions created by Ericsson are Copyright 1999, Ericsson Utvecklings</i>
   14:<i>%% AB. All Rights Reserved.''</i>
   15:<i>%% </i>
   16:<i>%%     $Id$</i>
   17:<i>%%</i>
   18:-<b>module</b>(epp_SUITE).
   19:-<b>export</b>([all/1]).
<a name="20"></a>   20:
   21:-<b>export</b>([rec_1/1, predef_mac/1, 
   22:	 upcase_mac/1, upcase_mac_1/1, upcase_mac_2/1,
   23:	 variable/1, variable_1/1]).
   24:
   25:-<b>export</b>([init_per_testcase/2, fin_per_testcase/2]).
   26:
   27:-<b>export</b>([epp_parse_erl_form/2]).
   28:
   29:-<b>include</b>("test_server.hrl").
<a name="30"></a>   30:
   31:<i>% Default timetrap timeout (set in init_per_testcase).</i>
   32:-<b>define</b>(default_timeout, ?t:minutes(1)).
   33:
<a name=init_per_testcase>   34:<b>init_per_testcase</b></a>(Case, Config) -&gt;
   35:    ?line Dog = ?t:timetrap(?default_timeout),
   36:    [{watchdog, Dog} | Config].
<a name=fin_per_testcase>   37:<b>fin_per_testcase</b></a>(Case, Config) -&gt;
   38:    Dog = ?config(watchdog, Config),
   39:    test_server:timetrap_cancel(Dog),
<a name="40"></a>   40:    ok.
   41:
<a name=all>   42:<b>all</b></a>(doc) -&gt;
   43:    ["Test cases for epp."];
<a name=all>   44:<b>all</b></a>(suite) -&gt;
   45:    [rec_1, upcase_mac, predef_mac, variable].
   46:
<a name=rec_1>   47:<b>rec_1</b></a>(doc) -&gt;
   48:    ["Recursive macros hang or crash epp (OTP-1398)."];
<a name=rec_1>   49:<b>rec_1</b></a>(suite) -&gt;
<a name="50"></a>   50:    [];
<a name=rec_1>   51:<b>rec_1</b></a>(Config) when list(Config) -&gt;
   52:    ?line File = filename:join(?config(data_dir, Config), "mac.erl"),
   53:    ?line {ok, List} = epp_parse_file(File, [], []),
   54:    %% we should encounter errors
   55:    ?line {value, _} = lists:keysearch(error, 1, List),
   56:    ?line check_errors(List),
   57:    ok.
   58:
   59:<i>%%% Here is a little reimplementation of epp:parse_file, which times out</i>
<a name="60"></a>   60:<i>%%% after 4 seconds if the epp server doesn't respond. If we use the</i>
   61:<i>%%% regular epp:parse_file, the test case will time out, and then epp</i>
   62:<i>%%% server will go on growing until we dump core.</i>
<a name=epp_parse_file>   63:<b>epp_parse_file</b></a>(File, Inc, Predef) -&gt;
   64:    {ok, Epp} = epp:open(File, Inc, Predef),
   65:    List = collect_epp_forms(Epp),
   66:    epp:close(Epp),
   67:    {ok, List}.
   68:
<a name=collect_epp_forms>   69:<b>collect_epp_forms</b></a>(Epp) -&gt;
<a name="70"></a>   70:    Result = epp_parse_erl_form(Epp),
   71:    case Result of
   72:	{error, _Error} -&gt;
   73:	    [Result | collect_epp_forms(Epp)];
   74:	{ok, Form} -&gt;
   75:	    [Form | collect_epp_forms(Epp)];
   76:	{eof, _} -&gt;
   77:	    [Result]
   78:    end.
   79:
<a name=epp_parse_erl_form><a name="80"></a>   80:<b>epp_parse_erl_form</b></a>(Epp) -&gt;
   81:    P = spawn(?MODULE, epp_parse_erl_form, [Epp, self()]),
   82:    receive
   83:	{P, Result} -&gt;
   84:	    Result
   85:    after 4000 -&gt;
   86:	    exit(Epp, kill),
   87:	    exit(P, kill),
   88:	    timeout
   89:    end.
<a name="90"></a>   90:
<a name=epp_parse_erl_form>   91:<b>epp_parse_erl_form</b></a>(Epp, Parent) -&gt;
   92:    Parent ! {self(), epp:parse_erl_form(Epp)}.
   93:
<a name=check_errors>   94:<b>check_errors</b></a>([]) -&gt;
   95:    ok;
<a name=check_errors>   96:<b>check_errors</b></a>([{error, Info} | Rest]) -&gt;
   97:    ?line {Line, Mod, Desc} = Info,
   98:    ?line if integer(Line) -&gt; ok end,
   99:    ?line Str = lists:flatten(Mod:format_error(Desc)),
<a name="100"></a>  100:    ?line [Str] = io_lib:format("~s", [Str]),
  101:    check_errors(Rest);
<a name=check_errors>  102:<b>check_errors</b></a>([_ | Rest]) -&gt;
  103:    check_errors(Rest).
  104:
<a name=upcase_mac>  105:<b>upcase_mac</b></a>(doc) -&gt;
  106:    ["Check that uppercase macro names are implicitly quoted (OTP-2608)"];
<a name=upcase_mac>  107:<b>upcase_mac</b></a>(suite) -&gt;
  108:    [upcase_mac_1, upcase_mac_2].
  109:
<a name=upcase_mac_1><a name="110"></a>  110:<b>upcase_mac_1</b></a>(doc) -&gt;
  111:    [];
<a name=upcase_mac_1>  112:<b>upcase_mac_1</b></a>(suite) -&gt;
  113:    [];
<a name=upcase_mac_1>  114:<b>upcase_mac_1</b></a>(Config) when list(Config) -&gt;
  115:    ?line File = filename:join(?config(data_dir, Config), "mac2.erl"),
  116:    ?line {ok, List} = epp:parse_file(File, [], []),
  117:    ?line [_, {attribute, _, plupp, Tuple} | _] = List,
  118:    ?line Tuple = {1, 1, 3, 3},
  119:    ok.
<a name="120"></a>  120:
<a name=upcase_mac_2>  121:<b>upcase_mac_2</b></a>(doc) -&gt;
  122:    [];
<a name=upcase_mac_2>  123:<b>upcase_mac_2</b></a>(suite) -&gt;
  124:    [];
<a name=upcase_mac_2>  125:<b>upcase_mac_2</b></a>(Config) when list(Config) -&gt;
  126:    ?line File = filename:join(?config(data_dir, Config), "mac2.erl"),
  127:    ?line {ok, List} = epp:parse_file(File, [], [{p, 5}, {'P', 6}]),
  128:    ?line [_, {attribute, _, plupp, Tuple} | _] = List,
  129:    ?line Tuple = {5, 5, 6, 6},
<a name="130"></a>  130:    ok.
  131:
<a name=predef_mac>  132:<b>predef_mac</b></a>(doc) -&gt;
  133:    [];
<a name=predef_mac>  134:<b>predef_mac</b></a>(suite) -&gt;
  135:    [];
<a name=predef_mac>  136:<b>predef_mac</b></a>(Config) when list(Config) -&gt;
  137:    ?line File = filename:join(?config(data_dir, Config), "mac3.erl"),
  138:    ?line {ok, List} = epp:parse_file(File, [], []),
  139:    ?line [_,
<a name="140"></a>  140:	   {attribute, Line1, l, Line1},
  141:	   {attribute, _, f, File},
  142:	   {attribute, _, machine1, _},
  143:	   {attribute, _, module, mac3},
  144:	   {attribute, _, m, mac3},
  145:	   {attribute, _, ms, "mac3"},
  146:	   {attribute, _, machine2, _}
  147:	   | _] = List,
  148:    ok.
  149:
<a name=variable><a name="150"></a>  150:<b>variable</b></a>(doc) -&gt;
  151:    ["Check variable as first file component of the include directives."];
<a name=variable>  152:<b>variable</b></a>(suite) -&gt;
  153:    [variable_1].
  154:
<a name=variable_1>  155:<b>variable_1</b></a>(doc) -&gt;
  156:    [];
<a name=variable_1>  157:<b>variable_1</b></a>(suite) -&gt;
  158:    [];
<a name=variable_1>  159:<b>variable_1</b></a>(Config) when list(Config) -&gt;
<a name="160"></a>  160:    ?line DataDir = ?config(data_dir, Config),
  161:    ?line File = filename:join(DataDir, "variable_1.erl"),
  162:    ?line true = os:putenv("VAR", DataDir),
  163:    %% variable_1.erl includes variable_1_include.hrl and
  164:    %% variable_1_include_dir.hrl.
  165:    ?line {ok, List} = epp:parse_file(File, [], []),
  166:    ?line {value, {attribute,_,a,{value1,value2}}} = 
  167:	lists:keysearch(a,3,List),
  168:    ok.
</pre>
<hr size=1><i>The transformation of this file (169 lines) took 0.00 seconds</i><br>
</body>
</html>
