<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head><title>/usr/home/jlouis/hacking/test_server/stdlib_test/select_SUITE.erl</title></head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
    1:-<b>module</b>(select_SUITE).
    2:-<b>author</b>('pan@erix.ericsson.se').
    3:
    4:-<b>export</b>([test/0]).
    5:
    6:<i>%%</i>
    7:<i>%% Define to run outside of test server</i>
    8:<i>%%</i>
    9:<i>%%-define(STANDALONE,1).</i>
<a name="10"></a>   10: 
   11:<i>%%</i>
   12:<i>%% Define for debug output</i>
   13:<i>%%</i>
   14:<i>%%-define(debug,1).</i>
   15: 
   16:-<b>ifdef</b>(STANDALONE).
   17:-<b>define</b>(config(A,B),config(A,B)).
   18:-<b>export</b>([config/2]).
   19:-<b>define</b>(fmt(A,B),io:format(A,B)).
<a name="20"></a>   20:-<b>else</b>.
   21:-<b>include</b>("test_server.hrl").
   22:-<b>define</b>(fmt(A,B),test_server:format(A,B)).
   23:-<b>endif</b>.
   24: 
   25:-<b>ifdef</b>(debug).
   26:-<b>ifdef</b>(STANDALONE).
   27:-<b>define</b>(line, erlang:display({?MODULE,?LINE}), ).
   28:-<b>endif</b>.
   29:-<b>define</b>(dbgformat(A,B),io:format(A,B)).
<a name="30"></a>   30:-<b>else</b>.
   31:-<b>ifdef</b>(STANDALONE).
   32:-<b>define</b>(line, noop, ).
   33:-<b>endif</b>.
   34:-<b>define</b>(dbgformat(A,B),noop).
   35:-<b>endif</b>.
   36: 
   37:-<b>ifdef</b>(STANDALONE).
<a name=config>   38:<b>config</b></a>(priv_dir,_) -&gt;
   39:    ".".
<a name="40"></a>   40:-<b>else</b>.
   41:<i>%% When run in test server.</i>
   42:-<b>export</b>([all/1,select_test/1,init_per_testcase/2, fin_per_testcase/2, 
   43:	 return_values/1]).
<a name=init_per_testcase>   44:<b>init_per_testcase</b></a>(Case, Config) -&gt;
   45:    ?line Dog=test_server:timetrap(test_server:seconds(1200)),
   46:    [{watchdog, Dog}|Config].
   47: 
<a name=fin_per_testcase>   48:<b>fin_per_testcase</b></a>(Case, Config) -&gt;
   49:    Dog=?config(watchdog, Config),
<a name="50"></a>   50:    test_server:timetrap_cancel(Dog),
   51:    ok.
   52:
<a name=all>   53:<b>all</b></a>(doc) -&gt;
   54:    ["Test ets:select"];
<a name=all>   55:<b>all</b></a>(suite) -&gt;
   56:    [return_values, select_test].
   57: 
<a name=select_test>   58:<b>select_test</b></a>(suite) -&gt;
   59:    [];
<a name=select_test><a name="60"></a>   60:<b>select_test</b></a>(doc) -&gt;
   61:    ["Tests select in numerous ways"];
<a name=select_test>   62:<b>select_test</b></a>(Config) when list(Config) -&gt;
   63:    do_test(Config).
   64:
<a name=return_values>   65:<b>return_values</b></a>(suite) -&gt;
   66:    [];
<a name=return_values>   67:<b>return_values</b></a>(doc) -&gt;
   68:    ["Tests return values in specific situations for select/3 and select/1"];
<a name=return_values>   69:<b>return_values</b></a>(Config) when list(Config) -&gt;
<a name="70"></a>   70:    do_return_values().
   71:
   72:-<b>endif</b>.
   73:
   74:
<a name=table_factor>   75:<b>table_factor</b></a>({dets,_}) -&gt;
   76:    1;
<a name=table_factor>   77:<b>table_factor</b></a>({ets,_}) -&gt;
   78:    100.
   79:
<a name=gen_dets_filename><a name="80"></a>   80:<b>gen_dets_filename</b></a>(Config,N) -&gt;
   81:    filename:join(?config(priv_dir,Config),
   82:		  "testdets_" ++ integer_to_list(N) ++ ".dets").
   83:
<a name=create_tables>   84:<b>create_tables</b></a>(Config) -&gt;
   85:    Hash = ets:new(xxx, []), 
   86:    Tree = ets:new(yyy, [ordered_set]),
   87:    Bag = ets:new(yyy, [bag]),
   88:    DBag = ets:new(yyy, [duplicate_bag]),
   89:    F1 = gen_dets_filename(Config,1),
<a name="90"></a>   90:    (catch file:delete(F1)),
   91:    {ok,DetsPlain} = dets:open_file(testdets_1,
   92:			       [{file, F1}]),
   93:    F3 = gen_dets_filename(Config,3),
   94:    (catch file:delete(F3)),
   95:    {ok,DetsBag} = dets:open_file(testdets_3,
   96:				     [{file, F3},{type, bag}]),
   97:    F4 = gen_dets_filename(Config,4),
   98:    (catch file:delete(F4)),
   99:    {ok,DetsDBag} = dets:open_file(testdets_4,
<a name="100"></a>  100:				     [{file, F4},{type, duplicate_bag}]),
  101:    [{ets,Hash}, {ets,Tree}, {ets,Bag}, {ets,DBag}, 
  102:     {dets, DetsPlain}, {dets, DetsBag}, {dets, DetsDBag}].
  103:
  104:
<a name=gen_key>  105:<b>gen_key</b></a>(N,list) -&gt;
  106:    [N,N+1,N+2];
<a name=gen_key>  107:<b>gen_key</b></a>(N,tuple) -&gt;
  108:    {N,N+1,N+2};
<a name=gen_key>  109:<b>gen_key</b></a>(N,complex) -&gt;
<a name="110"></a>  110:    {[N,N+1],N+2}.
  111:
<a name=gen_fun>  112:<b>gen_fun</b></a>(N) -&gt;
  113:    fun() -&gt;
  114:	    N
  115:    end.
  116:
<a name=gen_bin>  117:<b>gen_bin</b></a>(N) -&gt;
  118:    list_to_binary(integer_to_list(N)).
  119:
<a name=gen_object><a name="120"></a>  120:<b>gen_object</b></a>(N,Type) -&gt;
  121:    L = integer_to_list(N),
  122:    A = list_to_atom("a" ++ L),
  123:    {gen_key(N,Type), L, A, gen_fun(N), gen_bin(N)}.
<a name=gen_object1>  124:<b>gen_object1</b></a>(N,Type) -&gt;
  125:    L = integer_to_list(N),
  126:    A = list_to_atom("a" ++ L),
  127:    {gen_key(N,Type), A, L, gen_fun(N), gen_bin(N)}.
  128:
<a name=fill_table>  129:<b>fill_table</b></a>(_,0,_) -&gt;
<a name="130"></a>  130:    ok;
<a name=fill_table>  131:<b>fill_table</b></a>({Mod,Tab},N,Type) -&gt;
  132:    Obj1 = gen_object1(N,Type),
  133:    Obj = gen_object(N,Type),
  134:    Mod:insert(Tab, Obj1),
  135:    case Mod:info(Tab,type) of
  136:	bag -&gt;
  137:	    Mod:insert(Tab, Obj);
  138:	duplicate_bag -&gt;
  139:	    Mod:insert(Tab, Obj),
<a name="140"></a>  140:	    Mod:insert(Tab, Obj1);
  141:	_ -&gt;
  142:	    ok
  143:    end,
  144:    fill_table({Mod,Tab},N-1,Type).
  145:
<a name=table_size>  146:<b>table_size</b></a>(Tab) -&gt;
  147:    15 *table_factor(Tab).
  148:
<a name=build_tables>  149:<b>build_tables</b></a>(Config,Type) -&gt;
<a name="150"></a>  150:    L = create_tables(Config),
  151:    ?dbgformat("Tables: ~p~n",[L]),
  152:    lists:foreach(fun(TD) -&gt;
  153:		      fill_table(TD,table_size(TD),Type)
  154:		  end,
  155:		  L),
  156:    L.
  157:
<a name=destroy_tables>  158:<b>destroy_tables</b></a>([]) -&gt;
  159:    ok;
<a name=destroy_tables><a name="160"></a>  160:<b>destroy_tables</b></a>([{ets,Tab}|T]) -&gt;
  161:    ets:delete(Tab),
  162:    destroy_tables(T);
<a name=destroy_tables>  163:<b>destroy_tables</b></a>([{dets,Tab}|T]) -&gt;
  164:    dets:close(Tab),
  165:    destroy_tables(T).
  166:    
  167:
<a name=init_random>  168:<b>init_random</b></a>(Config) -&gt;
  169:    WriteDir = ReadDir = ?config(priv_dir,Config),
<a name="170"></a>  170:    (catch file:make_dir(WriteDir)),
  171:    Seed = case file:consult(filename:join([ReadDir, 
  172:					    "preset_random_seed2.txt"])) of
  173:	       {ok,[X]} -&gt;
  174:		   X;
  175:	       _ -&gt;
  176:		   {A,B,C} = erlang:now(),
  177:		   random:seed(A,B,C),
  178:		   get(random_seed)
  179:	   end,
<a name="180"></a>  180:    put(random_seed,Seed),
  181:    {ok, F} = file:open(filename:join([WriteDir, "last_random_seed2.txt"]), 
  182:			[write]),
  183:    io:format(F,"~p. ~n",[Seed]),
  184:    file:close(F),
  185:    ok.
  186:
<a name=create_random_key>  187:<b>create_random_key</b></a>(N,Type) -&gt;
  188:    gen_key(random:uniform(N),Type).
  189:
<a name=create_pb_key><a name="190"></a>  190:<b>create_pb_key</b></a>(N,list) -&gt;
  191:    X = random:uniform(N),
  192:    case random:uniform(4) of
  193:	3 -&gt; {[X, X+1, '_'], fun([Z,Z1,P1]) -&gt;  
  194:				      [Z,Z1,P1] =:= [X,X+1,P1] end};
  195:	2 -&gt; {[X, '_', '_'], fun([Z,P1,P2]) -&gt;  [Z,P1,P2] =:= [X,P1,P2] end};
  196:	1 -&gt; {[X, X+1, '$1'], fun([Z,Z1,P1]) -&gt;  
  197:				      [Z,Z1,P1] =:= [X,X+1,P1] end};
  198:	_ -&gt; {[X, '$1', '$2'], fun([Z,P1,P2]) -&gt;  [Z,P1,P2] =:= [X,P1,P2] end}
  199:    end;
<a name=create_pb_key><a name="200"></a>  200:<b>create_pb_key</b></a>(N, tuple) -&gt;
  201:    X = random:uniform(N),
  202:    case random:uniform(2) of
  203:	1 -&gt; {{X, X+1, '$1'},fun({Z,Z1,P1}) -&gt;  {Z,Z1,P1} =:= {X,X+1,P1} end};
  204:	_ -&gt; {{X, '$1', '$2'},fun({Z,P1,P2}) -&gt;  {Z,P1,P2} =:= {X,P1,P2} end}
  205:    end;
<a name=create_pb_key>  206:<b>create_pb_key</b></a>(N, complex) -&gt;
  207:    X = random:uniform(N),
  208:    case random:uniform(2) of
  209:	1 -&gt; {{[X, X+1], '$1'}, fun({[Z,Z1],P1}) -&gt;  
<a name="210"></a>  210:					{[Z,Z1],P1} =:= {[X,X+1],P1} end};
  211:	_ -&gt; {{[X, '$1'], '$2'},fun({[Z,P1],P2}) -&gt; 
  212:					{[Z,P1],P2} =:= {[X,P1],P2} end}
  213:    end.
<a name=table_foldl>  214:<b>table_foldl</b></a>(Fun, Acc,{Mod,Tab},'$end_of_table') -&gt;
  215:    Acc;
<a name=table_foldl>  216:<b>table_foldl</b></a>(Fun, Acc,{Mod,Tab},Key) -&gt;
  217:    Objs = Mod:lookup(Tab,Key),
  218:    Acc2 = lists:foldl(Fun,Acc,Objs),
  219:    ?dbgformat("Objs: ~p, Acc2: ~p~n",[Objs,Acc2]),
<a name="220"></a>  220:    table_foldl(Fun, Acc2, {Mod,Tab}, Mod:next(Tab,Key)).
<a name=table_foldl>  221:<b>table_foldl</b></a>(Fun, Acc,{Mod,Tab}) -&gt;
  222:    table_foldl(Fun, Acc,{Mod,Tab},Mod:first(Tab)).
  223:
<a name=chunked_select>  224:<b>chunked_select</b></a>(Mod,Tab,MS,0) -&gt;
  225:    Mod:select(Tab,MS);
<a name=chunked_select>  226:<b>chunked_select</b></a>(Mod,Tab,MS,Chunk) when Chunk &gt; 0-&gt;
  227:    do_chunk_select(Mod, Mod:select(Tab,MS,Chunk),[]);
<a name=chunked_select>  228:<b>chunked_select</b></a>(Mod,Tab,MS,Chunk) when Chunk &lt; 0-&gt;
  229:    case Mod of
<a name="230"></a>  230:	ets -&gt;
  231:	    do_chunk_select_reverse(Mod, 
  232:				    Mod:select_reverse(Tab,MS,-Chunk),[]);
  233:	_ -&gt;
  234:	    chunked_select(Mod,Tab,MS,-Chunk)
  235:    end.
  236:
  237:
<a name=do_chunk_select_reverse>  238:<b>do_chunk_select_reverse</b></a>(Mod, '$end_of_table',Acc) -&gt;
  239:    %% OK, all this reversing is only needed for ordered_set, but
<a name="240"></a>  240:    %% this is only testcases, right?
  241:    erlang:display(did_chunked_select_reverse),
  242:    Acc; 
<a name=do_chunk_select_reverse>  243:<b>do_chunk_select_reverse</b></a>(Mod, {L,C},Acc) -&gt;
  244:    NewAcc = lists:reverse(L)++Acc,
  245:    do_chunk_select(Mod, Mod:select(C), NewAcc).
  246:
<a name=do_chunk_select>  247:<b>do_chunk_select</b></a>(Mod, '$end_of_table',Acc) -&gt;
  248:    %% OK, all this reversing is only needed for ordered_set, but
  249:    %% this is only testcases, right?
<a name="250"></a>  250:    lists:reverse(Acc); 
<a name=do_chunk_select>  251:<b>do_chunk_select</b></a>(Mod, {L,C},Acc) -&gt;
  252:    NewAcc = lists:reverse(L)++Acc,
  253:    do_chunk_select(Mod, Mod:select(C), NewAcc).
  254:
<a name=cmp_ms_to_fun>  255:<b>cmp_ms_to_fun</b></a>({Mod,Tab}, MS, Fun1, Fun2) -&gt;
  256:    cmp_ms_to_fun({Mod,Tab}, MS, Fun1, Fun2, 0).
  257:
<a name=cmp_ms_to_fun>  258:<b>cmp_ms_to_fun</b></a>({Mod,Tab}, MS, Fun1, Fun2, ChunkSize) -&gt;
  259:    MSRes = lists:sort(chunked_select(Mod,Tab,MS,ChunkSize)),
<a name="260"></a>  260:    FunRes0 = table_foldl(Fun1,[],{Mod,Tab}),
  261:    FunRes = case Fun2 of
  262:		 F when function(F) -&gt;
  263:		     FunRes1 = table_foldl(F,[],{Mod,Tab}),
  264:		     lists:merge(FunRes0,FunRes1);
  265:		 [] -&gt;
  266:		     lists:sort(FunRes0)
  267:	     end,
  268:    case MSRes =:= FunRes of
  269:	true -&gt;
<a name="270"></a>  270:	    true;
  271:	false -&gt;
  272:	    ?fmt("Match_spec result differs from fun result:~n",[]),
  273:	    ?fmt("Parameters: ~p,~p,~p,~p~n", 
  274:		      [{Mod,Tab}, MS, Fun1, Fun2]),
  275:	    ?fmt("Match_spec Result: ~p~n", [MSRes]),
  276:	    ?fmt("Fun Result: ~p~n", [FunRes]),
  277:	    Info = (catch Mod:info(Tab)),
  278:	    ?fmt("Table info:~p~n", [Info]),
  279:	    {'EXIT', {hej, ST}} = (catch erlang:fault(hej)),
<a name="280"></a>  280:	    ?fmt("Stack backtrace: ~p~n", [ST]),
  281:	    erlang:fault(badmatch)
  282:    end.
  283:
<a name=do_n>  284:<b>do_n</b></a>(0,Fun) -&gt;
  285:    ok;
<a name=do_n>  286:<b>do_n</b></a>(N,Fun) -&gt;
  287:    Fun(),
  288:    do_n(N-1,Fun).
  289:
<a name="290"></a>  290:<i>%%</i>
  291:<i>%% We want some misses to, so pretend the tables are slightly</i>
  292:<i>%% larger than they really are.</i>
  293:<i>%%</i>
<a name=num_els>  294:<b>num_els</b></a>(Tab) -&gt;
  295:    16 * table_factor(Tab).
  296:
  297:
<a name=test>  298:<b>test</b></a>() -&gt;
  299:    do_return_values(),
<a name="300"></a>  300:    do_test([]).
  301:
<a name=do_test>  302:<b>do_test</b></a>(Config) -&gt;
  303:    init_random(Config),
  304:    whitebox(),
  305:    lists:foreach(fun(Type) -&gt;
  306:			  Tabs = build_tables(Config,Type),
  307:			  basic_key(Config,Tabs,Type),
  308:			  ?fmt("basic_key done for type ~w~n",[Type]),
  309:			  basic_pb_key(Config,Tabs,Type),
<a name="310"></a>  310:			  ?fmt("basic_pb_key done for type ~w~n",[Type]),
  311:			  double_pb_key(Config,Tabs,Type),
  312:			  ?fmt("double_pb_key done for type ~w~n",[Type]),
  313:			  multi_key(Config,Tabs,Type),
  314:			  ?fmt("multi_key done for type ~w~n",[Type]),
  315:			  multi_mixed_key(Config,Tabs,Type),
  316:			  ?fmt("multi_mixed_key done for type ~w~n",
  317:				    [Type]),
  318:			  destroy_tables(Tabs)
  319:		  end,
<a name="320"></a>  320:		  [tuple, list, complex]),
  321:    ok.
  322:    
<a name=basic_key>  323:<b>basic_key</b></a>(Config,Tabs,Type) -&gt;
  324:    Fun = fun() -&gt;
  325:		  lists:map(fun(Tab) -&gt;
  326:				    ?line Key = 
  327:					create_random_key(num_els(Tab),Type),
  328:				    ?line  MS = 
  329:					[{{Key,'_','_','_','_'},[],['$_']}],
<a name="330"></a>  330:				    MF = fun({Key0,A,B,F,Bi},Acc) -&gt;
  331:						 case Key =:= Key0 of
  332:						     true -&gt;
  333:							 [{Key0,A,B,F,Bi} | 
  334:							  Acc];
  335:						     _ -&gt;
  336:							 Acc
  337:						 end
  338:					 end,
  339:				    ?line cmp_ms_to_fun(Tab,MS,MF,[])
<a name="340"></a>  340:			    end,
  341:			    Tabs)
  342:	  end,
  343:    ?line do_n(50,Fun),
  344:    ok.
  345:		  
<a name=basic_pb_key>  346:<b>basic_pb_key</b></a>(Config,Tabs,Type) -&gt;
  347:    InnerFun = fun(Tab) -&gt;
  348:		       ?line {Key,KeyFun}  = 
  349:			   create_pb_key(num_els(Tab),Type),
<a name="350"></a>  350:		       ?line MS = [{{Key,'_','_','_','_'},[],['$_']}],
  351:		       MF = fun({Key0,A,B,F,Bi},Acc) -&gt;
  352:				    case KeyFun(Key0) of
  353:					true -&gt;
  354:					    [{Key0,A,B,F,Bi} | 
  355:					     Acc];
  356:					_ -&gt;
  357:					    Acc
  358:				    end
  359:			    end,
<a name="360"></a>  360:		       ?line cmp_ms_to_fun(Tab,MS,MF,[])
  361:	       end,
  362:    ?line {Etses, Detses} = split_by_type(Tabs),
  363:    
  364:    ?line FunEts = fun() -&gt;
  365:			   ?line lists:foreach(InnerFun,
  366:					       Etses)
  367:		   end,
  368:    ?line FunDets = fun() -&gt;
  369:			    ?line lists:foreach(InnerFun,
<a name="370"></a>  370:						Detses)
  371:		    end,
  372:    ?line do_n(table_factor(hd(Etses)) div 2,FunEts),
  373:    ?line do_n(10,FunDets),
  374:    ok.
  375:		  
<a name=double_pb_key>  376:<b>double_pb_key</b></a>(Config,Tabs,Type) -&gt;
  377:    InnerFun = fun(Tab) -&gt;
  378:		       ?line {KeyA,KeyFunA}  = 
  379:			   create_pb_key(num_els(Tab),Type),
<a name="380"></a>  380:		       ?line {KeyB,KeyFunB}  = 
  381:			   create_pb_key(num_els(Tab),Type),
  382:		       MS = [{{KeyA,'_','_','_','_'},[],['$_']},
  383:			     {{KeyB,'_','_','_','_'},[],['$_']}],
  384:		       ?dbgformat("Tab: ~p, MS: ~p~n",
  385:				  [Tab,MS]),
  386:		       MF = fun({Key0,A,B,F,Bi},Acc) -&gt;
  387:				    case KeyFunA(Key0) of
  388:					true -&gt;
  389:					    ?dbgformat
<a name="390"></a>  390:					       ("FunMatched:"
  391:						" ~p~n",
  392:						[{Key0,A,
  393:						  B,F,Bi}]),
  394:					    [{Key0,A,B,F,Bi} | 
  395:					     Acc];
  396:					_ -&gt;
  397:					    case KeyFunB(Key0) of
  398:						true -&gt;
  399:						    ?dbgformat
<a name="400"></a>  400:						       ("Fun"
  401:							"Matched:"
  402:							" ~p~n",
  403:							[{Key0,A,
  404:							  B,F,
  405:							  Bi}]),
  406:						    [{Key0,A,B,
  407:						      F,Bi} |
  408:						     Acc];
  409:						_ -&gt;
<a name="410"></a>  410:						    Acc
  411:					    end
  412:				    end
  413:			    end,
  414:		       ?line cmp_ms_to_fun(Tab,MS,MF,[])
  415:	       end,
  416:    ?line {Etses, Detses} = split_by_type(Tabs),
  417:    
  418:    ?line FunEts = fun() -&gt;
  419:			   ?line lists:foreach(InnerFun,
<a name="420"></a>  420:					       Etses)
  421:		   end,
  422:    ?line FunDets = fun() -&gt;
  423:			    ?line lists:foreach(InnerFun,
  424:						Detses)
  425:		    end,
  426:    ?line do_n(table_factor(hd(Etses)) div 2,FunEts),
  427:    ?line do_n(10,FunDets),
  428:    ok.
  429:		  
<a name="430"></a>  430:	    
<a name=multi_key>  431:<b>multi_key</b></a>(Config,Tabs,Type) -&gt;
  432:    Fun = fun() -&gt;
  433:		  lists:map(fun(Tab) -&gt;
  434:				    ?line KeyA  = 
  435:					create_random_key(num_els(Tab),Type),
  436:				    ?line KeyB  = 
  437:					create_random_key(num_els(Tab),Type),
  438:				    ?line KeyC  = 
  439:					create_random_key(num_els(Tab),Type),
<a name="440"></a>  440:				    ?line KeyD  = 
  441:					create_random_key(num_els(Tab),Type),
  442:				    ?line KeyE  = 
  443:					create_random_key(num_els(Tab),Type),
  444:				    ?line KeyF  = 
  445:					create_random_key(num_els(Tab),Type),
  446:				    ?line KeyG  = 
  447:					create_random_key(num_els(Tab),Type),
  448:				    ?line KeyH  = 
  449:					create_random_key(num_els(Tab),Type),
<a name="450"></a>  450:				    ?line KeyI  = 
  451:					create_random_key(num_els(Tab),Type),
  452:				    ?line KeyJ  = 
  453:					create_random_key(num_els(Tab),Type),
  454:				    ?line KeyK  = 
  455:					create_random_key(num_els(Tab),Type),
  456:				    ?line KeyL  = 
  457:					create_random_key(num_els(Tab),Type),
  458:				    
  459:				    MS = [{{KeyA,'$1','_','$2','_'},[],
<a name="460"></a>  460:					   [{{'$1','$2'}}]},
  461:					  {{KeyB,'$1','_','$2','_'},[],
  462:					   [{{'$1','$2'}}]},
  463:					  {{KeyC,'$1','_','$2','_'},[],
  464:					   [{{'$1','$2'}}]},
  465:					  {{KeyD,'$1','_','$2','_'},[],
  466:					   [{{'$1','$2'}}]},
  467:					  {{KeyE,'$1','_','$2','_'},[],
  468:					   [{{'$1','$2'}}]},
  469:					  {{KeyF,'$1','_','$2','_'},[],
<a name="470"></a>  470:					   [{{'$1','$2'}}]},
  471:					  {{KeyG,'$1','_','$2','_'},[],
  472:					   [{{'$1','$2'}}]},
  473:					  {{KeyH,'$1','_','$2','_'},[],
  474:					   [{{'$1','$2'}}]},
  475:					  {{KeyI,'$1','_','$2','_'},[],
  476:					   [{{'$1','$2'}}]},
  477:					  {{KeyJ,'$1','_','$2','_'},[],
  478:					   [{{'$1','$2'}}]},
  479:					  {{KeyK,'$1','_','$2','_'},[],
<a name="480"></a>  480:					   [{{'$1','$2'}}]},
  481:					  {{KeyL,'$1','_','$2','_'},[],
  482:					   [{{'$1','$2'}}]}
  483:					 ],
  484:				    ?dbgformat("Tab: ~p, MS: ~p~n",
  485:					      [Tab,MS]),
  486:				    MF = fun({Key0,A,B,F,Bi},Acc) -&gt;
  487:						 case Key0 of
  488:						     KeyA -&gt;
  489:							 [ {A,F} | 
<a name="490"></a>  490:							   Acc];
  491:						     KeyB -&gt;
  492:							 [ {A,F} | 
  493:							   Acc];
  494:						     KeyC -&gt;
  495:							 [ {A,F} | 
  496:							   Acc];
  497:						     KeyD -&gt;
  498:							 [ {A,F} | 
  499:							   Acc];
<a name="500"></a>  500:						     KeyE -&gt;
  501:							 [ {A,F} | 
  502:							   Acc];
  503:						     KeyF -&gt;
  504:							 [ {A,F} | 
  505:							   Acc];
  506:						     KeyG -&gt;
  507:							 [ {A,F} | 
  508:							   Acc];
  509:						     KeyH -&gt;
<a name="510"></a>  510:							 [ {A,F} | 
  511:							   Acc];
  512:						     KeyI -&gt;
  513:							 [ {A,F} | 
  514:							   Acc];
  515:						     KeyJ -&gt;
  516:							 [ {A,F} | 
  517:							   Acc];
  518:						     KeyK -&gt;
  519:							 [ {A,F} | 
<a name="520"></a>  520:							   Acc];
  521:						     KeyL -&gt;
  522:							 [ {A,F} | 
  523:							   Acc];
  524:						     _ -&gt;
  525:							 Acc
  526:						 end
  527:					 end,
  528:				    ?line cmp_ms_to_fun(Tab,MS,MF,[])
  529:			    end,
<a name="530"></a>  530:			    Tabs)
  531:	  end,
  532:    ?line do_n(33,Fun),
  533:    ok.
  534:		  
<a name=multi_mixed_key>  535:<b>multi_mixed_key</b></a>(Config,Tabs,Type) -&gt;
  536:    InnerFun = fun(Tab) -&gt;
  537:		       ?line KeyA  = 
  538:			   create_random_key(num_els(Tab),Type),
  539:		       ?line KeyB  = 
<a name="540"></a>  540:			   create_random_key(num_els(Tab),Type),
  541:		       ?line KeyC  = 
  542:			   create_random_key(num_els(Tab),Type),
  543:		       ?line KeyD  = 
  544:			   create_random_key(num_els(Tab),Type),
  545:		       ?line {KeyE, FunE}  = 
  546:			   create_pb_key(num_els(Tab),Type),
  547:		       ?line KeyF  = 
  548:			   create_random_key(num_els(Tab),Type),
  549:		       ?line {KeyG, FunG}  = 
<a name="550"></a>  550:			   create_pb_key(num_els(Tab),Type),
  551:		       ?line KeyH  = 
  552:			   create_random_key(num_els(Tab),Type),
  553:		       ?line KeyI  = 
  554:			   create_random_key(num_els(Tab),Type),
  555:		       ?line {KeyJ, FunJ}  = 
  556:			   create_pb_key(num_els(Tab),Type),
  557:		       ?line KeyK  = 
  558:			   create_random_key(num_els(Tab),Type),
  559:		       ?line KeyL  = 
<a name="560"></a>  560:			   create_random_key(num_els(Tab),Type),
  561:		       
  562:		       MS = [{{KeyA,'$1','_','$2','_'},[],
  563:			      [{{'$1','$2'}}]},
  564:			     {{KeyB,'$1','_','$2','_'},[],
  565:			      [{{'$1','$2'}}]},
  566:			     {{KeyC,'$1','_','$2','_'},[],
  567:			      [{{'$1','$2'}}]},
  568:			     {{KeyD,'$1','_','$2','_'},[],
  569:			      [{{'$1','$2'}}]},
<a name="570"></a>  570:			     {{KeyE,'$100','_','$200','_'},[],
  571:			      [{{'$100','$200'}}]},
  572:			     {{KeyF,'$1','_','$2','_'},[],
  573:			      [{{'$1','$2'}}]},
  574:			     {{KeyG,'$100','_','$200','_'},[],
  575:			      [{{'$100','$200'}}]},
  576:			     {{KeyH,'$1','_','$2','_'},[],
  577:			      [{{'$1','$2'}}]},
  578:			     {{KeyI,'$1','_','$2','_'},[],
  579:			      [{{'$1','$2'}}]},
<a name="580"></a>  580:			     {{KeyJ,'$100','_','$200','_'},[],
  581:			      [{{'$100','$200'}}]},
  582:			     {{KeyK,'$1','_','$2','_'},[],
  583:			      [{{'$1','$2'}}]},
  584:			     {{KeyL,'$1','_','$2','_'},[],
  585:			      [{{'$1','$2'}}]}
  586:			    ],
  587:		       ?dbgformat("Tab: ~p, MS: ~p~n",
  588:				  [Tab,MS]),
  589:		       MF = fun({Key0,A,B,F,Bi},Acc) -&gt;
<a name="590"></a>  590:				    case Key0 of
  591:					KeyA -&gt;
  592:					    [ {A,F} | 
  593:					      Acc];
  594:					KeyB -&gt;
  595:					    [ {A,F} | 
  596:					      Acc];
  597:					KeyC -&gt;
  598:					    [ {A,F} | 
  599:					      Acc];
<a name="600"></a>  600:					KeyD -&gt;
  601:					    [ {A,F} | 
  602:					      Acc];
  603:					KeyF -&gt;
  604:					    [ {A,F} | 
  605:					      Acc];
  606:					KeyH -&gt;
  607:					    [ {A,F} | 
  608:					      Acc];
  609:					KeyI -&gt;
<a name="610"></a>  610:					    [ {A,F} | 
  611:					      Acc];
  612:					KeyK -&gt;
  613:					    [ {A,F} | 
  614:					      Acc];
  615:					KeyL -&gt;
  616:					    [ {A,F} | 
  617:					      Acc];
  618:					Else -&gt;
  619:					    case FunE(Else) or 
<a name="620"></a>  620:						FunG(Else) or
  621:						FunJ(Else) of
  622:						true -&gt;
  623:						    [ {A,F} | 
  624:						      Acc]; 
  625:						_ -&gt;
  626:						    Acc
  627:					    end
  628:				    end
  629:			    end,
<a name="630"></a>  630:		       ?line cmp_ms_to_fun(Tab,MS,MF,[]),
  631:		       ?line case Tab of
  632:				 {ets,_} -&gt;
  633:				     ?line cmp_ms_to_fun(Tab,MS,MF,[],1),  
  634:				     ?line cmp_ms_to_fun(Tab,MS,MF,[],10),  
  635:				     ?line cmp_ms_to_fun(Tab,MS,MF,[],1000000),  
  636:				     ?line cmp_ms_to_fun(Tab,MS,MF,[],-1),  
  637:				     ?line cmp_ms_to_fun(Tab,MS,MF,[],-10),  
  638:				     ?line cmp_ms_to_fun(Tab,MS,MF,[],-1000000);  
  639:				 _ -&gt;
<a name="640"></a>  640:				     ok
  641:			     end
  642:	       end,
  643:    ?line {Etses, Detses} = split_by_type(Tabs),
  644:    
  645:    ?line FunEts = fun() -&gt;
  646:			   ?line lists:foreach(InnerFun,
  647:					       Etses)
  648:		   end,
  649:    ?line FunDets = fun() -&gt;
<a name="650"></a>  650:			    ?line lists:foreach(InnerFun,
  651:						Detses)
  652:		    end,
  653:    ?line do_n(table_factor(hd(Etses)) div 2,FunEts),
  654:    ?line do_n(table_factor(hd(Detses)) div 2,FunDets),
  655:    ok.
  656:		  
  657:	    
<a name=split_by_type>  658:<b>split_by_type</b></a>(List) -&gt;    
  659:    split_by_type(List,[],[]).
<a name=split_by_type><a name="660"></a>  660:<b>split_by_type</b></a>([],AccEts,AccDets) -&gt;
  661:    {AccEts,AccDets};
<a name=split_by_type>  662:<b>split_by_type</b></a>([{dets,Tab}|T],AccEts,AccDets) -&gt;
  663:    split_by_type(T,AccEts,[{dets,Tab}|AccDets]);
<a name=split_by_type>  664:<b>split_by_type</b></a>([{ets,Tab}|T],AccEts,AccDets) -&gt;
  665:    split_by_type(T,[{ets,Tab}|AccEts],AccDets).
  666:
<a name=whitebox>  667:<b>whitebox</b></a>() -&gt;
  668:    ?line ets:new(xxx,[named_table, ordered_set]),
  669:    ?line ets:new(yyy,[named_table]),
<a name="670"></a>  670:    ?line E = fun(0,F)-&gt;ok;
  671:		 (N,F) -&gt; 
  672:		      ?line ets:insert(xxx,{N,N rem 10}), 
  673:		      ?line ets:insert(yyy,{N,N rem 10}), 
  674:		      F(N-1,F) 
  675:	      end,
  676:    ?line E(10000,E),                                                          
  677:
  678:    ?line G = fun(F,C,A) -&gt; 
  679:		      ?line case ets:select(C) of 
<a name="680"></a>  680:				{L,C2} -&gt; 
  681:				    ?line F(F,C2,A+length(L)); 
  682:				'$end_of_table' -&gt; 
  683:				    ?line A 
  684:			    end 
  685:	      end,
  686:    ?line H=fun({L,C}) -&gt; 
  687:		    ?line G(G,C,length(L)) 
  688:	    end,
  689:    
<a name="690"></a>  690:    ?line 1 = H(ets:select(xxx,[{{'$1','$2'},[{'&lt;','$1',2}],['$_']}],7)),
  691:    ?line 10000 = H(ets:select(xxx,[{{'$1','$2'},[],['$_']}],1)),
  692:    ?line 1 = H(ets:select(yyy,[{{'$1','$2'},[{'&lt;','$1',2}],['$_']}],7)),
  693:    ?line 10000 = H(ets:select(yyy,[{{'$1','$2'},[],['$_']}],1)),
  694:
  695:    ?line {[{5,5}],_} = ets:select(xxx,[{{5,'$2'},[],['$_']}],1),
  696:    ?line {[{5,5}],_} = ets:select(yyy,[{{5,'$2'},[],['$_']}],1),
  697:
  698:    ?line I = fun(I,0) -&gt; 
  699:		      ok;
<a name="700"></a>  700:		 (I,N) -&gt; 
  701:		      ?line 10000 =  
  702:			  H(ets:select(xxx,[{{'$1','$2'},[],['$_']}],N)), 
  703:		      I(I,N-1) 
  704:	      end,
  705:    ?line I(I,2000),
  706:    ?line J = fun(F,C,A) -&gt; 
  707:		      ?line case ets:select(C) of 
  708:				{L,C2} -&gt; 
  709:				    ?line F(F,C2,lists:reverse(L)++A); 
<a name="710"></a>  710:				'$end_of_table' -&gt; 
  711:				    ?line lists:reverse(A) 
  712:			    end 
  713:	      end,
  714:    ?line K = fun({L,C}) -&gt; 
  715:		      ?line J(J,C,lists:reverse(L)) 
  716:	      end,
  717:    ?line M = fun(F, What, 0) -&gt; 
  718:		      ok;
  719:		 (F, What, N) -&gt; 
<a name="720"></a>  720:		      ?line What =  
  721:			  K(ets:select(xxx,[{{'$1','$2'},[],['$_']}],N)), 
  722:		      F(F, What, N-1) 
  723:	      end,
  724:    ?line N = fun(HM) -&gt; 
  725:		      ?line What = ets:select(xxx,[{{'$1','$2'},[],['$_']}]), 
  726:		      ?line What = lists:sort(What), 
  727:		      M(M, What, HM) 
  728:	      end,
  729:    ?line N(2000),
<a name="730"></a>  730:    ?line ets:delete(xxx),
  731:    ?line ets:delete(yyy).
  732:
  733:
<a name=do_return_values>  734:<b>do_return_values</b></a>() -&gt;
  735:    ?line T = ets:new(xxx,[ordered_set]),
  736:    ?line U = ets:new(xxx,[]),
  737:    ?line '$end_of_table' = ets:select(T,[{'_',[],['$_']}],1),
  738:    ?line '$end_of_table' = ets:select(U,[{'_',[],['$_']}],1),
  739:    ?line ets:insert(T,{ett,1}),
<a name="740"></a>  740:    ?line ets:insert(U,{ett,1}),
  741:    ?line {[{ett,1}],C1} = ets:select(T,[{'_',[],['$_']}],1),
  742:    ?line '$end_of_table' = ets:select(C1),
  743:    ?line {[{ett,1}],C2} = ets:select(U,[{'_',[],['$_']}],1),
  744:    ?line '$end_of_table' = ets:select(C2),
  745:    ?line {[{ett,1}],C3} = ets:select(T,[{'_',[],['$_']}],2),
  746:    ?line '$end_of_table' = ets:select(C3),
  747:    ?line {[{ett,1}],C4} = ets:select(U,[{'_',[],['$_']}],2),
  748:    ?line '$end_of_table' = ets:select(C4),
  749:    ?line E = fun(0,F)-&gt;ok;
<a name="750"></a>  750:		 (N,F) -&gt; 
  751:		      ?line ets:insert(T,{N,N rem 10}), 
  752:		      ?line ets:insert(U,{N,N rem 10}), 
  753:		      F(N-1,F) 
  754:	      end,
  755:    ?line E(10000,E),                                                          
  756:    ?line '$end_of_table' = ets:select(T,[{{hej, hopp},[],['$_']}],1),
  757:    ?line '$end_of_table' = ets:select(U,[{{hej,hopp},[],['$_']}],1),
  758:    ?line {[{ett,1}],CC1} = ets:select(T,[{{'$1','_'},[{is_atom, '$1'}],
  759:					  ['$_']}],1),
<a name="760"></a>  760:    ?line '$end_of_table' = ets:select(CC1),
  761:    ?line {[{ett,1}],CC2} = ets:select(U,[{{'$1','_'},[{is_atom, '$1'}],
  762:					  ['$_']}],1),
  763:    ?line '$end_of_table' = ets:select(CC2),
  764:    ?line {[{ett,1}],CC3} = ets:select(T,[{{'$1','_'},[{is_atom, '$1'}],
  765:					  ['$_']}],2),
  766:    ?line '$end_of_table' = ets:select(CC3),
  767:    ?line {[{ett,1}],CC4} = ets:select(U,[{{'$1','_'},[{is_atom, '$1'}],
  768:					  ['$_']}],2),
  769:    ?line '$end_of_table' = ets:select(CC4),
<a name="770"></a>  770:    ?line ets:delete(T),
  771:    ?line ets:delete(U),
  772:    ?line V = ets:new(xxx,[{keypos, 4}]),
  773:    ?line X = ets:new(xxx,[ordered_set, {keypos, 4}]),
  774:    ?line ets:insert(V,{1,1,1,ett}),
  775:    ?line ets:insert(X,{1,1,1,ett}),
  776:    ?line '$end_of_table' = ets:select(V,[{{1,1,1},[],['$_']}],1),
  777:    ?line '$end_of_table' = ets:select(X,[{{1,1,1},[],['$_']}],1),
  778:    ?line ets:delete(V),
  779:    ?line ets:delete(X),
<a name="780"></a>  780:    ok.
  781:    
  782:    
  783:
  784:
  785:
</pre>
<hr size=1><i>The transformation of this file (786 lines) took 0.02 seconds</i><br>
</body>
</html>
