<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head><title>/usr/home/jlouis/hacking/test_server/stdlib_test/ets_SUITE.erl</title></head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
    1:<i>%% ``The contents of this file are subject to the Erlang Public License,</i>
    2:<i>%% Version 1.1, (the "License"); you may not use this file except in</i>
    3:<i>%% compliance with the License. You should have received a copy of the</i>
    4:<i>%% Erlang Public License along with this software. If not, it can be</i>
    5:<i>%% retrieved via the world wide web at http://www.erlang.org/.</i>
    6:<i>%% </i>
    7:<i>%% Software distributed under the License is distributed on an "AS IS"</i>
    8:<i>%% basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See</i>
    9:<i>%% the License for the specific language governing rights and limitations</i>
<a name="10"></a>   10:<i>%% under the License.</i>
   11:<i>%% </i>
   12:<i>%% The Initial Developer of the Original Code is Ericsson Utvecklings AB.</i>
   13:<i>%% Portions created by Ericsson are Copyright 1999, Ericsson Utvecklings</i>
   14:<i>%% AB. All Rights Reserved.''</i>
   15:<i>%% </i>
   16:<i>%%     $Id$</i>
   17:<i>%%</i>
   18:-<b>module</b>(ets_SUITE).
   19:-<b>export</b>([all/1]).
<a name="20"></a>   20:-<b>export</b>([new/1,default/1,setbag/1,badnew/1,verybadnew/1,named/1,keypos2/1,
   21:	 privacy/1,nosy/1]).
   22:-<b>export</b>([insert/1,empty/1,badinsert/1]).
   23:-<b>export</b>([lookup/1,time_lookup/1,badlookup/1]).
   24:-<b>export</b>([delete/1,delete_elem/1,delete_tab/1,baddelete/1,match_delete/1]).
   25:-<b>export</b>([match_delete3/1]).
   26:-<b>export</b>([firstnext/1]).
   27:-<b>export</b>([slot/1]).
   28:-<b>export</b>([match/1, match1/1, match2/1, match_object/1, match_object2/1]).
   29:-<b>export</b>([misc/1, dups/1, misc1/1, fixtable/1, info/1, tab2list/1]).
<a name="30"></a>   30:-<b>export</b>([files/1, tab2file/1, tab2file2/1, tab2file3/1]).
   31:-<b>export</b>([heavy/1, heavy_lookup/1, heavy_lookup_element/1]).
   32:-<b>export</b>([lookup_element/1, lookup_element_mult/1]).
   33:-<b>export</b>([all_2214/1]).
   34:<i>%-export([i_2409/1]).</i>
   35:-<b>export</b>([fold/1]).
   36:-<b>export</b>([foldl_ordered/1, foldr_ordered/1, foldl/1, foldr/1, fold_empty/1]).
   37:-<b>export</b>([t_delete_object/1, t_init_table/1, t_whitebox/1, 
   38:	 t_delete_all_objects/1, t_insert_list/1, t_test_ms/1,
   39:	 t_select_delete/1,t_ets_dets/1]).
<a name="40"></a>   40:
   41:-<b>export</b>([do_lookup/2, do_lookup_element/3]).
   42:
   43:-<b>export</b>([do0_2214/0, do_2214/1, do1_2214/1]).
   44:-<b>export</b>([ordered/1, ordered_match/1, interface_equality/1,
   45:	 fixtable_next/1, fixtable_insert/1, rename/1, update_counter/1,
   46:	 partly_bound/1, match_heavy/1]).
   47:-<b>export</b>([member/1]).
   48:-<b>export</b>([memory/1]).
   49:-<b>export</b>([select_fail/1]).
<a name="50"></a>   50:-<b>export</b>([init_per_testcase/2, fin_per_testcase/2]).
   51:<i>%% Convenience for manual testing</i>
   52:-<b>export</b>([random_test/0]).
   53:
   54:<i>% internal exports</i>
   55:<i>%-export([heartbeat_loop/1]).</i>
   56:-<b>export</b>([dont_make_worse_sub/0, make_better_sub1/0, make_better_sub2/0]).
   57:
   58:-<b>include</b>("test_server.hrl").
   59:
<a name="60"></a>   60:-<b>changes</b>(["- Added test case for match_delete.",
   61:	  "- Added another match test case (specified keypos)",
   62:          "- Improved misc test case a little.",
   63:	  "- Added fixtable test case.",
   64:	  "- Added doc clause to some test cases for test_server suite "
   65:	  "structure generation (to be added)"
   66:	 ]).
   67:-<b>changes</b>(["- Added test cases for file2tab &amp; tab2file w/ pretty heavy "
   68:	  "loaded tables of both set &amp; bag type."
   69:	  "- Added heacy lookup &amp; lookup_element tests"
<a name="70"></a>   70:	  "- Added ets:info test case."
   71:	 ]).
   72:-<b>changes</b>(["- Fixed all test cases (Config) clause to have list() "
   73:	  "  guard"
   74:	 ]).
   75:-<b>changes</b>(["- Added case verybadnew OTP-2314 ets:new crashes emulator."
   76:	 ]).
   77:
<a name=init_per_testcase>   78:<b>init_per_testcase</b></a>(Func, Config) -&gt;
   79:    Dog=test_server:timetrap(test_server:seconds(360)),
<a name="80"></a>   80:    [{watchdog, Dog}|Config].
   81:
<a name=fin_per_testcase>   82:<b>fin_per_testcase</b></a>(Func, Config) -&gt;
   83:    Dog=?config(watchdog, Config),
   84:    test_server:timetrap_cancel(Dog).
   85:
   86:<i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
   87:
<a name=all>   88:<b>all</b></a>(suite) -&gt; {req, [stdlib],
   89:	       [new,insert,lookup,delete,firstnext,slot,match,
<a name="90"></a>   90:		all_2214,
   91:		lookup_element, misc,files, heavy, 
   92:<i>%		i_2409, </i>
   93:		ordered, ordered_match, interface_equality,
   94:		fixtable_next, fixtable_insert, rename,
   95:		update_counter, partly_bound, match_heavy,
   96:		fold, member,
   97:		t_delete_object, t_init_table, t_whitebox, 
   98:		t_delete_all_objects, t_insert_list, t_test_ms,
   99:		t_select_delete, t_ets_dets, memory,
<a name="100"></a>  100:		select_fail]}.
  101:
  102:<i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
  103:
<a name=new>  104:<b>new</b></a>(suite) -&gt; [default,setbag,badnew,verybadnew,named,keypos2,privacy].
  105:
<a name=default>  106:<b>default</b></a>(doc) -&gt;
  107:    ["Test case to check that a new ets table is defined as a `set' and "
  108:     "`protected'"];
<a name=default>  109:<b>default</b></a>(suite) -&gt; [];
<a name=default><a name="110"></a>  110:<b>default</b></a>(Config) when list(Config) -&gt;
  111:    %% Default should be set,protected
  112:    ?line Def = ets:new(def,[]),
  113:    ?line set = ets:info(Def,type),
  114:    ?line protected = ets:info(Def,protection),
  115:    ok.
  116:
<a name=select_fail>  117:<b>select_fail</b></a>(doc) -&gt;
  118:    ["Test that select fails even if nothing can match"];
<a name=select_fail>  119:<b>select_fail</b></a>(suite) -&gt;
<a name="120"></a>  120:    [];
<a name=select_fail>  121:<b>select_fail</b></a>(Config) when list(Config) -&gt;    
  122:    ?line lists:foreach(
  123:	    fun(T) -&gt;
  124:		    ?line ets:insert(T,{a,a}),
  125:		    ?line case (catch 
  126:				ets:select(T,[{{a,'_'},[],[{snuffla}]}])) of
  127:			      {'EXIT',{badarg,_}} -&gt;
  128:				  ok;
  129:			      Else0 -&gt;
<a name="130"></a>  130:				  exit({type,ets:info(T,type),
  131:					expected,'EXIT',got,Else0})
  132:			  end,
  133:		    ?line case (catch 
  134:				ets:select(T,[{{b,'_'},[],[{snuffla}]}])) of
  135:			      {'EXIT',{badarg,_}} -&gt;
  136:				  ok;
  137:			      Else1 -&gt;
  138:				  exit({type,ets:info(T,type),
  139:					expected,'EXIT',got,Else1})
<a name="140"></a>  140:			  end,
  141:		    ?line ets:delete(T)
  142:	    end, [ets:new(x,[ordered_set]),ets:new(x,[set]),
  143:		  ets:new(x,[bag]),ets:new(x,[duplicate_bag])]),
  144:    ok.
  145: 
  146:
  147:-<b>define</b>(S(T),ets:info(T,memory)).
<a name=memory>  148:<b>memory</b></a>(doc) -&gt;
  149:    ["Whitebox test of ets:info(X,memory)"];
<a name=memory><a name="150"></a>  150:<b>memory</b></a>(suite) -&gt;
  151:    [];
<a name=memory>  152:<b>memory</b></a>(Config) when list(Config) -&gt;    
  153:    ?line L = [T1,T2,T3,T4] = fill_sets_int(1000),
  154:    ?line {17856,17063,17063,17069} = {?S(T1),?S(T2),?S(T3),?S(T4)},
  155:    ?line lists:foreach(fun(T) -&gt;
  156:			  ?line ets:delete(T,ets:first(T))
  157:		  end,
  158:		  L),
  159:    ?line {17842,17046,17029,17035} ={?S(T1),?S(T2),?S(T3),?S(T4)},
<a name="160"></a>  160:    ?line lists:foreach(fun(T) -&gt;
  161:			  ?line ets:match_delete(T,{ets:first(T),'_'})
  162:		  end,
  163:		  L),
  164:    ?line {17828,17031,16997,17001} = {?S(T1),?S(T2),?S(T3),?S(T4)},
  165:    ?line lists:foreach(fun(T) -&gt;
  166:			  ?line ets:delete_all_objects(T)
  167:		  end,
  168:		  L),
  169:    ?line {70,277,277,277} = {?S(T1),?S(T2),?S(T3),?S(T4)},
<a name="170"></a>  170:    lists:foreach(fun(T) -&gt;
  171:			  ?line ets:delete(T)
  172:		  end,
  173:		  L),
  174:    ?line L2 =  [T11,T12,T13,T14] = fill_sets_int(1000),
  175:    ?line lists:foreach(fun(T) -&gt;
  176:			  ?line ets:select_delete(T,[{'_',[],[true]}])
  177:		  end,
  178:		  L2),
  179:    ?line {70,277,277,277} = {?S(T11),?S(T12),?S(T13),?S(T14)},
<a name="180"></a>  180:    ok.
  181:
<a name=t_whitebox>  182:<b>t_whitebox</b></a>(doc) -&gt;
  183:    ["Diverse whitebox testes"];
<a name=t_whitebox>  184:<b>t_whitebox</b></a>(suite) -&gt;
  185:    [];
<a name=t_whitebox>  186:<b>t_whitebox</b></a>(Config) when list(Config) -&gt;    
  187:    whitebox_1(),
  188:    whitebox_1(),
  189:    whitebox_1(),
<a name="190"></a>  190:    whitebox_2(),
  191:    whitebox_2(),
  192:    whitebox_2().
  193:
<a name=whitebox_1>  194:<b>whitebox_1</b></a>() -&gt;
  195:    ?line T=ets:new(x,[bag]),
  196:    ?line ets:insert(T,[{du,glade},{ta,en}]),
  197:    ?line ets:insert(T,[{hej,hopp2},{du,glade2},{ta,en2}]),
  198:    ?line {_,C}=ets:match(T,{ta,'$1'},1),
  199:    ?line ets:select(C),
<a name="200"></a>  200:    ?line ets:match(C),
  201:    ?line ets:delete(T),
  202:    ok.
  203:
<a name=whitebox_2>  204:<b>whitebox_2</b></a>() -&gt;
  205:    ?line T=ets:new(x,[ordered_set,{keypos,2}]),
  206:    ?line T2=ets:new(x,[set,{keypos,2}]),
  207:    ?line 0 = ets:select_delete(T,[{{hej},[],[true]}]),
  208:    ?line 0 = ets:select_delete(T,[{{hej,hopp},[],[true]}]),
  209:    ?line 0 = ets:select_delete(T2,[{{hej},[],[true]}]),
<a name="210"></a>  210:    ?line 0 = ets:select_delete(T2,[{{hej,hopp},[],[true]}]),
  211:    ?line ets:delete(T),
  212:    ?line ets:delete(T2),
  213:    ok.
  214:    
  215:    
<a name=t_ets_dets>  216:<b>t_ets_dets</b></a>(doc) -&gt;
  217:    ["Test ets:to/from_dets"];
<a name=t_ets_dets>  218:<b>t_ets_dets</b></a>(suite) -&gt;
  219:    [];
<a name=t_ets_dets><a name="220"></a>  220:<b>t_ets_dets</b></a>(Config) when list(Config) -&gt;
  221:    ?line Fname = gen_dets_filename(Config,1),
  222:    ?line (catch file:delete(Fname)),
  223:    ?line {ok,DTab} = dets:open_file(testdets_1,
  224:			       [{file, Fname}]),
  225:    ?line ETab = ets:new(x,[]),
  226:    ?line filltabint(ETab,3000),
  227:    ?line DTab = ets:to_dets(ETab,DTab),
  228:    ?line ets:delete_all_objects(ETab),
  229:    ?line 0 = ets:info(ETab,size),
<a name="230"></a>  230:    ?line true = ets:from_dets(ETab,DTab),
  231:    ?line 3000 = ets:info(ETab,size),
  232:    ?line ets:delete(ETab),
  233:    ?line {'EXIT',{badarg,[{ets,to_dets,[ETab,DTab]}|_]}} =
  234:	(catch ets:to_dets(ETab,DTab)),
  235:    ?line {'EXIT',{badarg,[{ets,from_dets,[ETab,DTab]}|_]}} =
  236:	(catch ets:from_dets(ETab,DTab)),
  237:    ?line ETab2 = ets:new(x,[]),
  238:    ?line filltabint(ETab2,3000),
  239:    ?line dets:close(DTab),
<a name="240"></a>  240:    ?line {'EXIT',{badarg,[{ets,to_dets,[ETab2,DTab]}|_]}} =
  241:	(catch ets:to_dets(ETab2,DTab)),
  242:    ?line {'EXIT',{badarg,[{ets,from_dets,[ETab2,DTab]}|_]}} =
  243:	(catch ets:from_dets(ETab2,DTab)),
  244:    ?line ets:delete(ETab2),
  245:    ok.
  246:
<a name=t_delete_all_objects>  247:<b>t_delete_all_objects</b></a>(doc) -&gt;
  248:    ["Test ets:delete_all_objects/1"];
<a name=t_delete_all_objects>  249:<b>t_delete_all_objects</b></a>(suite) -&gt;
<a name="250"></a>  250:    [];
<a name=t_delete_all_objects>  251:<b>t_delete_all_objects</b></a>(Config) when list(Config) -&gt;
  252:    ?line T=ets:new(x,[]),
  253:    ?line filltabint(T,4000),
  254:    ?line O=ets:first(T),
  255:    ?line ets:next(T,O),
  256:    ?line ets:safe_fixtable(T,true),
  257:    ?line true = ets:delete_all_objects(T),
  258:    ?line '$end_of_table' = ets:next(T,O),
  259:    ?line 0 = ets:info(T,size),
<a name="260"></a>  260:    ?line 4000 = ets:info(T,kept_objects),
  261:    ?line ets:safe_fixtable(T,false),
  262:    ?line 0 = ets:info(T,size),
  263:    ?line 0 = ets:info(T,kept_objects),
  264:    ?line filltabint(T,4000),
  265:    ?line 4000 = ets:info(T,size),
  266:    ?line true = ets:delete_all_objects(T),
  267:    ?line 0 = ets:info(T,size),
  268:    ?line ets:delete(T),
  269:    ok.
<a name="270"></a>  270:
<a name=t_delete_object>  271:<b>t_delete_object</b></a>(doc) -&gt;
  272:    ["Test ets:delete_object/2"];
<a name=t_delete_object>  273:<b>t_delete_object</b></a>(suite) -&gt;
  274:    [];
<a name=t_delete_object>  275:<b>t_delete_object</b></a>(Config) when list(Config) -&gt;
  276:    ?line T = ets:new(x,[]),
  277:    ?line filltabint(T,4000),
  278:    ?line del_one_by_one_set(T,1,4001),
  279:    ?line filltabint(T,4000),
<a name="280"></a>  280:    ?line del_one_by_one_set(T,4000,0),
  281:    ?line filltabint(T,4000),
  282:    ?line First = ets:first(T),
  283:    ?line Next = ets:next(T,First),
  284:    ?line ets:safe_fixtable(T,true),
  285:    ?line ets:delete_object(T,{First, integer_to_list(First)}),
  286:    ?line Next = ets:next(T,First),
  287:    ?line 3999 = ets:info(T,size),
  288:    ?line 1 = ets:info(T,kept_objects),
  289:    ?line ets:safe_fixtable(T,false),
<a name="290"></a>  290:    ?line 3999 = ets:info(T,size),
  291:    ?line 0 = ets:info(T,kept_objects),
  292:    ?line ets:delete(T),
  293:    ?line T1 = ets:new(x,[ordered_set]),
  294:    ?line filltabint(T1,4000),
  295:    ?line del_one_by_one_set(T1,1,4001),
  296:    ?line filltabint(T1,4000),
  297:    ?line del_one_by_one_set(T1,4000,0),
  298:    ?line ets:delete(T1),
  299:    ?line T2 = ets:new(x,[bag]),
<a name="300"></a>  300:    ?line filltabint2(T2,4000),
  301:    ?line del_one_by_one_bag(T2,1,4001),
  302:    ?line filltabint2(T2,4000),
  303:    ?line del_one_by_one_bag(T2,4000,0),
  304:    ?line ets:delete(T2),
  305:    ?line T3 = ets:new(x,[duplicate_bag]),
  306:    ?line filltabint3(T3,4000),
  307:    ?line del_one_by_one_dbag_1(T3,1,4001),
  308:    ?line filltabint3(T3,4000),
  309:    ?line del_one_by_one_dbag_1(T3,4000,0),
<a name="310"></a>  310:    ?line filltabint(T3,4000),
  311:    ?line filltabint3(T3,4000),
  312:    ?line del_one_by_one_dbag_2(T3,1,4001),
  313:    ?line filltabint(T3,4000),
  314:    ?line filltabint3(T3,4000),
  315:    ?line del_one_by_one_dbag_2(T3,4000,0),
  316:    ?line ets:delete(T3),
  317:    ok.
  318:
<a name=make_init_fun>  319:<b>make_init_fun</b></a>(N) when N &gt; 4000-&gt;
<a name="320"></a>  320:    fun(read) -&gt;
  321:	    end_of_input;
  322:       (close) -&gt;
  323:	    exit(close_not_expected)
  324:    end;
<a name=make_init_fun>  325:<b>make_init_fun</b></a>(N) -&gt;
  326:    fun(read) -&gt;
  327:	    case N rem 2 of
  328:		0 -&gt;
  329:		    {[{N, integer_to_list(N)}, {N, integer_to_list(N)}],
<a name="330"></a>  330:		     make_init_fun(N + 1)};
  331:		1 -&gt;
  332:		    {[], make_init_fun(N + 1)}
  333:	    end;
  334:       (close) -&gt;
  335:	    exit(close_not_expected)
  336:    end.
  337:
<a name=t_init_table>  338:<b>t_init_table</b></a>(doc) -&gt;
  339:    ["Test ets:init_table/2"];
<a name=t_init_table><a name="340"></a>  340:<b>t_init_table</b></a>(suite) -&gt;
  341:    [];
<a name=t_init_table>  342:<b>t_init_table</b></a>(Config) when list(Config)-&gt;
  343:    ?line T = ets:new(x,[duplicate_bag]),
  344:    ?line filltabint(T,4000),
  345:    ?line ets:init_table(T, make_init_fun(1)),
  346:    ?line del_one_by_one_dbag_1(T,4000,0),
  347:    ?line ets:delete(T),
  348:    ok.
  349:
<a name=do_fill_dbag_using_lists><a name="350"></a>  350:<b>do_fill_dbag_using_lists</b></a>(T,0) -&gt;
  351:    T;
<a name=do_fill_dbag_using_lists>  352:<b>do_fill_dbag_using_lists</b></a>(T,N) -&gt;
  353:    ets:insert(T,[{N,integer_to_list(N)},
  354:		  {N + N rem 2,integer_to_list(N + N rem 2)}]),
  355:    do_fill_dbag_using_lists(T,N - 1). 
  356:
<a name=t_insert_list>  357:<b>t_insert_list</b></a>(doc) -&gt;
  358:    ["Test ets:insert/2 with list of objects."];
<a name=t_insert_list>  359:<b>t_insert_list</b></a>(suite) -&gt;
<a name="360"></a>  360:    [];
<a name=t_insert_list>  361:<b>t_insert_list</b></a>(Config) when list(Config) -&gt;
  362:    ?line T = ets:new(x,[duplicate_bag]),
  363:    ?line do_fill_dbag_using_lists(T,4000),
  364:    ?line del_one_by_one_dbag_2(T,4000,0),
  365:    ?line ets:delete(T),
  366:    ok.
  367:
<a name=t_test_ms>  368:<b>t_test_ms</b></a>(doc) -&gt;
  369:    ["Test interface of ets:test_ms/2"];
<a name=t_test_ms><a name="370"></a>  370:<b>t_test_ms</b></a>(suite) -&gt;
  371:    [];
<a name=t_test_ms>  372:<b>t_test_ms</b></a>(Config) when list(Config) -&gt;
  373:    ?line {ok,[a,b]} = ets:test_ms({a,b},
  374:				   [{{'$1','$2'},[{'&lt;','$1','$2'}],['$$']}]),
  375:    ?line {ok,false} = ets:test_ms({a,b},
  376:				   [{{'$1','$2'},[{'&gt;','$1','$2'}],['$$']}]),
  377:    ?line {error,[{error,String}]} = ets:test_ms({a,b},
  378:						 [{{'$1','$2'},
  379:						   [{'flurp','$1','$2'}],
<a name="380"></a>  380:						   ['$$']}]),
  381:    ?line true = (if list(String) -&gt; true; true -&gt; false end),
  382:    ok.
  383:
<a name=t_select_delete>  384:<b>t_select_delete</b></a>(doc) -&gt;
  385:    ["Test the ets:select_delete/2 and ets:select_count/2 BIF's"];
<a name=t_select_delete>  386:<b>t_select_delete</b></a>(suite) -&gt;
  387:    [];
<a name=t_select_delete>  388:<b>t_select_delete</b></a>(Config) when list(Config) -&gt;
  389:    ?line Tables = fill_sets_int(10000),
<a name="390"></a>  390:    lists:foreach
  391:      (fun(Table) -&gt;
  392:	       ?line 4000 = ets:select_count(Table,[{{'$1', '_'},
  393:						     [{'&gt;', 
  394:						       {'rem', 
  395:							'$1', 5}, 
  396:						       2}],
  397:						     [true]}]),
  398:	       ?line 4000 = ets:select_delete(Table,[{{'$1', '_'},
  399:						      [{'&gt;', 
<a name="400"></a>  400:							{'rem', 
  401:							 '$1', 5}, 
  402:							2}],
  403:						      [true]}]),
  404:	       ?line check(Table,
  405:			   fun({N,_}) when (N rem 5) =&lt; 2 -&gt;
  406:				   true;
  407:			      (_) -&gt;
  408:				   false
  409:			   end,
<a name="410"></a>  410:			   6000)
  411:       end,
  412:       Tables),
  413:    lists:foreach
  414:      (fun(Table) -&gt;
  415:	       ?line ets:select_delete(Table,[{'_',[],[true]}]),
  416:	       ?line xfilltabint(Table,4000),
  417:	       ?line successive_delete(Table,1,4001,bound),
  418:	       ?line 0 = ets:info(Table,size),
  419:	       ?line xfilltabint(Table,4000),
<a name="420"></a>  420:	       ?line successive_delete(Table,4000,0, bound),
  421:	       ?line 0 = ets:info(Table,size),
  422:	       ?line xfilltabint(Table,4000),
  423:	       ?line successive_delete(Table,1,4001,unbound),
  424:	       ?line 0 = ets:info(Table,size),
  425:	       ?line xfilltabint(Table,4000),
  426:	       ?line successive_delete(Table,4000,0, unbound),
  427:	       ?line 0 = ets:info(Table,size)
  428:       end,
  429:       Tables),
<a name="430"></a>  430:    lists:foreach
  431:      (fun(Table) -&gt;
  432:	       F = case ets:info(Table,type) of
  433:		       X when X == bag; X == duplicate_bag -&gt;
  434:			   2;
  435:		       _ -&gt; 
  436:			   1
  437:		   end,
  438: 	       ?line xfilltabstr(Table, 4000),
  439:	       ?line 1000 = ets:select_count(Table,
<a name="440"></a>  440:					     [{{[$3 | '$1'], '_'},
  441:					       [{'==',
  442:						 {'length', '$1'},
  443:						 3}],[true]}]) div F,
  444:	       ?line 1000 = ets:select_delete(Table,
  445:					      [{{[$3 | '$1'], '_'},
  446:						[{'==',
  447:						  {'length', '$1'},
  448:						  3}],[true]}]) div F,
  449:	       ?line check(Table, fun({[3,_,_,_],_}) -&gt; false;
<a name="450"></a>  450:				     (_) -&gt; true
  451:				  end, 3000*F),
  452:	       ?line 8 = ets:select_count(Table,
  453:					  [{{"7",'_'},[],[false]},
  454:					   {{['_'], '_'},
  455:					    [],[true]}]) div F,
  456:	       ?line 8 = ets:select_delete(Table,
  457:					   [{{"7",'_'},[],[false]},
  458:					    {{['_'], '_'},
  459:					     [],[true]}]) div F,
<a name="460"></a>  460:	       ?line check(Table, fun({"7",_}) -&gt; true;
  461:				     ({[_],_}) -&gt; false;
  462:				     (_) -&gt; true
  463:				  end, 2992*F),
  464:	       ?line xfilltabstr(Table, 4000),
  465:	       %% This happens to be interesting for other select types too
  466:	       ?line 200 = length(ets:select(Table,
  467:					     [{{[$3,'_','_'],'_'},
  468:					       [],[true]},
  469:					      {{[$1,'_','_'],'_'},
<a name="470"></a>  470:					       [],[true]}])) div F,
  471:	       ?line 200 = ets:select_count(Table,
  472:					    [{{[$3,'_','_'],'_'},
  473:					      [],[true]},
  474:					     {{[$1,'_','_'],'_'},
  475:					      [],[true]}]) div F,
  476:	       ?line 200 = length(element(1,ets:select(Table,
  477:						       [{{[$3,'_','_'],'_'},
  478:							 [],[true]},
  479:							{{[$1,'_','_'],'_'},
<a name="480"></a>  480:							 [],[true]}],
  481:						       1000))) div F,
  482:	       ?line 200 = length(
  483:			     ets:select_reverse(Table,
  484:						[{{[$3,'_','_'],'_'},
  485:						  [],[true]},
  486:						 {{[$1,'_','_'],'_'},
  487:						  [],[true]}])) div F,
  488:	       ?line 200 = length(
  489:			     element(1,
<a name="490"></a>  490:				     ets:select_reverse
  491:				     (Table,
  492:				      [{{[$3,'_','_'],'_'},
  493:					[],[true]},
  494:				       {{[$1,'_','_'],'_'},
  495:					[],[true]}],
  496:				      1000))) div F,
  497:	       ?line 200 = ets:select_delete(Table,
  498:					     [{{[$3,'_','_'],'_'},
  499:					       [],[true]},
<a name="500"></a>  500:					      {{[$1,'_','_'],'_'},
  501:					       [],[true]}]) div F,
  502:	       ?line 0 = ets:select_count(Table,
  503:					  [{{[$3,'_','_'],'_'},
  504:					    [],[true]},
  505:					   {{[$1,'_','_'],'_'},
  506:					    [],[true]}]) div F,
  507:	       ?line check(Table, fun({[$3,_,_],_}) -&gt; false;
  508:				     ({[$1,_,_],_}) -&gt; false;
  509:				     (_) -&gt; true
<a name="510"></a>  510:				  end, 3800*F)
  511:       end,
  512:       Tables),
  513:    lists:foreach(fun(Tab) -&gt; ets:delete(Tab) end,Tables),
  514:    ok.
  515:
<a name=partly_bound>  516:<b>partly_bound</b></a>(doc) -&gt;
  517:    ["Test that partly bound keys gives faster matches"];
<a name=partly_bound>  518:<b>partly_bound</b></a>(suite) -&gt;
  519:    [];
<a name=partly_bound><a name="520"></a>  520:<b>partly_bound</b></a>(Config) when list(Config) -&gt;
  521:    ?line dont_make_worse(),
  522:    ?line make_better(),
  523:    ok.
  524:
<a name=dont_make_worse>  525:<b>dont_make_worse</b></a>() -&gt;
  526:    seventyfive_percent_success({?MODULE,dont_make_worse_sub,[]},0,0,10).
  527:
<a name=dont_make_worse_sub>  528:<b>dont_make_worse_sub</b></a>() -&gt;
  529:    ?line T = build_table([a,b],[a,b],15000),
<a name="530"></a>  530:    ?line T1 = time_match_object(T,{'_',a,a,1500}, [{{a,a,1500},a,a,1500}]),
  531:    ?line T2 = time_match_object(T,{{a,a,'_'},a,a,1500}, 
  532:				 [{{a,a,1500},a,a,1500}]),
  533:    ?line ets:delete(T),
  534:    ?line true = (T1 &gt; T2),
  535:    ok.
  536:    
<a name=make_better>  537:<b>make_better</b></a>() -&gt;
  538:    seventyfive_percent_success({?MODULE,make_better_sub2,[]},0,0,10),
  539:    seventyfive_percent_success({?MODULE,make_better_sub1,[]},0,0,10).
<a name=make_better_sub1><a name="540"></a>  540:<b>make_better_sub1</b></a>() -&gt;
  541:    ?line T = build_table2([a,b],[a,b],15000),
  542:    ?line T1 = time_match_object(T,{'_',1500,a,a}, [{{1500,a,a},1500,a,a}]),
  543:    ?line T2 = time_match_object(T,{{1500,a,'_'},1500,a,a}, 
  544:				 [{{1500,a,a},1500,a,a}]),
  545:    ?line ets:delete(T),
  546:    ?line io:format("~p&gt;~p~n",[(T1 / 100),T2]),
  547:    ?line true = ((T1 / 100) &gt; T2), % More marginal than needed.
  548:    ok.
  549:
<a name=make_better_sub2><a name="550"></a>  550:<b>make_better_sub2</b></a>() -&gt;
  551:    ?line T = build_table2([a,b],[a,b],15000),
  552:    ?line T1 = time_match(T,{'$1',1500,a,a}),
  553:    ?line T2 = time_match(T,{{1500,a,'$1'},1500,a,a}),
  554:    ?line ets:delete(T),
  555:    ?line io:format("~p&gt;~p~n",[(T1 / 100),T2]),
  556:    ?line true = ((T1 / 100) &gt; T2), % More marginal than needed.
  557:    ok.
  558:
  559:
<a name=match_heavy><a name="560"></a>  560:<b>match_heavy</b></a>(doc) -&gt;
  561:    ["Heavy random matching, comparing set with ordered_set."];
<a name=match_heavy>  562:<b>match_heavy</b></a>(suite) -&gt;
  563:    [];
<a name=match_heavy>  564:<b>match_heavy</b></a>(Config) when list(Config) -&gt;
  565:    PrivDir = ?config(priv_dir,Config),
  566:    DataDir = ?config(data_dir, Config),
  567:    %% Easier to have in process dictionary when manually
  568:    %% running the test function.
  569:    put(where_to_read,DataDir),
<a name="570"></a>  570:    put(where_to_write,PrivDir),
  571:    Dog=?config(watchdog, Config),
  572:    test_server:timetrap_cancel(Dog),    
  573:    NewDog=test_server:timetrap(test_server:seconds(1000)),
  574:    NewConfig = [{watchdog, NewDog} | lists:keydelete(watchdog,1,Config)],
  575:    random_test(),
  576:    drop_match(),
  577:    NewConfig.
  578:
  579:<i>%%% Extra safety for the very low probability that this is not</i>
<a name="580"></a>  580:<i>%%% caught by the random test (Statistically impossible???) </i>
<a name=drop_match>  581:<b>drop_match</b></a>() -&gt;
  582:    ?line T = build_table([a,b],[a],1500),
  583:    ?line [{{a,a,1},a,a,1},{{b,a,1},b,a,1}] = 
  584:	ets:match_object(T, {'_','_','_',1}).
  585:
  586:
<a name=ets_match>  587:<b>ets_match</b></a>(Tab,Expr) -&gt;
  588:    case random:uniform(2) of
  589:	1 -&gt;
<a name="590"></a>  590:	    ets:match(Tab,Expr);
  591:	_ -&gt;
  592:	    match_chunked(Tab,Expr)
  593:    end.
  594:
<a name=match_chunked>  595:<b>match_chunked</b></a>(Tab,Expr) -&gt;
  596:    match_chunked_collect(ets:match(Tab,Expr,
  597:				    random:uniform(1999) + 1)).
<a name=match_chunked_collect>  598:<b>match_chunked_collect</b></a>('$end_of_table') -&gt;
  599:    [];
<a name=match_chunked_collect><a name="600"></a>  600:<b>match_chunked_collect</b></a>({Results, Continuation}) -&gt;
  601:    Results ++ match_chunked_collect(ets:match(Continuation)).
  602:
<a name=ets_match_object>  603:<b>ets_match_object</b></a>(Tab,Expr) -&gt;
  604:    case random:uniform(2) of
  605:	1 -&gt;
  606:	    ets:match_object(Tab,Expr);
  607:	_ -&gt;
  608:	    match_object_chunked(Tab,Expr)
  609:    end.
<a name="610"></a>  610:
<a name=match_object_chunked>  611:<b>match_object_chunked</b></a>(Tab,Expr) -&gt;
  612:    match_object_chunked_collect(ets:match_object(Tab,Expr,
  613:						  random:uniform(1999) + 1)).
<a name=match_object_chunked_collect>  614:<b>match_object_chunked_collect</b></a>('$end_of_table') -&gt;
  615:    [];
<a name=match_object_chunked_collect>  616:<b>match_object_chunked_collect</b></a>({Results, Continuation}) -&gt;
  617:    Results ++ match_object_chunked_collect(ets:match_object(Continuation)).
  618:
  619:
<a name="620"></a>  620:    
<a name=random_test>  621:<b>random_test</b></a>() -&gt;
  622:    ?line ReadDir = get(where_to_read),
  623:    ?line WriteDir = get(where_to_write),
  624:    ?line (catch file:make_dir(WriteDir)),
  625:    ?line Seed = case file:consult(filename:join([ReadDir, 
  626:					    "preset_random_seed.txt"])) of
  627:	       {ok,[X]} -&gt;
  628:		   X;
  629:	       _ -&gt;
<a name="630"></a>  630:		   {A,B,C} = erlang:now(),
  631:		   random:seed(A,B,C),
  632:		   get(random_seed)
  633:	   end,
  634:    put(random_seed,Seed),
  635:    ?line {ok, F} = file:open(filename:join([WriteDir, 
  636:					     "last_random_seed.txt"]), 
  637:			      [write]),
  638:    io:format(F,"~p. ~n",[Seed]),
  639:    file:close(F),
<a name="640"></a>  640:    io:format("Random seed ~p written to ~s, copy to ~s to rerun with "
  641:	      "same seed.",[Seed, 
  642:			    filename:join([WriteDir, "last_random_seed.txt"]),
  643:			    filename:join([ReadDir, 
  644:					    "preset_random_seed.txt"])]),
  645:    do_random_test().
  646:
<a name=do_random_test>  647:<b>do_random_test</b></a>() -&gt;
  648:    ?line OrdSet = ets:new(xxx,[ordered_set]),
  649:    ?line Set = ets:new(xxx,[]),
<a name="650"></a>  650:    ?line do_n_times(fun() -&gt;
  651:		       ?line Key = create_random_string(25),
  652:		       ?line Value = create_random_tuple(25),
  653:		       ?line ets:insert(OrdSet,{Key,Value}),
  654:		       ?line ets:insert(Set,{Key,Value})
  655:	       end, 5000),
  656:    ?line io:format("~nData inserted~n"),
  657:    ?line do_n_times(fun() -&gt;
  658:		       ?line I = random:uniform(25),
  659:		       ?line Key = create_random_string(I) ++ '_',
<a name="660"></a>  660:		       ?line L1 = ets_match_object(OrdSet,{Key,'_'}),
  661:		       ?line L2 = lists:sort(ets_match_object(Set,{Key,'_'})),
  662:		       case L1 == L2 of
  663:			   false -&gt;
  664:			       io:format("~p != ~p~n",
  665:					 [L1,L2]),
  666:			       ?line exit({not_eq, L1, L2});
  667:			   true -&gt;
  668:			       ok
  669:		       end
<a name="670"></a>  670:	       end,
  671:	       2000),
  672:    ?line io:format("~nData matched~n"),
  673:    ?line ets:match_delete(OrdSet,'_'),
  674:    ?line ets:match_delete(Set,'_'),
  675:    ?line do_n_times(fun() -&gt;
  676:		       ?line Value = create_random_string(25),
  677:		       ?line Key = create_random_tuple(25),
  678:		       ?line ets:insert(OrdSet,{Key,Value}),
  679:		       ?line ets:insert(Set,{Key,Value})
<a name="680"></a>  680:	       end, 2000),
  681:    ?line io:format("~nData inserted~n"),
  682:    (fun() -&gt;
  683:	     ?line Key = list_to_tuple(lists:duplicate(25,'_')),
  684:	     ?line L1 = ets_match_object(OrdSet,{Key,'_'}),
  685:	     ?line L2 = lists:sort(ets_match_object(Set,{Key,'_'})),
  686:	     ?line 2000 = length(L1),
  687:	     case L1 == L2 of
  688:		 false -&gt;
  689:		     io:format("~p != ~p~n",
<a name="690"></a>  690:			       [L1,L2]),
  691:		     ?line exit({not_eq, L1, L2});
  692:		 true -&gt;
  693:		     ok
  694:	     end
  695:     end)(),
  696:    (fun() -&gt;
  697:	     ?line Key = {'$1','$2','$3','$4',
  698:			  '$5','$6','$7','$8',
  699:			  '$9','$10','$11','$12',
<a name="700"></a>  700:			  '$13','$14','$15','$16',
  701:			  '$17','$18','$19','$20',
  702:			  '$21','$22','$23','$24',
  703:			  '$25'},
  704:	     ?line L1 = ets_match_object(OrdSet,{Key,'_'}),
  705:	     ?line L2 = lists:sort(ets_match_object(Set,{Key,'_'})),
  706:	     ?line 2000 = length(L1),
  707:	     case L1 == L2 of
  708:		 false -&gt;
  709:		     io:format("~p != ~p~n",
<a name="710"></a>  710:			       [L1,L2]),
  711:		     ?line exit({not_eq, L1, L2});
  712:		 true -&gt;
  713:		     ok
  714:	     end
  715:     end)(),
  716:    (fun() -&gt;
  717:	     ?line Key = {'$1','$2','$3','$4',
  718:			  '$5','$6','$7','$8',
  719:			  '$9','$10','$11','$12',
<a name="720"></a>  720:			  '$13','$14','$15','$16',
  721:			  '$17','$18','$19','$20',
  722:			  '$21','$22','$23','$24',
  723:			  '$25'},
  724:	     ?line L1 = ets_match(OrdSet,{Key,'_'}),
  725:	     ?line L2 = lists:sort(ets_match(Set,{Key,'_'})),
  726:	     ?line 2000 = length(L1),
  727:	     case L1 == L2 of
  728:		 false -&gt;
  729:		     io:format("~p != ~p~n",
<a name="730"></a>  730:			       [L1,L2]),
  731:		     ?line exit({not_eq, L1, L2});
  732:		 true -&gt;
  733:		     ok
  734:	     end
  735:     end)(),
  736:    ?line ets:match_delete(OrdSet,'_'),
  737:    ?line ets:match_delete(Set,'_'),
  738:    ?line do_n_times(fun() -&gt;
  739:		       ?line Value = create_random_string(25),
<a name="740"></a>  740:		       ?line Key = create_random_tuple(25),
  741:		       ?line ets:insert(OrdSet,{Key,Value}),
  742:		       ?line ets:insert(Set,{Key,Value})
  743:	       end, 2000),
  744:    ?line io:format("~nData inserted~n"),
  745:    do_n_times(fun() -&gt;
  746:		       ?line Key = create_partly_bound_tuple(25),
  747:		       ?line L1 = ets_match_object(OrdSet,{Key,'_'}),
  748:		       ?line L2 = lists:sort(ets_match_object(Set,{Key,'_'})),
  749:		       case L1 == L2 of
<a name="750"></a>  750:			   false -&gt;
  751:			       io:format("~p != ~p~n",
  752:					 [L1,L2]),
  753:			       ?line exit({not_eq, L1, L2});
  754:			   true -&gt;
  755:			       ok
  756:		       end
  757:	       end,
  758:	       2000),
  759:    ?line do_n_times(fun() -&gt;
<a name="760"></a>  760:		       ?line Key = create_partly_bound_tuple2(25),
  761:		       ?line L1 = ets_match_object(OrdSet,{Key,'_'}),
  762:		       ?line L2 = lists:sort(ets_match_object(Set,{Key,'_'})),
  763:		       case L1 == L2 of
  764:			   false -&gt;
  765:			       io:format("~p != ~p~n",
  766:					 [L1,L2]),
  767:			       ?line exit({not_eq, L1, L2});
  768:			   true -&gt;
  769:			       ok
<a name="770"></a>  770:		       end
  771:	       end,
  772:	       2000),
  773:    do_n_times(fun() -&gt;
  774:		       ?line Key = create_partly_bound_tuple2(25),
  775:		       ?line L1 = ets_match(OrdSet,{Key,'_'}),
  776:		       ?line L2 = lists:sort(ets_match(Set,{Key,'_'})),
  777:		       case L1 == L2 of
  778:			   false -&gt;
  779:			       io:format("~p != ~p~n",
<a name="780"></a>  780:					 [L1,L2]),
  781:			       ?line exit({not_eq, L1, L2});
  782:			   true -&gt;
  783:			       ok
  784:		       end
  785:	       end,
  786:	       2000),
  787:    io:format("~nData matched~n"),
  788:    ets:match_delete(OrdSet,'_'),
  789:    ets:match_delete(Set,'_'),
<a name="790"></a>  790:    do_n_times(fun() -&gt;
  791:		       do_n_times(fun() -&gt;
  792:					  ?line Value = 
  793:					      create_random_string(25),
  794:					  ?line Key = create_random_tuple(25),
  795:					  ?line ets:insert(OrdSet,{Key,Value}),
  796:					  ?line ets:insert(Set,{Key,Value})
  797:				  end, 500),
  798:		       io:format("~nData inserted~n"),
  799:		       do_n_times(fun() -&gt;
<a name="800"></a>  800:					  ?line Key = 
  801:					      create_partly_bound_tuple(25),
  802:					  ets:match_delete(OrdSet,{Key,'_'}),
  803:					  ets:match_delete(Set,{Key,'_'}),
  804:					  L1 = ets:info(OrdSet,size),
  805:					  L2 = ets:info(Set,size),
  806:					  [] = ets_match_object(OrdSet,
  807:								{Key,'_'}),
  808:					  case L1 == L2 of
  809:					      false -&gt;
<a name="810"></a>  810:						  io:format("~p != ~p "
  811:							    "(deleted ~p)~n",
  812:							    [L1,L2,Key]),
  813:						  exit({not_eq, L1, L2,
  814:							{deleted,Key}});
  815:					      true -&gt;
  816:						  ok
  817:					  end
  818:				  end,
  819:				  50),
<a name="820"></a>  820:		       io:format("~nData deleted~n")
  821:	       end,
  822:	       10),
  823:    ets:delete(OrdSet),
  824:    ets:delete(Set),
  825:    ok.
  826:
<a name=update_counter>  827:<b>update_counter</b></a>(doc) -&gt;
  828:    ["test various variants of update_counter"];
<a name=update_counter>  829:<b>update_counter</b></a>(suite) -&gt;
<a name="830"></a>  830:    [];
<a name=update_counter>  831:<b>update_counter</b></a>(Config) when list(Config) -&gt;
  832:    Set = ets:new(set,[]),
  833:    OrdSet = ets:new(ordered_set,[ordered_set]),
  834:    update_counter(Set,Config),
  835:    update_counter(OrdSet, Config),
  836:    ok.
  837:
<a name=update_counter>  838:<b>update_counter</b></a>(T,C) -&gt;
  839:    ?line ets:insert(T,{a,1,1}),
<a name="840"></a>  840:    ?line 101 = ets:update_counter(T,a,100),
  841:    ?line [{a,101,1}] = ets:lookup(T,a),
  842:    ?line 101 = ets:update_counter(T,a,{3,100}),
  843:    ?line [{a,101,101}] = ets:lookup(T,a),
  844:    ?line LoopF = fun(Initial, Times, Add, Tab, Key, Pos, Myself) -&gt;
  845:		    case Times of
  846:			0 -&gt;
  847:			    Initial;
  848:			N -&gt;
  849:			    NInitial = Initial + Add,
<a name="850"></a>  850:			    ?line NInitial = ets:update_counter(Tab,Key,
  851:								{Pos,Add}),
  852:			    ?line Myself(NInitial,N-1,Add,Tab,Key,Pos,Myself)
  853:		    end
  854:	    end,
  855:    ?line New2 =LoopF(101,100,10000000000,T,a,2,LoopF),
  856:    ?line New3 = LoopF(101,100,10000000000,T,a,3,LoopF),
  857:    ?line LoopF(New2,200,-20000000000,T,a,2,LoopF),
  858:    ?line LoopF(New3,20000,-20000,T,a,3,LoopF),
  859:    ?line LoopF2 = fun(Initial, Times, Add, Tab, Key, 
<a name="860"></a>  860:		       Pos, Thres, Warp, Myself) -&gt;
  861:		    case Times of
  862:			0 -&gt;
  863:			    Initial;
  864:			N -&gt;
  865:			    NInitial = case Initial + Add of
  866:					   X when X &gt; Thres, Add &gt; 0 -&gt;
  867:					       Warp;
  868:					   Y when Y &lt; Thres, Add &lt; 0 -&gt;
  869:					       Warp;
<a name="870"></a>  870:					   Z -&gt;
  871:					       Z
  872:				     end,
  873:			    %erlang:display({Initial,NInitial,Add,Thres}),
  874:			    ?line NInitial = ets:update_counter(Tab,Key,
  875:								{Pos,Add,
  876:								 Thres,Warp}),
  877:			    ?line Myself(NInitial,N-1,Add,Tab,Key,Pos,
  878:					 Thres, Warp, Myself)
  879:		    end
<a name="880"></a>  880:	    end,
  881:    ?line ets:insert(T,{a,101,101}),
  882:    ?line New4 =LoopF2(101,100,10000000000,T,a,2,100000000000,101,LoopF2),
  883:    ?line New5 = LoopF2(101,100,10000000000,T,a,3,100000000000,101,LoopF2),
  884:    ?line LoopF2(New4,200,-20000000000,T,a,2,-200000000000,New4,LoopF2),
  885:    ?line LoopF2(New5,20000,-20000,T,a,3,-200000,New5+1,LoopF2),
  886:    %?line ets:insert(T,{b,4712,50000}),
  887:    %?line 16#FFFFFFFF = ets:update_counter(T,b,{2,0,0,16#FFFFFFFF}),
  888:    %?line -16#FFFFFFFF = ets:update_counter(T,b,{3,0,0,-16#FFFFFFFF}),
  889:    ok.
<a name="890"></a>  890:		    
  891:
  892:
<a name=fixtable_next>  893:<b>fixtable_next</b></a>(doc) -&gt;
  894:    ["Check that a first-next sequence always works on a fixed table"];
<a name=fixtable_next>  895:<b>fixtable_next</b></a>(suite) -&gt;
  896:    [];
<a name=fixtable_next>  897:<b>fixtable_next</b></a>(Config) when list(Config) -&gt;
  898:    ?line do_fixtable_next(ets:new(set,[public])),
  899:    ?line do_fixtable_next(ets:new(ordered_set, [ordered_set,public])),
<a name="900"></a>  900:    ?line do_fixtable_next(ets:new(bag, [bag,public])),
  901:    ?line do_fixtable_next(ets:new(duplicate_bag, [duplicate_bag,public])),
  902:    ok.
  903:    
<a name=do_fixtable_next>  904:<b>do_fixtable_next</b></a>(Tab) -&gt;
  905:   ?line  F = fun(X,T,FF) -&gt; case X of 
  906:			   0 -&gt; true; 
  907:			   _ -&gt; 
  908:			       ets:insert(T, {X,
  909:					      integer_to_list(X),
<a name="910"></a>  910:					      X rem 10}),
  911:			       FF(X-1,T,FF) 
  912:		       end 
  913:	end,
  914:    ?line F(100,Tab,F),
  915:    ?line ets:fixtable(Tab,true),
  916:    ?line First = ets:first(Tab),
  917:    ?line ets:delete(Tab, First),
  918:    ?line ets:next(Tab, First),
  919:    ?line ets:match_delete(Tab,{'_','_','_'}),
<a name="920"></a>  920:    ?line '$end_of_table' = ets:next(Tab, First),
  921:    ?line true = ets:info(Tab, fixed),
  922:    ?line ets:fixtable(Tab, false),
  923:    ?line false = ets:info(Tab, fixed),
  924:    ?line ets:delete(Tab).
  925:
<a name=fixtable_insert>  926:<b>fixtable_insert</b></a>(doc) -&gt;    
  927:    ["Check inserts of deleted keys in fixed bag's"];
<a name=fixtable_insert>  928:<b>fixtable_insert</b></a>(suite) -&gt;
  929:    [];
<a name=fixtable_insert><a name="930"></a>  930:<b>fixtable_insert</b></a>(Config) when list(Config) -&gt;
  931:    Ets = make_table(ets, [bag], [{1,1}, {1,2}, {2,1}, {2,2}]),
  932:    ets:fixtable(Ets,true),
  933:    ets:match_delete(Ets,{2,1}),
  934:    2 = ets:first(Ets),
  935:    1 = ets:next(Ets,2),
  936:    ets:delete(Ets,1),
  937:    '$end_of_table' = ets:next(Ets,2),
  938:    ets:insert(Ets, {1,1}),
  939:    1 = ets:next(Ets,2),
<a name="940"></a>  940:    '$end_of_table' = ets:next(Ets,1),
  941:    ets:delete(Ets,1),
  942:    '$end_of_table' = ets:next(Ets,2),
  943:    ets:insert(Ets, {1,2}),
  944:    1 = ets:next(Ets,2),
  945:    '$end_of_table' = ets:next(Ets,1),
  946:    ets:delete(Ets,1),
  947:    '$end_of_table' = ets:next(Ets,2),
  948:    ets:delete(Ets,2),
  949:    '$end_of_table' = ets:next(Ets,2),
<a name="950"></a>  950:    ets:fixtable(Ets,false),
  951:    {'EXIT',{badarg,_}} = (catch ets:next(Ets,2)),
  952:    ok.
  953:    
<a name=rename>  954:<b>rename</b></a>(doc) -&gt;
  955:    ["Check rename of ets tables"];
<a name=rename>  956:<b>rename</b></a>(suite) -&gt;
  957:    [];
<a name=rename>  958:<b>rename</b></a>(Config) when list(Config) -&gt;
  959:    ets:new(foobazz,[named_table, public]),
<a name="960"></a>  960:    ets:insert(foobazz,{foo,bazz}),
  961:    ets:rename(foobazz,ungermanbazz),
  962:    {'EXIT',{badarg, _}} = (catch ets:lookup(foobazz,foo)),
  963:    [{foo,bazz}] = ets:lookup(ungermanbazz,foo),
  964:    ets:delete(ungermanbazz),
  965:    ok.
  966:
<a name=interface_equality>  967:<b>interface_equality</b></a>(doc) -&gt;
  968:    ["Tests that the return values and errors are equal for set's and"
  969:     " ordered_set's where applicable"];
<a name=interface_equality><a name="970"></a>  970:<b>interface_equality</b></a>(suite) -&gt;
  971:    [];
<a name=interface_equality>  972:<b>interface_equality</b></a>(Config) when list(Config) -&gt;
  973:    ?line Set = ets:new(set,[set]),
  974:    ?line OrderedSet = ets:new(ordered_set,[ordered_set]),
  975:    ?line F = fun(X,T,FF) -&gt; case X of 
  976:			   0 -&gt; true; 
  977:			   _ -&gt; 
  978:			       ets:insert(T, {X,
  979:					      integer_to_list(X),
<a name="980"></a>  980:					      X rem 10}),
  981:			       FF(X-1,T,FF) 
  982:		       end 
  983:	end,
  984:    ?line F(100,Set,F),
  985:    ?line F(100,OrderedSet,F),
  986:    ?line equal_results(ets, insert, Set, OrderedSet, [{a,"a"}]),
  987:    ?line equal_results(ets, insert, Set, OrderedSet, [{1,1,"1"}]),
  988:    ?line equal_results(ets, lookup, Set, OrderedSet, [10]),
  989:    ?line equal_results(ets, lookup, Set, OrderedSet, [1000]),
<a name="990"></a>  990:    ?line equal_results(ets, delete, Set, OrderedSet, [10]),
  991:    ?line equal_results(ets, delete, Set, OrderedSet, [nott]),
  992:    ?line equal_results(ets, lookup, Set, OrderedSet, [1000]),
  993:    ?line equal_results(ets, insert, Set, OrderedSet, [10]),
  994:    ?line equal_results(ets, next, Set, OrderedSet, ['$end_of_table']),
  995:    ?line equal_results(ets, prev, Set, OrderedSet, ['$end_of_table']),
  996:    ?line equal_results(ets, match, Set, OrderedSet, [{'_','_','_'}]),
  997:    ?line equal_results(ets, match, Set, OrderedSet, [{'_','_','_','_'}]),
  998:    ?line equal_results(ets, match, Set, OrderedSet, [{$3,$2,2}]),
  999:    ?line equal_results(ets, match, Set, OrderedSet, ['_']),
<a name="1000"></a> 1000:    ?line equal_results(ets, match, Set, OrderedSet, ['$1']),
 1001:    ?line equal_results(ets, match, Set, OrderedSet, [{'_','$50',3}]),
 1002:    ?line equal_results(ets, match, Set, OrderedSet, [['_','$50',3]]),
 1003:    ?line equal_results(ets, match_delete, Set, OrderedSet, [{'_','_',4}]),
 1004:    ?line equal_results(ets, match_delete, Set, OrderedSet, [{'_','_',4}]),
 1005:    ?line equal_results(ets, match_object, Set, OrderedSet, [{'_','_',4}]),
 1006:    ?line equal_results(ets, match_object, Set, OrderedSet, [{'_','_',5}]),
 1007:    ?line equal_results(ets, match_object, Set, OrderedSet, [{'_','_',4}]),
 1008:    ?line equal_results(ets, match_object, Set, OrderedSet, ['_']),
 1009:    ?line equal_results(ets, match_object, Set, OrderedSet, ['$5011']),
<a name="1010"></a> 1010:    ?line equal_results(ets, match_delete, Set, OrderedSet, ['$20']),
 1011:    ?line equal_results(ets, lookup_element, Set, OrderedSet, [13,2]),
 1012:    ?line equal_results(ets, lookup_element, Set, OrderedSet, [13,4]),
 1013:    ?line equal_results(ets, lookup_element, Set, OrderedSet, [14,2]),
 1014:    ?line equal_results(ets, delete, Set, OrderedSet, []),
 1015:    ok.
 1016:
<a name=equal_results> 1017:<b>equal_results</b></a>(M, F, FirstArg1, FirstArg2 ,ACommon) -&gt;
 1018:    Res = maybe_sort((catch apply(M,F, [FirstArg1 | ACommon]))),
 1019:    Res = maybe_sort((catch apply(M,F,[FirstArg2 | ACommon]))).
<a name="1020"></a> 1020:
<a name=maybe_sort> 1021:<b>maybe_sort</b></a>(L) when list(L) -&gt;
 1022:    lists:sort(L);
 1023:<i>%maybe_sort({'EXIT',{Reason, [{Module, Function, _}|_]}}) -&gt;</i>
 1024:<i>%    {'EXIT',{Reason, [{Module, Function, '_'}]}};</i>
<a name=maybe_sort> 1025:<b>maybe_sort</b></a>({'EXIT',{Reason, List}}) when list(List) -&gt;
 1026:    {'EXIT',{Reason, lists:map(fun({Module, Function, _}) -&gt;
 1027:				       {Module, Function, '_'}
 1028:			       end,
 1029:			       List)}};
<a name=maybe_sort><a name="1030"></a> 1030:<b>maybe_sort</b></a>(Any) -&gt;
 1031:    Any.
 1032:
<a name=ordered_match> 1033:<b>ordered_match</b></a>(doc) -&gt;
 1034:    ["Test match, match_object and match_delete in ordered set's"];
<a name=ordered_match> 1035:<b>ordered_match</b></a>(suite) -&gt;
 1036:    [];
<a name=ordered_match> 1037:<b>ordered_match</b></a>(Config) when list(Config)-&gt;
 1038:    ?line F = fun(X,T,FF) -&gt; case X of 
 1039:			 0 -&gt; true; 
<a name="1040"></a> 1040:			 _ -&gt; 
 1041:			     ets:insert(T, {X,
 1042:					    integer_to_list(X), 
 1043:					    X rem 10,
 1044:					    X rem 100,
 1045:					    X rem 1000}), 
 1046:			     FF(X-1,T,FF) 
 1047:		     end 
 1048:	end,
 1049:    ?line T1 = ets:new(xxx,[ordered_set]),
<a name="1050"></a> 1050:    ?line F(3000,T1,F),
 1051:    ?line [[3,3],[3,3],[3,3]] = ets:match(T1, {'_','_','$1','$2',3}),
 1052:    ?line F2 = fun(X,Rem,Res,FF) -&gt; case X of 
 1053:				  0 -&gt; []; 
 1054:				  _ -&gt; 
 1055:				      case X rem Rem of
 1056:					  Res -&gt;
 1057:					      FF(X-1,Rem,Res,FF) ++
 1058:						  [{X,
 1059:						    integer_to_list(X), 
<a name="1060"></a> 1060:						    X rem 10,
 1061:						    X rem 100,
 1062:						    X rem 1000}];
 1063:					  _ -&gt;
 1064:					      FF(X-1,Rem,Res,FF)
 1065:				      end
 1066:			      end 
 1067:	 end,
 1068:    ?line OL1 = F2(3000,100,2,F2),
 1069:    ?line OL1 = ets:match_object(T1, {'_','_','_',2,'_'}),
<a name="1070"></a> 1070:    ?line true = ets:match_delete(T1,{'_','_','_',2,'_'}), 
 1071:    ?line [] = ets:match_object(T1, {'_','_','_',2,'_'}),
 1072:    ?line OL2 = F2(3000,100,3,F2),
 1073:    ?line OL2 = ets:match_object(T1, {'_','_','_',3,'_'}),
 1074:    ?line ets:delete(T1),
 1075:    ok.
 1076:    
 1077:
<a name=ordered> 1078:<b>ordered</b></a>(doc) -&gt;
 1079:    ["Test basic functionality in ordered_set's."];
<a name=ordered><a name="1080"></a> 1080:<b>ordered</b></a>(suite) -&gt;
 1081:    [];
<a name=ordered> 1082:<b>ordered</b></a>(Config) when list(Config) -&gt;
 1083:    ?line T = ets:new(oset, [ordered_set]),
 1084:    ?line InsList = [ 
 1085:		      25,26,27,28,
 1086:		      5,6,7,8,
 1087:		      21,22,23,24,
 1088:		      9,10,11,12,
 1089:		      1,2,3,4,
<a name="1090"></a> 1090:		      17,18,19,20,
 1091:		      13,14,15,16
 1092:		     ],
 1093:    ?line lists:foreach(fun(X) -&gt;
 1094:			  ets:insert(T,{X,integer_to_list(X)})
 1095:		  end,
 1096:		  InsList),
 1097:    ?line IL2 = lists:map(fun(X) -&gt; {X,integer_to_list(X)} end, InsList),
 1098:    ?line L1 = pick_all_forward(T),
 1099:    ?line L2 = pick_all_backwards(T),
<a name="1100"></a> 1100:    ?line S1 = lists:sort(IL2),
 1101:    ?line S2 = lists:reverse(lists:sort(IL2)),
 1102:    ?line S1 = L1,
 1103:    ?line S2 = L2,
 1104:    ?line [{1,"1"}] = ets:slot(T,0),
 1105:    ?line [{28,"28"}] = ets:slot(T,27),
 1106:    ?line 27 = ets:prev(T,28),
 1107:    ?line [{7,"7"}] = ets:slot(T,6),
 1108:    ?line '$end_of_table' = ets:next(T,28),
 1109:    ?line [{12,"12"}] = ets:slot(T,11),
<a name="1110"></a> 1110:    ?line '$end_of_table' = ets:slot(T,28),
 1111:    ?line [{1,"1"}] = ets:slot(T,0),
 1112:    ?line 28 = ets:prev(T,29),
 1113:    ?line 1 = ets:next(T,0),
 1114:    ?line pick_all_forward(T),
 1115:    ?line [{7,"7"}] = ets:slot(T,6),
 1116:    ?line L2 = pick_all_backwards(T),
 1117:    ?line [{7,"7"}] = ets:slot(T,6),
 1118:    ok.
 1119:
<a name=pick_all><a name="1120"></a> 1120:<b>pick_all</b></a>(T,'$end_of_table',How) -&gt;
 1121:    [];
<a name=pick_all> 1122:<b>pick_all</b></a>(T,Last,How) -&gt;
 1123:    ?line This = case How of
 1124:	       next -&gt;
 1125:		   ?line ets:next(T,Last);
 1126:	       prev -&gt;
 1127:		   ?line ets:prev(T,Last)
 1128:	   end,
 1129:    ?line [LastObj] = ets:lookup(T,Last),
<a name="1130"></a> 1130:    ?line [LastObj | pick_all(T,This,How)].
 1131:
<a name=pick_all_forward> 1132:<b>pick_all_forward</b></a>(T) -&gt;
 1133:    ?line pick_all(T,ets:first(T),next).
<a name=pick_all_backwards> 1134:<b>pick_all_backwards</b></a>(T) -&gt;
 1135:    ?line pick_all(T,ets:last(T),prev).
 1136:    
 1137:    
 1138:
<a name=setbag> 1139:<b>setbag</b></a>(doc) -&gt;   ["Small test case for both set and bag type ets tables."];
<a name=setbag><a name="1140"></a> 1140:<b>setbag</b></a>(suite) -&gt; [];
<a name=setbag> 1141:<b>setbag</b></a>(Config) when list(Config) -&gt;    
 1142:    ?line Set = ets:new(set,[set]),
 1143:    ?line Bag = ets:new(bag,[bag]),
 1144:    ?line Key = {foo,bar},
 1145:    
 1146:    %% insert some value
 1147:    ?line ets:insert(Set,{Key,val1}),
 1148:    ?line ets:insert(Bag,{Key,val1}),
 1149:    
<a name="1150"></a> 1150:    %% insert new value for same key again
 1151:    ?line ets:insert(Set,{Key,val2}),
 1152:    ?line ets:insert(Bag,{Key,val2}),
 1153:    
 1154:    %% check
 1155:    ?line [{Key,val2}] = ets:lookup(Set,Key),
 1156:    ?line case ets:lookup(Bag,Key) of
 1157:	[{Key,val1},{Key,val2}] -&gt;
 1158:	    ok;
 1159:	[{Key,val2},{Key,val1}] -&gt;
<a name="1160"></a> 1160:	    ok
 1161:    end,
 1162:    ok.
 1163:
<a name=badnew> 1164:<b>badnew</b></a>(doc) -&gt;
 1165:    ["Test case to check proper return values for illegal ets:new() calls."];
<a name=badnew> 1166:<b>badnew</b></a>(suite) -&gt; [];
<a name=badnew> 1167:<b>badnew</b></a>(Config) when list(Config) -&gt;
 1168:    ?line {'EXIT',{badarg,_}} = (catch ets:new(12,[])),
 1169:    ?line {'EXIT',{badarg,_}} = (catch ets:new({a,b},[])),
<a name="1170"></a> 1170:    ?line {'EXIT',{badarg,_}} = (catch ets:new(name,[foo])),
 1171:    ok.
 1172:
<a name=verybadnew> 1173:<b>verybadnew</b></a>(doc) -&gt;
 1174:    ["Test case to check that a not well formed list does not crash the "
 1175:     "emulator. OTP-2314 "];
<a name=verybadnew> 1176:<b>verybadnew</b></a>(suite) -&gt; [];
<a name=verybadnew> 1177:<b>verybadnew</b></a>(Config) when list(Config) -&gt;
 1178:    ?line {'EXIT',{badarg,_}} = (catch ets:new(verybad,[set|protected])),
 1179:    ok.
<a name="1180"></a> 1180:
<a name=named> 1181:<b>named</b></a>(doc) -&gt;   ["Small check to see if named tables work."];
<a name=named> 1182:<b>named</b></a>(suite) -&gt; [];
<a name=named> 1183:<b>named</b></a>(Config) when list(Config) -&gt;
 1184:    ?line Tab = make_table(foo,
 1185:			   [named_table],
 1186:			   [{key,val}]),
 1187:    ?line [{key,val}] = ets:lookup(foo,key),
 1188:    ok.
 1189:
<a name=keypos2><a name="1190"></a> 1190:<b>keypos2</b></a>(doc) -&gt;   ["Test case to check if specified keypos works."];
<a name=keypos2> 1191:<b>keypos2</b></a>(suite) -&gt; [];
<a name=keypos2> 1192:<b>keypos2</b></a>(Config) when list(Config) -&gt;
 1193:    ?line Tab = make_table(foo,
 1194:			   [set,{keypos,2}],
 1195:			   [{val,key}, {val2,key}]),
 1196:    ?line [{val2,key}] = ets:lookup(Tab,key),
 1197:    ok.
 1198:
<a name=privacy> 1199:<b>privacy</b></a>(doc) -&gt;
<a name="1200"></a> 1200:    ["Privacy check. Check that a named(public/private/protected) table "
 1201:     "cannot be read by",
 1202:     "the wrong process(es)."];
<a name=privacy> 1203:<b>privacy</b></a>(suite) -&gt; [];
<a name=privacy> 1204:<b>privacy</b></a>(Config) when list(Config) -&gt;
 1205:    ?line process_flag(trap_exit,true),
 1206:    ?line Nosy = spawn_link(?MODULE,nosy,[self()]),
 1207:    receive
 1208:	{'EXIT',Nosy,Reason} -&gt;
 1209:	    ?line exit({privacy_test,Reason});
<a name="1210"></a> 1210:	ok -&gt;
 1211:	    ok
 1212:    end,
 1213:
 1214:    %% check read rights
 1215:    ?line [] = ets:lookup(pub, foo),
 1216:    ?line [] = ets:lookup(prot,foo),
 1217:    ?line {'EXIT',{badarg,_}} = (catch ets:lookup(priv,foo)),
 1218:
 1219:    %% check write rights
<a name="1220"></a> 1220:    ?line true = ets:insert(pub, {1,foo}),
 1221:    ?line {'EXIT',{badarg,_}} = (catch ets:insert(prot,{2,foo})),
 1222:    ?line {'EXIT',{badarg,_}} = (catch ets:insert(priv,{3,foo})),
 1223:
 1224:    %% check that it really wasn't written, either
 1225:    ?line [] = ets:lookup(prot,foo),
 1226:
 1227:    Nosy ! die,
 1228:    receive
 1229:	{'EXIT',Nosy,_} -&gt;
<a name="1230"></a> 1230:	    ok
 1231:    end,
 1232:    ok.
 1233:
<a name=nosy> 1234:<b>nosy</b></a>(Boss) -&gt;
 1235:    Pub  = ets:new(pub, [public,named_table]),
 1236:    Prot = ets:new(prot,[protected,named_table]),
 1237:    Priv = ets:new(priv,[private,named_table]),
 1238:    Boss ! ok,
 1239:    receive
<a name="1240"></a> 1240:	die -&gt;
 1241:	    ok
 1242:    end.
 1243:
 1244:<i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
 1245:
<a name=insert> 1246:<b>insert</b></a>(doc) -&gt;   ["Test proper and improper inserts into a table."];
<a name=insert> 1247:<b>insert</b></a>(suite) -&gt; [empty,badinsert].
 1248:
<a name=empty> 1249:<b>empty</b></a>(doc) -&gt;
<a name="1250"></a> 1250:    ["Check lookup in an empty table and lookup of a non-existing key"];
<a name=empty> 1251:<b>empty</b></a>(suite) -&gt; [];
<a name=empty> 1252:<b>empty</b></a>(Config) when list(Config) -&gt;
 1253:    ?line Tab = ets:new(foo,[]),
 1254:    ?line [] = ets:lookup(Tab,key),
 1255:    ?line true = ets:insert(Tab,{key2,val}),
 1256:    ?line [] = ets:lookup(Tab,key),
 1257:    ok.
 1258:
<a name=badinsert> 1259:<b>badinsert</b></a>(doc) -&gt;
<a name="1260"></a> 1260:    ["Check proper return values for illegal insert operations."];
<a name=badinsert> 1261:<b>badinsert</b></a>(suite) -&gt; [];
<a name=badinsert> 1262:<b>badinsert</b></a>(Config) when list(Config) -&gt;
 1263:    ?line {'EXIT',{badarg,_}} = (catch ets:insert(foo,{key,val})),
 1264:    
 1265:    ?line Tab = ets:new(foo,[]),
 1266:    ?line {'EXIT',{badarg,_}} = (catch ets:insert(Tab,{})),
 1267:
 1268:    ?line Tab3 = ets:new(foo,[{keypos,3}]),
 1269:    ?line {'EXIT',{badarg,_}} = (catch ets:insert(Tab3,{a,b})),
<a name="1270"></a> 1270:
 1271:    ?line {'EXIT',{badarg,_}} = (catch ets:insert(Tab,[key,val2])),
 1272:    ok.
 1273:
 1274:<i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
 1275:
<a name=lookup> 1276:<b>lookup</b></a>(doc) -&gt; ["Some tests for lookups (timing, bad lookups, etc.)."];
<a name=lookup> 1277:<b>lookup</b></a>(suite) -&gt; [time_lookup,badlookup].
 1278:
<a name=time_lookup> 1279:<b>time_lookup</b></a>(doc) -&gt;   ["Lookup timing."];
<a name=time_lookup><a name="1280"></a> 1280:<b>time_lookup</b></a>(suite) -&gt; [];
<a name=time_lookup> 1281:<b>time_lookup</b></a>(Config) when list(Config) -&gt;
 1282:    %% just for timing, really
 1283:    ?line Tab = ets:new(foo,[]),
 1284:    ?line fill_tab(Tab,foo),
 1285:    ?line ets:insert(Tab,{{a,key},foo}),
 1286:    ?line {Time,_} = ?t:timecall(test_server,do_times,
 1287:				    [10000,ets,lookup,[Tab,{a,key}]]),
 1288:    ?line {comment,lists:flatten(io_lib:format(
 1289:				   "~.1f ets lookups/s",[10000/Time]))}.
<a name="1290"></a> 1290:
<a name=badlookup> 1291:<b>badlookup</b></a>(doc) -&gt;
 1292:    ["Check proper return values from bad lookups in existing/non existing "
 1293:     " ets tables"];
<a name=badlookup> 1294:<b>badlookup</b></a>(suite) -&gt; [];
<a name=badlookup> 1295:<b>badlookup</b></a>(Config) when list(Config) -&gt;
 1296:    ?line {'EXIT',{badarg,_}} = (catch ets:lookup(foo,key)),
 1297:    
 1298:    ?line Tab = ets:new(foo,[]),
 1299:    ?line ets:delete(Tab),
<a name="1300"></a> 1300:    ?line {'EXIT',{badarg,_}} = (catch ets:lookup(Tab,key)),
 1301:    ok.
 1302:
<a name=fill_tab> 1303:<b>fill_tab</b></a>(Tab,Val) -&gt;
 1304:    ?line ets:insert(Tab,{key,Val}),
 1305:    ?line ets:insert(Tab,{{a,144},Val}),
 1306:    ?line ets:insert(Tab,{{a,key2},Val}),
 1307:    ?line ets:insert(Tab,{14,Val}).
 1308:
 1309:<i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="1310"></a> 1310:
<a name=lookup_element> 1311:<b>lookup_element</b></a>(doc) -&gt; ["Some tests for lookup_element."];
<a name=lookup_element> 1312:<b>lookup_element</b></a>(suite) -&gt; [lookup_element_mult].
 1313:
<a name=lookup_element_mult> 1314:<b>lookup_element_mult</b></a>(doc) -&gt;   ["Multiple return elements (OTP-2386)"];
<a name=lookup_element_mult> 1315:<b>lookup_element_mult</b></a>(suite) -&gt; [];
<a name=lookup_element_mult> 1316:<b>lookup_element_mult</b></a>(Config) when list(Config) -&gt;
 1317:    ?line T = ets:new(service, [bag, {keypos, 2}]),
 1318:    ?line D = lists:reverse(lem_data()),
 1319:    ?line lists:foreach(fun(X) -&gt; ets:insert(T, X) end, D),
<a name="1320"></a> 1320:    ?line ok = lem_crash_3(T).
 1321:
 1322:
<a name=lem_data> 1323:<b>lem_data</b></a>() -&gt;
 1324:    [
 1325:     {service,'eddie2@boromir',{150,236,14,103},httpd88,self()},
 1326:     {service,'eddie2@boromir',{150,236,14,103},httpd80,self()},
 1327:     {service,'eddie3@boromir',{150,236,14,107},httpd88,self()},
 1328:     {service,'eddie3@boromir',{150,236,14,107},httpd80,self()},
 1329:     {service,'eddie4@boromir',{150,236,14,108},httpd88,self()}
<a name="1330"></a> 1330:    ].
 1331:
<a name=lem_crash> 1332:<b>lem_crash</b></a>(T) -&gt;
 1333:    L = ets:lookup_element(T, 'eddie2@boromir', 3),
 1334:    {erlang:hash(L, 256), L}.
 1335:
<a name=lem_crash_3> 1336:<b>lem_crash_3</b></a>(T) -&gt;
 1337:    lem_crash(T),
 1338:    io:format("Survived once~n"),
 1339:    lem_crash(T),
<a name="1340"></a> 1340:    io:format("Survived twice~n"),
 1341:    lem_crash(T),
 1342:    io:format("Survived all!~n"),
 1343:    ok.
 1344:
 1345:<i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
 1346:
<a name=delete> 1347:<b>delete</b></a>(doc) -&gt; ["Check delete functionality (proper/improper deletes)"];
<a name=delete> 1348:<b>delete</b></a>(suite) -&gt; [delete_elem,delete_tab,baddelete,match_delete,match_delete3].
 1349:
<a name=delete_elem><a name="1350"></a> 1350:<b>delete_elem</b></a>(doc) -&gt;
 1351:    ["Check delete of an element inserted in a `filled' table."];
<a name=delete_elem> 1352:<b>delete_elem</b></a>(suite) -&gt; [];
<a name=delete_elem> 1353:<b>delete_elem</b></a>(Config) when list(Config) -&gt;
 1354:    Types = [set, bag, duplicate_bag, ordered_set],
 1355:    delete_elem2(Types).
<a name=delete_elem2> 1356:<b>delete_elem2</b></a>([]) -&gt;
 1357:    ok;
<a name=delete_elem2> 1358:<b>delete_elem2</b></a>([Type|Tail]) -&gt;
 1359:    ?line Tab = ets:new(foo,[Type]),
<a name="1360"></a> 1360:    ?line fill_tab(Tab,foo),
 1361:    ?line ets:insert(Tab,{{b,key},foo}),
 1362:    ?line ets:insert(Tab,{{c,key},foo}),
 1363:    ?line true = ets:delete(Tab,{b,key}),
 1364:    ?line [] = ets:lookup(Tab,{b,key}),
 1365:    ?line [{{c,key},foo}] = ets:lookup(Tab,{c,key}),
 1366:    delete_elem2(Tail).
 1367:    
<a name=delete_tab> 1368:<b>delete_tab</b></a>(doc) -&gt;
 1369:    ["Check that ets:delete() works and releases the name of the deleted "
<a name="1370"></a> 1370:     "table."];
<a name=delete_tab> 1371:<b>delete_tab</b></a>(suite) -&gt; [];
<a name=delete_tab> 1372:<b>delete_tab</b></a>(Config) when list(Config) -&gt;
 1373:    ?line Nam1 = ets:new(foo,[named_table]),
 1374:    ?line true = ets:delete(foo),
 1375:    %% name should be available again, now
 1376:    ?line Nam2 = ets:new(foo,[named_table]),
 1377:    ?line true = ets:delete(Nam2),
 1378:    ok.
 1379:
<a name=baddelete><a name="1380"></a> 1380:<b>baddelete</b></a>(doc) -&gt;
 1381:    ["Check proper return values for illegal delete operations."];
<a name=baddelete> 1382:<b>baddelete</b></a>(suite) -&gt; [];
<a name=baddelete> 1383:<b>baddelete</b></a>(Config) when list(Config) -&gt;
 1384:    ?line {'EXIT',{badarg,_}} = (catch ets:delete(foo)),
 1385:    ?line Tab = ets:new(foo,[]),
 1386:    ?line true = ets:delete(Tab),
 1387:    ?line {'EXIT',{badarg,_}} = (catch ets:delete(Tab)),
 1388:    ok.
 1389:
<a name=match_delete><a name="1390"></a> 1390:<b>match_delete</b></a>(doc) -&gt;
 1391:    ["Check that match_delete works. Also tests tab2list function."];
<a name=match_delete> 1392:<b>match_delete</b></a>(suite) -&gt; [];    
<a name=match_delete> 1393:<b>match_delete</b></a>(Config) when list(Config) -&gt;
 1394:    Types = [set, bag, duplicate_bag, ordered_set],
 1395:    match_delete2(Types).
 1396:
<a name=match_delete2> 1397:<b>match_delete2</b></a>([]) -&gt; ok;
<a name=match_delete2> 1398:<b>match_delete2</b></a>([Type|Tail]) -&gt;
 1399:    ?line Tab = ets:new(kad,[Type]),
<a name="1400"></a> 1400:    ?line fill_tab(Tab,foo),
 1401:    ?line ets:insert(Tab,{{c,key},bar}),
 1402:    ?line _ = ets:match_delete(Tab,{'_',foo}),
 1403:    ?line [{{c,key},bar}] = ets:tab2list(Tab),
 1404:    ?line _ = ets:match_delete(Tab,'_'),
 1405:    ?line [] = ets:tab2list(Tab),
 1406:    ?line true = ets:delete(Tab),
 1407:    match_delete2(Tail).
 1408:
<a name=match_delete3> 1409:<b>match_delete3</b></a>(doc) -&gt;
<a name="1410"></a> 1410:    ["OTP-3005: check match_delete with constant argument."];
<a name=match_delete3> 1411:<b>match_delete3</b></a>(suite) -&gt; [];    
<a name=match_delete3> 1412:<b>match_delete3</b></a>(Config) when list(Config) -&gt;
 1413:    T = make_table(test,
 1414:		   [duplicate_bag],
 1415:		   [{aa,17},
 1416:		    {cA,1000},
 1417:		    {cA,17},
 1418:		    {cA,1000},
 1419:		    {aa,17}]),
<a name="1420"></a> 1420:    %% 'aa' and 'cA' have the same hash value in the current
 1421:    %% implementation. This causes the aa's to precede the cA's, to make
 1422:    %% the test more interesting.
 1423:    [{cA,1000},{cA,1000}] = ets:match_object(T, {'_', 1000}),
 1424:    ets:match_delete(T, {cA,1000}),
 1425:    [] = ets:match_object(T, {'_', 1000}),
 1426:    ets:delete(T),
 1427:    true.
 1428:
 1429:
<a name="1430"></a> 1430:<i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
 1431:
<a name=firstnext> 1432:<b>firstnext</b></a>(doc) -&gt; ["Tests ets:first/1 &amp; ets:next/2."];
<a name=firstnext> 1433:<b>firstnext</b></a>(suite) -&gt; [];
<a name=firstnext> 1434:<b>firstnext</b></a>(Config) when list(Config) -&gt;
 1435:    ?line Tab = ets:new(foo,[]),
 1436:    ?line [] = firstnext_collect(Tab,ets:first(Tab),[]),
 1437:    ?line fill_tab(Tab,foo),
 1438:    ?line Len = length(ets:tab2list(Tab)),
 1439:    ?line Len = length(firstnext_collect(Tab,ets:first(Tab),[])),
<a name="1440"></a> 1440:    ok.
 1441:
<a name=firstnext_collect> 1442:<b>firstnext_collect</b></a>(Tab,'$end_of_table',List) -&gt;
 1443:    ?line List;
<a name=firstnext_collect> 1444:<b>firstnext_collect</b></a>(Tab,Key,List) -&gt;
 1445:    ?line firstnext_collect(Tab,ets:next(Tab,Key),[Key|List]).
 1446:
 1447:<i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
 1448:
<a name=all_2214> 1449:<b>all_2214</b></a>(doc) -&gt;
<a name="1450"></a> 1450:    ["all/1's result should not contain 'undefined' (OTP-2214)"];
<a name=all_2214> 1451:<b>all_2214</b></a>(suite) -&gt;
 1452:    [];
<a name=all_2214> 1453:<b>all_2214</b></a>(Config) when list(Config) -&gt;
 1454:    ?line Pid = spawn(?MODULE, do0_2214, []),
 1455:    ?line ok = check_2214(1),
 1456:    ?line exit(Pid, done),			%kill off the ets tables
 1457:    ok.
 1458:
<a name=do0_2214> 1459:<b>do0_2214</b></a>() -&gt;
<a name="1460"></a> 1460:    spawn_link(?MODULE, do1_2214, [self()]).
 1461:
<a name=do_2214> 1462:<b>do_2214</b></a>(Pid) -&gt;
 1463:    spawn_link(?MODULE, do1_2214, [Pid]).
 1464:
<a name=do1_2214> 1465:<b>do1_2214</b></a>(Pid) -&gt;
 1466:    ets:new(fnaff, [bag]),
 1467:    receive
 1468:    after 2000 -&gt; ok
 1469:    end,
<a name="1470"></a> 1470:    do_2214(Pid).
 1471:
<a name=check_2214> 1472:<b>check_2214</b></a>(I) when I &gt; 100000 -&gt;
 1473:    ok;
<a name=check_2214> 1474:<b>check_2214</b></a>(I) -&gt;
 1475:    A = ets:all(),
 1476:    case undef_check(A, A) of
 1477:	true -&gt;
 1478:	    {fail, I, A};
 1479:	false -&gt;
<a name="1480"></a> 1480:	    check_2214(I+1)
 1481:    end.
 1482:
<a name=undef_check> 1483:<b>undef_check</b></a>([], L) -&gt;
 1484:    false;
<a name=undef_check> 1485:<b>undef_check</b></a>([{T, undefined} | _], L) -&gt;
 1486:    true;
<a name=undef_check> 1487:<b>undef_check</b></a>([_ | Rest], L) -&gt;
 1488:    undef_check(Rest, L).
 1489:
<a name="1490"></a> 1490:<i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
 1491:
<a name=slot> 1492:<b>slot</b></a>(suite) -&gt; [];
<a name=slot> 1493:<b>slot</b></a>(Config) when list(Config) -&gt;
 1494:    ?line Tab = ets:new(foo,[]),
 1495:    ?line fill_tab(Tab,foo),
 1496:    ?line Elts = ets:info(Tab,size),
 1497:    ?line Elts = slot_loop(Tab,0,0),
 1498:    ok.
 1499:
<a name=slot_loop><a name="1500"></a> 1500:<b>slot_loop</b></a>(Tab,SlotNo,EltsSoFar) -&gt;
 1501:    ?line case ets:slot(Tab,SlotNo) of
 1502:	      '$end_of_table' -&gt;
 1503:		  ?line {'EXIT',{badarg,_}} =
 1504:		      (catch ets:slot(Tab,SlotNo+1)),
 1505:		  ?line EltsSoFar;
 1506:	      Elts -&gt;
 1507:		  ?line slot_loop(Tab,SlotNo+1,EltsSoFar+length(Elts))
 1508:    end.
 1509:
<a name="1510"></a> 1510:<i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
 1511:
<a name=match> 1512:<b>match</b></a>(suite) -&gt; [match1, match2, match_object, match_object2].
 1513:
<a name=match1> 1514:<b>match1</b></a>(suite) -&gt; [];
<a name=match1> 1515:<b>match1</b></a>(Config) when list(Config) -&gt;
 1516:    ?line Tab = ets:new(foo,[]),
 1517:    ?line fill_tab(Tab,foo),
 1518:    ?line [] = ets:match(Tab,{}),
 1519:    ?line ets:insert(Tab,{{one,4},4}),
<a name="1520"></a> 1520:    ?line ets:insert(Tab,{{one,5},5}),
 1521:    ?line ets:insert(Tab,{{two,4},4}),
 1522:    ?line ets:insert(Tab,{{two,5},6}),
 1523:    ?line case ets:match(Tab,{{one,'_'},'$0'}) of
 1524:	      [[4],[5]] -&gt; ok;
 1525:	      [[5],[4]] -&gt; ok
 1526:	  end,
 1527:    ?line case ets:match(Tab,{{two,'$1'},'$0'}) of
 1528:	      [[4,4],[6,5]] -&gt; ok;
 1529:	      [[6,5],[4,4]] -&gt; ok
<a name="1530"></a> 1530:	  end,
 1531:    ?line case ets:match(Tab,{{two,'$9'},'$4'}) of
 1532:	      [[4,4],[6,5]] -&gt; ok;
 1533:	      [[6,5],[4,4]] -&gt; ok
 1534:	  end,
 1535:    ?line case ets:match(Tab,{{two,'$9'},'$22'}) of
 1536:	      [[4,4],[5,6]] -&gt; ok;
 1537:	      [[5,6],[4,4]] -&gt; ok
 1538:	  end,
 1539:    ?line [[4]] = ets:match(Tab,{{two,'$0'},'$0'}),
<a name="1540"></a> 1540:    ?line Len = length(ets:match(Tab,'$0')),
 1541:    ?line Len = length(ets:match(Tab,'_')),
 1542:    ?line if Len &gt; 4 -&gt; ok end,
 1543:    ?line true = ets:delete(Tab),
 1544:    ok.
 1545:
<a name=match2> 1546:<b>match2</b></a>(doc) -&gt; ["Tests match with specified keypos bag table."];
<a name=match2> 1547:<b>match2</b></a>(suite) -&gt; [];
<a name=match2> 1548:<b>match2</b></a>(Config) when list(Config) -&gt;
 1549:    ?line Tab = make_table(foobar,
<a name="1550"></a> 1550:			   [bag, private, named_table, {keypos, 2}],
 1551:			   [{value1, key1},
 1552:			    {value2_1, key2},
 1553:			    {value2_2, key2},
 1554:			    {value3_1, key3},
 1555:			    {value3_2, key3}]),
 1556:    ?line case length(ets:match(Tab, '$1')) of
 1557:	      5 -&gt; ok;
 1558:	      _ -&gt; ?t:fail("Length of matched list is wrong.")
 1559:	  end,
<a name="1560"></a> 1560:    ?line [[value3_1],[value3_2]] = ets:match(Tab, {'$1', key3}),
 1561:    ?line [[key1]] = ets:match(Tab, {value1, '$1'}),
 1562:    ?line true = ets:delete(Tab),
 1563:    ok.
 1564:
<a name=match_object> 1565:<b>match_object</b></a>(doc) -&gt; ["Sime ets:match_object test."];
<a name=match_object> 1566:<b>match_object</b></a>(suite) -&gt; [];    
<a name=match_object> 1567:<b>match_object</b></a>(Config) when list(Config) -&gt;
 1568:    ?line Tab = ets:new(foobar, []),
 1569:    ?line fill_tab(Tab, foo),
<a name="1570"></a> 1570:    ?line ets:insert(Tab, {{one, 4}, 4}),
 1571:    ?line ets:insert(Tab,{{one,5},5}),
 1572:    ?line ets:insert(Tab,{{two,4},4}),
 1573:    ?line ets:insert(Tab,{{two,5},6}),
 1574:    ?line case ets:match_object(Tab, {{one, '_'}, '$0'}) of
 1575:	[{{one,5},5},{{one,4},4}] -&gt; ok;
 1576:	[{{one,4},4},{{one,5},5}] -&gt; ok;
 1577:	_ -&gt; ?t:fail("ets:match_object() returned something funny.")
 1578:    end,
 1579:    ?line case ets:match_object(Tab, {{two, '$1'}, '$0'}) of
<a name="1580"></a> 1580:	[{{two,5},6},{{two,4},4}] -&gt; ok;
 1581:	[{{two,4},4},{{two,5},6}] -&gt; ok;
 1582:	_ -&gt; ?t:fail("ets:match_object() returned something funny.")
 1583:    end,
 1584:    ?line case ets:match_object(Tab, {{two, '$9'}, '$4'}) of
 1585:	[{{two,5},6},{{two,4},4}] -&gt; ok;
 1586:	[{{two,4},4},{{two,5},6}] -&gt; ok;
 1587:	_ -&gt; ?t:fail("ets:match_object() returned something funny.")
 1588:    end,
 1589:    ?line case ets:match_object(Tab, {{two, '$9'}, '$22'}) of
<a name="1590"></a> 1590:	[{{two,5},6},{{two,4},4}] -&gt; ok;
 1591:	[{{two,4},4},{{two,5},6}] -&gt; ok;
 1592:	_ -&gt; ?t:fail("ets:match_object() returned something funny.")
 1593:    end,
 1594:    % Check that unsucessful match returns an empty list.
 1595:    ?line [] = ets:match_object(Tab, {{three,'$0'}, '$92'}),
 1596:    % Check that '$0' equals '_'.
 1597:    Len = length(ets:match_object(Tab, '$0')),
 1598:    Len = length(ets:match_object(Tab, '_')),
 1599:    ?line if Len &gt; 4 -&gt; ok end,
<a name="1600"></a> 1600:    ?line true = ets:delete(Tab),
 1601:    ok.
 1602:
<a name=match_object2> 1603:<b>match_object2</b></a>(suite) -&gt; [];
<a name=match_object2> 1604:<b>match_object2</b></a>(doc) -&gt; ["Tests that db_match_object does not generate "
 1605:		       "a `badarg' when resuming a search with no "
 1606:		       "previous matches."];
<a name=match_object2> 1607:<b>match_object2</b></a>(Config) when list(Config) -&gt;
 1608:    ?line Tab = ets:new(foo, [bag, {keypos, 2}]),
 1609:    ?line fill_tab2(Tab, 0, 13005),     % match_db_object does 1000
<a name="1610"></a> 1610:                                       % elements per pass, might
 1611:                                       % change in the future.
 1612:    ?line case catch ets:match_object(Tab, {hej, '$1'}) of
 1613:	      {'EXIT', _} -&gt;
 1614:		  ets:delete(Tab),
 1615:		  ?t:fail("match_object EXIT:ed");
 1616:	      [] -&gt;
 1617:		  io:format("Nothing matched.");
 1618:	      List -&gt;
 1619:		  io:format("Matched:~p~n",[List])
<a name="1620"></a> 1620:	  end,
 1621:    ets:delete(Tab),
 1622:    ok.
 1623:
 1624:<i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
 1625:
<a name=misc> 1626:<b>misc</b></a>(suite) -&gt; [misc1, fixtable, info, dups, tab2list].
 1627:
<a name=tab2list> 1628:<b>tab2list</b></a>(doc) -&gt; ["Tests tab2list (OTP-3319)"];
<a name=tab2list> 1629:<b>tab2list</b></a>(suite) -&gt; [];
<a name=tab2list><a name="1630"></a> 1630:<b>tab2list</b></a>(Config) when list(Config) -&gt;
 1631:    ?line Tab = make_table(foo,
 1632:			   [ordered_set],
 1633:			   [{a,b}, {c,b}, {b,b}, {a,c}]),
 1634:    ?line [{a,c},{b,b},{c,b}] = ets:tab2list(Tab),
 1635:    ok.
 1636:
<a name=misc1> 1637:<b>misc1</b></a>(doc) -&gt; ["Simple general small test. ",
 1638:	      "If this fails, ets is in really bad shape."];
<a name=misc1> 1639:<b>misc1</b></a>(suite) -&gt; [];
<a name=misc1><a name="1640"></a> 1640:<b>misc1</b></a>(Config) when list(Config) -&gt;
 1641:    ?line Tab = ets:new(foo,[]),
 1642:    ?line true = lists:member(Tab,ets:all()),
 1643:    ?line ets:delete(Tab),
 1644:    ?line false = lists:member(Tab,ets:all()),
 1645:    ?line case catch ets:delete(Tab) of
 1646:	      {'EXIT', Reason} -&gt;
 1647:		  ok;
 1648:	      true -&gt;
 1649:		  ?t:fail("Delete of nonexisting table returned `true'.")
<a name="1650"></a> 1650:	  end,
 1651:    ok.
 1652:
<a name=fixtable> 1653:<b>fixtable</b></a>(doc) -&gt;  ["Check the fixtable function."];
<a name=fixtable> 1654:<b>fixtable</b></a>(suite) -&gt; [];
<a name=fixtable> 1655:<b>fixtable</b></a>(Config) when list(Config) -&gt;
 1656:    ?line Tab = ets:new(foo, []),
 1657:    ?line fill_tab(Tab, foobar),
 1658:    ?line true = ets:fixtable(Tab, true),
 1659:    ?line receive after 1 -&gt; ok end,
<a name="1660"></a> 1660:    ?line true = ets:fixtable(Tab, false),
 1661:    ?line ets:delete(Tab),
 1662:    ?line case catch ets:fixtable(Tab, true) of
 1663:	      {'EXIT', Reason} -&gt;
 1664:		  ok;
 1665:	      _ -&gt;
 1666:		  ?t:fail("Fixtable on nonexisting table returned `true'")
 1667:	  end,
 1668:    ok.
 1669:
<a name=info><a name="1670"></a> 1670:<b>info</b></a>(doc) -&gt; ["Tests ets:info result for required tuples."];
<a name=info> 1671:<b>info</b></a>(suite) -&gt; [];
<a name=info> 1672:<b>info</b></a>(Config) when list(Config) -&gt;
 1673:    ?line MeMyselfI=self(),
 1674:    ?line ThisNode=node(),
 1675:    ?line Tab = ets:new(foobar, [{keypos, 2}]),
 1676:    ?line Res = tuple_to_list(ets:info(Tab)),
 1677:    ?line {value, {memory, Mem}} = lists:keysearch(memory, 1, Res),
 1678:    ?line {value, {owner, MeMyselfI}} = lists:keysearch(owner, 1, Res),
 1679:    ?line {value, {name, foobar}} = lists:keysearch(name, 1, Res),
<a name="1680"></a> 1680:    ?line {value, {size, 0}} = lists:keysearch(size, 1, Res),
 1681:    ?line {value, {node, ThisNode}} = lists:keysearch(node, 1, Res),
 1682:    ?line {value, {named_table, false}} = lists:keysearch(named_table, 1, Res),
 1683:    ?line {value, {type, set}} = lists:keysearch(type, 1, Res),
 1684:    ?line {value, {keypos, 2}} = lists:keysearch(keypos, 1, Res),
 1685:    ?line {value, {protection, protected}} =
 1686:	lists:keysearch(protection, 1, Res),
 1687:    ?line true = ets:delete(Tab),
 1688:    ?line undefined = ets:info(non_existing_table_xxyy),
 1689:    ?line undefined = ets:info(non_existing_table_xxyy,type),
<a name="1690"></a> 1690:    ?line undefined = ets:info(non_existing_table_xxyy,node),
 1691:    ?line undefined = ets:info(non_existing_table_xxyy,named_table),
 1692:    ?line undefined = ets:info(non_existing_table_xxyy,safe_fixed),
 1693:    ok.
 1694:
<a name=dups> 1695:<b>dups</b></a>(doc) -&gt; ["Test various duplicate_bags stuff"];
<a name=dups> 1696:<b>dups</b></a>(suite) -&gt; [];
<a name=dups> 1697:<b>dups</b></a>(Config) when list(Config) -&gt;
 1698:    ?line T = make_table(funky,
 1699:			 [duplicate_bag],
<a name="1700"></a> 1700:			 [{1, 2}, {1, 2}]),
 1701:    ?line 2 = length(ets:tab2list(T)),
 1702:    ?line ets:delete(T, 1),
 1703:    ?line [] = ets:lookup(T, 1),
 1704:
 1705:    ?line ets:insert(T, {1, 2, 2}),
 1706:    ?line ets:insert(T, {1, 2, 4}),
 1707:    ?line ets:insert(T, {1, 2, 2}),
 1708:    ?line ets:insert(T, {1, 2, 2}),
 1709:    ?line ets:insert(T, {1, 2, 4}),
<a name="1710"></a> 1710:
 1711:    ?line 5 = length(ets:tab2list(T)),
 1712:
 1713:    ?line 5 = length(ets:match(T, {'$1', 2, '$2'})),
 1714:    ?line 3 = length(ets:match(T, {'_', '$1', '$1'})),
 1715:    ?line ets:match_delete(T, {'_', '$1', '$1'}),
 1716:    ?line 0 = length(ets:match(T, {'_', '$1', '$1'})),
 1717:    ?line ets:delete(T),
 1718:    ok.
 1719:
<a name="1720"></a> 1720:<i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
 1721:
<a name=files> 1722:<b>files</b></a>(suite) -&gt; [tab2file, tab2file2, tab2file3].
 1723:
<a name=tab2file> 1724:<b>tab2file</b></a>(doc) -&gt; ["Check the ets:tab2file function on an empty "
 1725:		  "ets table."];
<a name=tab2file> 1726:<b>tab2file</b></a>(suite) -&gt; [];
<a name=tab2file> 1727:<b>tab2file</b></a>(Config) when list(Config) -&gt;
 1728:    %% Write an empty ets table to a file, read back and check properties.
 1729:    ?line Tab = ets:new(ets_SUITE_foo_tab, [named_table, set, private,
<a name="1730"></a> 1730:					    {keypos, 2}]),
 1731:    ?line FName = filename:join([?config(priv_dir, Config),"tab2file_case"]),
 1732:    ?line ok = ets:tab2file(Tab, FName),
 1733:    ?line true = ets:delete(Tab),
 1734:    %
 1735:    ?line {ok, Tab2} = ets:file2tab(FName),
 1736:    ?line private = ets:info(Tab2, protection),
 1737:    ?line true = ets:info(Tab2, named_table),
 1738:    ?line 2 = ets:info(Tab2, keypos),
 1739:    ?line set = ets:info(Tab2, type),
<a name="1740"></a> 1740:    ?line true = ets:delete(Tab2),
 1741:    ok.
 1742:    
<a name=tab2file2> 1743:<b>tab2file2</b></a>(doc) -&gt; ["Check the ets:tab2file function on a ",
 1744:		   "filled set type ets table."];
<a name=tab2file2> 1745:<b>tab2file2</b></a>(suite) -&gt; [];
<a name=tab2file2> 1746:<b>tab2file2</b></a>(Config) when list(Config) -&gt;	
 1747:    %% Try the same on a filled set table.
 1748:    ?line Tab = ets:new(ets_SUITE_foo_tab, [named_table, set, private,
 1749:					    {keypos, 2}]),
<a name="1750"></a> 1750:    ?line FName = filename:join([?config(priv_dir, Config),"tab2file2_case"]),
 1751:    ?line ok = fill_tab2(Tab, 0, 10000),   % Fill up the table (grucho mucho!)
 1752:    ?line Len = length(ets:tab2list(Tab)),
 1753:    ?line ok = ets:tab2file(Tab, FName),
 1754:    ?line true = ets:delete(Tab),
 1755:    %
 1756:    ?line {ok, Tab2} = ets:file2tab(FName),
 1757:    ?line private = ets:info(Tab2, protection),
 1758:    ?line true = ets:info(Tab2, named_table),
 1759:    ?line 2 = ets:info(Tab2, keypos),
<a name="1760"></a> 1760:    ?line set = ets:info(Tab2, type),
 1761:    ?line Len = length(ets:tab2list(Tab2)),
 1762:    ?line true = ets:delete(Tab2),
 1763:    ok.
 1764:
<a name=tab2file3> 1765:<b>tab2file3</b></a>(doc) -&gt; ["Check the ets:tab2file function on a ",
 1766:		   "filled bag type ets table."];
<a name=tab2file3> 1767:<b>tab2file3</b></a>(suite) -&gt; [];
<a name=tab2file3> 1768:<b>tab2file3</b></a>(Config) when list(Config) -&gt;
 1769:    %% Try the same on a filled bag table.
<a name="1770"></a> 1770:    ?line Tab = ets:new(ets_SUITE_foo_tab, [named_table, bag, private,
 1771:					    {keypos, 2}]),
 1772:    ?line FName = filename:join([?config(priv_dir, Config),"tab2file3_case"]),
 1773:    ?line ok = fill_tab2(Tab, 0, 10000),   % Fill up the table (grucho mucho!)
 1774:    ?line Len = length(ets:tab2list(Tab)),
 1775:    ?line Mem = ets:info(Tab, memory),
 1776:    ?line ok = ets:tab2file(Tab, FName),
 1777:    ?line true = ets:delete(Tab),
 1778:
 1779:    ?line {ok, Tab2} = ets:file2tab(FName),
<a name="1780"></a> 1780:    ?line private = ets:info(Tab2, protection),
 1781:    ?line true = ets:info(Tab2, named_table),
 1782:    ?line 2 = ets:info(Tab2, keypos),
 1783:    ?line bag = ets:info(Tab2, type),
 1784:    ?line Len = length(ets:tab2list(Tab2)),
 1785:    ?line Mem = ets:info(Tab2, memory),
 1786:    ?line true = ets:delete(Tab2),
 1787:    ok.
 1788:
 1789:-<b>define</b>(test_list, [8,5,4,1,58,125,255, 250, 245, 240, 235,
<a name="1790"></a> 1790:		    230, Num rem 255, 255, 125, 130, 135, 140, 145,
 1791:		    150, 134, 12, 54, Val rem 255, 12, 3, 6, 9, 126]).
 1792:-<b>define</b>(big_test_list, [Num rem 256|lists:seq(1, 66)]).
 1793:-<b>define</b>(test_integer, 2846287468+Num).
 1794:-<b>define</b>(test_float, 187263.18236-Val).
 1795:-<b>define</b>(test_atom, some_crazy_atom).
 1796:-<b>define</b>(test_tuple, {just, 'Some', 'Tuple', 1, [list, item], Val+Num}).
 1797:
 1798:<i>%% Insert different datatypes into a ets table.</i>
<a name=fill_tab2> 1799:<b>fill_tab2</b></a>(Tab, Val, 0) -&gt;
<a name="1800"></a> 1800:    ok;
<a name=fill_tab2> 1801:<b>fill_tab2</b></a>(Tab, Val, Num) -&gt;
 1802:    ?line Item =
 1803:	case Num rem 10 of
 1804:	    0 -&gt; "String";
 1805:	    1 -&gt; ?line ?test_atom;
 1806:	    2 -&gt; ?line ?test_tuple;
 1807:	    3 -&gt; ?line ?test_integer;
 1808:	    4 -&gt; ?line ?test_float;
 1809:	    5 -&gt; ?line list_to_binary(?test_list); %Heap binary
<a name="1810"></a> 1810:	    6 -&gt; ?line list_to_binary(?big_test_list); %Refc binary
 1811:	    7 -&gt; ?line make_sub_binary(?test_list, Num); %Sub binary
 1812:	    8 -&gt; ?line ?test_list;
 1813:	    9 -&gt; ?line fun(X) -&gt; {Tab,Val,X*Num} end
 1814:	end,
 1815:    ?line true=ets:insert(Tab, {Item, Val}),
 1816:    ?line fill_tab2(Tab, Val+1, Num-1),
 1817:    ok.
 1818:<i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
 1819:
<a name=make_sub_binary><a name="1820"></a> 1820:<b>make_sub_binary</b></a>(List, Num) when list(List) -&gt;
 1821:    N = Num rem 23,
 1822:    Bin = list_to_binary([lists:seq(0, N)|List]),
 1823:    {_,B} = split_binary(Bin, N+1),
 1824:    B.
 1825:
<a name=heavy> 1826:<b>heavy</b></a>(suite) -&gt; [heavy_lookup, heavy_lookup_element].
 1827:
 1828:<i>%% Lookup stuff like crazy...</i>
<a name=heavy_lookup> 1829:<b>heavy_lookup</b></a>(doc) -&gt; ["Performs multiple lookups for every key ",
<a name="1830"></a> 1830:		      "in a large table."];
<a name=heavy_lookup> 1831:<b>heavy_lookup</b></a>(suite) -&gt; [];
<a name=heavy_lookup> 1832:<b>heavy_lookup</b></a>(Config) when list(Config) -&gt;
 1833:    ?line Tab = ets:new(foobar_table, [set, protected, {keypos, 2}]),
 1834:    ?line ok = fill_tab2(Tab, 0, 7000),
 1835:    ?line ?t:do_times(50, ?MODULE, do_lookup, [Tab, 6999]),
 1836:    ?line true = ets:delete(Tab),
 1837:    ok.
 1838:
<a name=do_lookup> 1839:<b>do_lookup</b></a>(Tab, 0) -&gt; ok;
<a name=do_lookup><a name="1840"></a> 1840:<b>do_lookup</b></a>(Tab, N) -&gt;
 1841:    case ets:lookup(Tab, N) of
 1842:	[] -&gt; ?t:format("Set #~p was reported as empty. Not valid.",
 1843:				 [N]),
 1844:	      exit('Invalid lookup');
 1845:	_ -&gt;  do_lookup(Tab, N-1)
 1846:    end.
 1847:
<a name=heavy_lookup_element> 1848:<b>heavy_lookup_element</b></a>(doc) -&gt; ["Performs multiple lookups for ",
 1849:			      "every element in a large table."];
<a name=heavy_lookup_element><a name="1850"></a> 1850:<b>heavy_lookup_element</b></a>(suite) -&gt; [];
<a name=heavy_lookup_element> 1851:<b>heavy_lookup_element</b></a>(Config) when list(Config) -&gt;
 1852:    ?line Tab = ets:new(foobar_table, [set, protected, {keypos, 2}]),
 1853:    ?line ok = fill_tab2(Tab, 0, 7000),
 1854:    case os:type() of
 1855:	vxworks -&gt;
 1856:	    ?line ?t:do_times(5, ?MODULE, do_lookup_element,
 1857:				       [Tab, 6999, 1]);
 1858:						% lookup ALL elements 5 times.
 1859:	_ -&gt;
<a name="1860"></a> 1860:	    ?line ?t:do_times(50, ?MODULE, do_lookup_element,
 1861:				       [Tab, 6999, 1])
 1862:						% lookup ALL elements 50 times.
 1863:    end,
 1864:    ?line true = ets:delete(Tab),
 1865:    ok.
 1866:
<a name=do_lookup_element> 1867:<b>do_lookup_element</b></a>(Tab, 0, _) -&gt; ok;
<a name=do_lookup_element> 1868:<b>do_lookup_element</b></a>(Tab, N, M) -&gt;
 1869:    ?line case catch ets:lookup_element(Tab, N, M) of
<a name="1870"></a> 1870:	      {'EXIT', {badarg, _}} -&gt;
 1871:		  case M of
 1872:		      1 -&gt; ?t:fail("Set #~p reported as empty. Not valid.",
 1873:				   [N]),
 1874:			   exit('Invalid lookup_element');
 1875:		      _ -&gt; ?line do_lookup_element(Tab, N-1, 1)
 1876:		  end;
 1877:	      _ -&gt; ?line do_lookup_element(Tab, N, M+1)
 1878:    end.
 1879:
<a name="1880"></a> 1880:
<a name=fold> 1881:<b>fold</b></a>(suite) -&gt; [foldl_ordered, foldr_ordered,
 1882:		foldl, foldr,
 1883:		fold_empty].
 1884:
<a name=fold_empty> 1885:<b>fold_empty</b></a>(doc) -&gt;
 1886:    [];
<a name=fold_empty> 1887:<b>fold_empty</b></a>(suite) -&gt; [];
<a name=fold_empty> 1888:<b>fold_empty</b></a>(Config) when list(Config) -&gt;
 1889:    ?line Tab = make_table(a, [], []),
<a name="1890"></a> 1890:    ?line [] = ets:foldl(fun(X) -&gt; exit(hej) end, [], Tab),
 1891:    ?line [] = ets:foldr(fun(X) -&gt; exit(hej) end, [], Tab),
 1892:    ok.
 1893:
<a name=foldl> 1894:<b>foldl</b></a>(doc) -&gt;
 1895:    [];
<a name=foldl> 1896:<b>foldl</b></a>(suite) -&gt; [];
<a name=foldl> 1897:<b>foldl</b></a>(Config) when list(Config) -&gt;
 1898:    ?line L = [{a,1}, {c,3}, {b,2}],
 1899:    ?line LS = lists:sort(L),
<a name="1900"></a> 1900:    ?line Tab = make_table(a, [bag], L),
 1901:    ?line LS = lists:sort(ets:foldl(fun(E,A) -&gt; [E|A] end, [], Tab)),
 1902:    ok.
 1903:
<a name=foldr> 1904:<b>foldr</b></a>(doc) -&gt;
 1905:    [];
<a name=foldr> 1906:<b>foldr</b></a>(suite) -&gt; [];
<a name=foldr> 1907:<b>foldr</b></a>(Config) when list(Config) -&gt;
 1908:    ?line L = [{a,1}, {c,3}, {b,2}],
 1909:    ?line LS = lists:sort(L),
<a name="1910"></a> 1910:    ?line Tab = make_table(a, [bag], L),
 1911:    ?line LS = lists:sort(ets:foldr(fun(E,A) -&gt; [E|A] end, [], Tab)),
 1912:    ok.
 1913:
<a name=foldl_ordered> 1914:<b>foldl_ordered</b></a>(doc) -&gt;
 1915:    [];
<a name=foldl_ordered> 1916:<b>foldl_ordered</b></a>(suite) -&gt; [];
<a name=foldl_ordered> 1917:<b>foldl_ordered</b></a>(Config) when list(Config) -&gt;
 1918:    ?line L = [{a,1}, {c,3}, {b,2}],
 1919:    ?line LS = lists:sort(L),
<a name="1920"></a> 1920:    ?line Tab = make_table(a, [ordered_set], L),
 1921:    ?line LS = lists:reverse(ets:foldl(fun(E,A) -&gt; [E|A] end, [], Tab)),
 1922:    ok.
 1923:
<a name=foldr_ordered> 1924:<b>foldr_ordered</b></a>(doc) -&gt;
 1925:    [];
<a name=foldr_ordered> 1926:<b>foldr_ordered</b></a>(suite) -&gt; [];
<a name=foldr_ordered> 1927:<b>foldr_ordered</b></a>(Config) when list(Config) -&gt;
 1928:    ?line L = [{a,1}, {c,3}, {b,2}],
 1929:    ?line LS = lists:sort(L),
<a name="1930"></a> 1930:    ?line Tab = make_table(a, [ordered_set], L),
 1931:    ?line LS = ets:foldr(fun(E,A) -&gt; [E|A] end, [], Tab),
 1932:    ok.
 1933:
 1934:<i>% i_2409(doc) -&gt;</i>
 1935:<i>%     ["Test that ets:i() does not starve out other processes which",</i>
 1936:<i>%      "might cause heartbeat timeout",</i>
 1937:<i>%      "OTP-2409"];</i>
 1938:<i>% i_2409(suite) -&gt; [];</i>
 1939:<i>% i_2409(Config) when list(Config) -&gt;</i>
<a name="1940"></a> 1940:<i>%     ?line Tab = ets:new(heartbeat_table, [set, protected, {keypos, 2}]),</i>
 1941:<i>%     ?line ok = fill_tab2(Tab, 0, 20000),</i>
 1942:<i>%     Pid = spawn(?MODULE,heartbeat_loop,[0]),</i>
 1943:<i>%     ?line true = eloop(Tab,50),</i>
 1944:<i>%     Pid ! {self(),stop},</i>
 1945:<i>%     Count = receive </i>
 1946:<i>% 	{Pid, _Count} -&gt;</i>
 1947:<i>% 	    _Count</i>
 1948:<i>%     end,</i>
 1949:<i>%     ?line C = if </i>
<a name="1950"></a> 1950:<i>% 	      Count &gt; 0 -&gt;</i>
 1951:<i>% 		  ok;</i>
 1952:<i>% 	      true -&gt;</i>
 1953:<i>% 		  false</i>
 1954:<i>% 	  end,</i>
 1955:<i>%     ?line io:format("Count = ~p~n",[Count]),</i>
 1956:<i>%     ?line ok = C,</i>
 1957:<i>%     ets:delete(Tab).</i>
 1958:
 1959:
<a name=member><a name="1960"></a> 1960:<b>member</b></a>(suite) -&gt;
 1961:    [];
<a name=member> 1962:<b>member</b></a>(doc) -&gt;
 1963:    ["Tests ets:member BIF"];
<a name=member> 1964:<b>member</b></a>(Config) when list(Config) -&gt;
 1965:    ?line T = ets:new(xxx,[ordered_set]),
 1966:    ?line U = ets:new(xxx,[]),
 1967:    ?line false = ets:member(T,hej),
 1968:    ?line false = ets:member(U,hej),
 1969:    ?line E = fun(0,F)-&gt;ok;
<a name="1970"></a> 1970:		 (N,F) -&gt; 
 1971:		      ?line ets:insert(T,{N,N rem 10}), 
 1972:		      ?line ets:insert(U,{N,N rem 10}), 
 1973:		      F(N-1,F) 
 1974:	      end,
 1975:    ?line E(10000,E),                                                          
 1976:    ?line false = ets:member(T,hej),
 1977:    ?line false = ets:member(U,hej),
 1978:    ?line true = ets:member(T,1),
 1979:    ?line true = ets:member(U,1),
<a name="1980"></a> 1980:    ?line false = ets:member(T,20000),
 1981:    ?line false = ets:member(U,20000),
 1982:    ?line ets:delete(T,5),
 1983:    ?line ets:delete(U,5),
 1984:    ?line false = ets:member(T,5),
 1985:    ?line false = ets:member(U,5),
 1986:    ?line ets:safe_fixtable(T,true),
 1987:    ?line ets:safe_fixtable(U,true),
 1988:    ?line ets:delete(T,6),
 1989:    ?line ets:delete(U,6),
<a name="1990"></a> 1990:    ?line false = ets:member(T,6),
 1991:    ?line false = ets:member(U,6),
 1992:    ?line ets:safe_fixtable(T,false),
 1993:    ?line ets:safe_fixtable(U,false),
 1994:    ?line false = ets:member(T,6),
 1995:    ?line false = ets:member(U,6),
 1996:    ?line ets:delete(T),
 1997:    ?line ets:delete(U),
 1998:    ?line {'EXIT',{badarg,_}} = (catch ets:member(finnsinte, 23)),
 1999:    ?line {'EXIT',{badarg,_}} = (catch ets:member(T, 23)),
<a name="2000"></a> 2000:    ?line {'EXIT',{badarg,_}} = (catch ets:member(U, 23)),
 2001:    ok.
 2002:
 2003:
 2004:<i>% eloop(Tab,0) -&gt;</i>
 2005:<i>%     true;</i>
 2006:<i>% eloop(Tab,Count) -&gt;</i>
 2007:<i>%     ets:info(Tab,memory),</i>
 2008:<i>%     eloop(Tab,Count-1).</i>
 2009:
<a name="2010"></a> 2010:<i>% heartbeat_loop(Count) -&gt; </i>
 2011:<i>%     receive </i>
 2012:<i>% 	{From,stop} -&gt;</i>
 2013:<i>% 	    From ! {self(),Count}</i>
 2014:<i>%     after 1 -&gt;</i>
 2015:<i>% 	    heartbeat_loop(Count+1)</i>
 2016:<i>%     end.</i>
 2017:
 2018:       
<a name=build_table> 2019:<b>build_table</b></a>(L1,L2,Num) -&gt;
<a name="2020"></a> 2020:    T = ets:new(xxx, [ordered_set]
 2021:	       ),
 2022:    lists:foreach(
 2023:      fun(X1) -&gt;
 2024:	      lists:foreach(
 2025:		fun(X2) -&gt;
 2026:			F = fun(FF,N) -&gt;
 2027:				    ets:insert(T,{{X1,X2,N}, 
 2028:						  X1, X2, N}),
 2029:				    case N of 
<a name="2030"></a> 2030:					0 -&gt;
 2031:					    ok;
 2032:					_ -&gt;
 2033:					    FF(FF,N-1)
 2034:				    end
 2035:			    end,
 2036:			F(F,Num)
 2037:		end, L2)
 2038:      end, L1),
 2039:    T.
<a name="2040"></a> 2040:
<a name=build_table2> 2041:<b>build_table2</b></a>(L1,L2,Num) -&gt;
 2042:    T = ets:new(xxx, [ordered_set]
 2043:	       ),
 2044:    lists:foreach(
 2045:      fun(X1) -&gt;
 2046:	      lists:foreach(
 2047:		fun(X2) -&gt;
 2048:			F = fun(FF,N) -&gt;
 2049:				    ets:insert(T,{{N,X1,X2}, 
<a name="2050"></a> 2050:						  N, X1, X2}),
 2051:				    case N of 
 2052:					0 -&gt;
 2053:					    ok;
 2054:					_ -&gt;
 2055:					    FF(FF,N-1)
 2056:				    end
 2057:			    end,
 2058:			F(F,Num)
 2059:		end, L2)
<a name="2060"></a> 2060:      end, L1),
 2061:    T.
 2062:
<a name=time_match_object> 2063:<b>time_match_object</b></a>(Tab,Match, Res) -&gt;
 2064:    T1 = erlang:now(),
 2065:    Res = ets:match_object(Tab,Match),
 2066:    T2 = erlang:now(),
 2067:    nowdiff(T1,T2).
 2068:
<a name=time_match> 2069:<b>time_match</b></a>(Tab,Match) -&gt;
<a name="2070"></a> 2070:    T1 = erlang:now(),
 2071:    ets:match(Tab,Match),
 2072:    T2 = erlang:now(),
 2073:    nowdiff(T1,T2).
 2074:
<a name=seventyfive_percent_success> 2075:<b>seventyfive_percent_success</b></a>(_,S,Fa,0) -&gt;
 2076:    true = (S &gt; ((S + Fa) * 0.75));
 2077:
<a name=seventyfive_percent_success> 2078:<b>seventyfive_percent_success</b></a>({M,F,A},S,Fa,N) -&gt;
 2079:    case (catch apply(M,F,A)) of
<a name="2080"></a> 2080:	{'EXIT', _} -&gt;
 2081:	    seventyfive_percent_success({M,F,A},S,Fa+1,N-1);
 2082:	_ -&gt;
 2083:	    seventyfive_percent_success({M,F,A},S+1,Fa,N-1)
 2084:    end.
 2085:
 2086:
<a name=nowtonumber> 2087:<b>nowtonumber</b></a>({Mega, Secs, Milli}) -&gt;
 2088:    Milli + Secs * 1000000 + Mega * 1000000000000.
<a name=nowdiff> 2089:<b>nowdiff</b></a>(T1,T2) -&gt;
<a name="2090"></a> 2090:    nowtonumber(T2) - nowtonumber(T1).
 2091:
<a name=create_random_string> 2092:<b>create_random_string</b></a>(0) -&gt;
 2093:    [];
 2094:
<a name=create_random_string> 2095:<b>create_random_string</b></a>(OfLength) -&gt;
 2096:    C = case random:uniform(2) of
 2097:	1 -&gt;
 2098:	    (random:uniform($Z - $A + 1) - 1) + $A;
 2099:	_ -&gt;
<a name="2100"></a> 2100:	    (random:uniform($z - $a + 1) - 1) + $a
 2101:	end,
 2102:    [C | create_random_string(OfLength - 1)].
 2103:
 2104:
<a name=create_random_tuple> 2105:<b>create_random_tuple</b></a>(OfLength) -&gt;
 2106:    list_to_tuple(lists:map(fun(X) -&gt;
 2107:				    list_to_atom([X])
 2108:			    end,create_random_string(OfLength))).
 2109:
<a name=create_partly_bound_tuple><a name="2110"></a> 2110:<b>create_partly_bound_tuple</b></a>(OfLength) -&gt;
 2111:    case random:uniform(2) of
 2112:	1 -&gt;
 2113:	   create_partly_bound_tuple1(OfLength); 
 2114:	_ -&gt;
 2115:	   create_partly_bound_tuple3(OfLength)
 2116:    end.
 2117:
<a name=create_partly_bound_tuple1> 2118:<b>create_partly_bound_tuple1</b></a>(OfLength) -&gt;
 2119:    T0 = create_random_tuple(OfLength),
<a name="2120"></a> 2120:    I = random:uniform(OfLength),
 2121:    setelement(I,T0,'$1').
 2122:
 2123:
<a name=set_n_random_elements> 2124:<b>set_n_random_elements</b></a>(T0,0,_,_) -&gt;
 2125:    T0;
<a name=set_n_random_elements> 2126:<b>set_n_random_elements</b></a>(T0,N,OfLength,GenFun) -&gt;
 2127:    I = random:uniform(OfLength),
 2128:    What = GenFun(I),
 2129:    case element(I,T0) of
<a name="2130"></a> 2130:	What -&gt;
 2131:	    set_n_random_elements(T0,N,OfLength,GenFun);
 2132:	Else -&gt;
 2133:	    set_n_random_elements(setelement(I,T0,What),
 2134:				  N-1,OfLength,GenFun)
 2135:    end.
 2136:
<a name=make_dollar_atom> 2137:<b>make_dollar_atom</b></a>(I) -&gt;
 2138:    list_to_atom([$$] ++ integer_to_list(I)).
<a name=create_partly_bound_tuple2> 2139:<b>create_partly_bound_tuple2</b></a>(OfLength) -&gt;
<a name="2140"></a> 2140:    T0 = create_random_tuple(OfLength),
 2141:    I = random:uniform(OfLength - 1),
 2142:    set_n_random_elements(T0,I,OfLength,fun make_dollar_atom/1).
 2143:
<a name=create_partly_bound_tuple3> 2144:<b>create_partly_bound_tuple3</b></a>(OfLength) -&gt;
 2145:    T0 = create_random_tuple(OfLength),
 2146:    I = random:uniform(OfLength - 1),
 2147:    set_n_random_elements(T0,I,OfLength,fun(_) -&gt; '_' end).
 2148:
<a name=do_n_times> 2149:<b>do_n_times</b></a>(_,0) -&gt;
<a name="2150"></a> 2150:    ok;
<a name=do_n_times> 2151:<b>do_n_times</b></a>(Fun,N) -&gt;
 2152:    Fun(),
 2153:    case N rem 1000 of
 2154:	0 -&gt;
 2155:	    io:format(".");
 2156:	_ -&gt;
 2157:	    ok
 2158:    end,
 2159:    do_n_times(Fun,N-1).
<a name="2160"></a> 2160:
<a name=make_table> 2161:<b>make_table</b></a>(Name, Options, Elements) -&gt;
 2162:    T = ets:new(Name, Options),
 2163:    lists:foreach(fun(E) -&gt; ets:insert(T, E) end, Elements),
 2164:    T.
<a name=filltabint> 2165:<b>filltabint</b></a>(Tab,0) -&gt;
 2166:    Tab;
<a name=filltabint> 2167:<b>filltabint</b></a>(Tab,N) -&gt;
 2168:    ets:insert(Tab,{N,integer_to_list(N)}),
 2169:    filltabint(Tab,N-1).
<a name=filltabint2><a name="2170"></a> 2170:<b>filltabint2</b></a>(Tab,0) -&gt;
 2171:    Tab;
<a name=filltabint2> 2172:<b>filltabint2</b></a>(Tab,N) -&gt;
 2173:    ets:insert(Tab,{N + N rem 2,integer_to_list(N)}),
 2174:    filltabint2(Tab,N-1).
<a name=filltabint3> 2175:<b>filltabint3</b></a>(Tab,0) -&gt;
 2176:    Tab;
<a name=filltabint3> 2177:<b>filltabint3</b></a>(Tab,N) -&gt;
 2178:    ets:insert(Tab,{N + N rem 2,integer_to_list(N + N rem 2)}),
 2179:    filltabint3(Tab,N-1).
<a name=xfilltabint><a name="2180"></a> 2180:<b>xfilltabint</b></a>(Tab,N) -&gt;
 2181:    case ets:info(Tab,type) of
 2182:	bag -&gt;
 2183:	    filltabint2(Tab,N);
 2184:	duplicate_bag -&gt;
 2185:	    ets:select_delete(Tab,[{'_',[],[true]}]),
 2186:	    filltabint3(Tab,N);
 2187:	_ -&gt;
 2188:	    filltabint(Tab,N)
 2189:    end.
<a name="2190"></a> 2190:    
<a name=filltabstr> 2191:<b>filltabstr</b></a>(Tab,0) -&gt;
 2192:    Tab;
<a name=filltabstr> 2193:<b>filltabstr</b></a>(Tab,N) -&gt;
 2194:    ets:insert(Tab,{integer_to_list(N),N}),
 2195:    filltabstr(Tab,N-1).
<a name=filltabstr2> 2196:<b>filltabstr2</b></a>(Tab,0) -&gt;
 2197:    Tab;
<a name=filltabstr2> 2198:<b>filltabstr2</b></a>(Tab,N) -&gt;
 2199:    ets:insert(Tab,{integer_to_list(N),N}),
<a name="2200"></a> 2200:    ets:insert(Tab,{integer_to_list(N),N+1}),
 2201:    filltabstr2(Tab,N-1).
<a name=filltabstr3> 2202:<b>filltabstr3</b></a>(Tab,0) -&gt;
 2203:    Tab;
<a name=filltabstr3> 2204:<b>filltabstr3</b></a>(Tab,N) -&gt;
 2205:    ets:insert(Tab,{integer_to_list(N),N}),
 2206:    ets:insert(Tab,{integer_to_list(N),N}),
 2207:    filltabstr3(Tab,N-1).
<a name=xfilltabstr> 2208:<b>xfilltabstr</b></a>(Tab,N) -&gt;
 2209:    case ets:info(Tab,type) of
<a name="2210"></a> 2210:	bag -&gt;
 2211:	    filltabstr2(Tab,N);
 2212:	duplicate_bag -&gt;
 2213:	    ets:select_delete(Tab,[{'_',[],[true]}]),
 2214:	    filltabstr3(Tab,N);
 2215:	_ -&gt;
 2216:	    filltabstr(Tab,N)
 2217:    end.
<a name=fill_sets_int> 2218:<b>fill_sets_int</b></a>(N) -&gt;
 2219:    Tab1 = ets:new(xxx, [ordered_set]),
<a name="2220"></a> 2220:    filltabint(Tab1,N),
 2221:    Tab2 = ets:new(xxx, [set]),
 2222:    filltabint(Tab2,N),
 2223:    Tab3 = ets:new(xxx, [bag]),
 2224:    filltabint2(Tab3,N),
 2225:    Tab4 = ets:new(xxx, [duplicate_bag]),
 2226:    filltabint3(Tab4,N),
 2227:    [Tab1,Tab2,Tab3,Tab4].
 2228:
 2229:<i>% 	       case ets:info(Table, type) of</i>
<a name="2230"></a> 2230:<i>% 		   bag -&gt;</i>
 2231:<i>% 		       throw(Table);</i>
 2232:<i>% 		   _ -&gt;</i>
 2233:<i>% 		       ok</i>
 2234:<i>% 	       end,</i>
<a name=check_fun> 2235:<b>check_fun</b></a>(Tab,Fun,'$end_of_table') -&gt;
 2236:    ok;
<a name=check_fun> 2237:<b>check_fun</b></a>(Tab,Fun,Item) -&gt;
 2238:    lists:foreach(fun(Obj) -&gt;
 2239:			  true = Fun(Obj)
<a name="2240"></a> 2240:		  end,
 2241:		  ets:lookup(Tab,Item)),
 2242:    check_fun(Tab,Fun,ets:next(Tab,Item)),
 2243:    ok.
 2244:
<a name=check> 2245:<b>check</b></a>(Tab,Fun,N) -&gt;
 2246:    N = ets:info(Tab, size),
 2247:    check_fun(Tab,Fun,ets:first(Tab)).
 2248:
 2249:
<a name="2250"></a> 2250:
<a name=del_one_by_one_set> 2251:<b>del_one_by_one_set</b></a>(T,N,N) -&gt;
 2252:    0 = ets:info(T,size),
 2253:    ok;
<a name=del_one_by_one_set> 2254:<b>del_one_by_one_set</b></a>(T,From,To) -&gt;
 2255:    N = ets:info(T,size),
 2256:    ets:delete_object(T,{From, integer_to_list(From)}),
 2257:    N = (ets:info(T,size) + 1),
 2258:    Next = if
 2259:	       From &lt; To -&gt;
<a name="2260"></a> 2260:		   From + 1;
 2261:	       true -&gt;
 2262:		   From - 1
 2263:	   end,
 2264:    del_one_by_one_set(T,Next,To).
 2265:
<a name=del_one_by_one_bag> 2266:<b>del_one_by_one_bag</b></a>(T,N,N) -&gt;
 2267:    0 = ets:info(T,size),
 2268:    ok;
<a name=del_one_by_one_bag> 2269:<b>del_one_by_one_bag</b></a>(T,From,To) -&gt;
<a name="2270"></a> 2270:    N = ets:info(T,size),
 2271:    ets:delete_object(T,{From + From rem 2, integer_to_list(From)}),
 2272:    N = (ets:info(T,size) + 1),
 2273:    Next = if
 2274:	       From &lt; To -&gt;
 2275:		   From + 1;
 2276:	       true -&gt;
 2277:		   From - 1
 2278:	   end,
 2279:    del_one_by_one_bag(T,Next,To).
<a name="2280"></a> 2280:
 2281:
<a name=del_one_by_one_dbag_1> 2282:<b>del_one_by_one_dbag_1</b></a>(T,N,N) -&gt;
 2283:    0 = ets:info(T,size),
 2284:    ok;
<a name=del_one_by_one_dbag_1> 2285:<b>del_one_by_one_dbag_1</b></a>(T,From,To) -&gt;
 2286:    N = ets:info(T,size),
 2287:    ets:delete_object(T,{From, integer_to_list(From)}),
 2288:    case From rem 2 of
 2289:	0 -&gt;
<a name="2290"></a> 2290:	    N = (ets:info(T,size) + 2);
 2291:	1 -&gt;
 2292:	    N = ets:info(T,size)
 2293:    end,
 2294:    Next = if
 2295:	       From &lt; To -&gt;
 2296:		   From + 1;
 2297:	       true -&gt;
 2298:		   From - 1
 2299:	   end,
<a name="2300"></a> 2300:    del_one_by_one_dbag_1(T,Next,To).
 2301:
<a name=del_one_by_one_dbag_2> 2302:<b>del_one_by_one_dbag_2</b></a>(T,N,N) -&gt;
 2303:    0 = ets:info(T,size),
 2304:    ok;
<a name=del_one_by_one_dbag_2> 2305:<b>del_one_by_one_dbag_2</b></a>(T,From,To) -&gt;
 2306:    N = ets:info(T,size),
 2307:    ets:delete_object(T,{From, integer_to_list(From)}),
 2308:    case From rem 2 of
 2309:	0 -&gt;
<a name="2310"></a> 2310:	    N = (ets:info(T,size) + 3);
 2311:	1 -&gt;
 2312:	    N = (ets:info(T,size) + 1)
 2313:    end,
 2314:    Next = if
 2315:	       From &lt; To -&gt;
 2316:		   From + 1;
 2317:	       true -&gt;
 2318:		   From - 1
 2319:	   end,
<a name="2320"></a> 2320:    del_one_by_one_dbag_2(T,Next,To).
 2321:
<a name=successive_delete> 2322:<b>successive_delete</b></a>(Table,From,To,Type) -&gt;
 2323:    successive_delete(Table,From,To,Type,ets:info(Table,type)).
 2324:
<a name=successive_delete> 2325:<b>successive_delete</b></a>(Table,N,N,_,_) -&gt;
 2326:    ok;
<a name=successive_delete> 2327:<b>successive_delete</b></a>(Table,From,To,Type,TType) -&gt;
 2328:    MS = case Type of
 2329:	     bound -&gt;
<a name="2330"></a> 2330:		 [{{From,'_'},[],[true]}];
 2331:	     unbound -&gt;
 2332:		 [{{'$1','_'},[],[{'==', '$1', From}]}]
 2333:	 end,
 2334:    case TType of
 2335:	X when X == bag; X == duplicate_bag -&gt;
 2336:	    %erlang:display(From),
 2337:	    case From rem 2 of
 2338:		0 -&gt;
 2339:		    2 = ets:select_delete(Table,MS);
<a name="2340"></a> 2340:		_ -&gt;
 2341:		    0 = ets:select_delete(Table,MS)
 2342:	    end;
 2343:	_ -&gt;
 2344:	    1 = ets:select_delete(Table,MS)
 2345:    end,
 2346:    Next = if
 2347:	       From &lt; To -&gt;
 2348:		   From + 1;
 2349:	       true -&gt;
<a name="2350"></a> 2350:		   From - 1
 2351:	   end,
 2352:    successive_delete(Table, Next, To, Type,TType).
 2353:
<a name=gen_dets_filename> 2354:<b>gen_dets_filename</b></a>(Config,N) -&gt;
 2355:    filename:join(?config(priv_dir,Config),
 2356:		  "testdets_" ++ integer_to_list(N) ++ ".dets").
 2357:
 2358:
 2359:
</pre>
<hr size=1><i>The transformation of this file (2360 lines) took 0.09 seconds</i><br>
</body>
</html>
