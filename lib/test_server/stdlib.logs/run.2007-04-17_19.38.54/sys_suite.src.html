<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head><title>/usr/home/jlouis/hacking/test_server/stdlib_test/sys_SUITE.erl</title></head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
    1:<i>%% ``The contents of this file are subject to the Erlang Public License,</i>
    2:<i>%% Version 1.1, (the "License"); you may not use this file except in</i>
    3:<i>%% compliance with the License. You should have received a copy of the</i>
    4:<i>%% Erlang Public License along with this software. If not, it can be</i>
    5:<i>%% retrieved via the world wide web at http://www.erlang.org/.</i>
    6:<i>%% </i>
    7:<i>%% Software distributed under the License is distributed on an "AS IS"</i>
    8:<i>%% basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See</i>
    9:<i>%% the License for the specific language governing rights and limitations</i>
<a name="10"></a>   10:<i>%% under the License.</i>
   11:<i>%% </i>
   12:<i>%% The Initial Developer of the Original Code is Ericsson Utvecklings AB.</i>
   13:<i>%% Portions created by Ericsson are Copyright 1999, Ericsson Utvecklings</i>
   14:<i>%% AB. All Rights Reserved.''</i>
   15:<i>%% </i>
   16:<i>%%     $Id$</i>
   17:<i>%%</i>
   18:-<b>module</b>(sys_SUITE).
   19:-<b>export</b>([all/1,log/1,log_to_file/1,stats/1,trace/1,suspend/1,install/1]).
<a name="20"></a>   20:-<b>export</b>([handle_call/3,terminate/2,init/1]).
   21:-<b>include</b>("test_server.hrl").
   22:
   23:-<b>define</b>(server,sys_SUITE_server).
   24:
   25:
   26:<i>%% Doesn't look into change_code at all</i>
   27:<i>%% Doesn't address writing your own process that understands</i>
   28:<i>%% system messages at all.</i>
   29:
<a name="30"></a>   30:
<a name=all>   31:<b>all</b></a>(suite) -&gt; {req,[stdlib],[log,log_to_file,stats,trace,suspend,install]}.
   32:
   33:<i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
   34:
<a name=log>   35:<b>log</b></a>(suite) -&gt; [];
<a name=log>   36:<b>log</b></a>(Config) when list(Config) -&gt;
   37:    ?line {ok,Server} = start(),
   38:    ?line ok = sys:log(?server,true),
   39:    ?line {ok,-44} = public_call(44),
<a name="40"></a>   40:    ?line ok = sys:log(?server,false),
   41:    ?line ok = sys:log(?server,print),
   42:    ?line stop(),
   43:    ok.
   44:
<a name=log_to_file>   45:<b>log_to_file</b></a>(suite) -&gt; [];
<a name=log_to_file>   46:<b>log_to_file</b></a>(Config) when list(Config) -&gt;
   47:    TempName = test_server:temp_name(?config(priv_dir,Config) ++ "sys."),
   48:    ?line {ok,Server} = start(),
   49:    ?line ok = sys:log_to_file(?server,TempName),
<a name="50"></a>   50:    ?line {ok,-44} = public_call(44),
   51:    ?line ok = sys:log_to_file(?server,false),
   52:    ?line {ok,Fd} = file:open(TempName,read),
   53:    ?line Msg1 = io:get_line(Fd,''),
   54:    ?line Msg2 = io:get_line(Fd,''),
   55:    ?line file:close(Fd),
   56:    ?line lists:prefix("*DBG* sys_SUITE_server got call {req,44} from ",Msg1),
   57:    ?line lists:prefix("*DBG* sys_SUITE_server sent {ok,-44} to ",Msg2),
   58:    ?line stop(),
   59:    ok.
<a name="60"></a>   60:
<a name=stats>   61:<b>stats</b></a>(suite) -&gt; [];
<a name=stats>   62:<b>stats</b></a>(Config) when list(Config) -&gt;
   63:    ?line Self = self(),
   64:    ?line {ok,Server} = start(),
   65:    ?line ok = sys:statistics(?server,true),
   66:    ?line {ok,-44} = public_call(44),
   67:    ?line {ok,Stats} = sys:statistics(?server,get),
   68:    ?line lists:member({messages_in,1},Stats),
   69:    ?line lists:member({messages_out,1},Stats),
<a name="70"></a>   70:    ?line ok = sys:statistics(?server,false),
   71:    ?line {status,Pid,{module,Mod},[PDict,running,Self,_,_]} =
   72:	sys:get_status(?server),
   73:    ?line {ok,no_statistics} = sys:statistics(?server,get),
   74:    ?line stop(),
   75:    ok.
   76:
<a name=trace>   77:<b>trace</b></a>(suite) -&gt; [];
<a name=trace>   78:<b>trace</b></a>(Config) when list(Config) -&gt;
   79:    ?line {ok,Server} = start(),
<a name="80"></a>   80:    case os:type() of
   81:	vxworks -&gt;
   82:	    ?line test_server:sleep(20000);
   83:	_ -&gt;
   84:	    ?line test_server:sleep(2000)
   85:    end,
   86:    ?line test_server:capture_start(),
   87:    ?line sys:trace(?server,true),
   88:    ?line {ok,-44} = public_call(44),
   89:    %% ho, hum, allow for the io to reach us..
<a name="90"></a>   90:    case os:type() of
   91:	vxworks -&gt;
   92:	    ?line test_server:sleep(10000);
   93:	_ -&gt;
   94:	    ?line test_server:sleep(1000)
   95:    end,
   96:    ?line test_server:capture_stop(),
   97:    ?line [Msg1,Msg2] = test_server:capture_get(),
   98:    ?line lists:prefix("*DBG* sys_SUITE_server got call {req,44} from ",Msg1),
   99:    ?line lists:prefix("*DBG* sys_SUITE_server sent {ok,-44} to ",Msg2),
<a name="100"></a>  100:    ?line stop(),
  101:    ok.
  102:
<a name=suspend>  103:<b>suspend</b></a>(suite) -&gt; [];
<a name=suspend>  104:<b>suspend</b></a>(Config) when list(Config) -&gt;
  105:    ?line Self = self(),
  106:    ?line {ok,Server} = start(),
  107:    ?line sys:suspend(?server,1000),
  108:    ?line {'EXIT',_} = (catch public_call(48)),
  109:    ?line {status,_,_,[_,suspended,_,_,_]} = sys:get_status(?server),
<a name="110"></a>  110:    ?line sys:suspend(?server,1000), %% doing it twice is no error
  111:    ?line {'EXIT',_} = (catch public_call(48)),
  112:    ?line sys:resume(?server),
  113:    ?line {status,_,_,[_,running,_,_,_]} = sys:get_status(?server),
  114:    ?line {ok,-48} = (catch public_call(48)),
  115:    ?line sys:resume(?server), %% doing it twice is no error
  116:    ?line {ok,-48} = (catch public_call(48)),
  117:    ?line stop(),
  118:    ok.
  119:
<a name=install><a name="120"></a>  120:<b>install</b></a>(suite) -&gt; [];
<a name=install>  121:<b>install</b></a>(Config) when list(Config) -&gt;
  122:    ?line {ok,Server} = start(),
  123:    ?line Master = self(),
  124:    ?line SpyFun = 
  125:	fun(func_state,Event,ProcState) -&gt;
  126:		case Event of
  127:		    {in,{'$gen_call',From,{req,Arg}}} -&gt;
  128:			io:format("Trigged\n"),
  129:			Master ! {spy_got,{request,Arg},ProcState};
<a name="130"></a>  130:		    Other -&gt;
  131:			io:format("Trigged other=~p\n",[Other])
  132:		end
  133:	end,
  134:    ?line sys:install(?server,{SpyFun,func_state}),
  135:    ?line {ok,-1} = (catch public_call(1)),
  136:    ?line sys:no_debug(?server),
  137:    ?line {ok,-2} = (catch public_call(2)),
  138:    ?line sys:install(?server,{SpyFun,func_state}),
  139:    ?line sys:install(?server,{SpyFun,func_state}),
<a name="140"></a>  140:    ?line {ok,-3} = (catch public_call(3)),
  141:    ?line sys:remove(?server,SpyFun),
  142:    ?line {ok,-4} = (catch public_call(4)),
  143:    ?line Msgs = test_server:messages_get(),
  144:    ?line [{spy_got,{request,1},sys_SUITE_server},
  145:	   {spy_got,{request,3},sys_SUITE_server}] = Msgs,
  146:    ?line stop(),
  147:    ok.
  148:
  149:<i>%%%%%%%%%%%%%%%%%%%%</i>
<a name="150"></a>  150:<i>%% Dummy server</i>
  151:
<a name=public_call>  152:<b>public_call</b></a>(Arg) -&gt;
  153:    gen_server:call(?server,{req,Arg},1000).
  154:
<a name=start>  155:<b>start</b></a>() -&gt;
  156:    gen_server:start_link({local,?server},?MODULE,[],[]).
  157:
<a name=stop>  158:<b>stop</b></a>() -&gt;
  159:    gen_server:call(?server,stop,1000).
<a name="160"></a>  160:
<a name=init>  161:<b>init</b></a>([]) -&gt;
  162:    {ok,0}.
  163:
<a name=handle_call>  164:<b>handle_call</b></a>({req,Arg},_From,State) -&gt;
  165:    NewState = State+1,
  166:    {reply,{ok,-Arg},NewState};
<a name=handle_call>  167:<b>handle_call</b></a>(stop,_From,State) -&gt;
  168:    {stop,normal,ok,State}.
  169:
<a name=terminate><a name="170"></a>  170:<b>terminate</b></a>(Reason,State) -&gt;
  171:    ok.
  172:
  173:<i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%    </i>
</pre>
<hr size=1><i>The transformation of this file (174 lines) took 0.00 seconds</i><br>
</body>
</html>
