<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head><title>/usr/home/jlouis/hacking/test_server/stdlib_test/dets_SUITE.erl</title></head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
    1:<i>%% ``The contents of this file are subject to the Erlang Public License,</i>
    2:<i>%% Version 1.1, (the "License"); you may not use this file except in</i>
    3:<i>%% compliance with the License. You should have received a copy of the</i>
    4:<i>%% Erlang Public License along with this software. If not, it can be</i>
    5:<i>%% retrieved via the world wide web at http://www.erlang.org/.</i>
    6:<i>%% </i>
    7:<i>%% Software distributed under the License is distributed on an "AS IS"</i>
    8:<i>%% basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See</i>
    9:<i>%% the License for the specific language governing rights and limitations</i>
<a name="10"></a>   10:<i>%% under the License.</i>
   11:<i>%% </i>
   12:<i>%% The Initial Developer of the Original Code is Ericsson Utvecklings AB.</i>
   13:<i>%% Portions created by Ericsson are Copyright 1999, Ericsson Utvecklings</i>
   14:<i>%% AB. All Rights Reserved.''</i>
   15:<i>%% </i>
   16:<i>%%     $Id $</i>
   17:<i>%%</i>
   18:-<b>module</b>(dets_SUITE).
   19:
<a name="20"></a>   20:<i>%-define(debug, true).</i>
   21:
   22:-<b>ifdef</b>(debug).
   23:-<b>define</b>(format(S, A), io:format(S, A)).
   24:-<b>define</b>(line, put(line, ?LINE), ).
   25:-<b>define</b>(config(X,Y), foo).
   26:-<b>define</b>(t, test_server).
   27:-<b>define</b>(privdir(_), "./dets_SUITE_priv").
   28:-<b>define</b>(datadir(_), "./dets_SUITE_data").
   29:-<b>else</b>.
<a name="30"></a>   30:-<b>include</b>("test_server.hrl").
   31:-<b>define</b>(format(S, A), ok).
   32:-<b>define</b>(privdir(Conf), ?config(priv_dir, Conf)).
   33:-<b>define</b>(datadir(Conf), ?config(data_dir, Conf)).
   34:-<b>endif</b>.
   35:
   36:-<b>export</b>([all/1, not_run/1, newly_started/1, basic_v8/1, basic_v9/1,
   37:	 open_v8/1, open_v9/1, sets_v8/1, sets_v9/1, bags_v8/1,
   38:	 bags_v9/1, duplicate_bags_v8/1, duplicate_bags_v9/1,
   39:	 access_v8/1, access_v9/1, dirty_mark/1, dirty_mark2/1,
<a name="40"></a>   40:	 bag_next_v8/1, bag_next_v9/1, oldbugs_v8/1, oldbugs_v9/1,
   41:	 unsafe_assumptions/1, truncated_segment_array_v8/1,
   42:	 truncated_segment_array_v9/1, open_file_v8/1, open_file_v9/1,
   43:	 init_table_v8/1, init_table_v9/1, repair_v8/1, repair_v9/1,
   44:	 hash_v8b_v8c/1, phash/1, fold_v8/1, fold_v9/1, fixtable_v8/1,
   45:	 fixtable_v9/1, match_v8/1, match_v9/1, select_v8/1,
   46:	 select_v9/1, update_counter/1, badarg/1, cache_sets_v8/1,
   47:	 cache_sets_v9/1, cache_bags_v8/1, cache_bags_v9/1,
   48:	 cache_duplicate_bags_v8/1, cache_duplicate_bags_v9/1,
   49:	 otp_4208/1, otp_4989/1, many_clients/1, otp_4906/1]).
<a name="50"></a>   50:
   51:-<b>export</b>([dets_dirty_loop/0]).
   52:
   53:-<b>export</b>([histogram/1, sum_histogram/1, ave_histogram/1]).
   54:
   55:-<b>export</b>([init_per_testcase/2, fin_per_testcase/2]).
   56:
   57:<i>%% Internal export.</i>
   58:-<b>export</b>([client/2]).
   59:
<a name="60"></a>   60:-<b>import</b>(lists, 
   61:	[append/1, delete/2, duplicate/2, filter/2, foreach/2, keysearch/3, 
   62:	 last/1, map/2, member/2, reverse/1, seq/2, sort/1, usort/1]).
   63:
   64:-<b>include_lib</b>("kernel/include/file.hrl").
   65:
   66:-<b>define</b>(DETS_SERVER, dets).
   67:
   68:<i>%% HEADSZ taken from dets_v8.erl and dets_v9.erl.</i>
   69:-<b>define</b>(HEADSZ_v8, 40).
<a name="70"></a>   70:-<b>define</b>(HEADSZ_v9, (56+28*4+16)).
   71:-<b>define</b>(NO_KEYS_POS_v9, 36).
   72:-<b>define</b>(CLOSED_PROPERLY_POS, 8).
   73:
   74:-<b>define</b>(NOT_PROPERLY_CLOSED,0).
   75:-<b>define</b>(CLOSED_PROPERLY,1).
   76:
<a name=init_per_testcase>   77:<b>init_per_testcase</b></a>(_Case, Config) -&gt;
   78:    Dog=?t:timetrap(?t:minutes(15)),
   79:    [{watchdog, Dog}|Config].
<a name="80"></a>   80:
<a name=fin_per_testcase>   81:<b>fin_per_testcase</b></a>(_Case, Config) -&gt;
   82:    Dog=?config(watchdog, Config),
   83:    test_server:timetrap_cancel(Dog),
   84:    ok.
   85:
<a name=all>   86:<b>all</b></a>(suite) -&gt;
   87:    case os:type() of
   88:	vxworks -&gt;
   89:	    [not_run];
<a name="90"></a>   90:	_ -&gt;
   91:	    {req,[stdlib],
   92:	     [basic_v8, basic_v9, open_v8, open_v9, sets_v8, sets_v9,
   93:	      bags_v8, bags_v9, duplicate_bags_v8, duplicate_bags_v9,
   94:	      newly_started, open_file_v8, open_file_v9,
   95:	      init_table_v8, init_table_v9, repair_v8, repair_v9,
   96:	      access_v8, access_v9, oldbugs_v8, oldbugs_v9,
   97:	      unsafe_assumptions, truncated_segment_array_v8,
   98:	      truncated_segment_array_v9, dirty_mark, dirty_mark2,
   99:	      bag_next_v8, bag_next_v9, hash_v8b_v8c, phash, fold_v8,
<a name="100"></a>  100:	      fold_v9, fixtable_v8, fixtable_v9, match_v8, match_v9,
  101:	      select_v8, select_v9, update_counter, badarg,
  102:	      cache_sets_v8, cache_sets_v9, cache_bags_v8,
  103:	      cache_bags_v9, cache_duplicate_bags_v8,
  104:	      cache_duplicate_bags_v9, otp_4208, otp_4989, many_clients, 
  105:              otp_4906]} end.
  106:
<a name=not_run>  107:<b>not_run</b></a>(suite) -&gt; [];
<a name=not_run>  108:<b>not_run</b></a>(Conf) when list(Conf) -&gt;
  109:    {comment, "Not runnable VxWorks/NFS"}.
<a name="110"></a>  110:
<a name=newly_started>  111:<b>newly_started</b></a>(doc) -&gt;
  112:    ["OTP-3621"];
<a name=newly_started>  113:<b>newly_started</b></a>(suite) -&gt; 
  114:    [];
<a name=newly_started>  115:<b>newly_started</b></a>(Config) when list(Config) -&gt;
  116:    ?line true = is_alive(),
  117:    ?line {ok, Node} = test_server:start_node(slave1, slave, []),
  118:    ?line [] = rpc:call(Node, dets, all, []),
  119:    ok.
<a name="120"></a>  120:
<a name=basic_v8>  121:<b>basic_v8</b></a>(doc) -&gt;
  122:    ["Basic test case."];
<a name=basic_v8>  123:<b>basic_v8</b></a>(suite) -&gt; 
  124:    [];
<a name=basic_v8>  125:<b>basic_v8</b></a>(Config) when list(Config) -&gt;
  126:    basic(Config, 8).
  127:
<a name=basic_v9>  128:<b>basic_v9</b></a>(doc) -&gt;
  129:    ["Basic test case."];
<a name=basic_v9><a name="130"></a>  130:<b>basic_v9</b></a>(suite) -&gt; 
  131:    [];
<a name=basic_v9>  132:<b>basic_v9</b></a>(Config) when list(Config) -&gt;
  133:    basic(Config, 9).
  134:
<a name=basic>  135:<b>basic</b></a>(Config, Version) -&gt;
  136:    ?line Tab = dets_basic_test,
  137:    ?line FName = filename(Tab, Config),
  138:
  139:    P0 = pps(),
<a name="140"></a>  140:    ?line {ok, _} = dets:open_file(Tab,[{file, FName},{version,Version}]),
  141:    ?line ok = dets:insert(Tab,{mazda,japan}),
  142:    ?line ok = dets:insert(Tab,{toyota,japan}),
  143:    ?line ok = dets:insert(Tab,{suzuki,japan}),
  144:    ?line ok = dets:insert(Tab,{honda,japan}),
  145:    ?line ok = dets:insert(Tab,{renault,france}),
  146:    ?line ok = dets:insert(Tab,{citroen,france}),
  147:    ?line ok = dets:insert(Tab,{opel,germany}),
  148:    ?line ok = dets:insert(Tab,{saab,sweden}),
  149:    ?line ok = dets:insert(Tab,{volvo,sweden}),
<a name="150"></a>  150:    ?line [{opel,germany}] = dets:lookup(Tab,opel),
  151:    ?line Japs = dets:traverse(Tab, fun(Obj) -&gt; 
  152:					   case Obj of 
  153:					       {_, japan} -&gt; {continue, Obj};
  154:					       _ -&gt; continue
  155:					   end
  156:				    end),
  157:    ?line 4  = length(Japs),
  158:    ?line ok = dets:close(Tab),
  159:    ?line file:delete(FName),
<a name="160"></a>  160:    ?line P0 == pps(),
  161:    ok.
  162:    
  163:
<a name=open_v8>  164:<b>open_v8</b></a>(doc) -&gt;
  165:    [];
<a name=open_v8>  166:<b>open_v8</b></a>(suite) -&gt; 
  167:    [];
<a name=open_v8>  168:<b>open_v8</b></a>(Config) when list(Config) -&gt;
  169:    open(Config, 8).
<a name="170"></a>  170:
<a name=open_v9>  171:<b>open_v9</b></a>(doc) -&gt;
  172:    [];
<a name=open_v9>  173:<b>open_v9</b></a>(suite) -&gt; 
  174:    [];
<a name=open_v9>  175:<b>open_v9</b></a>(Config) when list(Config) -&gt;
  176:    open(Config, 9).
  177:
<a name=open>  178:<b>open</b></a>(Config, Version) -&gt;
  179:    ?line {Sets, Bags, Dups} = args(Config),
<a name="180"></a>  180:    
  181:    ?line dets:stop(),
  182:    ?line All = Sets ++ Bags ++ Dups,
  183:    ?line delete_files(All),
  184:
  185:    ?line Data = make_data(1),
  186:
  187:    P0 = pps(),
  188:    ?line Tabs = open_files(1, All, Version),
  189:    ?line initialize(Tabs, Data),
<a name="190"></a>  190:    ?line check(Tabs, Data),
  191:
  192:    ?line foreach(fun(Tab) -&gt; ok = dets:close(Tab) end, Tabs),
  193:    %% Now reopen the files
  194:    ?format("Reopening closed files \n", []),
  195:    ?line Tabs = open_files(1, All, Version),
  196:    ?format("Checking contents of reopened files \n", []),
  197:    ?line check(Tabs, Data),
  198:    %% crash the dets server
  199:
<a name="200"></a>  200:    ?format("Crashing dets server \n", []),
  201:    process_flag(trap_exit, true),
  202:    Procs = [whereis(?DETS_SERVER) | map(fun(Tab) -&gt; dets:info(Tab, pid) end,
  203:				 Tabs)],
  204:    foreach(fun(Pid) -&gt; exit(Pid, kill) end, Procs),
  205:    c:flush(),  %% flush all the EXIT sigs
  206:    timer:sleep(200),
  207:
  208:    %% Now reopen the files again
  209:    ?format("Reopening crashed files \n", []),
<a name="210"></a>  210:    ?line open_files(1, All, Version),
  211:    ?format("Checking contents of repaired files \n", []),
  212:    ?line check(Tabs, Data),
  213:    
  214:    ?line close_all(Tabs),
  215:
  216:    ?line delete_files(All),
  217:    ?line P0 == pps(),
  218:    ok.
  219:    
<a name=check><a name="220"></a>  220:<b>check</b></a>(Tabs, Data) -&gt;
  221:    foreach(fun(Tab) -&gt;
  222:		    ?line Kp = dets:info(Tab, keypos), 
  223:		    ?format("checking ~p~n", [Tab]),
  224:		    foreach(fun(Item) -&gt;
  225:				    case dets:lookup(Tab, k(Kp,Item)) of
  226:					[Item] -&gt; ok;
  227:					_Other -&gt; bad(Tab,Item)
  228:				    end
  229:			    end, Data)
<a name="230"></a>  230:	    end, Tabs),
  231:    ok.
  232:    
<a name=k>  233:<b>k</b></a>(Kp, Obj) -&gt; element(Kp, Obj).
  234:
<a name=bad>  235:<b>bad</b></a>(_Tab, _Item) -&gt;
  236:    ?format("Can't find item ~p in ~p ~n", [_Item, _Tab]),
  237:    exit(badtab).
  238:
<a name=sets_v8>  239:<b>sets_v8</b></a>(doc) -&gt;
<a name="240"></a>  240:    ["Performs traversal and match testing on set type dets tables."];
<a name=sets_v8>  241:<b>sets_v8</b></a>(suite) -&gt;
  242:    [];
<a name=sets_v8>  243:<b>sets_v8</b></a>(Config) when list(Config) -&gt;
  244:    sets(Config, 8).
  245:
<a name=sets_v9>  246:<b>sets_v9</b></a>(doc) -&gt;
  247:    ["Performs traversal and match testing on set type dets tables."];
<a name=sets_v9>  248:<b>sets_v9</b></a>(suite) -&gt;
  249:    [];
<a name=sets_v9><a name="250"></a>  250:<b>sets_v9</b></a>(Config) when list(Config) -&gt;
  251:    sets(Config, 9).
  252:
<a name=sets>  253:<b>sets</b></a>(Config, Version) -&gt;
  254:    ?line {Sets, _, _} = args(Config),
  255:
  256:    ?line Data = make_data(1),
  257:    ?line delete_files(Sets),
  258:    P0 = pps(),
  259:    ?line Tabs = open_files(1, Sets, Version),
<a name="260"></a>  260:    Bigger = [{17,q,w,w}, {48,q,w,w,w,w,w,w}], % 48 requires a bigger buddy
  261:    ?line initialize(Tabs, Data++Bigger++Data), % overwrite
  262:    ?line Len = length(Data),
  263:    ?line foreach(fun(Tab) -&gt; trav_test(Data, Len, Tab) end, Tabs),
  264:    ?line size_test(Len, Tabs),
  265:    ?line no_keys_test(Tabs),
  266:    ?line foreach(fun(Tab) -&gt; del_test(Tab) end, Tabs),
  267:    ?line initialize(Tabs, Data),
  268:    ?line foreach(fun(Tab) -&gt; del_obj_test(Tab) end, Tabs),
  269:    ?line initialize(Tabs, Data),
<a name="270"></a>  270:    ?line foreach(fun(Tab) -&gt;
  271:			  Len = dets:info(Tab, size) end, 
  272:		  Tabs),
  273:    ?line foreach(fun(Tab) -&gt; match_test(Data, Tab) end, Tabs),
  274:    ?line foreach(fun(Tab) -&gt; match_del_test(Tab) end, Tabs),
  275:    
  276:    ?line close_all(Tabs),
  277:    ?line delete_files(Sets),
  278:    ?line P0 == pps(),
  279:    ok.
<a name="280"></a>  280:
<a name=bags_v8>  281:<b>bags_v8</b></a>(doc) -&gt;
  282:    ["Performs traversal and match testing on bag type dets tables."];
<a name=bags_v8>  283:<b>bags_v8</b></a>(suite) -&gt;
  284:    [];
<a name=bags_v8>  285:<b>bags_v8</b></a>(Config) when list(Config) -&gt;
  286:    bags(Config, 8).
  287:
<a name=bags_v9>  288:<b>bags_v9</b></a>(doc) -&gt;
  289:    ["Performs traversal and match testing on bag type dets tables."];
<a name=bags_v9><a name="290"></a>  290:<b>bags_v9</b></a>(suite) -&gt;
  291:    [];
<a name=bags_v9>  292:<b>bags_v9</b></a>(Config) when list(Config) -&gt;
  293:    bags(Config, 9).
  294:
<a name=bags>  295:<b>bags</b></a>(Config, Version) -&gt;
  296:    {_, Bags, _} = args(Config),
  297:    ?line Data = make_data(1, bag),  %% gives twice as many objects
  298:    ?line delete_files(Bags),
  299:    P0 = pps(),
<a name="300"></a>  300:    ?line Tabs = open_files(1, Bags, Version),
  301:    ?line initialize(Tabs, Data++Data),
  302:    ?line Len = length(Data),
  303:    ?line foreach(fun(Tab) -&gt; trav_test(Data, Len, Tab) end, Tabs),
  304:    ?line size_test(Len, Tabs),
  305:    ?line no_keys_test(Tabs),
  306:    ?line foreach(fun(Tab) -&gt; del_test(Tab) end, Tabs),
  307:    ?line initialize(Tabs, Data),
  308:    ?line foreach(fun(Tab) -&gt; del_obj_test(Tab) end, Tabs),
  309:    ?line initialize(Tabs, Data),
<a name="310"></a>  310:    ?line foreach(fun(Tab) -&gt;
  311:			  Len = dets:info(Tab, size) end, 
  312:		  Tabs),
  313:    ?line foreach(fun(Tab) -&gt; match_test(Data, Tab) end, Tabs),
  314:    ?line foreach(fun(Tab) -&gt; match_del_test(Tab) end, Tabs),
  315:    ?line close_all(Tabs),
  316:    ?line delete_files(Bags),
  317:    ?line P0 == pps(),
  318:    ok.
  319:
<a name="320"></a>  320:
<a name=duplicate_bags_v8>  321:<b>duplicate_bags_v8</b></a>(doc) -&gt;
  322:   ["Performs traversal and match testing on duplicate_bag type dets tables."];
<a name=duplicate_bags_v8>  323:<b>duplicate_bags_v8</b></a>(suite) -&gt;
  324:    [];
<a name=duplicate_bags_v8>  325:<b>duplicate_bags_v8</b></a>(Config) when list(Config) -&gt;
  326:    duplicate_bags(Config, 8).
  327:
<a name=duplicate_bags_v9>  328:<b>duplicate_bags_v9</b></a>(doc) -&gt;
  329:   ["Performs traversal and match testing on duplicate_bag type dets tables."];
<a name=duplicate_bags_v9><a name="330"></a>  330:<b>duplicate_bags_v9</b></a>(suite) -&gt;
  331:    [];
<a name=duplicate_bags_v9>  332:<b>duplicate_bags_v9</b></a>(Config) when list(Config) -&gt;
  333:    duplicate_bags(Config, 9).
  334:
<a name=duplicate_bags>  335:<b>duplicate_bags</b></a>(Config, Version) when list(Config) -&gt;
  336:    {_, _, Dups} = args(Config),
  337:    ?line Data = make_data(1, duplicate_bag), %% gives twice as many objects
  338:    ?line delete_files(Dups),
  339:    P0 = pps(),
<a name="340"></a>  340:    ?line Tabs = open_files(1, Dups, Version),
  341:    ?line initialize(Tabs, Data),
  342:    ?line Len = length(Data),
  343:    ?line foreach(fun(Tab) -&gt; trav_test(Data, Len, Tab) end, Tabs),
  344:    ?line size_test(Len, Tabs),
  345:    ?line no_keys_test(Tabs),
  346:    ?line foreach(fun(Tab) -&gt; del_test(Tab) end, Tabs),
  347:    ?line initialize(Tabs, Data),
  348:    ?line foreach(fun(Tab) -&gt; del_obj_test(Tab) end, Tabs),
  349:    ?line initialize(Tabs, Data),
<a name="350"></a>  350:    ?line foreach(fun(Tab) -&gt;
  351:			  Len = dets:info(Tab, size) end, 
  352:		  Tabs),
  353:    ?line foreach(fun(Tab) -&gt; match_test(Data, Tab) end, Tabs),
  354:    ?line foreach(fun(Tab) -&gt; match_del_test(Tab) end, Tabs),
  355:    ?line close_all(Tabs),
  356:    ?line delete_files(Dups),
  357:    ?line P0 == pps(),
  358:    ok.
  359:
<a name="360"></a>  360:
<a name=access_v8>  361:<b>access_v8</b></a>(doc) -&gt;
  362:    [];
<a name=access_v8>  363:<b>access_v8</b></a>(suite) -&gt;
  364:    [];
<a name=access_v8>  365:<b>access_v8</b></a>(Config) when list(Config) -&gt;
  366:    access(Config, 8).
  367:
<a name=access_v9>  368:<b>access_v9</b></a>(doc) -&gt;
  369:    [];
<a name=access_v9><a name="370"></a>  370:<b>access_v9</b></a>(suite) -&gt;
  371:    [];
<a name=access_v9>  372:<b>access_v9</b></a>(Config) when list(Config) -&gt;
  373:    access(Config, 9).
  374:
<a name=access>  375:<b>access</b></a>(Config, Version) -&gt;
  376:    Args_acc = [[{ram_file, true}, {access, read}],
  377:		[{access, read}]],
  378:    Args = [[{ram_file, true}],
  379:	    []],
<a name="380"></a>  380:    
  381:    ?line {Args_acc_1, _, _} = zip_filename(Args_acc, [], [], Config),
  382:    ?line delete_files(Args_acc_1),
  383:    ?line {Args_1, _, _} = zip_filename(Args, [], [], Config),
  384:
  385:    P0 = pps(),
  386:    ?line {error, {file_error,_,enoent}} = dets:open_file('1', hd(Args_acc_1)),
  387:
  388:    ?line Tabs = open_files(1, Args_1, Version),
  389:    ?line close_all(Tabs),
<a name="390"></a>  390:    ?line Tabs = open_files(1, Args_acc_1, Version),
  391:
  392:    ?line foreach(fun(Tab) -&gt;
  393:			  {error, {access_mode,_}} = dets:insert(Tab, {1,2}),
  394:			  [] = dets:lookup(Tab, 11),
  395:			  '$end_of_table' = dets:first(Tab),
  396:			  {error, {access_mode,_}} = dets:delete(Tab, 22)
  397:		  end, Tabs),
  398:    ?line close_all(Tabs),
  399:    ?line delete_files(Args_acc_1),
<a name="400"></a>  400:    ?line P0 == pps(),
  401:    ok.
  402:
  403:
<a name=dirty_mark>  404:<b>dirty_mark</b></a>(doc) -&gt;
  405:    ["Test that the table is not marked dirty if not written"];
<a name=dirty_mark>  406:<b>dirty_mark</b></a>(suite) -&gt;
  407:    [];
<a name=dirty_mark>  408:<b>dirty_mark</b></a>(Config) when list(Config) -&gt;
  409:    ?line true = is_alive(),
<a name="410"></a>  410:    ?line Tab = dets_dirty_mark_test,
  411:    ?line FName = filename(Tab, Config),
  412:    P0 = pps(),
  413:    ?line dets:open_file(Tab,[{file, FName}]),
  414:    ?line dets:insert(Tab,{mazda,japan}),
  415:    ?line dets:insert(Tab,{toyota,japan}),
  416:    ?line dets:insert(Tab,{suzuki,japan}),
  417:    ?line dets:insert(Tab,{honda,japan}),
  418:    ?line dets:insert(Tab,{renault,france}),
  419:    ?line dets:insert(Tab,{citroen,france}),
<a name="420"></a>  420:    ?line dets:insert(Tab,{opel,germany}),
  421:    ?line dets:insert(Tab,{saab,sweden}),
  422:    ?line dets:insert(Tab,{volvo,sweden}),
  423:    ?line [{opel,germany}] = dets:lookup(Tab,opel),
  424:    ?line ok = dets:close(Tab),
  425:    ?line Call = fun(P,A) -&gt;
  426:		   P ! {self(), A},
  427:		   receive
  428:		       {P, Ans} -&gt;
  429:			   Ans
<a name="430"></a>  430:		   after 5000 -&gt;
  431:			   exit(other_process_dead)
  432:		   end
  433:	   end,
  434:    ?line {ok, Node} = test_server:start_node(dets_dirty_mark, 
  435:					      slave,
  436:					      [{linked, false},
  437:					       {args, "-pa " ++ 
  438:					       filename:dirname
  439:						(code:which(?MODULE))}]),
<a name="440"></a>  440:    ?line ok = ensure_node(20, Node),
  441:    %% io:format("~p~n",[rpc:call(Node, code, get_path, [])]),
  442:    %% io:format("~p~n",[rpc:call(Node, file, get_cwd, [])]),
  443:    %% io:format("~p~n",[Config]),
  444:    ?line Pid = rpc:call(Node,erlang, spawn, 
  445:			 [?MODULE, dets_dirty_loop, []]),
  446:    ?line {ok, Tab} = Call(Pid, [open, Tab, [{file, FName}]]),
  447:    ?line [{opel,germany}] = Call(Pid, [read,Tab,opel]),
  448:    ?line {badrpc, nodedown} = rpc:call(Node,erlang,halt,[]),
  449:    ?line {ok, Tab} = dets:open_file(Tab,[{file, FName}, 
<a name="450"></a>  450:					  {repair,false}]),
  451:    ?line ok = dets:close(Tab),
  452:    ?line file:delete(FName),
  453:    ?line P0 == pps(),
  454:    ok.
  455:
<a name=dirty_mark2>  456:<b>dirty_mark2</b></a>(doc) -&gt;
  457:    ["Test that the table is flushed when auto_save is in effect"];
<a name=dirty_mark2>  458:<b>dirty_mark2</b></a>(suite) -&gt;
  459:    [];
<a name=dirty_mark2><a name="460"></a>  460:<b>dirty_mark2</b></a>(Config) when list(Config) -&gt;
  461:    ?line true = is_alive(),
  462:    ?line Tab = dets_dirty_mark2_test,
  463:    ?line FName = filename(Tab, Config),
  464:    P0 = pps(),
  465:    ?line dets:open_file(Tab,[{file, FName}]),
  466:    ?line dets:insert(Tab,{toyota,japan}),
  467:    ?line dets:insert(Tab,{suzuki,japan}),
  468:    ?line dets:insert(Tab,{honda,japan}),
  469:    ?line dets:insert(Tab,{renault,france}),
<a name="470"></a>  470:    ?line dets:insert(Tab,{citroen,france}),
  471:    ?line dets:insert(Tab,{opel,germany}),
  472:    ?line dets:insert(Tab,{saab,sweden}),
  473:    ?line dets:insert(Tab,{volvo,sweden}),
  474:    ?line [{opel,germany}] = dets:lookup(Tab,opel),
  475:    ?line ok = dets:close(Tab),
  476:    ?line Call = fun(P,A) -&gt;
  477:		   P ! {self(), A},
  478:		   receive
  479:		       {P, Ans} -&gt;
<a name="480"></a>  480:			   Ans
  481:		   after 5000 -&gt;
  482:			   exit(other_process_dead)
  483:		   end
  484:	   end,
  485:    ?line {ok, Node} = test_server:start_node(dets_dirty_mark2, 
  486:					      slave,
  487:					      [{linked, false},
  488:					       {args, "-pa " ++ 
  489:					       filename:dirname
<a name="490"></a>  490:						(code:which(?MODULE))}]),
  491:    ?line ok = ensure_node(20, Node),
  492:    ?line Pid = rpc:call(Node,erlang, spawn, 
  493:			 [?MODULE, dets_dirty_loop, []]),
  494:    ?line {ok, Tab} = Call(Pid, [open, Tab, [{file, FName},{auto_save,1000}]]),
  495:    ?line ok = Call(Pid, [write,Tab,{mazda,japan}]),
  496:    ?line timer:sleep(2100),
  497:    %% Read something, just to give auto save time to finish.
  498:    ?line [{opel,germany}] = Call(Pid, [read,Tab,opel]),
  499:    ?line {badrpc, nodedown} = rpc:call(Node,erlang,halt,[]),
<a name="500"></a>  500:    ?line {ok, Tab} = dets:open_file(Tab, [{file, FName}, {repair,false}]),
  501:    ?line ok = dets:close(Tab),
  502:    ?line file:delete(FName),
  503:    ?line P0 == pps(),
  504:    ok.
  505:
<a name=dets_dirty_loop>  506:<b>dets_dirty_loop</b></a>() -&gt;
  507:    receive 
  508:	{From, [open, Name, Args]} -&gt;
  509:	    Ret = dets:open_file(Name, Args),
<a name="510"></a>  510:	    From ! {self(), Ret},
  511:	    dets_dirty_loop();
  512:	{From, [read, Name, Key]} -&gt;
  513:	    Ret = dets:lookup(Name, Key),
  514:	    From ! {self(), Ret},
  515:	    dets_dirty_loop();
  516:	{From, [write, Name, Value]} -&gt;
  517:	    Ret = dets:insert(Name, Value),
  518:	    From ! {self(), Ret},
  519:	    dets_dirty_loop()
<a name="520"></a>  520:    end.
  521:
  522:
<a name=bag_next_v8>  523:<b>bag_next_v8</b></a>(suite) -&gt;
  524:    [];
<a name=bag_next_v8>  525:<b>bag_next_v8</b></a>(doc) -&gt;
  526:    ["Check that bags and next work as expected."];
<a name=bag_next_v8>  527:<b>bag_next_v8</b></a>(Config) when list(Config) -&gt;
  528:    bag_next(Config, 8).
  529:
<a name=bag_next_v9><a name="530"></a>  530:<b>bag_next_v9</b></a>(suite) -&gt;
  531:    [];
<a name=bag_next_v9>  532:<b>bag_next_v9</b></a>(doc) -&gt;
  533:    ["Check that bags and next work as expected."];
<a name=bag_next_v9>  534:<b>bag_next_v9</b></a>(Config) when list(Config) -&gt;
  535:    ?line Tab = dets_bag_next_test,
  536:    ?line FName = filename(Tab, Config),
  537:
  538:    %% first and next crash upon error
  539:    ?line dets:open_file(Tab,[{file, FName}, {type, bag},{version,9}]),
<a name="540"></a>  540:    ?line ok = dets:insert(Tab, [{1,1},{2,2},{3,3},{4,4}]),
  541:    ?line FirstKey = dets:first(Tab),
  542:    ?line NextKey = dets:next(Tab, FirstKey),
  543:    ?line [FirstObj | _] = dets:lookup(Tab, FirstKey),
  544:    ?line [NextObj | _] = dets:lookup(Tab, NextKey),
  545:    ?line {ok, FirstPos} = dets:where(Tab, FirstObj),
  546:    ?line {ok, NextPos} = dets:where(Tab, NextObj),
  547:    crash(FName, NextPos+12),
  548:    ?line {'EXIT', {error, {bad_object,FName}}} = 
  549:	(catch dets:next(Tab, FirstKey)),
<a name="550"></a>  550:    crash(FName, FirstPos+12),
  551:    ?line {'EXIT', {error, {bad_object,FName}}} = 
  552:	(catch dets:first(Tab)),
  553:    ?line dets:close(Tab),
  554:    ?line file:delete(FName),
  555:
  556:    bag_next(Config, 9).
  557:
<a name=bag_next>  558:<b>bag_next</b></a>(Config, Version) -&gt;
  559:    ?line Tab = dets_bag_next_test,
<a name="560"></a>  560:    ?line FName = filename(Tab, Config),
  561:    P0 = pps(),
  562:    ?line dets:open_file(Tab,[{file, FName}, {type, bag},{version,Version}]),
  563:    ?line dets:insert(Tab,{698,hopp}),
  564:    ?line dets:insert(Tab,{186,hopp}),
  565:    ?line dets:insert(Tab,{hej,hopp}),
  566:    ?line dets:insert(Tab,{186,plopp}),
  567:    Loop = fun(N, Last, Self) -&gt;
  568:		   case N of
  569:		       0 -&gt;
<a name="570"></a>  570:			   exit({unterminated_first_next_sequence, N, Last});
  571:		       _ -&gt;
  572:			   case Last of
  573:			       '$end_of_table' -&gt;
  574:				   ok;
  575:			       _ -&gt;
  576:				   Self(N-1, dets:next(Tab,Last), Self)
  577:			   end
  578:		   end
  579:	   end,
<a name="580"></a>  580:    ?line ok = Loop(4,dets:first(Tab),Loop),
  581:    ?line dets:close(Tab),
  582:    ?line file:delete(FName),
  583:    ?line P0 == pps(),
  584:    ok.
  585:
<a name=oldbugs_v8>  586:<b>oldbugs_v8</b></a>(doc) -&gt;
  587:    [];
<a name=oldbugs_v8>  588:<b>oldbugs_v8</b></a>(suite) -&gt;
  589:    [];
<a name=oldbugs_v8><a name="590"></a>  590:<b>oldbugs_v8</b></a>(Config) when list(Config) -&gt;
  591:    oldbugs(Config, 8).
  592:
<a name=oldbugs_v9>  593:<b>oldbugs_v9</b></a>(doc) -&gt;
  594:    [];
<a name=oldbugs_v9>  595:<b>oldbugs_v9</b></a>(suite) -&gt;
  596:    [];
<a name=oldbugs_v9>  597:<b>oldbugs_v9</b></a>(Config) when list(Config) -&gt;
  598:    oldbugs(Config, 9).
  599:
<a name=oldbugs><a name="600"></a>  600:<b>oldbugs</b></a>(Config, Version) -&gt;
  601:    FName = filename(dets_suite_oldbugs_test, Config),
  602:    P0 = pps(),
  603:    ?line {ok, ob} = dets:open_file(ob, [{version, Version},
  604:					 {type, bag}, {file, FName}]),
  605:    ?line ok = dets:insert(ob, {1, 2}),
  606:    ?line ok = dets:insert(ob, {1,3}),
  607:    ?line ok = dets:insert(ob, {1, 2}),
  608:    ?line 2 = dets:info(ob, size),  %% assertion
  609:    ?line ok = dets:close(ob),
<a name="610"></a>  610:    ?line file:delete(FName),
  611:    ?line P0 == pps(),
  612:    ok.
  613:
<a name=unsafe_assumptions>  614:<b>unsafe_assumptions</b></a>(suite) -&gt; [];
<a name=unsafe_assumptions>  615:<b>unsafe_assumptions</b></a>(doc) -&gt;
  616:    "Tests that shrinking an object and then expanding it works.";
<a name=unsafe_assumptions>  617:<b>unsafe_assumptions</b></a>(Config) when list(Config) -&gt;
  618:    FName = filename(dets_suite_unsafe_assumptions_test, Config),
  619:    ?line file:delete(FName),
<a name="620"></a>  620:    P0 = pps(),
  621:    ?line {ok, a} = dets:open_file(a, [{version,8},{file, FName}]),
  622:    O0 = {2,false},
  623:    O1 = {1, false},
  624:    O2 = {1, true},
  625:    O3 = {1, duplicate(20,false)},
  626:    O4 = {1, duplicate(25,false)}, % same 2-log as O3
  627:    ?line ok = dets:insert(a, O1),
  628:    ?line ok = dets:insert(a, O0),
  629:    ?line true = [O1,O0] == sort(get_all_objects(a)),
<a name="630"></a>  630:    ?line true = [O1,O0] == sort(get_all_objects_fast(a)),
  631:    ?line ok = dets:insert(a, O2),
  632:    ?line true = [O2,O0] == sort(get_all_objects(a)),
  633:    ?line true = [O2,O0] == sort(get_all_objects_fast(a)),
  634:    ?line ok = dets:insert(a, O3),
  635:    ?line true = [O3,O0] == sort(get_all_objects(a)),
  636:    ?line true = [O3,O0] == sort(get_all_objects_fast(a)),
  637:    ?line ok = dets:insert(a, O4),
  638:    ?line true = [O4,O0] == sort(get_all_objects(a)),
  639:    ?line true = [O4,O0] == sort(get_all_objects_fast(a)),
<a name="640"></a>  640:    ?line ok = dets:close(a),
  641:    ?line file:delete(FName),
  642:    ?line P0 == pps(),
  643:    ok.
  644:
<a name=truncated_segment_array_v8>  645:<b>truncated_segment_array_v8</b></a>(suite) -&gt; [];
<a name=truncated_segment_array_v8>  646:<b>truncated_segment_array_v8</b></a>(doc) -&gt;
  647:    "Tests that a file where the segment array has been truncated ",
  648:    "is possible to repair.";
<a name=truncated_segment_array_v8>  649:<b>truncated_segment_array_v8</b></a>(Config) when list(Config) -&gt;
<a name="650"></a>  650:    trunc_seg_array(Config, 8).
  651:
<a name=truncated_segment_array_v9>  652:<b>truncated_segment_array_v9</b></a>(suite) -&gt; [];
<a name=truncated_segment_array_v9>  653:<b>truncated_segment_array_v9</b></a>(doc) -&gt;
  654:    "Tests that a file where the segment array has been truncated ",
  655:    "is possible to repair.";
<a name=truncated_segment_array_v9>  656:<b>truncated_segment_array_v9</b></a>(Config) when list(Config) -&gt;
  657:    trunc_seg_array(Config, 9).
  658:
<a name=trunc_seg_array>  659:<b>trunc_seg_array</b></a>(Config, V) -&gt;
<a name="660"></a>  660:    TabRef = dets_suite_truncated_segment_array_test,
  661:    Fname = filename(TabRef, Config),
  662:    %% Create file that needs to be repaired
  663:    ?line file:delete(Fname),
  664:    P0 = pps(),
  665:    ?line {ok, TabRef} = dets:open_file(TabRef, [{file, Fname},{version,V}]),
  666:    ?line ok = dets:close(TabRef),
  667:    
  668:    %% Truncate the file
  669:    ?line HeadSize = headsz(V),
<a name="670"></a>  670:    ?line truncate(Fname, HeadSize + 10),
  671:    
  672:    %% Open the truncated file
  673:    ?line io:format("Expect repair:~n"),
  674:    ?line {ok, TabRef} = dets:open_file(TabRef, 
  675:					[{file, Fname}, {repair, true}]),
  676:    ?line ok = dets:close(TabRef),
  677:    ?line file:delete(Fname),
  678:    ?line P0 == pps(),
  679:    ok.
<a name="680"></a>  680:
<a name=open_file_v8>  681:<b>open_file_v8</b></a>(doc) -&gt;
  682:    ["open_file/1 test case."];
<a name=open_file_v8>  683:<b>open_file_v8</b></a>(suite) -&gt; 
  684:    [];
<a name=open_file_v8>  685:<b>open_file_v8</b></a>(Config) when list(Config) -&gt;
  686:    open_1(Config, 8).
  687:
<a name=open_file_v9>  688:<b>open_file_v9</b></a>(doc) -&gt;
  689:    ["open_file/1 test case."];
<a name=open_file_v9><a name="690"></a>  690:<b>open_file_v9</b></a>(suite) -&gt; 
  691:    [];
<a name=open_file_v9>  692:<b>open_file_v9</b></a>(Config) when list(Config) -&gt;
  693:    T = open_v9,
  694:    Fname = filename(T, Config),
  695:    ?line {ok, _} = dets:open_file(T, [{file,Fname},{version,9}]),
  696:    ?line 9 = dets:info(T, version),
  697:    ?line true = [self()] == dets:info(T, users),
  698:    ?line {ok, _} = dets:open_file(T, [{file,Fname},{version,9}]),
  699:    ?line {error,incompatible_arguments} = 
<a name="700"></a>  700:	dets:open_file(T, [{file,Fname},{version,8}]),
  701:    ?line true = [self(),self()] == dets:info(T, users),
  702:    ?line ok = dets:close(T),
  703:    ?line true = [self()] == dets:info(T, users),
  704:    ?line ok = dets:close(T),
  705:    ?line undefined = ets:info(T, users),
  706:    ?line file:delete(Fname),
  707:
  708:    open_1(Config, 9).
  709:
<a name=open_1><a name="710"></a>  710:<b>open_1</b></a>(Config, V) -&gt;
  711:    TabRef = open_file_1_test,
  712:    Fname = filename(TabRef, Config),
  713:    ?line file:delete(Fname),
  714:
  715:    P0 = pps(),
  716:    ?line {error,{file_error,Fname,enoent}} = dets:open_file(Fname),
  717:    
  718:    ?line ok = file:write_file(Fname, duplicate(100,65)),
  719:    ?line {error,{not_a_dets_file,Fname}} = dets:open_file(Fname),
<a name="720"></a>  720:    ?line file:delete(Fname),
  721:
  722:    HeadSize = headsz(V),
  723:    ?line {ok, TabRef} = dets:open_file(TabRef, [{file, Fname},{version,V}]),
  724:    ?line ok = dets:close(TabRef),
  725:    ?line truncate(Fname, HeadSize + 10),
  726:    ?line true = dets:is_dets_file(Fname),
  727:    ?line io:format("Expect repair:~n"),
  728:    ?line {ok, Ref} = dets:open_file(Fname), % repairing
  729:    ?line ok = dets:close(Ref),
<a name="730"></a>  730:    ?line file:delete(Fname),
  731:
  732:    %% truncated file header, invalid type
  733:    ?line {ok, TabRef} = dets:open_file(TabRef, [{file,Fname},{version,V}]),
  734:    ?line ok = ins(TabRef, 3000),
  735:    ?line ok = dets:close(TabRef),
  736:    TypePos = 12,
  737:    crash(Fname, TypePos),
  738:    ?line {error, {invalid_type_code,Fname}} = dets:open_file(Fname),
  739:    ?line truncate(Fname, HeadSize - 10),    
<a name="740"></a>  740:    ?line {error, {tooshort,Fname}} = dets:open_file(Fname),
  741:    ?line {ok, TabRef} = dets:open_file(TabRef, [{file,Fname},{version,V}]),
  742:    ?line ok = dets:close(TabRef),
  743:    ?line file:delete(Fname),
  744:
  745:    ?line {error,{file_error,{foo,bar},_}} = dets:is_dets_file({foo,bar}),
  746:    ?line P0 == pps(),
  747:    ok.
  748:
<a name=init_table_v8>  749:<b>init_table_v8</b></a>(doc) -&gt;
<a name="750"></a>  750:    ["initialize_table/2 and from_ets/2 test case."];
<a name=init_table_v8>  751:<b>init_table_v8</b></a>(suite) -&gt; 
  752:    [];
<a name=init_table_v8>  753:<b>init_table_v8</b></a>(Config) when list(Config) -&gt;
  754:    init_table(Config, 8).
  755:
<a name=init_table_v9>  756:<b>init_table_v9</b></a>(doc) -&gt;
  757:    ["initialize_table/2 and from_ets/2 test case."];
<a name=init_table_v9>  758:<b>init_table_v9</b></a>(suite) -&gt; 
  759:    [];
<a name=init_table_v9><a name="760"></a>  760:<b>init_table_v9</b></a>(Config) when list(Config) -&gt;
  761:    %% Objects are returned in "time order".
  762:    T = init_table_v9,
  763:    Fname = filename(T, Config),
  764:    ?line file:delete(Fname),
  765:    L = [{1,a},{2,b},{1,c},{2,c},{1,c},{2,a},{1,b}],
  766:    Input = init([L]),
  767:    ?line {ok, _} = dets:open_file(T, [{file,Fname},{version,9},
  768:				       {type,duplicate_bag}]),
  769:    ?line ok = dets:init_table(T, Input),
<a name="770"></a>  770:    ?line [{1,a},{1,c},{1,c},{1,b}] = dets:lookup(T, 1),
  771:    ?line [{2,b},{2,c},{2,a}] = dets:lookup(T, 2),
  772:    ?line ok = dets:close(T),
  773:    ?line file:delete(Fname),
  774:
  775:    init_table(Config, 9),
  776:    fast_init_table(Config).
  777:
<a name=init_table>  778:<b>init_table</b></a>(Config, V) -&gt;
  779:    TabRef = init_table_test,
<a name="780"></a>  780:    Fname = filename(TabRef, Config),
  781:    ?line file:delete(Fname),
  782:    P0 = pps(),
  783:
  784:    Args = [{file,Fname},{version,V},{auto_save,120000}],
  785:    ?line {ok, _} = dets:open_file(TabRef, Args),
  786:    ?line {'EXIT', _} = 
  787:	(catch dets:init_table(TabRef, fun(foo) -&gt; bar end)),
  788:    dets:close(TabRef),
  789:    ?line {ok, _} = dets:open_file(TabRef, Args),
<a name="790"></a>  790:    ?line {'EXIT', _} = (catch dets:init_table(TabRef, fun() -&gt; foo end)),
  791:    dets:close(TabRef),
  792:    ?line {ok, _} = dets:open_file(TabRef, Args),
  793:    ?line {'EXIT', {badarg, _}} = (catch dets:init_table(TabRef, nofun)),
  794:    ?line {'EXIT', {badarg, _}} = 
  795:	(catch dets:init_table(TabRef, fun(_X) -&gt; end_of_input end, 
  796:			       [{foo,bar}])),
  797:    dets:close(TabRef),
  798:    ?line {ok, _} = dets:open_file(TabRef, Args),
  799:    ?line away = (catch dets:init_table(TabRef, fun(_) -&gt; throw(away) end)),
<a name="800"></a>  800:    dets:close(TabRef),
  801:    ?line {ok, _} = dets:open_file(TabRef, Args),
  802:    ?line {error, {init_fun, fopp}} = 
  803:	dets:init_table(TabRef, fun(read) -&gt; fopp end),
  804:    dets:close(TabRef),
  805:
  806:    ?line {ok, _} = dets:open_file(TabRef, Args),
  807:    ?line dets:safe_fixtable(TabRef, true),
  808:    ?line {error, {fixed_table, TabRef}} = dets:init_table(TabRef, init([])),
  809:    ?line dets:safe_fixtable(TabRef, false),
<a name="810"></a>  810:    ?line ET = ets:new(foo,[]),
  811:    ?line ok = dets:from_ets(TabRef, ET),
  812:    ?line [] = get_all_objects(TabRef),
  813:    ?line [] = get_all_objects_fast(TabRef),
  814:    ?line true = ets:insert(ET, {1,a}),
  815:    ?line true = ets:insert(ET, {2,b}),
  816:    ?line ok = dets:from_ets(TabRef, ET),
  817:    ?line [{1,a},{2,b}] = sort(get_all_objects(TabRef)),
  818:    ?line [{1,a},{2,b}] = sort(get_all_objects_fast(TabRef)),
  819:    ?line true = ets:delete(ET),
<a name="820"></a>  820:    ?line 120000 = dets:info(TabRef, auto_save),
  821:    ?line ok = dets:close(TabRef),
  822:
  823:    ?line {ok, _} = dets:open_file(TabRef, [{access,read} | Args]),
  824:    ?line {error, {access_mode, Fname}} = dets:init_table(TabRef, init([])),
  825:    ?line ok = dets:close(TabRef),
  826:
  827:    ?line {ok, _} = dets:open_file(TabRef, Args),
  828:    ?line {error, invalid_objects_list} =
  829:	(catch dets:init_table(TabRef, init([[{1,2},bad,{3,4}]]))),
<a name="830"></a>  830:    ?line _ = dets:close(TabRef),
  831:    ?line file:delete(Fname),
  832:
  833:    L1 = [[{1,a},{2,b}],[],[{3,c}],[{4,d}],[]],
  834:    bulk_init(L1, set, 4, Config, V),
  835:    L2 = [[{1,a},{2,b}],[],[{2,q},{3,c}],[{4,d}],[{4,e},{2,q}]],
  836:    bulk_init(L2, set, 4, Config, V),
  837:    bulk_init(L2, bag, 6, Config, V),
  838:    bulk_init(L2, duplicate_bag, 7, Config, V),
  839:    bulk_init(L1, set, 4, 512, Config, V),
<a name="840"></a>  840:    bulk_init([], set, 0, 10000, Config, V),
  841:    file:delete(Fname),
  842:
  843:    %% Initiate a file that contains a lot of objects.
  844:    ?line {ok, _} = dets:open_file(TabRef, [{min_no_slots,10000} | Args]),
  845:    ?line ok = ins(TabRef, 6000),
  846:    Fun = init_fun(0, 10000),
  847:    ?line ok = dets:init_table(TabRef, Fun,{format,term}),
  848:    ?line All = sort(get_all_objects(TabRef)),
  849:    ?line FAll = get_all_objects_fast(TabRef),
<a name="850"></a>  850:    ?line true = All == sort(FAll),
  851:    ?line true = length(All) == 10000,
  852:    ?line ok = dets:close(TabRef),
  853:    ?line file:delete(Fname),
  854:
  855:    ?line {ok, _} = dets:open_file(TabRef, [{min_no_slots,4000} | Args]),
  856:    ?line ok = ins(TabRef, 6000),
  857:    ?line FileSize1 = dets:info(TabRef, file_size),
  858:    Fun2 = init_fun(0, 4000),
  859:    ?line ok = dets:init_table(TabRef, Fun2),
<a name="860"></a>  860:    ?line FileSize2 = dets:info(TabRef, file_size),
  861:    ?line ok = dets:close(TabRef),
  862:    ?line true = FileSize1 &gt; FileSize2,
  863:    ?line file:delete(Fname),
  864:
  865:    ?line P0 == pps(),
  866:    ok.
  867:
<a name=bulk_init>  868:<b>bulk_init</b></a>(Ls, Type, N, Config, V) -&gt;
  869:    bulk_init(Ls, Type, N, 256, Config, V).
<a name="870"></a>  870:
<a name=bulk_init>  871:<b>bulk_init</b></a>(Ls, Type, N, Est, Config, V) -&gt;
  872:    T = init_table_test,
  873:    Fname = filename(T, Config),
  874:    ?line file:delete(Fname),
  875:    Input = init(Ls),
  876:    Args = [{ram_file,false}, {type,Type},{keypos,1},{file,Fname},
  877:	    {estimated_no_objects, Est},{version,V}],
  878:    ?line {ok, T} = dets:open_file(T, Args),
  879:    ?line ok = dets:init_table(T, Input),
<a name="880"></a>  880:    ?line All = sort(get_all_objects(T)),
  881:    ?line FAll = get_all_objects_fast(T),
  882:    ?line true = All == sort(FAll),
  883:    ?line true = length(All) == N,
  884:    ?line true = dets:info(T, size) == N,
  885:    ?line ok = dets:close(T),
  886:    
  887:    ?line {ok, T} = dets:open_file(T, Args),
  888:    ?line All2 = sort(get_all_objects(T)),
  889:    ?line FAll2 = get_all_objects_fast(T),
<a name="890"></a>  890:    ?line true = All == All2,
  891:    ?line true = All == sort(FAll2),
  892:    ?line ok = dets:close(T),
  893:    ?line file:delete(Fname).
  894:
<a name=init>  895:<b>init</b></a>(L) -&gt;
  896:    fun(close) -&gt;
  897:	    ok;
  898:       (read) when [] == L -&gt;
  899:	    end_of_input;
<a name="900"></a>  900:       (read) -&gt;
  901:	    [E | Es] = L,
  902:	    {E, init(Es)}
  903:    end.
  904:
<a name=init_fun>  905:<b>init_fun</b></a>(I, N) -&gt;
  906:    fun(read) when I == N -&gt;
  907:	    end_of_input;
  908:       (read) -&gt;
  909:	    {NewN, Items} = items(I, N, 1000, []),
<a name="910"></a>  910:	    {Items, init_fun(NewN, N)};
  911:       (close) -&gt;
  912:	    ignored
  913:    end.
  914:
<a name=fast_init_table>  915:<b>fast_init_table</b></a>(Config) -&gt;
  916:    V = 9,
  917:    TabRef = init_table_test,
  918:    Fname = filename(TabRef, Config),
  919:    ?line file:delete(Fname),
<a name="920"></a>  920:    P0 = pps(),
  921:
  922:    Args = [{file,Fname},{version,V},{auto_save,120000}],
  923:
  924:    Source = init_table_test_source,
  925:    SourceFname = filename(Source, Config),
  926:    ?line file:delete(SourceFname),
  927:    SourceArgs = [{file,SourceFname},{version,V},{auto_save,120000}],
  928:
  929:    ?line {ok, Source} = dets:open_file(Source, SourceArgs),
<a name="930"></a>  930:    
  931:    ?line {ok, _} = dets:open_file(TabRef, Args),
  932:    ?line {'EXIT', _} = 
  933:	(catch dets:init_table(TabRef, fun(foo) -&gt; bar end, {format,bchunk})),
  934:    dets:close(TabRef),
  935:    ?line {ok, _} = dets:open_file(TabRef, Args),
  936:    ?line {'EXIT', _} = (catch dets:init_table(TabRef, fun() -&gt; foo end,
  937:					       {format,bchunk})),
  938:    dets:close(TabRef),
  939:    ?line {ok, _} = dets:open_file(TabRef, Args),
<a name="940"></a>  940:    ?line {'EXIT', {badarg, _}} = 
  941:	(catch dets:init_table(TabRef, nofun, {format,bchunk})),
  942:    dets:close(TabRef),
  943:    ?line {ok, _} = dets:open_file(TabRef, Args),
  944:    ?line away = (catch dets:init_table(TabRef, fun(_) -&gt; throw(away) end,
  945:					{format,bchunk})),
  946:    dets:close(TabRef),
  947:    ?line {ok, _} = dets:open_file(TabRef, Args),
  948:    ?line {error, {init_fun, fopp}} = 
  949:	dets:init_table(TabRef, fun(read) -&gt; fopp end, {format,bchunk}),
<a name="950"></a>  950:    dets:close(TabRef),
  951:    ?line {ok, _} = dets:open_file(TabRef, Args),
  952:    ?line dets:safe_fixtable(TabRef, true),
  953:    ?line {error, {fixed_table, TabRef}} = 
  954:	dets:init_table(TabRef, init([]), {format,bchunk}),
  955:    ?line dets:safe_fixtable(TabRef, false),
  956:    ?line ok = dets:close(TabRef),
  957:
  958:    ?line {ok, _} = dets:open_file(TabRef, [{access,read} | Args]),
  959:    ?line {error, {access_mode, Fname}} = 
<a name="960"></a>  960:	dets:init_table(TabRef, init([]), {format,bchunk}),
  961:    ?line ok = dets:close(TabRef),
  962:
  963:    ?line {ok, _} = dets:open_file(TabRef, Args),
  964:    ?line {error, {init_fun,{1,2}}} =
  965:	dets:init_table(TabRef, init([[{1,2},bad,{3,4}]]), {format,bchunk}),
  966:    ?line _ = dets:close(TabRef),
  967:    ?line file:delete(Fname),
  968:
  969:    ?line {ok, _} = dets:open_file(TabRef, Args),
<a name="970"></a>  970:    ?line {error, {init_fun, end_of_input}} = 
  971:	dets:init_table(TabRef, init([]),{format,bchunk}),
  972:    ?line _ = dets:close(TabRef),
  973:    ?line file:delete(Fname),
  974:
  975:    ?line {ok, _} = dets:open_file(TabRef, Args),
  976:    ?line {'EXIT', {badarg, _}} = 
  977:	(catch dets:init_table(TabRef, init([]),{format,foppla})),
  978:    ?line _ = dets:close(TabRef),
  979:    ?line file:delete(Fname),
<a name="980"></a>  980:
  981:    ?line {ok, _} = dets:open_file(TabRef, Args),
  982:    ?line ok = ins(TabRef, 100),
  983:
  984:    ?line [BParms | Objs] = collect_bchunk(TabRef, init_bchunk(TabRef)),
  985:    ?line Parms = binary_to_term(BParms),
  986:    ?line {error, {init_fun, &lt;&lt;"foobar"&gt;&gt;}} = 
  987:	dets:init_table(TabRef, init([[&lt;&lt;"foobar"&gt;&gt;]]),{format,bchunk}),
  988:    ?line _ = dets:close(TabRef),
  989:    ?line file:delete(Fname),
<a name="990"></a>  990:
  991:    ?line {ok, _} = dets:open_file(TabRef, Args),
  992:    ?line Parms1 = setelement(1, Parms, foobar),
  993:    BParms1 = term_to_binary(Parms1),
  994:    ?line {error, {init_fun, BParms1}} = 
  995:	dets:init_table(TabRef, init([[BParms1 | Objs]]),{format,bchunk}),
  996:    ?line _ = dets:close(TabRef),
  997:    ?line file:delete(Fname),
  998:
  999:    ?line {ok, _} = dets:open_file(TabRef, Args),
<a name="1000"></a> 1000:    [{Sz1,No1} | NoColls17] = element(size(Parms), Parms),
 1001:    Parms2 = setelement(size(Parms), Parms, [{Sz1,No1+1} | NoColls17]),
 1002:    BParms2 = term_to_binary(Parms2),
 1003:    ?line {error, invalid_objects_list} = 
 1004:	dets:init_table(TabRef, init([[BParms2 | Objs]]),{format,bchunk}),
 1005:    ?line _ = dets:close(TabRef),
 1006:    ?line file:delete(Fname),
 1007:
 1008:    ?line {ok, _} = dets:open_file(TabRef, Args),
 1009:    ?line [{LSize1,Slot1,Obj1} | ObjsRest] = Objs,
<a name="1010"></a> 1010:  
 1011:    ?line BadSize = size(Obj1)-1,
 1012:    ?line &lt;&lt;BadSizeObj:BadSize/binary,_:1/binary&gt;&gt; = Obj1,
 1013:    ?line BadObjs = [{LSize1,Slot1,BadSizeObj} | ObjsRest],
 1014:    ?line {error, invalid_objects_list} = 
 1015:	dets:init_table(TabRef, init([[BParms | BadObjs]]),{format,bchunk}),
 1016:    ?line _ = dets:close(TabRef),
 1017:    ?line file:delete(Fname),
 1018:
 1019:    ?line {ok, _} = dets:open_file(TabRef, Args),
<a name="1020"></a> 1020:    ?line &lt;&lt;Size:32,BigObj0/binary&gt;&gt; = list_to_binary(lists:duplicate(16,Obj1)),
 1021:    ?line BigObj = &lt;&lt;(Size*16):32,BigObj0/binary&gt;&gt;,
 1022:    ?line BadColl = [BParms, {LSize1+4,Slot1,BigObj} | ObjsRest],
 1023:    ?line {error, invalid_objects_list} = 
 1024:         dets:init_table(TabRef, init([BadColl]),{format,bchunk}),
 1025:    ?line _ = dets:close(TabRef),
 1026:    ?line file:delete(Fname),
 1027:
 1028:    ?line {ok, _} = dets:open_file(TabRef, Args),
 1029:    BadObj = &lt;&lt;"foobar"&gt;&gt;,
<a name="1030"></a> 1030:    ?line {error, invalid_objects_list} = 
 1031:	dets:init_table(TabRef, init([[BParms, BadObj]]),{format,bchunk}),
 1032:    ?line _ = dets:close(TabRef),
 1033:    ?line file:delete(Fname),
 1034:
 1035:    ?line {ok, _} = dets:open_file(TabRef, [{type,bag} | Args]),
 1036:    ?line {error, {init_fun, _}} = 
 1037:	dets:init_table(TabRef, init([[BParms]]),{format,bchunk}),
 1038:    ?line _ = dets:close(TabRef),
 1039:    ?line file:delete(Fname),
<a name="1040"></a> 1040:
 1041:    ?line ok = dets:close(Source),
 1042:    ?line file:delete(SourceFname),
 1043:
 1044:    L1 = [{1,a},{2,b},{3,c},{4,d}],
 1045:    fast_bulk_init(L1, set, 4, 4, Config, V),
 1046:    L2 = [{1,a},{2,b},{2,q},{3,c},{4,d},{4,e},{2,q}],
 1047:    fast_bulk_init(L2, set, 4, 4, Config, V),
 1048:    fast_bulk_init(L2, bag, 6, 4, Config, V),
 1049:    fast_bulk_init(L2, duplicate_bag, 7, 4, Config, V),
<a name="1050"></a> 1050:    fast_bulk_init(L1, set, 4, 4, 512, Config, V),
 1051:    fast_bulk_init([], set, 0, 0, 10000, Config, V),
 1052:    file:delete(Fname),
 1053:
 1054:    %% Initiate a file that contains a lot of objects.
 1055:    ?line {ok, _} = dets:open_file(Source, [{min_no_slots,10000} | SourceArgs]),
 1056:    Fun1 = init_fun(0, 10000),
 1057:    ?line ok = dets:init_table(Source, Fun1, {format,term}),
 1058:    
 1059:    ?line {ok, _} = dets:open_file(TabRef, [{min_no_slots,10000} | Args]),
<a name="1060"></a> 1060:    ?line ok = ins(TabRef, 6000),
 1061:    Fun2 = init_bchunk(Source),
 1062:    ?line true = 
 1063:        dets:is_compatible_bchunk_format(TabRef, 
 1064:                                         dets:info(Source, bchunk_format)),
 1065:    ?line false = dets:is_compatible_bchunk_format(TabRef, &lt;&lt;"foobar"&gt;&gt;),
 1066:    ?line ok = dets:init_table(TabRef, Fun2, {format, bchunk}),
 1067:    ?line ok = dets:close(Source),
 1068:    ?line file:delete(SourceFname),
 1069:    ?line All = sort(get_all_objects(TabRef)),
<a name="1070"></a> 1070:    ?line FAll = get_all_objects_fast(TabRef),
 1071:    ?line true = All == sort(FAll),
 1072:    ?line true = length(All) == 10000,
 1073:    ?line ok = dets:close(TabRef),
 1074:    ?line file:delete(Fname),
 1075:
 1076:    %% Initiate inserts fewer objects than the table contains.
 1077:    ?line {ok, _} = dets:open_file(Source, [{min_no_slots,1000} | SourceArgs]),
 1078:    ?line ok = ins(Source, 4000),
 1079:    
<a name="1080"></a> 1080:    ?line {ok, _} = dets:open_file(TabRef, [{min_no_slots,1000} | Args]),
 1081:    ?line ok = ins(TabRef, 6000),
 1082:    ?line FileSize1 = dets:info(TabRef, file_size),
 1083:    Fun4 = init_bchunk(Source),
 1084:    ?line ok = dets:init_table(TabRef, Fun4, {format, bchunk}),
 1085:    ?line ok = dets:close(Source),
 1086:    ?line file:delete(SourceFname),
 1087:    ?line FileSize2 = dets:info(TabRef, file_size),
 1088:    ?line All_2 = sort(get_all_objects(TabRef)),
 1089:    ?line FAll_2 = get_all_objects_fast(TabRef),
<a name="1090"></a> 1090:    ?line true = All_2 == sort(FAll_2),
 1091:    ?line true = length(All_2) == 4000,
 1092:    ?line ok = dets:close(TabRef),
 1093:    ?line true = FileSize1 &gt; FileSize2,
 1094:
 1095:    %% Bchunk and fixed table.
 1096:    ?line {ok, _} = dets:open_file(TabRef, Args),
 1097:    ?line NoItems = dets:info(TabRef, no_objects),
 1098:    ?line AllObjects1 = sort(get_all_objects_fast(TabRef)),
 1099:    ?line dets:safe_fixtable(TabRef, true),
<a name="1100"></a> 1100:    ?line true = dets:info(TabRef, fixed),
 1101:    ?line Cont1 = init_bchunk(TabRef),
 1102:    ?line NoDel = 
 1103:	dets:select_delete(TabRef, [{{'_',{item,'_','_'}},[],[true]}]),
 1104:    ?line true = (NoDel &gt; 0),
 1105:    ?line AllObjects2 = sort(get_all_objects_fast(TabRef)),
 1106:    ?line true = dets:info(TabRef, fixed),
 1107:    ?line Cont2 = init_bchunk(TabRef),
 1108:    ?line NoItems2 = dets:info(TabRef, no_objects),
 1109:    ?line true = (NoItems =:= NoItems2 + NoDel),
<a name="1110"></a> 1110:    ?line NoDel2 = dets:select_delete(TabRef, [{'_',[],[true]}]),
 1111:    ?line true = (NoDel2 &gt; 0),
 1112:    ?line AllObjects3 = sort(get_all_objects_fast(TabRef)),
 1113:    ?line NoItems3 = dets:info(TabRef, no_objects),
 1114:    ?line true = (NoItems3 =:= 0),
 1115:    ?line true = dets:info(TabRef, fixed),
 1116:    ?line true = (NoItems2 =:= NoItems3 + NoDel2),
 1117:    ?line Cont3 = init_bchunk(TabRef),
 1118:
 1119:    ?line BinColl1 = collect_bchunk(TabRef, Cont1),
<a name="1120"></a> 1120:    ?line BinColl2 = collect_bchunk(TabRef, Cont2),
 1121:    ?line BinColl3 = collect_bchunk(TabRef, Cont3),
 1122:    ?line dets:safe_fixtable(TabRef, false),
 1123:    ?line ok = dets:close(TabRef),    
 1124:    ?line file:delete(Fname),
 1125:
 1126:    %% Now check that the above collected binaries are correct.
 1127:    ?line {ok, _} = dets:open_file(TabRef, Args),
 1128:    ?line ok = dets:init_table(TabRef, init([BinColl1]),{format,bchunk}),
 1129:    ?line true = (AllObjects1 == sort(get_all_objects_fast(TabRef))),
<a name="1130"></a> 1130:    ?line true = (length(AllObjects1) == dets:info(TabRef, no_objects)),
 1131:    ?line ok = dets:init_table(TabRef, init([BinColl2]),{format,bchunk}),
 1132:    ?line true = (AllObjects2 == sort(get_all_objects_fast(TabRef))),
 1133:    ?line true = (length(AllObjects2) == dets:info(TabRef, no_objects)),
 1134:    ?line ok = dets:init_table(TabRef, init([BinColl3]),{format,bchunk}),
 1135:    ?line true = (AllObjects3 == sort(get_all_objects_fast(TabRef))),
 1136:    ?line true = (length(AllObjects3) == dets:info(TabRef, no_objects)),
 1137:    ?line ok = dets:close(TabRef),
 1138:    ?line file:delete(Fname),
 1139:    ?line P0 == pps(),
<a name="1140"></a> 1140:    ok.
 1141:
<a name=fast_bulk_init> 1142:<b>fast_bulk_init</b></a>(L, Type, N, NoKeys, Config, V) -&gt;
 1143:    fast_bulk_init(L, Type, N, NoKeys, 256, Config, V).
 1144:
<a name=fast_bulk_init> 1145:<b>fast_bulk_init</b></a>(L, Type, N, NoKeys, Est, Config, V) -&gt;
 1146:    T = init_table_test,
 1147:    Fname = filename(T, Config),
 1148:    ?line file:delete(Fname),
 1149:
<a name="1150"></a> 1150:    Args0 = [{ram_file,false}, {type,Type},{keypos,1},
 1151:	    {estimated_no_objects, Est},{version,V}],
 1152:    Args = [{file,Fname} | Args0],
 1153:    S = init_table_test_source,
 1154:    SFname = filename(S, Config),
 1155:    ?line file:delete(SFname),
 1156:    SArgs = [{file,SFname} | Args0],
 1157:
 1158:    ?line {ok, S} = dets:open_file(S, SArgs),
 1159:    ?line ok = dets:insert(S, L),
<a name="1160"></a> 1160:
 1161:    Input = init_bchunk(S),
 1162:    ?line {ok, T} = dets:open_file(T, Args),
 1163:    ?line ok = dets:init_table(T, Input, [{format,bchunk}]),
 1164:    ?line All = sort(get_all_objects(T)),
 1165:    ?line FAll = get_all_objects_fast(T),
 1166:    ?line true = All == sort(FAll),
 1167:    ?line true = length(All) == N,
 1168:    ?line true = dets:info(T, size) == N,
 1169:    ?line true = dets:info(T, no_keys) == NoKeys,
<a name="1170"></a> 1170:    ?line ok = dets:close(T),
 1171:    
 1172:    ?line {ok, T} = dets:open_file(T, Args),
 1173:    ?line All2 = sort(get_all_objects(T)),
 1174:    ?line FAll2 = get_all_objects_fast(T),
 1175:    ?line true = All == All2,
 1176:    ?line true = All == sort(FAll2),
 1177:    ?line ok = dets:close(T),
 1178:    ?line file:delete(Fname),
 1179:
<a name="1180"></a> 1180:    ?line ok = dets:close(S),
 1181:    ?line file:delete(SFname),
 1182:    ok.
 1183:
<a name=init_bchunk> 1184:<b>init_bchunk</b></a>(T) -&gt;
 1185:    Start = dets:bchunk(T, start),
 1186:    init_bchunk(T, Start).
 1187:
<a name=init_bchunk> 1188:<b>init_bchunk</b></a>(Tab, State) -&gt;
 1189:    fun(read) when State == '$end_of_table' -&gt;
<a name="1190"></a> 1190:	    end_of_input;
 1191:       (read) when element(1, State) == error -&gt;
 1192:	    State;
 1193:       (read) -&gt;
 1194:	    {Cont, Objs} = State,
 1195:	    {Objs, init_bchunk(Tab, dets:bchunk(Tab, Cont))};
 1196:       (close) -&gt;
 1197:	    ok
 1198:    end.
 1199:
<a name=collect_bchunk><a name="1200"></a> 1200:<b>collect_bchunk</b></a>(Tab, Fun) -&gt;
 1201:    collect_bchunk(Tab, Fun, []).
 1202:
<a name=collect_bchunk> 1203:<b>collect_bchunk</b></a>(Tab, Fun, L) -&gt;
 1204:    case Fun(read) of
 1205:	end_of_input -&gt;
 1206:	    lists:append(lists:reverse(L));
 1207:	{Objs, Fun2} when list(Objs) -&gt;
 1208:	    collect_bchunk(Tab, Fun2, [Objs | L]);
 1209:	Error -&gt;
<a name="1210"></a> 1210:	    Error
 1211:    end.
 1212:
<a name=items> 1213:<b>items</b></a>(I, N, C, L) when I == N; C == 0 -&gt;
 1214:    {I, L};
<a name=items> 1215:<b>items</b></a>(I, N, C, L) -&gt;
 1216:    items(I+1, N, C-1, [{I, item(I)} | L]).
 1217:
<a name=repair_v8> 1218:<b>repair_v8</b></a>(doc) -&gt;
 1219:    ["open_file and repair."];
<a name=repair_v8><a name="1220"></a> 1220:<b>repair_v8</b></a>(suite) -&gt; 
 1221:    [];
<a name=repair_v8> 1222:<b>repair_v8</b></a>(Config) when list(Config) -&gt;
 1223:    repair(Config, 8).
 1224:
<a name=repair_v9> 1225:<b>repair_v9</b></a>(doc) -&gt;
 1226:    ["open_file and repair."];
<a name=repair_v9> 1227:<b>repair_v9</b></a>(suite) -&gt; 
 1228:    [];
<a name=repair_v9> 1229:<b>repair_v9</b></a>(Config) when list(Config) -&gt;
<a name="1230"></a> 1230:    %% Convert from format 9 to format 8.
 1231:    T = convert_98,
 1232:    Fname = filename(T, Config),
 1233:    ?line file:delete(Fname),
 1234:    ?line {ok, _} = dets:open_file(T, [{file,Fname},{version,9},
 1235:				       {type,duplicate_bag}]),
 1236:    ?line 9 = dets:info(T, version),
 1237:    ?line true = is_binary(dets:info(T, bchunk_format)),
 1238:    ?line ok = dets:insert(T, [{1,a},{2,b},{1,c},{2,c},{1,c},{2,a},{1,b}]),
 1239:    ?line dets:close(T),
<a name="1240"></a> 1240:    ?line {error, {version_mismatch, _}} = 
 1241:	dets:open_file(T, [{file,Fname},{version,8},{type,duplicate_bag}]),
 1242:    ?line {ok, _} = dets:open_file(T, [{file,Fname},{version,8},
 1243:				       {type,duplicate_bag},{repair,force}]),
 1244:    ?line 8 = dets:info(T, version),
 1245:    ?line true = undefined == dets:info(T, bchunk_format),
 1246:    ?line [{1,a},{1,b},{1,c},{1,c}] = sort(dets:lookup(T, 1)),
 1247:    ?line [{2,a},{2,b},{2,c}] = sort(dets:lookup(T, 2)),
 1248:    ?line 7 = dets:info(T, no_objects),
 1249:    ?line no_keys_test(T),
<a name="1250"></a> 1250:    ?line _ = histogram(T, silent),
 1251:    ?line ok = dets:close(T),
 1252:    ?line file:delete(Fname),
 1253:
 1254:    %% The short lived format 9(a).
 1255:    %% Not very throughly tested here.
 1256:    A9 = a9,
 1257:    ?line Version9aS = filename:join(?datadir(Config), "version_9a.dets"),
 1258:    ?line Version9aT = filename('v9a.dets', Config),
 1259:    ?line {ok, _} = file:copy(Version9aS, Version9aT),
<a name="1260"></a> 1260:    ?line {ok, A9} = dets:open_file(A9, [{file,Version9aT}]),
 1261:    ?line undefined = dets:info(A9, bchunk_format),
 1262:    ?line [{1,a},{2,b},{3,c}] = sort(dets:match_object(A9, '_')),
 1263:    ?line ok = dets:insert(A9, {4,d}),
 1264:    ?line ok = dets:close(A9),
 1265:    ?line {ok, A9} = dets:open_file(A9, [{file,Version9aT}]),
 1266:    ?line {error, old_version} = dets:bchunk(A9, start),
 1267:    ?line ok = dets:close(A9),
 1268:    ?line io:format("Expect forced repair:~n"),
 1269:    ?line {ok, A9} = dets:open_file(A9, [{file,Version9aT},{repair,force}]),
<a name="1270"></a> 1270:    ?line {_, _} = dets:bchunk(A9, start),
 1271:    ?line ok = dets:close(A9),
 1272:    ?line file:delete(Version9aT),
 1273:
 1274:    repair(Config, 9).
 1275:
<a name=repair> 1276:<b>repair</b></a>(Config, V) -&gt;
 1277:    TabRef = repair_test,
 1278:    Fname = filename(TabRef, Config),
 1279:    ?line file:delete(Fname),
<a name="1280"></a> 1280:    HeadSize = headsz(V),
 1281:
 1282:    P0 = pps(),
 1283:    ?line {'EXIT', {badarg, _}} = 
 1284:	(catch dets:open_file(TabRef, [{min_no_slots,1000},
 1285:				       {max_no_slots,500}])),
 1286:    ?line {error,{file_error,hoppla,enoent}} = dets:file_info(hoppla),
 1287:    ?line {error,{file_error,Fname,enoent}} = 
 1288:	dets:open_file(TabRef, [{file, Fname}, {access, read}]),
 1289:
<a name="1290"></a> 1290:    %% compacting, and some kind of test that free lists are saved OK on file
 1291:    ?line {ok, TabRef} = dets:open_file(TabRef, [{file,Fname},{version,V}]),
 1292:    ?line 0 = dets:info(TabRef, size),
 1293:    ?line ok = ins(TabRef, 30000),
 1294:    ?line ok = del(TabRef, 30000, 3),
 1295:    ?line ok = dets:close(TabRef),
 1296:    ?line {error, {access_mode,Fname}} =
 1297:        dets:open_file(foo, [{file,Fname},{repair,force},{access,read}]),
 1298:    ?line {ok, Ref3} = dets:open_file(Fname), % no repair!
 1299:    ?line 20000 = dets:info(Ref3, size),
<a name="1300"></a> 1300:    ?line 20000 = dets:foldl(fun(_, N) -&gt; N+1 end, 0, Ref3),
 1301:    ?line 20000 = count_objects_quite_fast(Ref3), % actually a test of match
 1302:    ?line no_keys_test(Ref3),
 1303:    ?line ok = dets:close(Ref3),
 1304:    if
 1305:        V == 8 -&gt;
 1306:            ?line {ok, TabRef} = dets:open_file(TabRef, 
 1307:                                   [{file, Fname},{version,V},{access,read}]),
 1308:            ?line ok = dets:close(TabRef),
 1309:            ?line io:format("Expect compacting repair:~n"),
<a name="1310"></a> 1310:            ?line {ok, TabRef} = dets:open_file(TabRef, 
 1311:                                                [{file, Fname},{version,V}]),
 1312:            ?line 20000 = dets:info(TabRef, size),
 1313:	    ?line _ = histogram(TabRef, silent),
 1314:            ?line ok = dets:close(TabRef);
 1315:        true -&gt;
 1316:            ok
 1317:    end,
 1318:    ?line {error,{keypos_mismatch,Fname}} = 
 1319:	dets:open_file(TabRef, [{file, Fname},{keypos,17}]),
<a name="1320"></a> 1320:    ?line {error,{type_mismatch,Fname}} = 
 1321:	dets:open_file(TabRef, [{file, Fname},{type,duplicate_bag}]),
 1322:
 1323:    %% make one of the temporary files unwritable
 1324:    TmpFile = if 
 1325:		  V == 8 -&gt; 
 1326:		      Fname ++ ".TMP.10000"; 
 1327:		  true -&gt; Fname ++ ".TMP.1" 
 1328:	      end,
 1329:    ?line {ok, TmpFd} = file:open(TmpFile, [read,write]),
<a name="1330"></a> 1330:    ?line ok = file:close(TmpFd),
 1331:    ?line unwritable(TmpFile),
 1332:    ?line {error,{file_error,TmpFile,eacces}} = dets:fsck(Fname, V),
 1333:    ?line {ok, _} = dets:open_file(TabRef, 
 1334:                        [{repair,false},{file, Fname},{version,V}]),
 1335:    ?line 20000 = length(get_all_objects(TabRef)),
 1336:    ?line _ = histogram(TabRef, silent),
 1337:    ?line 20000 = length(get_all_objects_fast(TabRef)),
 1338:    ?line ok = dets:close(TabRef),
 1339:    ?line writable(TmpFile),
<a name="1340"></a> 1340:    ?line file:delete(TmpFile),
 1341:
 1342:    ?line truncate(Fname, HeadSize + 10),
 1343:    ?line {error,{not_closed, Fname}} = 
 1344:	dets:open_file(TabRef, [{file, Fname}, {access, read}]),
 1345:    ?line {error,{not_closed, Fname}} = 
 1346:	dets:open_file(TabRef, [{file, Fname}, {access, read}, 
 1347:                                {repair,force}]),
 1348:    ?line {error,{needs_repair, Fname}} = 
 1349:	dets:open_file(TabRef, [{file, Fname}, {repair, false}]),
<a name="1350"></a> 1350:    ?line file:delete(Fname),
 1351:
 1352:    %% truncated file header
 1353:    ?line {ok, TabRef} = dets:open_file(TabRef, [{file,Fname},{version,V}]),
 1354:    ?line ok = ins(TabRef, 100),
 1355:    ?line ok = dets:close(TabRef),
 1356:    ?line truncate(Fname, HeadSize - 10),    
 1357:    %% a new file is created ('tooshort')
 1358:    ?line {ok, TabRef} = dets:open_file(TabRef, 
 1359:					[{file,Fname},{version,V},
<a name="1360"></a> 1360:					 {min_no_slots,1000},
 1361:					 {max_no_slots,1000000}]),
 1362:    case dets:info(TabRef, no_slots) of
 1363:	undefined -&gt; ok;
 1364:	{Min1,Slot1,Max1} -&gt;
 1365:	    ?line true = Min1 =&lt; Slot1, true = Slot1 =&lt; Max1,
 1366:	    ?line true = 1000 &lt; Min1, true = 1000+256 &gt; Min1,
 1367:	    ?line true = 1000000 &lt; Max1, true = (1 bsl 20)+256 &gt; Max1
 1368:    end,
 1369:    ?line 0 = dets:info(TabRef, size),
<a name="1370"></a> 1370:    ?line no_keys_test(TabRef),
 1371:    ?line _ = histogram(TabRef, silent),
 1372:    ?line ok = dets:close(TabRef),
 1373:    ?line file:delete(Fname),
 1374:
 1375:    %% version bump (v8)
 1376:    ?line Version7S = filename:join(?datadir(Config), "version_r2d.dets"),
 1377:    ?line Version7T = filename('v2.dets', Config),
 1378:    ?line {ok, _} = file:copy(Version7S, Version7T),
 1379:    ?line {error,{version_bump, Version7T}} = dets:open_file(Version7T),
<a name="1380"></a> 1380:    ?line {error,{version_bump, Version7T}} = 
 1381:	dets:open_file(Version7T, [{file,Version7T},{repair,false}]),
 1382:    ?line {error,{version_bump, Version7T}} = 
 1383:	dets:open_file(Version7T, [{file, Version7T}, {access, read}]),
 1384:    ?line io:format("Expect upgrade:~n"),
 1385:    ?line {ok, _} = dets:open_file(Version7T, 
 1386:                                   [{file, Version7T},{version, V}]),
 1387:    ?line [{1,a},{2,b}] = sort(get_all_objects(Version7T)),
 1388:    ?line [{1,a},{2,b}] = sort(get_all_objects_fast(Version7T)),
 1389:    Phash = if 
<a name="1390"></a> 1390:		V == 8 -&gt; phash;
 1391:		true -&gt; phash2
 1392:	    end,
 1393:    ?line Phash = dets:info(Version7T, hash),
 1394:    ?line _ = histogram(Version7T, silent),
 1395:    ?line ok = dets:close(Version7T),
 1396:    ?line {ok, _} = dets:open_file(Version7T, [{file, Version7T}]),
 1397:    ?line Phash = dets:info(Version7T, hash),
 1398:    ?line ok = dets:close(Version7T),
 1399:    ?line file:delete(Version7T),
<a name="1400"></a> 1400:
 1401:    %% converting free lists
 1402:    ?line Version8aS = filename:join(?datadir(Config), "version_r3b02.dets"),
 1403:    ?line Version8aT = filename('v3.dets', Config),
 1404:    ?line {ok, _} = file:copy(Version8aS, Version8aT),
 1405:    %% min_no_slots and max_no_slots are ignored - no repair is taking place
 1406:    ?line {ok, _} = dets:open_file(version_8a, 
 1407:				   [{file, Version8aT},{min_no_slots,1000},
 1408:				    {max_no_slots,100000}]),
 1409:    ?line [{1,b},{2,a},{a,1},{b,2}] = sort(get_all_objects(version_8a)),
<a name="1410"></a> 1410:    ?line [{1,b},{2,a},{a,1},{b,2}] = sort(get_all_objects_fast(version_8a)),
 1411:    ?line ok = ins(version_8a, 1000),
 1412:    ?line 1002 = dets:info(version_8a, size),
 1413:    ?line no_keys_test(version_8a),
 1414:    ?line All8a = sort(get_all_objects(version_8a)),
 1415:    ?line 1002 = length(All8a),
 1416:    ?line FAll8a = sort(get_all_objects_fast(version_8a)),
 1417:    ?line true = sort(All8a) == sort(FAll8a),
 1418:    ?line ok = del(version_8a, 300, 3),
 1419:    ?line 902 = dets:info(version_8a, size),
<a name="1420"></a> 1420:    ?line no_keys_test(version_8a),
 1421:    ?line All8a2 = sort(get_all_objects(version_8a)),
 1422:    ?line 902 = length(All8a2),
 1423:    ?line FAll8a2 = sort(get_all_objects_fast(version_8a)),
 1424:    ?line true = sort(All8a2) == sort(FAll8a2),
 1425:    ?line _ = histogram(version_8a, silent),
 1426:    ?line ok = dets:close(version_8a),
 1427:    ?line file:delete(Version8aT),
 1428:
 1429:    %% will fail unless the slots are properly sorted when repairing (v8)
<a name="1430"></a> 1430:    BArgs = [{file, Fname},{type,duplicate_bag},
 1431:	     {delayed_write,{3000,10000}},{version,V}],
 1432:    ?line {ok, TabRef} = dets:open_file(TabRef, BArgs),
 1433:    Seq = seq(1, 500),
 1434:    Small = map(fun(X) -&gt; {X,X} end, Seq),
 1435:    Big = map(fun(X) -&gt; erlang:make_tuple(20, X) end, Seq),
 1436:    ?line ok = dets:insert(TabRef, Small),
 1437:    ?line ok = dets:insert(TabRef, Big),
 1438:    ?line ok = dets:insert(TabRef, Small),
 1439:    ?line ok = dets:insert(TabRef, Big),
<a name="1440"></a> 1440:    ?line dets:safe_fixtable(TabRef, true),
 1441:    ?line All = sort(get_all_objects(TabRef)),
 1442:    ?line dets:safe_fixtable(TabRef, false),
 1443:    ?line ok = dets:close(TabRef),
 1444:    ?line io:format("Expect forced repair:~n"),
 1445:    ?line {ok, _} = 
 1446:         dets:open_file(TabRef, [{repair,force},{min_no_slots,2000} | BArgs]),
 1447:    if 
 1448:	V == 9 -&gt;
 1449:	    ?line {MinNoSlots,_,MaxNoSlots} = dets:info(TabRef, no_slots),
<a name="1450"></a> 1450:	    ?line ok = dets:close(TabRef),
 1451:	    ?line io:format("Expect compaction:~n"),
 1452:	    ?line {ok, _} = 
 1453:		dets:open_file(TabRef, [{repair,force},
 1454:					{min_no_slots,MinNoSlots},
 1455:					{max_no_slots,MaxNoSlots} | BArgs]);
 1456:	true -&gt;
 1457:	    ok
 1458:    end,
 1459:    ?line All2 = get_all_objects(TabRef),
<a name="1460"></a> 1460:    ?line true = All == sort(All2),
 1461:    ?line FAll2 = get_all_objects_fast(TabRef),
 1462:    ?line true = All == sort(FAll2),
 1463:    ?line true = length(All) == dets:info(TabRef, size),
 1464:    ?line no_keys_test(TabRef),
 1465:    Fun = fun(X) -&gt; 4 = length(dets:lookup(TabRef, X)) end,
 1466:    ?line foreach(Fun, Seq),
 1467:    ?line _ = histogram(TabRef, silent),
 1468:    ?line ok = dets:close(TabRef),
 1469:    ?line file:delete(Fname),
<a name="1470"></a> 1470:
 1471:    %% object bigger than segments, the "hole" is taken care of
 1472:    ?line {ok, TabRef} = dets:open_file(TabRef, [{file, Fname},{version,V}]),
 1473:    Tuple = erlang:make_tuple(1000, foobar), % &gt; 2 kB
 1474:    ?line ok = dets:insert(TabRef, Tuple),
 1475:    %% at least one full segment (objects smaller than 2 kB):
 1476:    ?line ins(TabRef, 2000), 
 1477:    ?line ok = dets:close(TabRef),
 1478:
 1479:    if 
<a name="1480"></a> 1480:        V == 8 -&gt;
 1481:            %% first estimated number of objects is wrong, repair once more
 1482:            ?line {ok, Fd} = file:open(Fname, read_write),
 1483:            NoPos = HeadSize - 8,  % no_objects
 1484:            ?line file:pwrite(Fd, NoPos, &lt;&lt;0:32&gt;&gt;), % NoItems
 1485:            ok = file:close(Fd),
 1486:            ?line dets:fsck(Fname, V),
 1487:            ?line {ok, _} = 
 1488:                dets:open_file(TabRef, 
 1489:                               [{repair,false},{file, Fname},{version,V}]),
<a name="1490"></a> 1490:            ?line 2001 = length(get_all_objects(TabRef)),
 1491:            ?line _ = histogram(TabRef, silent),
 1492:            ?line 2001 = length(get_all_objects_fast(TabRef)),
 1493:            ?line ok = dets:close(TabRef);
 1494:        true -&gt;
 1495:            ok
 1496:    end,
 1497:
 1498:    ?line {ok, _} = 
 1499:        dets:open_file(TabRef, 
<a name="1500"></a> 1500:                       [{repair,false},{file, Fname},{version,V}]),
 1501:    ?line {ok, ObjPos} = dets:where(TabRef, {66,{item,number,66}}),
 1502:    ?line ok = dets:close(TabRef),
 1503:    %% Damaged object.
 1504:    Pos = 12, % v9: compaction fails, proper repair follows
 1505:    crash(Fname, ObjPos+Pos),
 1506:    ?line io:format(
 1507:	    "Expect forced repair (possibly after attempted compaction):~n"),
 1508:    ?line {ok, _} = 
 1509:	dets:open_file(TabRef, [{repair,force},{file, Fname},{version,V}]),
<a name="1510"></a> 1510:    ?line true = dets:info(TabRef, size) &lt; 2001,
 1511:    ?line ok = dets:close(TabRef),
 1512:    ?line file:delete(Fname),
 1513:
 1514:    %% The file is smaller than the padded object.
 1515:    ?line {ok, TabRef} = dets:open_file(TabRef, [{file,Fname},{version,V}]),
 1516:    ?line ok = dets:insert(TabRef, Tuple),
 1517:    ?line ok = dets:close(TabRef),
 1518:    ?line io:format("Expect forced repair or compaction:~n"),
 1519:    ?line {ok, _} = 
<a name="1520"></a> 1520:	dets:open_file(TabRef, [{repair,force},{file, Fname},{version,V}]),
 1521:    ?line true = 1 == dets:info(TabRef, size),
 1522:    ?line ok = dets:close(TabRef),
 1523:    ?line file:delete(Fname),
 1524:
 1525:    %% Damaged free lists.
 1526:    ?line {ok, TabRef} = dets:open_file(TabRef, [{file,Fname},{version,V}]),
 1527:    ?line ok = ins(TabRef, 300),
 1528:    ?line ok = dets:sync(TabRef),
 1529:    ?line ok = del(TabRef, 300, 3),
<a name="1530"></a> 1530:    %% FileSize is approximately where the free lists will be written.
 1531:    ?line FileSize = dets:info(TabRef, memory),
 1532:    ?line ok = dets:close(TabRef),
 1533:    crash(Fname, FileSize+20),
 1534:    ?line {error, {bad_freelists, Fname}} = 
 1535:	dets:open_file(TabRef, [{file,Fname},{version,V}]),
 1536:    ?line file:delete(Fname),
 1537:
 1538:
 1539:    %% File not closed, opening with read and read_write access tried.
<a name="1540"></a> 1540:    ?line {ok, TabRef} = dets:open_file(TabRef, [{file,Fname},{version,V}]),
 1541:    ?line ok = ins(TabRef, 300),
 1542:    ?line ok = dets:close(TabRef),
 1543:    ?line crash(Fname, ?CLOSED_PROPERLY_POS+3, ?NOT_PROPERLY_CLOSED),
 1544:    ?line {error, {not_closed, Fname}} =
 1545:       dets:open_file(foo, [{file,Fname},{version,V},{repair,force},
 1546:                            {access,read}]),
 1547:    ?line {error, {not_closed, Fname}} =
 1548:       dets:open_file(foo, [{file,Fname},{version,V},{repair,true},
 1549:                            {access,read}]),
<a name="1550"></a> 1550:    ?line io:format("Expect repair:~n"),
 1551:    ?line {ok, TabRef} =
 1552:       dets:open_file(TabRef, [{file,Fname},{version,V},{repair,true},
 1553:                               {access,read_write}]),
 1554:    ?line ok = dets:close(TabRef),
 1555:    ?line crash(Fname, ?CLOSED_PROPERLY_POS+3, ?NOT_PROPERLY_CLOSED),
 1556:    ?line io:format("Expect forced repair:~n"),
 1557:    ?line {ok, TabRef} =
 1558:       dets:open_file(TabRef, [{file,Fname},{version,V},{repair,force},
 1559:                               {access,read_write}]),
<a name="1560"></a> 1560:    ?line ok = dets:close(TabRef),
 1561:    ?line file:delete(Fname),    
 1562:
 1563:    %% The size of an object is huge.
 1564:    ?line {ok, TabRef} = dets:open_file(TabRef, [{file,Fname},{version,V}]),
 1565:    ?line ok = dets:insert(TabRef, [{1,2,3},{2,3,4}]),
 1566:    ?line {ok, ObjPos2} = dets:where(TabRef, {1,2,3}),
 1567:    ?line ok = dets:close(TabRef),
 1568:    ObjPos3 = if
 1569:                  V == 8 -&gt; ObjPos2 + 4;
<a name="1570"></a> 1570:                  V == 9 -&gt; ObjPos2
 1571:              end,
 1572:    crash(Fname, ObjPos3, 255),
 1573:    ?line io:format("Expect forced repair:~n"),
 1574:    ?line {ok, TabRef} = 
 1575:         dets:open_file(TabRef, [{file,Fname},{version,V},{repair,force}]),
 1576:    ?line ok = dets:close(TabRef),
 1577:    ?line file:delete(Fname),    
 1578:
 1579:    ?line P0 == pps(),
<a name="1580"></a> 1580:    ok.
 1581:
<a name=hash_v8b_v8c> 1582:<b>hash_v8b_v8c</b></a>(doc) -&gt;
 1583:    ["Test the use of different hashing algorithms in v8b and v8c of the "
 1584:     "Dets file format."];
<a name=hash_v8b_v8c> 1585:<b>hash_v8b_v8c</b></a>(suite) -&gt;
 1586:    [];
<a name=hash_v8b_v8c> 1587:<b>hash_v8b_v8c</b></a>(Config) when list(Config) -&gt;
 1588:    ?line Source = 
 1589:	filename:join(?datadir(Config), "dets_test_v8b.dets"),
<a name="1590"></a> 1590:    %% Little endian version of old file (there is an endianess bug in 
 1591:    %% the old hash). This is all about version 8 of the dets file format.
 1592:
 1593:    P0 = pps(),
 1594:    ?line SourceLE = 
 1595:	filename:join(?datadir(Config), 
 1596:		      "dets_test_v8b_little_endian.dets"),
 1597:    ?line Target1 = filename('oldhash1.dets', Config),
 1598:    ?line Target1LE = filename('oldhash1le.dets', Config),
 1599:    ?line Target2 = filename('oldhash2.dets', Config),
<a name="1600"></a> 1600:    ?line {ok, Bin} = file:read_file(Source),
 1601:    ?line {ok, BinLE} = file:read_file(SourceLE),
 1602:    ?line ok = file:write_file(Target1,Bin),
 1603:    ?line ok = file:write_file(Target1LE,BinLE),
 1604:    ?line ok = file:write_file(Target2,Bin),
 1605:    ?line {ok, d1} = dets:open_file(d1,[{file,Target1}]),
 1606:    ?line {ok, d1le} = dets:open_file(d1le,[{file,Target1LE}]),
 1607:    ?line {ok, d2} = dets:open_file(d2,[{file,Target2},{repair,force},
 1608:                                        {version,8}]),
 1609:    ?line FF = fun(N,_F,_T) when N &gt; 16#FFFFFFFFFFFFFFFF -&gt; 
<a name="1610"></a> 1610:		       ok;
 1611:		  (N,F,T) -&gt; 
 1612:		       V = integer_to_list(N),
 1613:		       case dets:lookup(T,N) of
 1614:				 [{N,V}] -&gt;
 1615:				     F(N*2,F,T);
 1616:				 _Error -&gt;
 1617:				     exit({failed,{lookup,T,N}})
 1618:			     end
 1619:	       end,
<a name="1620"></a> 1620:    ?line Mess = case (catch FF(1,FF,d1)) of
 1621:		     {'EXIT', {failed, {lookup,_,_}}} -&gt;
 1622:			 ?line ok = dets:close(d1),
 1623:			 ?line FF(1,FF,d1le),
 1624:			 ?line hash = dets:info(d1le,hash),
 1625:			 ?line dets:insert(d1le,{33333333333,hejsan}),
 1626:			 ?line [{33333333333,hejsan}] = 
 1627:			     dets:lookup(d1le,33333333333),
 1628:			 ?line ok = dets:close(d1le),
 1629:			 ?line {ok, d1le} = dets:open_file(d1le,
<a name="1630"></a> 1630:							   [{file,Target1LE}]),
 1631:			 ?line [{33333333333,hejsan}] = 
 1632:			     dets:lookup(d1le,33333333333),
 1633:			 ?line FF(1,FF,d1le),
 1634:			 ?line ok = dets:close(d1le),
 1635:			 "Seems to be a little endian machine";
 1636:		     {'EXIT', Fault} -&gt;
 1637:			 exit(Fault);
 1638:		     _ -&gt;
 1639:			 ?line ok = dets:close(d1le),
<a name="1640"></a> 1640:			 ?line hash = dets:info(d1,hash),
 1641:			 ?line dets:insert(d1,{33333333333,hejsan}),
 1642:			 ?line [{33333333333,hejsan}] = 
 1643:			     dets:lookup(d1,33333333333),
 1644:			 ?line ok = dets:close(d1),
 1645:			 ?line {ok, d1} = dets:open_file(d1,[{file,Target1}]),
 1646:			 ?line [{33333333333,hejsan}] = 
 1647:			     dets:lookup(d1,33333333333),
 1648:			 ?line FF(1,FF,d1),
 1649:			 ?line ok = dets:close(d1),
<a name="1650"></a> 1650:			 "Seems to be a big endian machine"
 1651:		 end,
 1652:    ?line FF(1,FF,d2),
 1653:    ?line phash = dets:info(d2,hash),
 1654:    ?line ok = dets:close(d2),
 1655:    ?line file:delete(Target1),
 1656:    ?line file:delete(Target1LE),
 1657:    ?line file:delete(Target2),
 1658:    ?line P0 == pps(),
 1659:    {comment, Mess}.
<a name="1660"></a> 1660:
<a name=phash> 1661:<b>phash</b></a>(doc) -&gt;
 1662:    ["Test version 9(b) with erlang:phash/2 as hash function."];
<a name=phash> 1663:<b>phash</b></a>(suite) -&gt;
 1664:    [];
<a name=phash> 1665:<b>phash</b></a>(Config) when list(Config) -&gt;
 1666:    T = phash,
 1667:    Phash_v9bS = filename:join(?datadir(Config), "version_9b_phash.dat"),
 1668:    Fname = filename('v9b.dets', Config),
 1669:    ?line {ok, _} = file:copy(Phash_v9bS, Fname),
<a name="1670"></a> 1670:    
 1671:    %% Deleting all objects changes the hash function. 
 1672:    %% A feature... (it's for free)
 1673:    ?line {ok, T} = dets:open_file(T, [{file, Fname}]),
 1674:    ?line phash = dets:info(T, hash),
 1675:    ?line dets:delete_all_objects(T),
 1676:    ?line phash2 = dets:info(T, hash),
 1677:    ?line [] = get_all_objects(T),
 1678:    ?line [] = get_all_objects_fast(T),
 1679:    ?line ok = dets:close(T),
<a name="1680"></a> 1680:
 1681:    %% The hash function is kept when compacting a table.
 1682:    ?line {ok, _} = file:copy(Phash_v9bS, Fname),
 1683:    ?line io:format("Expect compaction:~n"),
 1684:    ?line {ok, T} = dets:open_file(T, [{file, Fname},{repair,force}]),
 1685:    ?line phash = dets:info(T, hash),
 1686:    ?line [{1,a},{2,b},{3,c},{4,d},{5,e}] =
 1687:	lists:sort(dets:lookup_keys(T, [1,2,3,4,5])),
 1688:    ?line ok = dets:close(T),
 1689:
<a name="1690"></a> 1690:    %% The hash function is updated when repairing a table (no cost).
 1691:    ?line {ok, _} = file:copy(Phash_v9bS, Fname),
 1692:    crash(Fname, ?CLOSED_PROPERLY_POS+3, 0),
 1693:    ?line io:format("Expect repair:~n"),
 1694:    ?line {ok, T} = dets:open_file(T, [{file, Fname}]),
 1695:    ?line phash2 = dets:info(T, hash),
 1696:    ?line [{1,a},{2,b},{3,c},{4,d},{5,e}] =
 1697:	lists:sort(dets:lookup_keys(T, [1,2,3,4,5])),
 1698:    ?line ok = dets:close(T),
 1699:    
<a name="1700"></a> 1700:    %% One cannot use the bchunk format when copying between a phash
 1701:    %% table and a phash2 table. (There is no test for the case an R9
 1702:    %% (or later) node (using phash2) copies a table to an R8 node
 1703:    %% (using phash).) See also the comment on HASH_PARMS in dets_v9.erl.
 1704:    ?line {ok, _} = file:copy(Phash_v9bS, Fname),
 1705:    ?line {ok, T} = dets:open_file(T, [{file, Fname}]),
 1706:    ?line Type = dets:info(T, type),
 1707:    ?line KeyPos = dets:info(T, keypos),
 1708:    Input = init_bchunk(T),    
 1709:    T2 = phash_table,
<a name="1710"></a> 1710:    Fname2 = filename(T2, Config),
 1711:    Args = [{type,Type},{keypos,KeyPos},{version,9},{file,Fname2}],
 1712:    ?line {ok, T2} = dets:open_file(T2, Args),
 1713:    ?line {error, {init_fun, _}} = 
 1714:	dets:init_table(T2, Input, {format,bchunk}),
 1715:    ?line _ = dets:close(T2),
 1716:    ?line ok = dets:close(T),
 1717:    ?line file:delete(Fname2),
 1718:
 1719:    ?line file:delete(Fname),
<a name="1720"></a> 1720:    ok.
 1721:
<a name=fold_v8> 1722:<b>fold_v8</b></a>(doc) -&gt;
 1723:    ["foldl, foldr, to_ets"];
<a name=fold_v8> 1724:<b>fold_v8</b></a>(suite) -&gt;
 1725:    [];
<a name=fold_v8> 1726:<b>fold_v8</b></a>(Config) when list(Config) -&gt;
 1727:    fold(Config, 8).
 1728:
<a name=fold_v9> 1729:<b>fold_v9</b></a>(doc) -&gt;
<a name="1730"></a> 1730:    ["foldl, foldr, to_ets"];
<a name=fold_v9> 1731:<b>fold_v9</b></a>(suite) -&gt;
 1732:    [];
<a name=fold_v9> 1733:<b>fold_v9</b></a>(Config) when list(Config) -&gt;
 1734:    fold(Config, 9).
 1735:
<a name=fold> 1736:<b>fold</b></a>(Config, Version) -&gt;
 1737:    T = test_table,
 1738:    N = 100,
 1739:    ?line Fname = filename(T, Config),
<a name="1740"></a> 1740:    ?line file:delete(Fname),
 1741:    P0 = pps(),
 1742:
 1743:    Args = [{version, Version}, {file,Fname}, {estimated_no_objects, N}],
 1744:    ?line {ok, _} = dets:open_file(T, Args),
 1745:
 1746:    ?line ok = ins(T, N),
 1747:
 1748:    ?line Ets = ets:new(to_ets, [public]),
 1749:    ?line dets:to_ets(T, Ets),
<a name="1750"></a> 1750:    ?line true = N == ets:info(Ets, size),
 1751:    ?line ets:delete(Ets),
 1752:
 1753:    ?line Ets2 = ets:new(to_ets, [private]),
 1754:    ?line dets:to_ets(T, Ets2),
 1755:    ?line true = N == ets:info(Ets2, size),
 1756:    ?line ets:delete(Ets2),
 1757:
 1758:    ?line {'EXIT', {badarg, _}} = (catch dets:to_ets(T, not_an_ets_table)),
 1759:
<a name="1760"></a> 1760:    F0 = fun(X, A) -&gt; [X | A] end,
 1761:    ?line true = N == length(dets:foldl(F0, [], T)),
 1762:    ?line true = N == length(dets:foldr(F0, [], T)),
 1763:
 1764:    F1 = fun(_X, _A) -&gt; throw(away) end, 
 1765:    ?line away = (catch dets:foldl(F1, [], T)),
 1766:    ?line away = (catch dets:foldr(F1, [], T)),
 1767:
 1768:    F2 = fun(X, A) -&gt; X + A end, 
 1769:    ?line {'EXIT', _} = (catch dets:foldl(F2, [], T)),
<a name="1770"></a> 1770:    ?line {'EXIT', _} = (catch dets:foldr(F2, [], T)),
 1771:
 1772:    F3 = fun(_X) -&gt; throw(away) end,
 1773:    ?line away = (catch dets:traverse(T, F3)),
 1774:
 1775:    F4 = fun(X) -&gt; X + 17 end,
 1776:    ?line {'EXIT', _} = (catch dets:traverse(T, F4)),
 1777:
 1778:    ?line F5 = fun(_X) -&gt; done end,
 1779:    ?line done = dets:traverse(T, F5),
<a name="1780"></a> 1780:
 1781:    ?line {ok, ObjPos} = dets:where(T, {66,{item,number,66}}),
 1782:    ?line ok = dets:close(T),
 1783:
 1784:    %% Damaged object.
 1785:    Pos = if 
 1786:	      Version == 8 -&gt; 12;
 1787:	      Version == 9 -&gt; 8
 1788:	  end,
 1789:    crash(Fname, ObjPos+Pos),
<a name="1790"></a> 1790:    ?line {ok, _} = dets:open_file(T, Args),
 1791:    ?line io:format("Expect corrupt table:~n"),
 1792:    ?line {error,{bad_object,Fname}} = dets:foldl(F0, [], T),
 1793:    ?line {error,{bad_object,Fname}} = dets:close(T),
 1794:
 1795:    ?line file:delete(Fname),
 1796:    ?line P0 == pps(),
 1797:    ok.
 1798:
<a name=fixtable_v8> 1799:<b>fixtable_v8</b></a>(doc) -&gt;
<a name="1800"></a> 1800:    ["Add objects to a fixed table."];
<a name=fixtable_v8> 1801:<b>fixtable_v8</b></a>(suite) -&gt;
 1802:    [];
<a name=fixtable_v8> 1803:<b>fixtable_v8</b></a>(Config) when list(Config) -&gt;
 1804:    fixtable(Config, 8).
 1805:
<a name=fixtable_v9> 1806:<b>fixtable_v9</b></a>(doc) -&gt;
 1807:    ["Add objects to a fixed table."];
<a name=fixtable_v9> 1808:<b>fixtable_v9</b></a>(suite) -&gt;
 1809:    [];
<a name=fixtable_v9><a name="1810"></a> 1810:<b>fixtable_v9</b></a>(Config) when list(Config) -&gt;
 1811:    fixtable(Config, 9).
 1812:
<a name=fixtable> 1813:<b>fixtable</b></a>(Config, Version) when list(Config) -&gt;
 1814:    T = fixtable,
 1815:    ?line Fname = filename(fixtable, Config),
 1816:    ?line file:delete(Fname),
 1817:    Args = [{version,Version},{file,Fname}],
 1818:    P0 = pps(),
 1819:    ?line {ok, _} = dets:open_file(T, Args),
<a name="1820"></a> 1820:
 1821:    %% badarg
 1822:    ?line {'EXIT', {badarg, [{dets,fixtable,[no_table,true]}|_]}} =
 1823:	(catch dets:fixtable(no_table,true)),
 1824:    ?line {'EXIT', {badarg, [{dets,fixtable,[T,undefined]}|_]}} =
 1825:	(catch dets:fixtable(T,undefined)),
 1826:    ?line {'EXIT', {badarg, [{dets,safe_fixtable,[no_table,true]}|_]}} =
 1827:	(catch dets:safe_fixtable(no_table,true)),
 1828:    ?line {'EXIT', {badarg, [{dets,safe_fixtable,[T,undefined]}|_]}} =
 1829:	(catch dets:safe_fixtable(T,undefined)),
<a name="1830"></a> 1830:
 1831:    %% The table is not allowed to grow while the elements are inserted:
 1832:
 1833:    ?line ok = ins(T, 500),
 1834:    ?line dets:safe_fixtable(T, false),    
 1835:    %% Now the table can grow. At the same time as elements are inserted,
 1836:    %% the table tries to catch up with the previously inserted elements.
 1837:    ?line ok = ins(T, 1000),
 1838:    ?line 1000 = dets:info(T, size),
 1839:    ?line ok = dets:close(T),
<a name="1840"></a> 1840:    ?line file:delete(Fname),
 1841:
 1842:    ?line {ok, _} = dets:open_file(T, [{type, duplicate_bag} | Args]),
 1843:    %% In a fixed table, delete and re-insert an object.
 1844:    ?line ok = dets:insert(T, {1, a, b}),
 1845:    ?line dets:safe_fixtable(T, true),
 1846:    ?line ok = dets:match_delete(T, {1, a, b}),
 1847:    ?line ok = dets:insert(T, {1, a, b}),
 1848:    ?line dets:safe_fixtable(T, false),
 1849:    ?line 1 = length(dets:match_object(T, '_')),
<a name="1850"></a> 1850:
 1851:    ?line ok = dets:match_delete(T, '_'),
 1852:    %% In a fixed table, delete and insert a smaller object.
 1853:    ?line ok = dets:insert(T, {1, duplicate(100, e)}),
 1854:    ?line dets:safe_fixtable(T, true),
 1855:    ?line ok = dets:match_delete(T, {1, '_'}),
 1856:    ?line ok = dets:insert(T, {1, a, b}),
 1857:    ?line dets:safe_fixtable(T, false),
 1858:    ?line 1 = length(dets:match_object(T, '_')),
 1859:
<a name="1860"></a> 1860:    ?line ok = dets:delete_all_objects(T),
 1861:    %% Like the last one, but one extra object.
 1862:    ?line ok = dets:insert(T, {1, duplicate(100, e)}),
 1863:    ?line ok = dets:insert(T, {2, duplicate(100, e)}),
 1864:    ?line dets:safe_fixtable(T, true),
 1865:    ?line ok = dets:match_delete(T, {1, '_'}),
 1866:    ?line ok = dets:insert(T, {1, a, b}),
 1867:    ?line dets:safe_fixtable(T, false),
 1868:    ?line 2 = length(dets:match_object(T, '_')),
 1869:    ?line dets:safe_fixtable(T, true),
<a name="1870"></a> 1870:    ?line ok = dets:delete_all_objects(T),
 1871:    ?line true = dets:info(T, fixed),
 1872:    ?line 0 = length(dets:match_object(T, '_')),
 1873:
 1874:    ?line ok = dets:close(T),
 1875:    ?line file:delete(Fname),    
 1876:    ?line P0 == pps(),
 1877:    ok.
 1878:
<a name=match_v8> 1879:<b>match_v8</b></a>(doc) -&gt;
<a name="1880"></a> 1880:    ["Matching objects of a fixed table."];
<a name=match_v8> 1881:<b>match_v8</b></a>(suite) -&gt;
 1882:    [];
<a name=match_v8> 1883:<b>match_v8</b></a>(Config) when list(Config) -&gt;
 1884:    match(Config, 8).
 1885:
<a name=match_v9> 1886:<b>match_v9</b></a>(doc) -&gt;
 1887:    ["Matching objects of a fixed table."];
<a name=match_v9> 1888:<b>match_v9</b></a>(suite) -&gt;
 1889:    [];
<a name=match_v9><a name="1890"></a> 1890:<b>match_v9</b></a>(Config) when list(Config) -&gt;
 1891:    match(Config, 9).
 1892:
<a name=match> 1893:<b>match</b></a>(Config, Version) -&gt;
 1894:    T = match,
 1895:    ?line Fname = filename(match, Config),
 1896:    ?line file:delete(Fname),
 1897:    P0 = pps(),
 1898:
 1899:    Args = [{version, Version}, {file,Fname}, {type, duplicate_bag},
<a name="1900"></a> 1900:	    {estimated_no_objects,550}],
 1901:    ?line {ok, _} = dets:open_file(T, Args),
 1902:    ?line ok = dets:insert(T, {1, a, b}),
 1903:    ?line ok = dets:insert(T, {1, b, a}),
 1904:    ?line ok = dets:insert(T, {2, a, b}),
 1905:    ?line ok = dets:insert(T, {2, b, a}),
 1906:
 1907:    %% match, badarg
 1908:    MSpec = [{'_',[],['$_']}],
 1909:    ?line {'EXIT', {badarg, [{dets,safe_fixtable,[no_table,true]}|_]}} = 
<a name="1910"></a> 1910:	(catch dets:match(no_table, '_')),
 1911:    ?line {'EXIT', {badarg, [{dets,match,[T,'_',not_a_number]}|_]}} = 
 1912:	(catch dets:match(T, '_', not_a_number)),
 1913:    ?line {EC1, _} = dets:select(T, MSpec, 1),
 1914:    ?line {'EXIT', {badarg, [{dets,match,[EC1]}|_]}} = 
 1915:	(catch dets:match(EC1)),
 1916:
 1917:    %% match_object, badarg
 1918:    ?line {'EXIT', {badarg, [{dets,safe_fixtable,[no_table,true]}|_]}} = 
 1919:	(catch dets:match_object(no_table, '_')),
<a name="1920"></a> 1920:    ?line {'EXIT', {badarg, [{dets,match_object,[T,'_',not_a_number]}|_]}} = 
 1921:	(catch dets:match_object(T, '_', not_a_number)),
 1922:    ?line {EC2, _} = dets:select(T, MSpec, 1),
 1923:    ?line {'EXIT', {badarg, [{dets,match_object,[EC2]}|_]}} = 
 1924:	(catch dets:match_object(EC2)),
 1925:
 1926:    dets:safe_fixtable(T, true),
 1927:    ?line {[_, _], C1} = dets:match_object(T, '_', 2),
 1928:    ?line {[_, _], C2} = dets:match_object(C1),
 1929:    ?line '$end_of_table' = dets:match_object(C2),
<a name="1930"></a> 1930:    ?line {[_, _], C3} = dets:match_object(T, {1, '_', '_'}, 100),
 1931:    ?line '$end_of_table' = dets:match_object(C3),
 1932:    ?line {[], C4} = dets:match_object(T, {'_'}, default),
 1933:    ?line '$end_of_table' = dets:match_object(C4),
 1934:    ?line dets:safe_fixtable(T, false),
 1935:
 1936:    ?line dets:safe_fixtable(T, true),
 1937:    ?line {[_, _], C30} = dets:match(T, '$1', 2),
 1938:    ?line {[_, _], C31} = dets:match(C30),
 1939:    ?line '$end_of_table' = dets:match(C31),
<a name="1940"></a> 1940:    ?line {[_, _], C32} = dets:match(T, {1, '$1', '_'}, 100),
 1941:    ?line '$end_of_table' = dets:match(C32),
 1942:    ?line {[], C33} = dets:match(T, {'_'}, default),
 1943:    ?line '$end_of_table' = dets:match(C33),
 1944:    ?line dets:safe_fixtable(T, false),
 1945:    ?line [[1],[1],[2],[2]] = sort(dets:match(T, {'$1','_','_'})),
 1946:
 1947:    %% delete and insert while chunking
 1948:    ?line ok = dets:match_delete(T, '_'),
 1949:    L500 = seq(1, 500),
<a name="1950"></a> 1950:    Fun = fun(X) -&gt; ok = dets:insert(T, {X, a, b, c, d}) end,
 1951:    ?line foreach(Fun, L500),
 1952:    %% Select one object DI in L3 below to be deleted.
 1953:    ?line {_, TmpCont} = dets:match_object(T, '_', 200),    
 1954:    ?line {_, TmpCont1} = dets:match_object(TmpCont),
 1955:    ?line {TTL, _} = dets:match_object(TmpCont1),
 1956:    ?line DI = if Version == 8 -&gt; last(TTL); Version == 9 -&gt; hd(TTL) end,
 1957:    ?line dets:safe_fixtable(T, true),
 1958:    ?line {L1, C20} = dets:match_object(T, '_', 200),    
 1959:    ?line true = 200 =&lt; length(L1),
<a name="1960"></a> 1960:    ?line ok = dets:match_delete(T, {'2','_','_'}), % no match
 1961:    ?line ok = dets:match_delete(T, DI), % last object
 1962:    Tiny = {1050},
 1963:    ?line ok = dets:insert(T, Tiny),
 1964:    ?line true = member(Tiny, dets:match_object(T, '_')),
 1965:    ?line {_L2, C21} = dets:match_object(C20),
 1966:    ?line {L3, _C22} = dets:match_object(C21),
 1967:
 1968:    %% Tiny not visible here
 1969:    ?line false = member(Tiny, L3),
<a name="1970"></a> 1970:    %% It is not obvious that DI should be visible here.
 1971:    ?line true = member(DI, L3),
 1972:    ?line dets:safe_fixtable(T, false),
 1973:
 1974:    ?line ok = dets:close(T),
 1975:    ?line file:delete(Fname),
 1976:
 1977:    N = 100,
 1978:    ?line {ok, _} = dets:open_file(T, [{estimated_no_objects,N} | Args]),
 1979:    ?line ok = ins(T, N),
<a name="1980"></a> 1980:    Obj = {66,{item,number,66}},
 1981:    Spec = {'_','_'},
 1982:    ?line {ok, ObjPos} = dets:where(T, Obj),
 1983:    ?line ok = dets:close(T),
 1984:    %% Damaged object.
 1985:    crash(Fname, ObjPos+12),
 1986:    ?line {ok, _} = dets:open_file(T, Args),
 1987:    ?line io:format("Expect corrupt table:~n"),
 1988:    ?line case ins(T, N) of
 1989:	      ok -&gt;
<a name="1990"></a> 1990:		  ?line {error,{bad_object,Fname}} = dets:sync(T);
 1991:	      Else -&gt;
 1992:		  ?line {error,{bad_object,Fname}} = Else
 1993:	  end,
 1994:    ?line io:format("Expect corrupt table:~n"),
 1995:    ?line {error,{bad_object,Fname}} = dets:match(T, Spec),
 1996:    ?line io:format("Expect corrupt table:~n"),
 1997:    ?line {error,{bad_object,Fname}} = dets:match_delete(T, Spec),
 1998:    ?line {error,{bad_object,Fname}} = dets:close(T),
 1999:    ?line file:delete(Fname),
<a name="2000"></a> 2000:
 2001:    ?line {ok, _} = dets:open_file(T, [{estimated_no_objects,N} | Args]),
 2002:    ?line ok = ins(T, N),
 2003:    ?line {ok, ObjPos2} = dets:where(T, Obj),
 2004:    ?line ok = dets:close(T),
 2005:
 2006:    %% Damaged size of object.
 2007:    %% In v8, there is a next pointer before the size.
 2008:    CrashPos = if Version == 8 -&gt; 5; Version == 9 -&gt; 1 end,
 2009:    crash(Fname, ObjPos2+CrashPos),
<a name="2010"></a> 2010:    ?line {ok, _} = dets:open_file(T, Args),
 2011:    ?line io:format("Expect corrupt table:~n"),
 2012:    ?line case ins(T, N) of
 2013:	      ok -&gt;
 2014:		  ?line {error,{bad_object,Fname}} = dets:sync(T);
 2015:	      Else2 -&gt;
 2016:		  ?line {error,{bad_object,Fname}} = Else2
 2017:	  end,
 2018:    %% Just echoes...
 2019:    ?line {error,{bad_object,Fname}} = dets:match(T, Spec),
<a name="2020"></a> 2020:    ?line {error,{bad_object,Fname}} = dets:match_delete(T, Spec),
 2021:    ?line {error,{bad_object,Fname}} = dets:close(T),
 2022:    ?line file:delete(Fname),
 2023:
 2024:    ?line {ok, _} = dets:open_file(T, [{estimated_no_objects,N} | Args]),
 2025:    ?line ok = ins(T, N),
 2026:    ?line {ok, ObjPos3} = dets:where(T, Obj),
 2027:    ?line ok = dets:close(T),
 2028:
 2029:    %% match_delete finds an error
<a name="2030"></a> 2030:    CrashPos3 = if Version == 8 -&gt; 12; Version == 9 -&gt; 16 end,
 2031:    crash(Fname, ObjPos3+CrashPos3),
 2032:    ?line {ok, _} = dets:open_file(T, Args),
 2033:    ?line {error,{bad_object,Fname}} = dets:match_delete(T, Spec),
 2034:    ?line {error,{bad_object,Fname}} = dets:close(T),
 2035:    ?line file:delete(Fname),
 2036:
 2037:    %% The key is not fixed, but not all objects with the key are removed.
 2038:    ?line {ok, _} = dets:open_file(T, Args),
 2039:    ?line ok = dets:insert(T, [{1,a},{1,b},{1,c},{1,a},{1,b},{1,c}]),
<a name="2040"></a> 2040:    ?line 6 = dets:info(T, size),
 2041:    ?line ok = dets:match_delete(T, {'_',a}),
 2042:    ?line 4 = dets:info(T, size),
 2043:    ?line [{1,b},{1,b},{1,c},{1,c}] = 
 2044:	sort(dets:match_object(T,{'_','_'})),
 2045:    ?line ok = dets:close(T),
 2046:    ?line file:delete(Fname),
 2047:
 2048:    ?line P0 == pps(),
 2049:    ok.
<a name="2050"></a> 2050:
<a name=select_v8> 2051:<b>select_v8</b></a>(doc) -&gt;
 2052:    ["Selecting objects of a fixed table."];
<a name=select_v8> 2053:<b>select_v8</b></a>(suite) -&gt;
 2054:    [];
<a name=select_v8> 2055:<b>select_v8</b></a>(Config) when list(Config) -&gt;
 2056:    select(Config, 8).
 2057:
<a name=select_v9> 2058:<b>select_v9</b></a>(doc) -&gt;
 2059:    ["Selecting objects of a fixed table."];
<a name=select_v9><a name="2060"></a> 2060:<b>select_v9</b></a>(suite) -&gt;
 2061:    [];
<a name=select_v9> 2062:<b>select_v9</b></a>(Config) when list(Config) -&gt;
 2063:    select(Config, 9).
 2064:
<a name=select> 2065:<b>select</b></a>(Config, Version) -&gt;
 2066:    T = select,
 2067:    ?line Fname = filename(select, Config),
 2068:    ?line file:delete(Fname),
 2069:    P0 = pps(),
<a name="2070"></a> 2070:
 2071:    ?line Args = [{version,Version}, {file,Fname}, {type, duplicate_bag},
 2072:		  {estimated_no_objects,550}],
 2073:    ?line {ok, _} = dets:open_file(T, Args),
 2074:    ?line ok = dets:insert(T, {1, a, b}),
 2075:    ?line ok = dets:insert(T, {1, b, a}),
 2076:    ?line ok = dets:insert(T, {2, a, b}),
 2077:    ?line ok = dets:insert(T, {2, b, a}),
 2078:    ?line ok = dets:insert(T, {3, a, b}),
 2079:    ?line ok = dets:insert(T, {3, b, a}),
<a name="2080"></a> 2080:
 2081:    %% badarg
 2082:    MSpec = [{'_',[],['$_']}],
 2083:    ?line {'EXIT', {badarg, [{dets,safe_fixtable,[no_table,true]}|_]}} = 
 2084:	(catch dets:select(no_table, MSpec)),
 2085:    ?line {'EXIT', {badarg, [{dets,select,[T,&lt;&lt;17&gt;&gt;]}|_]}} = 
 2086:	(catch dets:select(T, &lt;&lt;17&gt;&gt;)),
 2087:    ?line {'EXIT', {badarg, [{dets,select,[T,[]]}|_]}} = 
 2088:	(catch dets:select(T, [])),
 2089:    ?line {'EXIT', {badarg, [{dets,select,[T,MSpec,not_a_number]}|_]}} = 
<a name="2090"></a> 2090:	(catch dets:select(T, MSpec, not_a_number)),
 2091:    ?line {EC, _} = dets:match(T, '_', 1),
 2092:    ?line {'EXIT', {badarg, [{dets,select,[EC]}|_]}} = 
 2093:	(catch dets:select(EC)),
 2094:
 2095:    AllSpec = [{'_',[],['$_']}],
 2096:
 2097:    ?line dets:safe_fixtable(T, true),
 2098:    ?line {[_, _], C1} = dets:select(T, AllSpec, 2),
 2099:    ?line {[_, _], C2} = dets:select(C1),
<a name="2100"></a> 2100:    ?line {[_, _], C2a} = dets:select(C2),
 2101:    ?line '$end_of_table' = dets:select(C2a),
 2102:    ?line {[_, _], C3} = dets:select(T, [{{1,'_','_'},[],['$_']}], 100),
 2103:    ?line '$end_of_table' = dets:select(C3),
 2104:    ?line {[], C4} = dets:select(T, [{{'_'},[],['$_']}], default),
 2105:    ?line '$end_of_table' = dets:select(C4),
 2106:    ?line dets:safe_fixtable(T, false),
 2107:    Sp1 = [{{1,'_','_'},[],['$_']},{{1,'_','_'},[],['$_']},
 2108:	   {{2,'_','_'},[],['$_']}],
 2109:    ?line [_,_,_,_] = dets:select(T, Sp1),
<a name="2110"></a> 2110:    Sp2 = [{{1,'_','_'},[],['$_']},{{1,'_','_'},[],['$_']},
 2111:	   {{'_','_','_'},[],['$_']}],
 2112:    ?line [_,_,_,_,_,_] = dets:select(T, Sp2),
 2113:
 2114:    AllDeleteSpec = [{'_',[],[true]}],
 2115:    %% delete and insert while chunking
 2116:    ?line 6 = dets:select_delete(T, AllDeleteSpec),
 2117:    L500 = seq(1, 500),
 2118:    Fun = fun(X) -&gt; ok = dets:insert(T, {X, a, b, c, d}) end,
 2119:    ?line foreach(Fun, L500),
<a name="2120"></a> 2120:    %% Select one object DI in L3 below to be deleted.
 2121:    ?line {_, TmpCont} = dets:match_object(T, '_', 200),    
 2122:    ?line {_, TmpCont1} = dets:match_object(TmpCont),
 2123:    ?line {TTL, _} = dets:match_object(TmpCont1),
 2124:    ?line DI = if Version == 8 -&gt; last(TTL); Version == 9 -&gt; hd(TTL) end,
 2125:    ?line dets:safe_fixtable(T, true),
 2126:    ?line {L1, C20} = dets:select(T, AllSpec, 200),
 2127:    ?line true = 200 =&lt; length(L1),
 2128:    ?line 0 = dets:select_delete(T, [{{2,'_','_'},[],[true]}]),
 2129:    ?line 1 = dets:select_delete(T, [{DI,[],[true]}]), % last object
<a name="2130"></a> 2130:    Tiny = {1050},
 2131:    ?line ok = dets:insert(T, Tiny),
 2132:    ?line true = member(Tiny, dets:select(T, AllSpec)),
 2133:    ?line {_L2, C21} = dets:select(C20),
 2134:    ?line {L3, _C22} = dets:select(C21),
 2135:    %% Tiny not visible here
 2136:    ?line false = member(Tiny, L3),
 2137:    %% It is not obvious that DI should be visible here (kind of ghost).
 2138:    ?line true = member(DI, L3),
 2139:    ?line dets:safe_fixtable(T, false),
<a name="2140"></a> 2140:    ?line ok = dets:close(T),
 2141:    ?line file:delete(Fname),
 2142:
 2143:    %% The key is not fixed, but not all objects with the key are removed.
 2144:    ?line {ok, _} = dets:open_file(T, Args),
 2145:    ?line ok = dets:insert(T, [{1,a},{1,b},{1,c},{1,a},{1,b},{1,c}]),
 2146:    ?line 6 = dets:info(T, size),
 2147:    ?line 2 = dets:select_delete(T, [{{'_',a},[],[true]}]),
 2148:    ?line 4 = dets:info(T, size),
 2149:    ?line [{1,b},{1,b},{1,c},{1,c}] = sort(dets:select(T, AllSpec)),
<a name="2150"></a> 2150:    ?line ok = dets:close(T),
 2151:    ?line file:delete(Fname),
 2152:
 2153:    ?line P0 == pps(),
 2154:    ok.
 2155:
<a name=update_counter> 2156:<b>update_counter</b></a>(doc) -&gt;
 2157:    ["Test update_counter/1."];
<a name=update_counter> 2158:<b>update_counter</b></a>(suite) -&gt;
 2159:    [];
<a name=update_counter><a name="2160"></a> 2160:<b>update_counter</b></a>(Config) when list(Config) -&gt;
 2161:    T = update_counter,
 2162:    ?line Fname = filename(select, Config),
 2163:    ?line file:delete(Fname),
 2164:    P0 = pps(),
 2165:
 2166:    ?line {'EXIT', {badarg, [{dets,update_counter,[no_table,1,1]}|_]}} = 
 2167:	(catch dets:update_counter(no_table, 1, 1)),
 2168:
 2169:    Args = [{file,Fname},{keypos,2}],
<a name="2170"></a> 2170:    ?line {ok, _} = dets:open_file(T, [{type,set} | Args]),
 2171:    ?line {'EXIT', {badarg, _}} = (catch dets:update_counter(T, 1, 1)),
 2172:    ?line ok = dets:insert(T, {1,a}),
 2173:    ?line {'EXIT', {badarg, _}} = (catch dets:update_counter(T, 1, 1)),
 2174:    ?line ok = dets:insert(T, {0,1}),
 2175:    ?line {'EXIT', {badarg, _}} = (catch dets:update_counter(T, 1, 1)),
 2176:    ?line ok = dets:insert(T, {0,1,0}),
 2177:    ?line 1 = dets:update_counter(T, 1, 1),
 2178:    ?line 2 = dets:update_counter(T, 1, 1),
 2179:    ?line 6 = dets:update_counter(T, 1, {3,4}),
<a name="2180"></a> 2180:    ?line {'EXIT', {badarg, _}} = (catch dets:update_counter(T, 1, {0,3})),
 2181:    ?line ok = dets:close(T),
 2182:    ?line file:delete(Fname),
 2183:
 2184:    ?line {ok, _} = dets:open_file(T, [{type,bag} | Args]),
 2185:    ?line ok = dets:insert(T, {0,1,0}),
 2186:    ?line {'EXIT', {badarg, _}} = (catch dets:update_counter(T, 1, 1)),
 2187:    ?line ok = dets:close(T),
 2188:    ?line file:delete(Fname),
 2189:    ?line P0 == pps(),
<a name="2190"></a> 2190:
 2191:    ok.
 2192:
<a name=badarg> 2193:<b>badarg</b></a>(doc) -&gt;
 2194:    ["Call some functions with bad arguments."];
<a name=badarg> 2195:<b>badarg</b></a>(suite) -&gt;
 2196:    [];
<a name=badarg> 2197:<b>badarg</b></a>(Config) when list(Config) -&gt;
 2198:    T = badarg,
 2199:    ?line Fname = filename(select, Config),
<a name="2200"></a> 2200:    ?line file:delete(Fname),
 2201:    P0 = pps(),
 2202:
 2203:    Args = [{file,Fname},{keypos,3}],
 2204:    ?line {ok, _} = dets:open_file(T, [{type,set} | Args]),
 2205:    % ?line dets:verbose(),
 2206:
 2207:    %% badargs are tested in match, select and fixtable too.
 2208:
 2209:    %% open
<a name="2210"></a> 2210:    ?line {'EXIT', {badarg, [{dets,open_file,[{a,tuple},[]]}|_]}} = 
 2211:	(catch dets:open_file({a,tuple},[])),
 2212:    ?line {'EXIT', {badarg, [{dets,open_file,[{a,tuple}]}|_]}} = 
 2213:	(catch dets:open_file({a,tuple})),
 2214:    ?line {'EXIT', {badarg, [{dets,open_file,[file,[foo]]}|_]}} = 
 2215:	(catch dets:open_file(file,[foo])),
 2216:    ?line {'EXIT', {badarg,[{dets,open_file,[{hej,san},[{type,set}|3]]}|_]}} =
 2217:	(catch dets:open_file({hej,san},[{type,set}|3])),
 2218:
 2219:    %% insert
<a name="2220"></a> 2220:    ?line {'EXIT', {badarg, [{dets,insert,[no_table,{1,2}]}|_]}} = 
 2221:	(catch dets:insert(no_table, {1,2})),
 2222:    ?line {'EXIT', {badarg, [{dets,insert,[no_table,[{1,2}]]}|_]}} = 
 2223:	(catch dets:insert(no_table, [{1,2}])),
 2224:    ?line {'EXIT', {badarg, [{dets,insert,[T,{1,2}]}|_]}} = 
 2225:	(catch dets:insert(T, {1,2})),
 2226:    ?line {'EXIT', {badarg, [{dets,insert,[T,[{1,2}]]}|_]}} = 
 2227:	(catch dets:insert(T, [{1,2}])),
 2228:    ?line {'EXIT', {badarg, [{dets,insert,[T,[{1,2,3}|3]]}|_]}} = 
 2229:	      (catch dets:insert(T, [{1,2,3} | 3])),
<a name="2230"></a> 2230:
 2231:    %% lookup{_keys}
 2232:    ?line {'EXIT', {badarg, [{dets,lookup_keys,[badarg,[]]}|_]}} = 
 2233:	(catch dets:lookup_keys(T, [])),
 2234:    ?line {'EXIT', {badarg, [{dets,lookup,[no_table,1]}|_]}} = 
 2235:	(catch dets:lookup(no_table, 1)),
 2236:    ?line {'EXIT', {badarg, [{dets,lookup_keys,[T,[1|2]]}|_]}} = 
 2237:	(catch dets:lookup_keys(T, [1 | 2])),
 2238:
 2239:    %% member
<a name="2240"></a> 2240:    ?line {'EXIT', {badarg, [{dets,member,[no_table,1]}|_]}} = 
 2241:	(catch dets:member(no_table, 1)),
 2242:
 2243:    %% sync
 2244:    ?line {'EXIT', {badarg, [{dets,sync,[no_table]}|_]}} = 
 2245:	(catch dets:sync(no_table)),
 2246:
 2247:    %% delete{_keys}
 2248:    ?line {'EXIT', {badarg, [{dets,delete,[no_table,1]}|_]}} = 
 2249:	(catch dets:delete(no_table, 1)),
<a name="2250"></a> 2250:
 2251:    %% delete_object
 2252:    ?line {'EXIT', {badarg, [{dets,delete_object,[no_table,{1,2,3}]}|_]}} = 
 2253:	(catch dets:delete_object(no_table, {1,2,3})),
 2254:    ?line {'EXIT', {badarg, [{dets,delete_object,[T,{1,2}]}|_]}} = 
 2255:	(catch dets:delete_object(T, {1,2})),
 2256:    ?line {'EXIT', {badarg, [{dets,delete_object,[no_table,[{1,2,3}]]}|_]}} = 
 2257:	(catch dets:delete_object(no_table, [{1,2,3}])),
 2258:    ?line {'EXIT', {badarg, [{dets,delete_object,[T,[{1,2}]]}|_]}} = 
 2259:	(catch dets:delete_object(T, [{1,2}])),
<a name="2260"></a> 2260:    ?line {'EXIT', {badarg, [{dets,delete_object,[T,[{1,2,3}|3]]}|_]}} = 
 2261:	(catch dets:delete_object(T, [{1,2,3} | 3])),
 2262:
 2263:    %% first,next,slot
 2264:    ?line {'EXIT', {badarg, [{dets,first,[no_table]}|_]}} =
 2265:	(catch dets:first(no_table)),
 2266:    ?line {'EXIT', {badarg, [{dets,next,[no_table,1]}|_]}} =
 2267:	(catch dets:next(no_table, 1)),
 2268:    ?line {'EXIT', {badarg, [{dets,slot,[no_table,0]}|_]}} =
 2269:	(catch dets:slot(no_table, 0)),
<a name="2270"></a> 2270:
 2271:    %% info
 2272:    ?line undefined = dets:info(no_table),
 2273:    ?line undefined = dets:info(no_table, foo),
 2274:    ?line undefined = dets:info(T, foo),
 2275:
 2276:    %% match_delete
 2277:    ?line {'EXIT', {badarg, [{dets,safe_fixtable,[no_table,true]}|_]}} = 
 2278:	(catch dets:match_delete(no_table, '_')),
 2279:
<a name="2280"></a> 2280:    %% delete_all_objects
 2281:    ?line {'EXIT', {badarg, [{dets,delete_all_objects,[no_table]}|_]}} = 
 2282:	(catch dets:delete_all_objects(no_table)),
 2283:
 2284:    %% select_delete
 2285:    MSpec = [{'_',[],['$_']}],
 2286:    ?line {'EXIT', {badarg, [{dets,safe_fixtable,[no_table,true]}|_]}} = 
 2287:	(catch dets:select_delete(no_table, MSpec)),
 2288:    ?line {'EXIT', {badarg, [{dets,select_delete,[T, &lt;&lt;17&gt;&gt;]}|_]}} = 
 2289:	(catch dets:select_delete(T, &lt;&lt;17&gt;&gt;)),
<a name="2290"></a> 2290:
 2291:    %% traverse, fold
 2292:    ?line {'EXIT', {badarg, [{dets,safe_fixtable,[no_table,true]}|_]}} = 
 2293:	(catch dets:traverse(no_table, fun(_) -&gt; continue end)),
 2294:    ?line {'EXIT', {badarg, [{dets,safe_fixtable,[no_table,true]}|_]}} = 
 2295:	(catch dets:foldl(fun(_, A) -&gt; A end, [], no_table)),
 2296:    ?line {'EXIT', {badarg, [{dets,safe_fixtable,[no_table,true]}|_]}} = 
 2297:	(catch dets:foldr(fun(_, A) -&gt; A end, [], no_table)),
 2298:
 2299:    %% close
<a name="2300"></a> 2300:    ?line ok = dets:close(T),
 2301:    ?line {error, not_owner} = dets:close(T),
 2302:    ?line {error, not_owner} = dets:close(T),
 2303:
 2304:    %% init_table
 2305:    ?line {'EXIT', {badarg,[{dets,init_table,[no_table,_,[]]}|_]}} =
 2306:	(catch dets:init_table(no_table, fun(X) -&gt; X end)),
 2307:    ?line {'EXIT', {badarg,[{dets,init_table,[no_table,_,[]]}|_]}} =
 2308:	(catch dets:init_table(no_table, fun(X) -&gt; X end, [])),
 2309:
<a name="2310"></a> 2310:    %% from_ets
 2311:    Ets = ets:new(ets,[]),
 2312:    ?line {'EXIT', {badarg,[{dets,from_ets,[no_table,_]}|_]}} =
 2313:	(catch dets:from_ets(no_table, Ets)),
 2314:    ets:delete(Ets),
 2315:
 2316:    ?line {ok, T} = dets:open_file(T, Args),
 2317:    ?line {error,incompatible_arguments} = 
 2318:	dets:open_file(T, [{type,bag} | Args]),
 2319:    ?line ok = dets:close(T),
<a name="2320"></a> 2320:
 2321:    file:delete(Fname),
 2322:    ?line P0 == pps(),
 2323:    ok.
 2324:
<a name=cache_sets_v8> 2325:<b>cache_sets_v8</b></a>(doc) -&gt;
 2326:    ["Test the write cache for sets."];
<a name=cache_sets_v8> 2327:<b>cache_sets_v8</b></a>(suite) -&gt;
 2328:    [];
<a name=cache_sets_v8> 2329:<b>cache_sets_v8</b></a>(Config) when list(Config) -&gt;
<a name="2330"></a> 2330:    cache_sets(Config, 8).
 2331:
<a name=cache_sets_v9> 2332:<b>cache_sets_v9</b></a>(doc) -&gt;
 2333:    ["Test the write cache for sets."];
<a name=cache_sets_v9> 2334:<b>cache_sets_v9</b></a>(suite) -&gt;
 2335:    [];
<a name=cache_sets_v9> 2336:<b>cache_sets_v9</b></a>(Config) when list(Config) -&gt;
 2337:    cache_sets(Config, 9).
 2338:
<a name=cache_sets> 2339:<b>cache_sets</b></a>(Config, Version) -&gt;
<a name="2340"></a> 2340:    Small = 2,
 2341:    cache_sets(Config, {0,0}, false, Small, Version),
 2342:    cache_sets(Config, {0,0}, true, Small, Version),
 2343:    cache_sets(Config, {5000,5000}, false, Small, Version),
 2344:    cache_sets(Config, {5000,5000}, true, Small, Version),
 2345:    %% Objects of size greater than 2 kB.
 2346:    Big = 1200,
 2347:    cache_sets(Config, {0,0}, false, Big, Version),
 2348:    cache_sets(Config, {0,0}, true, Big, Version),
 2349:    cache_sets(Config, {5000,5000}, false, Big, Version),
<a name="2350"></a> 2350:    cache_sets(Config, {5000,5000}, true, Big, Version),
 2351:    ok.
 2352:    
<a name=cache_sets> 2353:<b>cache_sets</b></a>(Config, DelayedWrite, Extra, Sz, Version) -&gt;
 2354:    %% Extra = bool(). Insert tuples until the tested key is not alone.
 2355:    %% Sz = integer(). Size of the inserted tuples.
 2356:
 2357:    T = cache,
 2358:    ?line Fname = filename(cache, Config),
 2359:    ?line file:delete(Fname),
<a name="2360"></a> 2360:    P0 = pps(),
 2361:
 2362:    ?line {ok, _} = 
 2363:	dets:open_file(T,[{version, Version}, {file,Fname}, {type,set}, 
 2364:			  {delayed_write, DelayedWrite}]),
 2365:
 2366:    Dups = 1,
 2367:    {Key, OtherKeys} = 
 2368:	if 
 2369:	    Extra == true -&gt;
<a name="2370"></a> 2370:		%% Insert enough to get three keys in some slot.
 2371:		?line dets:safe_fixtable(T, true),
 2372:		insert_objs(T, 1, Sz, Dups);
 2373:	    true -&gt;
 2374:		{1,[]}
 2375:	  end,
 2376:    Tuple = erlang:make_tuple(Sz, Key),
 2377:    ?line ok = dets:delete(T, Key),
 2378:    ?line ok = dets:sync(T),    
 2379:
<a name="2380"></a> 2380:    %% The values of keys in the same slot as Key are checked.
 2381:    ?line OtherValues = sort(lookup_keys(T, OtherKeys)),
 2382:    
 2383:    ?line ok = dets:insert(T, Tuple),
 2384:    ?line [Tuple] = dets:lookup(T, Key),
 2385:    ?line true = dets:member(T, Key),
 2386:    ?line ok = dets:insert(T, [Tuple,Tuple]),
 2387:    %% If no delay, the cache gets filled immediately, and written.
 2388:    ?line [Tuple] = dets:lookup_keys(T, [Key,a,b,c,d,e,f]),
 2389:    ?line true = dets:member(T, Key),
<a name="2390"></a> 2390:
 2391:    %% If delay, this happens without file access.
 2392:    ?line ok = dets:delete(T,Key),
 2393:    ?line ok = dets:insert(T,Tuple),
 2394:    ?line ok = dets:insert(T,Tuple),
 2395:    ?line [Tuple] = dets:lookup(T, Key),
 2396:    ?line true = dets:member(T, Key),
 2397:    ?line ok = dets:sync(T),
 2398:    ?line [Tuple] = dets:lookup(T, Key),
 2399:    ?line true = dets:member(T, Key),
<a name="2400"></a> 2400:
 2401:    %% Key's objects are is on file only, 
 2402:    %% key 'toto' in the cache (if there is one).
 2403:    ?line ok = dets:delete(T,toto),
 2404:    ?line ok = dets:insert(T,[{toto,b},{toto,b}]),
 2405:    ?line true = sort([Tuple,{toto,b}]) == 
 2406:                 sort(dets:lookup_keys(T, [Key,toto])),
 2407:    ?line true = dets:member(T, toto),
 2408:
 2409:    ?line ok = dets:delete(T, Key),
<a name="2410"></a> 2410:    ?line ok = dets:sync(T),
 2411:    ?line false = dets:member(T, Key),
 2412:    ?line Size = dets:info(T, size),
 2413:
 2414:    %% No object with the key on the file.
 2415:    %% Delete, add one object.
 2416:    Size1 = Size + 2,
 2417:    del_and_ins(key, T, Size1, Tuple, Key, 1),
 2418:    del_and_ins(object, T, Size1, Tuple, Key, 1),
 2419:    del_and_ins(both, T, Size1, Tuple, Key, 1),
<a name="2420"></a> 2420:
 2421:    %% One object with the key on the file.
 2422:    %% Delete it, add one object.
 2423:    Size2 = Size + 2,
 2424:    del_and_ins(key, T, Size2, Tuple, Key, 1),
 2425:    del_and_ins(object, T, Size2, Tuple, Key, 1),
 2426:    del_and_ins(both, T, Size2, Tuple, Key, 1),
 2427:
 2428:    %% Overwrite an old objekt with exactly the same size.
 2429:    Element = case element(2, Tuple) of
<a name="2430"></a> 2430:		  255 -&gt; 254;
 2431:		  E -&gt; E + 1
 2432:	      end,
 2433:    Tuple2 = setelement(2, Tuple, Element),
 2434:    ?line ok = dets:sync(T),
 2435:    ?line ok = dets:insert(T, Tuple2),
 2436:    ?line [Tuple2] = dets:lookup(T, Key),
 2437:    ?line true = dets:member(T, Key),
 2438:    ?line ok = dets:sync(T),    
 2439:    ?line [Tuple2] = dets:lookup(T, Key),
<a name="2440"></a> 2440:    ?line true = dets:member(T, Key),
 2441:
 2442:    ?line ok = dets:insert(T, {3,a}),
 2443:    ?line ok = dets:insert(T, {3,b}),
 2444:    ?line ok = dets:delete_object(T, {3,c}),
 2445:    ?line ok = dets:delete_object(T, {3,d}),
 2446:    ?line [{3,b}] = dets:lookup(T, 3),
 2447:
 2448:    ?line ok = dets:delete(T, 3),
 2449:    ?line ok = dets:delete_object(T, {3,c}),
<a name="2450"></a> 2450:    ?line ok = dets:delete_object(T, {3,d}),
 2451:    ?line [] = dets:lookup(T, 3),
 2452:
 2453:    ?line OtherValues = sort(lookup_keys(T, OtherKeys)),
 2454:    if
 2455:	Extra == true -&gt;
 2456:	    %% Let the table grow a while, if it needs to.
 2457:	    ?line All1 = get_all_objects(T),
 2458:	    ?line dets:safe_fixtable(T, false),
 2459:	    ?line timer:sleep(1000),
<a name="2460"></a> 2460:	    ?line OtherValues = sort(lookup_keys(T, OtherKeys)),
 2461:	    ?line dets:safe_fixtable(T, true),
 2462:	    ?line All2 = get_all_objects(T),
 2463:	    ?line FAll2 = get_all_objects_fast(T),
 2464:	    ?line true = sort(All2) == sort(FAll2),
 2465:            case symdiff(All1, All2) of
 2466:		{[],[]} -&gt;  ok;
 2467:		{X,Y} -&gt;
 2468:		    NoBad = length(X) + length(Y),
 2469:		    test_server:fail({sets,DelayedWrite,Extra,Sz,NoBad})
<a name="2470"></a> 2470:	    end;
 2471:	true -&gt;
 2472:	    ok
 2473:    end,
 2474:    ?line ok = dets:close(T),
 2475:
 2476:    file:delete(Fname),
 2477:    ?line P0 == pps(),
 2478:    ok.
 2479:    
<a name=cache_bags_v8><a name="2480"></a> 2480:<b>cache_bags_v8</b></a>(doc) -&gt;
 2481:    ["Test the write cache for bags."];
<a name=cache_bags_v8> 2482:<b>cache_bags_v8</b></a>(suite) -&gt;
 2483:    [];
<a name=cache_bags_v8> 2484:<b>cache_bags_v8</b></a>(Config) when list(Config) -&gt;
 2485:    cache_bags(Config, 8).
 2486:
<a name=cache_bags_v9> 2487:<b>cache_bags_v9</b></a>(doc) -&gt;
 2488:    ["Test the write cache for bags."];
<a name=cache_bags_v9> 2489:<b>cache_bags_v9</b></a>(suite) -&gt;
<a name="2490"></a> 2490:    [];
<a name=cache_bags_v9> 2491:<b>cache_bags_v9</b></a>(Config) when list(Config) -&gt;
 2492:    cache_bags(Config, 9).
 2493:
<a name=cache_bags> 2494:<b>cache_bags</b></a>(Config, Version) -&gt;
 2495:    Small = 2,
 2496:    cache_bags(Config, {0,0}, false, Small, Version),
 2497:    cache_bags(Config, {0,0}, true, Small, Version),
 2498:    cache_bags(Config, {5000,5000}, false, Small, Version),
 2499:    cache_bags(Config, {5000,5000}, true, Small, Version),
<a name="2500"></a> 2500:    %% Objects of size greater than 2 kB.
 2501:    Big = 1200,
 2502:    cache_bags(Config, {0,0}, false, Big, Version),
 2503:    cache_bags(Config, {0,0}, true, Big, Version),
 2504:    cache_bags(Config, {5000,5000}, false, Big, Version),
 2505:    cache_bags(Config, {5000,5000}, true, Big, Version),
 2506:    ok.
 2507:    
<a name=cache_bags> 2508:<b>cache_bags</b></a>(Config, DelayedWrite, Extra, Sz, Version) -&gt;
 2509:    %% Extra = bool(). Insert tuples until the tested key is not alone.
<a name="2510"></a> 2510:    %% Sz = integer(). Size of the inserted tuples.
 2511:
 2512:    T = cache,
 2513:    ?line Fname = filename(cache, Config),
 2514:    ?line file:delete(Fname),
 2515:    P0 = pps(),
 2516:
 2517:    ?line {ok, _} = 
 2518:	dets:open_file(T,[{version, Version}, {file,Fname}, {type,bag}, 
 2519:			  {delayed_write, DelayedWrite}]),
<a name="2520"></a> 2520:
 2521:    Dups = 1,
 2522:    {Key, OtherKeys} = 
 2523:	if 
 2524:	    Extra == true -&gt;
 2525:		%% Insert enough to get three keys in some slot.
 2526:		?line dets:safe_fixtable(T, true),
 2527:		insert_objs(T, 1, Sz, Dups);
 2528:	    true -&gt;
 2529:		{1,[]}
<a name="2530"></a> 2530:	  end,
 2531:    Tuple = erlang:make_tuple(Sz, Key),
 2532:    ?line ok = dets:delete(T, Key),
 2533:    ?line ok = dets:sync(T),    
 2534:
 2535:    %% The values of keys in the same slot as Key are checked.
 2536:    ?line OtherValues = sort(lookup_keys(T, OtherKeys)),
 2537:    
 2538:    ?line ok = dets:insert(T, Tuple),
 2539:    ?line [Tuple] = dets:lookup(T, Key),
<a name="2540"></a> 2540:    ?line true = dets:member(T, Key),
 2541:    ?line ok = dets:insert(T, [Tuple,Tuple]),
 2542:    %% If no delay, the cache gets filled immediately, and written.
 2543:    ?line [Tuple] = dets:lookup_keys(T, [Key,a,b,c,d,e,f]),
 2544:    ?line true = dets:member(T, Key),
 2545:
 2546:    %% If delay, this happens without file access. 
 2547:    %% (This is no longer true; cache lookup has been simplified.)
 2548:    ?line ok = dets:delete(T,Key),
 2549:    ?line ok = dets:insert(T,Tuple),
<a name="2550"></a> 2550:    ?line ok = dets:insert(T,Tuple),
 2551:    ?line [Tuple] = dets:lookup(T, Key),
 2552:    ?line true = dets:member(T, Key),
 2553:    ?line ok = dets:sync(T),
 2554:    ?line [Tuple] = dets:lookup(T, Key),
 2555:    ?line true = dets:member(T, Key),
 2556:
 2557:    %% Key's objects are is on file only, 
 2558:    %% key toto in the cache (if there is one).
 2559:    ?line ok = dets:delete(T,toto),
<a name="2560"></a> 2560:    ?line false = dets:member(T, toto),
 2561:    ?line ok = dets:insert(T,[{toto,b},{toto,b}]),
 2562:    ?line true = sort([Tuple,{toto,b}]) == 
 2563:                 sort(dets:lookup_keys(T, [Key,toto])),
 2564:    ?line true = dets:member(T, toto),
 2565:
 2566:    ?line ok = dets:delete(T, Key),
 2567:    ?line ok = dets:sync(T),
 2568:    ?line Size = dets:info(T, size),
 2569:
<a name="2570"></a> 2570:    %% No object with the key on the file.
 2571:    %% Delete, add one object.
 2572:    Size1 = Size + 2,
 2573:    del_and_ins(key, T, Size1, Tuple, Key, 1),
 2574:    del_and_ins(object, T, Size1, Tuple, Key, 1),
 2575:    del_and_ins(both, T, Size1, Tuple, Key, 1),
 2576:
 2577:    %% One object with the key on the file.
 2578:    %% Delete it, add one object.
 2579:    Size2 = Size + 2,
<a name="2580"></a> 2580:    del_and_ins(key, T, Size2, Tuple, Key, 1),
 2581:    del_and_ins(object, T, Size2, Tuple, Key, 1),
 2582:    del_and_ins(both, T, Size2, Tuple, Key, 1),
 2583:
 2584:    %% Overwrite an objekt on file with the same object.
 2585:    ?line ok = dets:insert(T, Tuple),
 2586:    ?line ok = dets:sync(T),
 2587:    ?line [Tuple2] = dets:lookup(T, Key),
 2588:    ?line true = dets:member(T, Key),
 2589:    ?line ok = dets:insert(T, Tuple),
<a name="2590"></a> 2590:    ?line ok = dets:sync(T),
 2591:    ?line [Tuple2] = dets:lookup(T, Key),
 2592:    ?line true = dets:member(T, Key),
 2593:
 2594:    %% A mix of insert and delete.
 2595:    ?line ok = dets:delete(T, Key),
 2596:    ?line ok = dets:sync(T),
 2597:    ?line ok = dets:delete(T, Key),
 2598:    ?line ok = dets:insert(T, {Key,foo}),
 2599:    ?line ok = dets:insert(T, {Key,bar}),
<a name="2600"></a> 2600:    ?line [{Key,bar},{Key,foo}] = sort(dets:lookup(T, Key)),
 2601:    ?line true = dets:member(T, Key),
 2602:    ?line ok = dets:delete_object(T, {Key,foo}),
 2603:    ?line ok = dets:insert(T, {Key,kar}),
 2604:    ?line [{Key,bar},{Key,kar}] = sort(dets:lookup(T, Key)),
 2605:    ?line true = dets:member(T, Key),
 2606:    ?line ok = dets:insert(T, [{Key,kar},{Key,kar}]),
 2607:    ?line [{Key,bar},{Key,kar}] = sort(dets:lookup(T, Key)),
 2608:    ?line true = dets:member(T, Key),
 2609:    ?line ok = dets:delete_object(T, {Key,bar}),
<a name="2610"></a> 2610:    ?line ok = dets:delete_object(T, {Key,kar}),
 2611:    ?line [] = dets:lookup(T, Key),
 2612:    ?line false = dets:member(T, Key),
 2613:    ?line ok = dets:sync(T),
 2614:    ?line [] = dets:lookup(T, Key),
 2615:    ?line false = dets:member(T, Key),
 2616:
 2617:    ?line OtherValues = sort(lookup_keys(T, OtherKeys)),
 2618:    if
 2619:	Extra == true -&gt;
<a name="2620"></a> 2620:	    %% Let the table grow for a while, if it needs to.
 2621:	    ?line All1 = get_all_objects(T),
 2622:	    ?line dets:safe_fixtable(T, false),
 2623:	    ?line timer:sleep(1200),
 2624:	    ?line OtherValues = sort(lookup_keys(T, OtherKeys)),
 2625:	    ?line dets:safe_fixtable(T, true),
 2626:	    ?line All2 = get_all_objects(T),
 2627:	    ?line FAll2 = get_all_objects_fast(T),
 2628:	    ?line true = sort(All2) == sort(FAll2),
 2629:            case symdiff(All1, All2) of
<a name="2630"></a> 2630:		{[],[]} -&gt;  ok;
 2631:		{X,Y} -&gt;
 2632:		    NoBad = length(X) + length(Y),
 2633:		    test_server:fail({bags,DelayedWrite,Extra,Sz,NoBad})
 2634:	    end;
 2635:	true -&gt;
 2636:	    ok
 2637:    end,
 2638:    ?line ok = dets:close(T),
 2639:    file:delete(Fname),
<a name="2640"></a> 2640:
 2641:    %% Second object of a key added and looked up simultaneously.
 2642:    R1 = {index_test,1,2,3,4},
 2643:    R2 = {index_test,2,2,13,14},
 2644:    R3 = {index_test,1,12,13,14},
 2645:    ?line {ok, _} = dets:open_file(T,[{version,Version},{type,bag},
 2646:				      {keypos,2},{file,Fname}]),
 2647:    ?line ok = dets:insert(T,R1),
 2648:    ?line ok = dets:sync(T),
 2649:    ?line ok = dets:insert(T,R2),
<a name="2650"></a> 2650:    ?line ok = dets:sync(T),
 2651:    ?line ok = dets:insert(T,R3),
 2652:    ?line [R1,R3] = sort(dets:lookup(T,1)),
 2653:    ?line true = dets:member(T, 1),
 2654:    ?line [R1,R3] = sort(dets:lookup(T,1)),
 2655:    ?line true = dets:member(T, 1),
 2656:    ?line ok = dets:close(T),
 2657:    file:delete(Fname),
 2658:
 2659:    ?line P0 == pps(),
<a name="2660"></a> 2660:    ok.
 2661:    
<a name=cache_duplicate_bags_v8> 2662:<b>cache_duplicate_bags_v8</b></a>(doc) -&gt;
 2663:    ["Test the write cache for duplicate bags."];
<a name=cache_duplicate_bags_v8> 2664:<b>cache_duplicate_bags_v8</b></a>(suite) -&gt;
 2665:    [];
<a name=cache_duplicate_bags_v8> 2666:<b>cache_duplicate_bags_v8</b></a>(Config) when list(Config) -&gt;
 2667:    cache_duplicate_bags(Config, 8).
 2668:
<a name=cache_duplicate_bags_v9> 2669:<b>cache_duplicate_bags_v9</b></a>(doc) -&gt;
<a name="2670"></a> 2670:    ["Test the write cache for duplicate bags."];
<a name=cache_duplicate_bags_v9> 2671:<b>cache_duplicate_bags_v9</b></a>(suite) -&gt;
 2672:    [];
<a name=cache_duplicate_bags_v9> 2673:<b>cache_duplicate_bags_v9</b></a>(Config) when list(Config) -&gt;
 2674:    cache_duplicate_bags(Config, 9).
 2675:
<a name=cache_duplicate_bags> 2676:<b>cache_duplicate_bags</b></a>(Config, Version) -&gt;
 2677:    Small = 2,
 2678:    cache_dup_bags(Config, {0,0}, false, Small, Version),
 2679:    cache_dup_bags(Config, {0,0}, true, Small, Version),
<a name="2680"></a> 2680:    cache_dup_bags(Config, {5000,5000}, false, Small, Version),
 2681:    cache_dup_bags(Config, {5000,5000}, true, Small, Version),
 2682:    %% Objects of size greater than 2 kB.
 2683:    Big = 1200,
 2684:    cache_dup_bags(Config, {0,0}, false, Big, Version),
 2685:    cache_dup_bags(Config, {0,0}, true, Big, Version),
 2686:    cache_dup_bags(Config, {5000,5000}, false, Big, Version),
 2687:    cache_dup_bags(Config, {5000,5000}, true, Big, Version).
 2688:
<a name=cache_dup_bags> 2689:<b>cache_dup_bags</b></a>(Config, DelayedWrite, Extra, Sz, Version) -&gt;
<a name="2690"></a> 2690:    %% Extra = bool(). Insert tuples until the tested key is not alone.
 2691:    %% Sz = integer(). Size of the inserted tuples.
 2692:
 2693:    T = cache,
 2694:    ?line Fname = filename(cache, Config),
 2695:    ?line file:delete(Fname),
 2696:    P0 = pps(),
 2697:
 2698:    ?line {ok, _} = 
 2699:	dets:open_file(T,[{version, Version}, {file,Fname}, 
<a name="2700"></a> 2700:			  {type,duplicate_bag}, 
 2701:			  {delayed_write, DelayedWrite}]),
 2702:
 2703:    Dups = 2,
 2704:    {Key, OtherKeys} = 
 2705:	if 
 2706:	    Extra == true -&gt;
 2707:		%% Insert enough to get three keys in some slot.
 2708:		?line dets:safe_fixtable(T, true),
 2709:		insert_objs(T, 1, Sz, Dups);
<a name="2710"></a> 2710:	    true -&gt;
 2711:		{1,[]}
 2712:	  end,
 2713:    Tuple = erlang:make_tuple(Sz, Key),
 2714:    ?line ok = dets:delete(T, Key),
 2715:    ?line ok = dets:sync(T),    
 2716:    ?line false = dets:member(T, Key),
 2717:
 2718:    %% The values of keys in the same slot as Key are checked.
 2719:    ?line OtherValues = sort(lookup_keys(T, OtherKeys)),
<a name="2720"></a> 2720:    
 2721:    ?line ok = dets:insert(T, Tuple),
 2722:    ?line [Tuple] = dets:lookup(T, Key),
 2723:    ?line true = dets:member(T, Key),
 2724:    ?line ok = dets:insert(T, [Tuple,Tuple]),
 2725:    %% If no delay, the cache gets filled immediately, and written.
 2726:    ?line [Tuple,Tuple,Tuple] = dets:lookup_keys(T, [Key,a,b,c,d,e,f]),
 2727:    ?line true = dets:member(T, Key),
 2728:
 2729:    %% If delay, this happens without file access.
<a name="2730"></a> 2730:    %% (This is no longer true; cache lookup has been simplified.)
 2731:    ?line ok = dets:delete(T,Key),
 2732:    ?line ok = dets:insert(T,Tuple),
 2733:    ?line ok = dets:insert(T,Tuple),
 2734:    ?line [Tuple,Tuple] = dets:lookup(T, Key),
 2735:    ?line true = dets:member(T, Key),
 2736:    ?line ok = dets:sync(T),
 2737:    ?line [Tuple,Tuple] = dets:lookup(T, Key),
 2738:    ?line true = dets:member(T, Key),
 2739:
<a name="2740"></a> 2740:    %% One object in the cache, one on the file.
 2741:    ?line ok = dets:delete(T,Key),
 2742:    ?line ok = dets:insert(T,Tuple),
 2743:    ?line ok = dets:sync(T),
 2744:    ?line ok = dets:insert(T,Tuple),
 2745:    ?line true = dets:member(T, Key), % should not read the file, but it does..
 2746:
 2747:    %% Key's objects are is on file only, 
 2748:    %% key toto in the cache (if there is one).
 2749:    ?line ok = dets:delete(T,toto),
<a name="2750"></a> 2750:    ?line ok = dets:insert(T,[{toto,b},{toto,b}]),
 2751:    ?line true = sort([Tuple,Tuple,{toto,b},{toto,b}]) == 
 2752:                 sort(dets:lookup_keys(T, [Key,toto])),
 2753:    ?line true = dets:member(T, toto),
 2754:    ?line Size = dets:info(T, size),
 2755:
 2756:    %% Two objects with the same key on the file.
 2757:    %% Delete them, add two objects.
 2758:    del_and_ins(key, T, Size, Tuple, Key, 2),
 2759:
<a name="2760"></a> 2760:    del_and_ins(object, T, Size, Tuple, Key, 2),
 2761:    del_and_ins(both, T, Size, Tuple, Key, 2),
 2762:
 2763:    %% Two objects with the same key on the file.
 2764:    %% Delete them, add three objects.
 2765:    del_and_ins(key, T, Size, Tuple, Key, 3),
 2766:    del_and_ins(object, T, Size, Tuple, Key, 3),
 2767:    del_and_ins(both, T, Size, Tuple, Key, 3),
 2768:
 2769:    %% Two objects with the same key on the file.
<a name="2770"></a> 2770:    %% Delete them, add one object.
 2771:    del_and_ins(key, T, Size, Tuple, Key, 1),
 2772:    del_and_ins(object, T, Size, Tuple, Key, 1),
 2773:    del_and_ins(both, T, Size, Tuple, Key, 1),
 2774:
 2775:    ?line OtherValues = sort(lookup_keys(T, OtherKeys)),
 2776:    if
 2777:	Extra == true -&gt;
 2778:	    %% Let the table grow for a while, if it needs to.
 2779:	    ?line All1 = get_all_objects(T),
<a name="2780"></a> 2780:	    ?line dets:safe_fixtable(T, false),
 2781:	    ?line timer:sleep(1200),
 2782:	    ?line OtherValues = sort(lookup_keys(T, OtherKeys)),
 2783:	    ?line dets:safe_fixtable(T, true),
 2784:	    ?line All2 = get_all_objects(T),
 2785:	    ?line FAll2 = get_all_objects_fast(T),
 2786:	    ?line true = sort(All2) == sort(FAll2),
 2787:            case symdiff(All1, All2) of
 2788:		{[],[]} -&gt;  ok;
 2789:		{X,Y} -&gt;
<a name="2790"></a> 2790:		    NoBad = length(X) + length(Y),
 2791:		    test_server:fail({dup_bags,DelayedWrite,Extra,Sz,NoBad})
 2792:	    end;
 2793:	true -&gt;
 2794:	    ok
 2795:    end,
 2796:    ?line ok = dets:close(T),
 2797:
 2798:    file:delete(Fname),
 2799:    ?line P0 == pps(),
<a name="2800"></a> 2800:    ok.
 2801:    
<a name=lookup_keys> 2802:<b>lookup_keys</b></a>(_T, []) -&gt;
 2803:    [];
<a name=lookup_keys> 2804:<b>lookup_keys</b></a>(T, Keys) -&gt;
 2805:    dets:lookup_keys(T, Keys).
 2806:
<a name=del_and_ins> 2807:<b>del_and_ins</b></a>(W, T, Size, Obj, Key, N) -&gt;
 2808:    case W of
 2809:	object -&gt; 
<a name="2810"></a> 2810:	    ?line ok = dets:delete_object(T, Obj);
 2811:	key -&gt;
 2812:
 2813:	    ?line ok = dets:delete(T, Key);
 2814:	both -&gt;
 2815:	    ?line ok = dets:delete(T, Key),
 2816:	    ?line ok = dets:delete_object(T, Obj)
 2817:    end,
 2818:    Objs = duplicate(N, Obj),
 2819:    ?line [] = dets:lookup(T, Key),
<a name="2820"></a> 2820:    ?line ok = dets:insert(T, Objs),
 2821:    ?line Objs = dets:lookup_keys(T, [snurrespratt,Key]),
 2822:    ?line true = Size + length(Objs)-2 == dets:info(T, size),
 2823:    ?line Objs = dets:lookup(T, Key).
 2824:
 2825:
<a name=insert_objs> 2826:<b>insert_objs</b></a>(T, N, Sz, Dups) -&gt;
 2827:    Seq = seq(N,N+255),
 2828:    L0 = map(fun(I) -&gt; erlang:make_tuple(Sz, I) end, Seq),
 2829:    L = append(duplicate(Dups, L0)),
<a name="2830"></a> 2830:    ?line ok = dets:insert(T, L),
 2831:    ?line case search_slot(T, 0) of
 2832:	      false -&gt;
 2833:		  insert_objs(T, N+256, Sz, Dups);
 2834:	      Keys -&gt;
 2835:		  Keys
 2836:	  end.
 2837:
<a name=search_slot> 2838:<b>search_slot</b></a>(T, I) -&gt;
 2839:    ?line case dets:slot(T, I) of
<a name="2840"></a> 2840:	      '$end_of_table' -&gt;
 2841:		  false;
 2842:	      Objs -&gt;
 2843:		  case usort(map(fun(X) -&gt; element(1, X) end, Objs)) of
 2844:		      [_, Key, _ | _] = Keys0 -&gt;
 2845:			  Keys = delete(Key, Keys0),
 2846:			  {Key, Keys};
 2847:		      _ -&gt;
 2848:			  search_slot(T, I+1)
 2849:		  end
<a name="2850"></a> 2850:	  end.
 2851:
<a name=symdiff> 2852:<b>symdiff</b></a>(L1, L2) -&gt;
 2853:    {X, _, Y} = 
 2854:	sofs:symmetric_partition(sofs:set(L1), sofs:set(L2)),
 2855:    {sofs:to_external(X), sofs:to_external(Y)}.
 2856:
<a name=otp_4208> 2857:<b>otp_4208</b></a>(doc) -&gt;
 2858:    ["Read only table and traversal caused crash."];
<a name=otp_4208> 2859:<b>otp_4208</b></a>(suite) -&gt;
<a name="2860"></a> 2860:    [];
<a name=otp_4208> 2861:<b>otp_4208</b></a>(Config) when list(Config) -&gt;
 2862:    Tab = otp_4208,
 2863:    ?line FName = filename(Tab, Config),
 2864:    Expected = sort([{3,ghi,12},{1,abc,10},{4,jkl,13},{2,def,11}]),
 2865:
 2866:    file:delete(FName),
 2867:    {ok, Tab} = dets:open_file(Tab, [{file,FName}]),
 2868:    ok = dets:insert(Tab, [{1,abc,10},{2,def,11},{3,ghi,12},{4,jkl,13}]),
 2869:    Expected = sort(dets:traverse(Tab, fun(X) -&gt; {continue, X} end)),
<a name="2870"></a> 2870:    ok = dets:close(Tab),
 2871:
 2872:    {ok, Tab} = dets:open_file(Tab, [{access, read},{file,FName}]),
 2873:    Expected = sort(dets:traverse(Tab, fun(X) -&gt; {continue, X} end)),
 2874:    ok = dets:close(Tab),
 2875:    file:delete(FName),
 2876:    
 2877:    ok.
 2878:
<a name=otp_4989> 2879:<b>otp_4989</b></a>(doc) -&gt;
<a name="2880"></a> 2880:    ["Read only table and growth."];
<a name=otp_4989> 2881:<b>otp_4989</b></a>(suite) -&gt;
 2882:    [];
<a name=otp_4989> 2883:<b>otp_4989</b></a>(Config) when list(Config) -&gt;
 2884:    Tab = otp_4989,
 2885:    ?line FName = filename(Tab, Config),
 2886:
 2887:    %% Do exactly as in the error report.
 2888:    ?line _Ets = ets:new(Tab, [named_table]),
 2889:    ets_init(Tab, 100000),
<a name="2890"></a> 2890:    ?line {ok, Tab} = 
 2891:        dets:open_file(Tab, [{access, read_write}, {file,FName}, {keypos,2}]),
 2892:    ?line ok = dets:from_ets(Tab, Tab),
 2893:    ?line ok = dets:close(Tab),
 2894:    %% Restore.
 2895:    ?line  {ok, Tab} = 
 2896:        dets:open_file(Tab, [{access, read}, {keypos, 2}, {file, FName}]),
 2897:    ?line true = ets:delete_all_objects(Tab),
 2898:    ?line true = ets:from_dets(Tab, Tab),
 2899:    ?line ok = dets:close(Tab),
<a name="2900"></a> 2900:    ets:delete(Tab),
 2901:    file:delete(FName),
 2902:    ok.
 2903:
<a name=ets_init> 2904:<b>ets_init</b></a>(_Tab, 0) -&gt;
 2905:    ok;
<a name=ets_init> 2906:<b>ets_init</b></a>(Tab, N) -&gt;
 2907:    ets:insert(Tab, {N,N}),
 2908:    ets_init(Tab, N - 1).
 2909:
<a name=many_clients><a name="2910"></a> 2910:<b>many_clients</b></a>(doc) -&gt;
 2911:    ["Several clients accessing a table simultaneously."];
<a name=many_clients> 2912:<b>many_clients</b></a>(suite) -&gt;
 2913:    [];
<a name=many_clients> 2914:<b>many_clients</b></a>(Config) when list(Config) -&gt;
 2915:    Tab = many_clients,
 2916:    ?line FName = filename(Tab, Config),
 2917:
 2918:    Server = self(),
 2919:
<a name="2920"></a> 2920:    P0 = pps(),
 2921:    ?line {ok, _} = dets:open_file(Tab,[{file, FName},{version,9}]),
 2922:    ?line [P1,P2,P3,P4] = new_clients(4, Tab),
 2923:
 2924:    %% dets:init_table/2 is used for making sure that all processes
 2925:    %% start sending requests before the Dets process begins to handle
 2926:    %% them; the requests arrive "in parallel".
 2927:
 2928:    %% Four processes accessing the same table at almost the same time.
 2929:
<a name="2930"></a> 2930:    %% One key is read, updated, and read again.
 2931:    Seq1 = [{P1,[{lookup,1,[{1,a}]}]}, {P2,[{insert,{1,b}}]},
 2932:	    {P3,[{lookup,1,[{1,b}]}]}, {P4,[{lookup,1,[{1,b}]}]}],
 2933:    ?line atomic_requests(Server, Tab, [[{1,a}]], Seq1),
 2934:    ?line true = get_replies([{P1,ok}, {P2,ok}, {P3,ok}, {P4,ok}]),
 2935:
 2936:    %% Different keys read by different processes
 2937:    Seq2 = [{P1,[{member,1,true}]}, {P2,[{lookup,2,[{2,b}]}]},
 2938:	    {P3,[{lookup,1,[{1,a}]}]}, {P4,[{lookup,3,[{3,c}]}]}],
 2939:    ?line atomic_requests(Server, Tab, [[{1,a},{2,b},{3,c}]], Seq2),
<a name="2940"></a> 2940:    ?line true = get_replies([{P1,ok}, {P2,ok}, {P3,ok}, {P4,ok}]),
 2941:
 2942:    %% Reading deleted key.
 2943:    Seq3 = [{P1,[{delete_key,2}]}, {P2,[{lookup,1,[{1,a}]}]},
 2944:	    {P3,[{lookup,1,[{1,a}]}]}, {P4,[{member,2,false}]}],
 2945:    ?line atomic_requests(Server, Tab, [[{1,a},{2,b},{3,c}]], Seq3),
 2946:    ?line true = get_replies([{P1,ok}, {P2,ok}, {P3,ok}, {P4,ok}]),
 2947:
 2948:    %% Inserting objects.
 2949:    Seq4 = [{P1,[{insert,[{1,a},{2,b}]}]}, {P2,[{insert,[{2,c},{3,a}]}]},
<a name="2950"></a> 2950:	    {P3,[{insert,[{3,b},{4,d}]}]},
 2951:	    {P4,[{lookup_keys,[1,2,3,4],[{1,a},{2,c},{3,b},{4,d}]}]}],
 2952:    ?line atomic_requests(Server, Tab, [], Seq4),
 2953:    ?line true = get_replies([{P1,ok}, {P2,ok}, {P3,ok}, {P4,ok}]),
 2954:
 2955:    %% Deleting objects.
 2956:    Seq5 = [{P1,[{delete_object,{1,a}}]}, {P2,[{delete_object,{1,a}}]},
 2957:	    {P3,[{delete_object,{3,c}}]},
 2958:	    {P4,[{lookup_keys,[1,2,3,4],[{2,b}]}]}],
 2959:    ?line atomic_requests(Server, Tab, [[{1,a},{2,b},{3,c}]], Seq5),
<a name="2960"></a> 2960:    ?line true = get_replies([{P1,ok}, {P2,ok}, {P3,ok}, {P4,ok}]),
 2961:
 2962:    %% Some request not streamed.
 2963:    Seq6 = [{P1,[{lookup,1,[{1,a}]}]}, {P2,[{info,size,3}]},
 2964:	    {P3,[{lookup,1,[{1,a}]}]}, {P4,[{info,size,3}]}],
 2965:    ?line atomic_requests(Server, Tab, [[{1,a},{2,b},{3,c}]], Seq6),
 2966:    ?line true = get_replies([{P1,ok}, {P2,ok}, {P3,ok}, {P4,ok}]),
 2967:
 2968:    %% Some request not streamed.
 2969:    Seq7 = [{P1,[{insert,[{3,a}]}]}, {P2,[{insert,[{3,b}]}]},
<a name="2970"></a> 2970:	    {P3,[{delete_object,{3,c}}]},
 2971:	    {P4,[{lookup,3,[{3,b}]}]}],
 2972:    ?line atomic_requests(Server, Tab, [[{3,c}]], Seq7),
 2973:    ?line true = get_replies([{P1,ok}, {P2,ok}, {P3,ok}, {P4,ok}]),
 2974:
 2975:    ?line put_requests(Server, [{P1,stop},{P2,stop},{P3,stop},{P4,stop}]),
 2976:    ?line ok = dets:close(Tab),
 2977:    ?line file:delete(FName),
 2978:
 2979:    %% Check that errors are handled correctly by the streaming operators.
<a name="2980"></a> 2980:    ?line {ok, _} = dets:open_file(Tab,[{file, FName},{version,9}]),
 2981:    ?line ok = ins(Tab, 100),
 2982:    Obj = {66,{item,number,66}},
 2983:    ?line {ok, ObjPos} = dets:where(Tab, Obj),
 2984:    ?line ok = dets:close(Tab),
 2985:    %% Damaged object.
 2986:    crash(FName, ObjPos+12),
 2987:    ?line {ok, _} = dets:open_file(Tab,[{file, FName},{version,9}]),
 2988:    ?line {error, {bad_object,FName}} = 
 2989:	dets:lookup_keys(Tab, [65,66,67,68,69]),
<a name="2990"></a> 2990:    ?line _Error = dets:close(Tab),
 2991:    ?line file:delete(FName),
 2992:
 2993:    ?line P0 == pps(),
 2994:
 2995:    ok.
 2996:
 2997:<i>%% Tab is initiated with the objects in Objs. Objs = [[object()]].</i>
<a name=atomic_requests> 2998:<b>atomic_requests</b></a>(Server, Tab, Objs, Req) -&gt;
 2999:    ok = dets:init_table(Tab, atomic_requests(Server, Objs, Req)).
<a name="3000"></a> 3000:
<a name=atomic_requests> 3001:<b>atomic_requests</b></a>(Server, L, Req) -&gt;
 3002:    fun(close) -&gt;
 3003:	    ok;
 3004:       (read) when [] == L -&gt;
 3005:	    put_requests(Server, Req),
 3006:	    end_of_input;
 3007:       (read) -&gt;
 3008:	    [E | Es] = L,
 3009:	    {E, atomic_requests(Server, Es, Req)}
<a name="3010"></a> 3010:    end.
 3011:
<a name=put_requests> 3012:<b>put_requests</b></a>(Server, L) -&gt;
 3013:    lists:foreach(fun({Pid,R}) -&gt; Pid ! {Server,R}, timer:sleep(1) end, L).
 3014:
<a name=get_replies> 3015:<b>get_replies</b></a>(L) -&gt;
 3016:    lists:all(fun({Pid,Reply}) -&gt; Reply == get_reply(Pid) end, L).
 3017:
<a name=get_reply> 3018:<b>get_reply</b></a>(Pid) -&gt;
 3019:    ?line receive {Pid, Reply} -&gt; Reply end.
<a name="3020"></a> 3020:
<a name=new_clients> 3021:<b>new_clients</b></a>(0, _Tab) -&gt;
 3022:    [];
<a name=new_clients> 3023:<b>new_clients</b></a>(N, Tab) -&gt;
 3024:    [new_client(Tab) | new_clients(N-1, Tab)].
 3025:
<a name=new_client> 3026:<b>new_client</b></a>(Tab) -&gt;
 3027:    spawn(?MODULE, client, [self(), Tab]).
 3028:
<a name=client> 3029:<b>client</b></a>(S, Tab) -&gt;
<a name="3030"></a> 3030:    receive 
 3031:	{S, stop} -&gt;
 3032:	    exit(normal);
 3033:	{S, ToDo} -&gt;
 3034:	    ?line Reply = eval(ToDo, Tab),
 3035:	    case Reply of
 3036:		{error, _} -&gt; io:format("~p: ~p~n", [self(), Reply]);
 3037:		_ -&gt; ok
 3038:	    end,
 3039:	    S ! {self(), Reply}
<a name="3040"></a> 3040:    end,
 3041:    client(S, Tab).
 3042:
<a name=eval> 3043:<b>eval</b></a>([], _Tab) -&gt;
 3044:    ok;
<a name=eval> 3045:<b>eval</b></a>([sync | L], Tab) -&gt;
 3046:    ?line case dets:sync(Tab) of
 3047:	      ok -&gt; eval(L, Tab);
 3048:	      Error -&gt; {error, {sync,Error}}
 3049:	  end;
<a name=eval><a name="3050"></a> 3050:<b>eval</b></a>([{insert,Stuff} | L], Tab) -&gt;
 3051:    ?line case dets:insert(Tab, Stuff) of
 3052:	      ok -&gt; eval(L, Tab);
 3053:	      Error -&gt; {error, {insert,Stuff,Error}}
 3054:	  end;
<a name=eval> 3055:<b>eval</b></a>([{lookup,Key,Expected} | L], Tab) -&gt;
 3056:    ?line case dets:lookup(Tab, Key) of
 3057:	      Expected -&gt; eval(L, Tab);
 3058:	      Else -&gt; {error, {lookup,Key,Expected,Else}}
 3059:	  end;
<a name=eval><a name="3060"></a> 3060:<b>eval</b></a>([{lookup_keys,Keys,Expected} | L], Tab) -&gt;
 3061:    %% Time order is destroyed...
 3062:    ?line case dets:lookup_keys(Tab, Keys) of
 3063:	      R when list(R) -&gt; 
 3064:		  case lists:sort(Expected) == lists:sort(R) of
 3065:		      true -&gt; eval(L, Tab);
 3066:		      false -&gt; {error, {lookup_keys,Keys,Expected,R}}
 3067:		  end;
 3068:	      Else -&gt; {error, {lookup_keys,Keys,Expected,Else}}
 3069:	  end;
<a name=eval><a name="3070"></a> 3070:<b>eval</b></a>([{member,Key,Expected} | L], Tab) -&gt;
 3071:    ?line case dets:member(Tab, Key) of
 3072:	      Expected -&gt; eval(L, Tab);
 3073:	      Else -&gt; {error, {member,Key,Expected,Else}}
 3074:	  end;
<a name=eval> 3075:<b>eval</b></a>([{delete_key,Key} | L], Tab) -&gt;
 3076:    ?line case dets:delete(Tab, Key) of
 3077:	      ok -&gt; eval(L, Tab);
 3078:	      Else -&gt; {error, {delete_key,Key,Else}}
 3079:	  end;
<a name=eval><a name="3080"></a> 3080:<b>eval</b></a>([{delete_object,Object} | L], Tab) -&gt;
 3081:    ?line case dets:delete_object(Tab, Object) of
 3082:	      ok -&gt; eval(L, Tab);
 3083:	      Else -&gt; {error, {delete_object,Object,Else}}
 3084:	  end;
<a name=eval> 3085:<b>eval</b></a>([{info,Tag,Expected} | L], Tab) -&gt;
 3086:    ?line case dets:info(Tab, Tag) of
 3087:	      Expected -&gt; eval(L, Tab);
 3088:	      Else -&gt; {error, {info,Tag,Else,Expected}}
 3089:	  end;
<a name=eval><a name="3090"></a> 3090:<b>eval</b></a>(Else, _Tab) -&gt;
 3091:    {error, {bad_request,Else}}.
 3092:
<a name=otp_4906> 3093:<b>otp_4906</b></a>(doc) -&gt;
 3094:    ["More than 128k keys caused crash."];
<a name=otp_4906> 3095:<b>otp_4906</b></a>(suite) -&gt;
 3096:    [];
<a name=otp_4906> 3097:<b>otp_4906</b></a>(Config) when list(Config) -&gt;
 3098:    N = 256*512 + 400,
 3099:    Tab = otp_4906,
<a name="3100"></a> 3100:    ?line FName = filename(Tab, Config),
 3101:    
 3102:    file:delete(FName),
 3103:    ?line {ok, Tab} = dets:open_file(Tab, [{file, FName}]),
 3104:    ?line ok = ins_small(Tab, 0, N),
 3105:    ?line ok = dets:close(Tab),
 3106:    ?line {ok, Tab} = dets:open_file(Tab, [{file, FName}]),
 3107:    ?line ok = read_4906(Tab, N-1),
 3108:    ?line ok = dets:close(Tab),
 3109:    file:delete(FName),
<a name="3110"></a> 3110:
 3111:    %% If the (only) process fixing a table updates the table, the
 3112:    %% process will no longer be punished with a 1 ms delay (hm, the
 3113:    %% server is delayed, it should be the client...). In this example
 3114:    %% the writing process *is* delayed.
 3115:    ?line {ok,Tab} = dets:open_file(Tab, [{file,FName}]),
 3116:    Parent = self(),
 3117:    FixPid = spawn_link(fun() -&gt; 
 3118:                                Reply = dets:safe_fixtable(Tab, true),
 3119:                                receive {Parent, stop} -&gt; ok end
<a name="3120"></a> 3120:                        end),
 3121:    ?line ok = ins_small(Tab, 0, 1000),
 3122:    FixPid ! {Parent, stop},
 3123:    timer:sleep(1),
 3124:    ?line ok = dets:close(Tab),
 3125:    file:delete(FName),
 3126:    ok.
 3127:
<a name=read_4906> 3128:<b>read_4906</b></a>(_T, N) when N &lt; 0 -&gt;
 3129:    ok;
<a name=read_4906><a name="3130"></a> 3130:<b>read_4906</b></a>(T, N) -&gt;
 3131:    ?line [_] = dets:lookup(T, N),
 3132:    read_4906(T, N-1).
 3133:
<a name=ins_small> 3134:<b>ins_small</b></a>(_T, I, N) when I =:= N -&gt;
 3135:    ok;
<a name=ins_small> 3136:<b>ins_small</b></a>(T, I, N) -&gt;
 3137:    ?line ok = dets:insert(T, {I}),
 3138:    ins_small(T, I+1, N).
 3139:
<a name="3140"></a> 3140:<i>%%</i>
 3141:<i>%% Parts common to several test cases</i>
 3142:<i>%% </i>
 3143:
<a name=crash> 3144:<b>crash</b></a>(File, Where) -&gt;
 3145:    crash(File, Where, [10]).
 3146:
<a name=crash> 3147:<b>crash</b></a>(File, Where, What) -&gt;
 3148:    ?line {ok, Fd} = file:open(File, read_write),
 3149:    ?line file:position(Fd, Where),
<a name="3150"></a> 3150:    ?line ok = file:write(Fd, What),
 3151:    ?line ok = file:close(Fd).
 3152:
<a name=args> 3153:<b>args</b></a>(Config) -&gt;
 3154:    {Sets, Bags, Dups} = 
 3155:	{[
 3156:	  [], 
 3157:	  [{type, set}, {estimated_no_objects, 300},  
 3158:	   {ram_file, true}],
 3159:	  [{type, set}, {estimated_no_objects, 300}],
<a name="3160"></a> 3160:	  [{type, set}, {estimated_no_objects, 300}],
 3161:	  [{auto_save,20}, {type, set}, 
 3162:	   {estimated_no_objects, 300}] 
 3163:	 ],
 3164:
 3165:	 [
 3166:	  [{type, bag}, {estimated_no_objects, 300}, {ram_file, true}],
 3167:	  [{type, bag}],
 3168:	  [{type, bag}, {estimated_no_objects, 300}],
 3169:	  [{type, bag}, {estimated_no_objects, 300}],
<a name="3170"></a> 3170:	  [{type, bag}, 
 3171:	   {auto_save,20}, {estimated_no_objects, 300}],
 3172:	  [{type, bag}, {estimated_no_objects, 300},   {ram_file, true}]
 3173:	 ],
 3174:
 3175:	 [
 3176:	  [{type, duplicate_bag}, {estimated_no_objects, 300}, 
 3177:	   {ram_file, true}],
 3178:	  [{type, duplicate_bag}],
 3179:	  [{type, duplicate_bag}, {estimated_no_objects, 300}],
<a name="3180"></a> 3180:	  [{type, duplicate_bag}, {estimated_no_objects, 300}],
 3181:	  [{type, duplicate_bag},
 3182:	   {auto_save,20}, {estimated_no_objects, 300}],
 3183:	  [{type, duplicate_bag}, {estimated_no_objects, 300},   
 3184:	   {ram_file, true}]
 3185:	 ]
 3186:	},
 3187:    zip_filename(Sets, Bags, Dups, Config).
 3188:
<a name=zip_filename> 3189:<b>zip_filename</b></a>(S, B, D, Conf) -&gt;
<a name="3190"></a> 3190:    zip_filename(S, B, D, [], [], [], 1, Conf).
 3191:
<a name=zip_filename> 3192:<b>zip_filename</b></a>([H|T], B, D, S1, B1, D1, I, Conf) -&gt;
 3193:    zip_filename(T, B, D, [[{file, new_filename(I, Conf)} | H] | S1],
 3194:		 B1, D1, I+1, Conf);
<a name=zip_filename> 3195:<b>zip_filename</b></a>([], [H|B], D, S1, B1, D1, I, Conf) -&gt;
 3196:    zip_filename([], B, D, S1, [[{file, new_filename(I, Conf)} | H] | B1],
 3197:		 D1, I+1, Conf);
<a name=zip_filename> 3198:<b>zip_filename</b></a>([], [], [H|T], S1, B1, D1, I, Conf) -&gt;
 3199:    zip_filename([], [], T, S1, B1, [[{file, new_filename(I, Conf)} | H] | D1],
<a name="3200"></a> 3200:		 I+1, Conf);
<a name=zip_filename> 3201:<b>zip_filename</b></a>([], [], [], S1, B1, D1, _, _Conf) -&gt;
 3202:    {reverse(S1), reverse(B1), reverse(D1)}.
 3203:
<a name=del_test> 3204:<b>del_test</b></a>(Tab) -&gt;
 3205:    ?format("Deltest on ~p~n", [Tab]),
 3206:    ?line Objs = get_all_objects(Tab),
 3207:    ?line Keys = map(fun(X) -&gt; element(1, X) end, Objs),
 3208:    ?line foreach(fun(Key) -&gt; dets:delete(Tab, Key) end, Keys),
 3209:    ?line 0 = length(get_all_objects(Tab)),
<a name="3210"></a> 3210:    ?line [] = get_all_objects_fast(Tab),
 3211:    ?line 0 = dets:info(Tab, size).
 3212:
<a name=del_obj_test> 3213:<b>del_obj_test</b></a>(Tab) -&gt;
 3214:    ?format("Delobjtest on ~p~n", [Tab]),
 3215:    ?line Objs = get_all_objects(Tab),
 3216:    ?line LL = length(Objs),
 3217:    ?line LL = dets:info(Tab, size),
 3218:    ?line foreach(fun(Obj) -&gt; dets:delete_object(Tab, Obj) end, Objs),
 3219:    ?line 0 = length(get_all_objects(Tab)),
<a name="3220"></a> 3220:    ?line [] = get_all_objects_fast(Tab),
 3221:    ?line 0 = dets:info(Tab, size).
 3222:
<a name=match_del_test> 3223:<b>match_del_test</b></a>(Tab) -&gt;
 3224:    ?line ?format("Match delete test on ~p~n", [Tab]),
 3225:    ?line ok = dets:match_delete(Tab, {'_','_','_'}),
 3226:    ?line Sz = dets:info(Tab, size),
 3227:    ?line true = Sz == length(dets:match_object(Tab, '_')),
 3228:    ?line ok = dets:match_delete(Tab, '_'),
 3229:    ?line 0 = dets:info(Tab, size),
<a name="3230"></a> 3230:    ?line 0 = length(get_all_objects(Tab)),
 3231:    ?line [] = get_all_objects_fast(Tab).
 3232:
<a name=trav_test> 3233:<b>trav_test</b></a>(_Data, Len, Tab) -&gt;
 3234:    ?format("Travtest on ~p~n", [Tab]),
 3235:    ?line _X0 = dets:traverse(Tab, fun(_X) -&gt; continue end),
 3236:    ?line XX = dets:traverse(Tab, fun(X) -&gt; {continue, X} end),
 3237:    ?line case Len == length(XX) of
 3238:	      false -&gt; ?format("DIFF ~p~n", [XX -- _Data]);
 3239:	      true -&gt; ok
<a name="3240"></a> 3240:	  end,
 3241:    ?line 1 = length(dets:traverse(Tab, fun(X) -&gt; {done, X} end)).
 3242:
<a name=match_test> 3243:<b>match_test</b></a>(Data, Tab) -&gt;
 3244:    ?line ?format("Match test on ~p~n", [Tab]),
 3245:    ?line Data1 = sort(filter(fun(X) when size(X) == 3 -&gt; true;
 3246:				 (_X) -&gt; false
 3247:			      end, Data)),
 3248:    ?line Data1 = sort(dets:match_object(Tab, {'$1', '$2', '$3'})),
 3249:
<a name="3250"></a> 3250:    ?line Len = length(Data),
 3251:    ?line Len = length(dets:match(Tab, '_')),
 3252:    ?line Len2 = length(Data1),
 3253:    ?line Len2 = length(dets:match(Tab, {'$1', '_', '_'})),
 3254:    
 3255:    ?line Data3 = 
 3256:	filter(fun(X) -&gt;
 3257:		       K = element(1, X),
 3258:		       if
 3259:			   tuple(K), size(X) == 3, size(K) == 2 -&gt; true;
<a name="3260"></a> 3260:			   true -&gt; false
 3261:		       end
 3262:	       end, Data),
 3263:    ?line Len3 = length(Data3),
 3264:    ?line Len3 = length(dets:match(Tab, {{'$1', '$2'}, '_', '_'})),
 3265:    ?line Len3 = length(dets:match_object(Tab, {{'$1', '$2'}, '_', '_'})),
 3266:    
 3267:    ?line R = make_ref(),
 3268:    ?line dets:insert(Tab, {{R, R}, 33 ,44}),
 3269:    ?line 1 = length(dets:match(Tab, {{R, R}, '_', '_'})),
<a name="3270"></a> 3270:    ?line 1 = length(dets:match_object(Tab, {{R, R}, '_', '_'})).
 3271:
 3272:<i>%%</i>
 3273:<i>%% Utilities</i>
 3274:<i>%%</i>
 3275:
<a name=headsz> 3276:<b>headsz</b></a>(8) -&gt;
 3277:    ?HEADSZ_v8;
<a name=headsz> 3278:<b>headsz</b></a>(_) -&gt;
 3279:    ?HEADSZ_v9.
<a name="3280"></a> 3280:
<a name=unwritable> 3281:<b>unwritable</b></a>(Fname) -&gt;
 3282:    ?line {ok, Info} = file:read_file_info(Fname),
 3283:    Mode = Info#file_info.mode - 8#00200,
 3284:    ?line file:write_file_info(Fname, Info#file_info{mode = Mode}).
 3285:
<a name=writable> 3286:<b>writable</b></a>(Fname) -&gt;
 3287:    ?line {ok, Info} = file:read_file_info(Fname),
 3288:    Mode = Info#file_info.mode bor 8#00200,
 3289:    ?line file:write_file_info(Fname, Info#file_info{mode = Mode}).
<a name="3290"></a> 3290:
<a name=truncate> 3291:<b>truncate</b></a>(File, Where) -&gt;
 3292:    ?line {ok, Fd} = file:open(File, read_write),
 3293:    ?line file:position(Fd, Where),
 3294:    ?line ok = file:truncate(Fd),
 3295:    ?line ok = file:close(Fd).
 3296:
<a name=new_filename> 3297:<b>new_filename</b></a>(Name, Config) when integer(Name) -&gt;
 3298:    filename:join(?privdir(Config),
 3299:		  integer_to_list(Name) ++ ".DETS").
<a name="3300"></a> 3300:
<a name=filename> 3301:<b>filename</b></a>(Name, Config) when atom(Name) -&gt;
 3302:    filename(atom_to_list(Name), Config);
<a name=filename> 3303:<b>filename</b></a>(Name, Config) -&gt;
 3304:    filename:join(?privdir(Config), Name).
 3305:
<a name=open_files> 3306:<b>open_files</b></a>(_Name, [], _Version) -&gt;
 3307:    [];
<a name=open_files> 3308:<b>open_files</b></a>(Name0, [Args | Tail], Version) -&gt;
 3309:    ?format("init ~p~n", [Args]),
<a name="3310"></a> 3310:    ?line Name = list_to_atom(integer_to_list(Name0)),
 3311:    ?line {ok, Name} = dets:open_file(Name, [{version,Version} | Args]),
 3312:    [Name | open_files(Name0+1, Tail, Version)].
 3313:    
<a name=close_all> 3314:<b>close_all</b></a>(Tabs) -&gt; foreach(fun(Tab) -&gt; dets:close(Tab) end, Tabs).
 3315:
<a name=delete_files> 3316:<b>delete_files</b></a>(Args) -&gt;   
 3317:    Fun = fun(F) -&gt;
 3318:		  {value, {file, File}} = keysearch(file, 1, F),
 3319:		  file:delete(File),
<a name="3320"></a> 3320:		  File
 3321:	  end,
 3322:    map(Fun, Args).
 3323:
 3324:<i>%% Initialize all tables</i>
<a name=initialize> 3325:<b>initialize</b></a>(Tabs, Data) -&gt;
 3326:    ?line foreach(fun(Tab) -&gt;
 3327:			  Fun = fun(Obj) -&gt; ok =  dets:insert(Tab, Obj) end,
 3328:			  foreach(Fun, Data),
 3329:			  dets:sync(Tab)
<a name="3330"></a> 3330:		  end, Tabs).
 3331:
 3332:<i>%% need more than 512 objects to really trig overflow</i>
<a name=make_data> 3333:<b>make_data</b></a>(Kp) -&gt;
 3334:    make_data(Kp, set).
 3335:
<a name=make_data> 3336:<b>make_data</b></a>(Kp, Type) -&gt;
 3337:    dup(Type, make_data(Kp, Type, 520)).
 3338:
<a name=dup> 3339:<b>dup</b></a>(duplicate_bag, [H1, H2 |T]) -&gt;
<a name="3340"></a> 3340:    [H1,H2, H1, H2 | dup(duplicate_bag, T)];
<a name=dup> 3341:<b>dup</b></a>(_, Other) -&gt;
 3342:    Other.
 3343:    
<a name=make_data> 3344:<b>make_data</b></a>(_Kp, Type, 0) -&gt; 
 3345:    odd_keys(Type);
<a name=make_data> 3346:<b>make_data</b></a>(1, set, I) -&gt;
 3347:    [{I, q,w} | make_data(1, set, I-1)];
<a name=make_data> 3348:<b>make_data</b></a>(2, set, I) -&gt;
 3349:    [{hh, I, q,w} | make_data(2, set, I-1)];
<a name=make_data><a name="3350"></a> 3350:<b>make_data</b></a>(1, bag, I) -&gt;
 3351:    [{I, q,w} , {I, hah, 77} | make_data(1, bag, I-1)];
<a name=make_data> 3352:<b>make_data</b></a>(2, bag, I) -&gt;
 3353:    [{hh, I, q,w} , {hh, I, lalal, 900} | make_data(2, bag, I-1)];
<a name=make_data> 3354:<b>make_data</b></a>(1, duplicate_bag, I) -&gt;
 3355:    [{I, q,w} , {I, hah, 77} | make_data(1, duplicate_bag, I-1)];
<a name=make_data> 3356:<b>make_data</b></a>(2, duplicate_bag, I) -&gt;
 3357:    [{hh, I, q,w} , {hh, I, lalal, 900} | make_data(2, duplicate_bag, I-1)].
 3358:
<a name=odd_keys> 3359:<b>odd_keys</b></a>(_) -&gt;
<a name="3360"></a> 3360:    [{foo, 1 ,2},
 3361:     {{foo, foo}, 2,3},
 3362:     {"kakaka", {{{}}}, jj},
 3363:     {{"kallll", "kkk", []}, 66.7777},
 3364:     {make_ref(), 99, 66},
 3365:     {{1},2,3,4,5,6,7,duplicate(50, 8)},
 3366:     {self(), 7,8,88},
 3367:     {[self()], 8, 11}].
 3368:
 3369:
<a name=ins><a name="3370"></a> 3370:<b>ins</b></a>(_T, 0) -&gt;
 3371:    ok;
<a name=ins> 3372:<b>ins</b></a>(T, N) -&gt;
 3373:    case dets:insert(T, {N, item(N)}) of
 3374:	ok -&gt; ins(T, N-1);
 3375:	Error -&gt; Error
 3376:    end.
 3377:
<a name=item> 3378:<b>item</b></a>(N) when N rem 2 =:= 0 -&gt;
 3379:    {item, number, N};
<a name=item><a name="3380"></a> 3380:<b>item</b></a>(N) -&gt;
 3381:    {item, number, N, a, much, bigger, one, i, think}.
 3382:
<a name=del> 3383:<b>del</b></a>(_T, N, _I) when N =&lt; 0 -&gt;
 3384:    ok;
<a name=del> 3385:<b>del</b></a>(T, N, I) -&gt;
 3386:    ok = dets:delete(T, N),
 3387:    del(T, N-I, I).
 3388:
<a name=ensure_node> 3389:<b>ensure_node</b></a>(0, _Node) -&gt;
<a name="3390"></a> 3390:    could_not_start_node;
<a name=ensure_node> 3391:<b>ensure_node</b></a>(N, Node) -&gt;
 3392:    case net_adm:ping(Node) of
 3393:	pang -&gt;
 3394:	    receive after 1000 -&gt;
 3395:			     ok
 3396:		    end,
 3397:	    ensure_node(N-1,Node);
 3398:	pong -&gt;
 3399:	    ok
<a name="3400"></a> 3400:    end.
 3401:
<a name=size_test> 3402:<b>size_test</b></a>(Len, Tabs) -&gt;
 3403:    ?line foreach(fun(Tab) -&gt;
 3404:			  Len = dets:info(Tab, size)
 3405:		  end, Tabs).
 3406:
<a name=no_keys_test> 3407:<b>no_keys_test</b></a>([T | Ts]) -&gt;
 3408:    no_keys_test(T),
 3409:    no_keys_test(Ts);
<a name=no_keys_test><a name="3410"></a> 3410:<b>no_keys_test</b></a>([]) -&gt;
 3411:    ok;
<a name=no_keys_test> 3412:<b>no_keys_test</b></a>(T) -&gt;
 3413:    case dets:info(T, version) of
 3414:	8 -&gt;
 3415:	    ok;
 3416:	9 -&gt;
 3417:	    Kp = dets:info(T, keypos),
 3418:	    ?line All = dets:match_object(T, '_'),
 3419:	    ?line L = lists:map(fun(X) -&gt; element(Kp, X) end, All),
<a name="3420"></a> 3420:	    ?line NoKeys = length(lists:usort(L)),
 3421:	    ?line case {dets:info(T, no_keys), NoKeys} of
 3422:		      {N, N} -&gt;
 3423:			  ok;
 3424:		      {N1, N2} -&gt;
 3425:			  exit({no_keys_test, N1, N2})
 3426:		  end
 3427:    end.
 3428:
 3429:<i>%% Caution: unless the table has been fixed, strange results can be returned.</i>
<a name=get_all_objects><a name="3430"></a> 3430:<b>get_all_objects</b></a>(Tab) -&gt; get_all_objects(dets:first(Tab), Tab, []).
 3431:
 3432:<i>%% Assuming no key matches {error, Reason}...</i>
<a name=get_all_objects> 3433:<b>get_all_objects</b></a>('$end_of_table', _Tab, L) -&gt; L;
<a name=get_all_objects> 3434:<b>get_all_objects</b></a>({error, Reason}, _Tab, _L) -&gt;
 3435:    exit({get_all_objects, get(line), {error, Reason}});
<a name=get_all_objects> 3436:<b>get_all_objects</b></a>(Key, Tab, L) -&gt; 
 3437:    Objs = dets:lookup(Tab, Key),
 3438:    ?line get_all_objects(dets:next(Tab, Key), Tab, Objs ++ L).
 3439:
<a name=count_objects_quite_fast><a name="3440"></a> 3440:<b>count_objects_quite_fast</b></a>(Tab) -&gt;
 3441:    ?line R1 = dets:match_object(Tab, '_', 1),
 3442:    count_objs_1(R1, 0).
 3443:
<a name=count_objs_1> 3444:<b>count_objs_1</b></a>('$end_of_table', N) -&gt;
 3445:    N;
<a name=count_objs_1> 3446:<b>count_objs_1</b></a>({Ts,C}, N) when list(Ts) -&gt;
 3447:    count_objs_1(dets:match_object(C), length(Ts) + N).
 3448:
<a name=get_all_objects_fast> 3449:<b>get_all_objects_fast</b></a>(Tab) -&gt;
<a name="3450"></a> 3450:    dets:match_object(Tab, '_').
 3451:
 3452:<i>%% Relevant for version 8.</i>
<a name=histogram> 3453:<b>histogram</b></a>(Tab) -&gt;
 3454:    OnePercent = case dets:info(Tab, no_slots) of
 3455:	undefined -&gt; undefined;
 3456:	{_, NoSlots, _} -&gt; NoSlots/100
 3457:    end,
 3458:    histogram(Tab, OnePercent).
 3459:
<a name=histogram><a name="3460"></a> 3460:<b>histogram</b></a>(Tab, OnePercent) -&gt;
 3461:    ?line E = ets:new(histo, []),
 3462:    ?line dets:safe_fixtable(Tab, true),
 3463:    ?line Hist = histo(Tab, E, 0, OnePercent, OnePercent),
 3464:    ?line dets:safe_fixtable(Tab, false),
 3465:    ?line case Hist of
 3466:	      ok -&gt;
 3467:		  ?line H = ets:tab2list(E),
 3468:		  ?line true = ets:delete(E),
 3469:		  sort(H);
<a name="3470"></a> 3470:	      Error -&gt;
 3471:		  ets:delete(E),
 3472:		  Error
 3473:	  end.
 3474:
<a name=histo> 3475:<b>histo</b></a>(T, E, I, One, Count) when number(Count), I &gt; Count -&gt;
 3476:    io:format("."),
 3477:    histo(T, E, I, One, Count+One);
<a name=histo> 3478:<b>histo</b></a>(T, E, I, One, Count) -&gt;
 3479:    ?line case dets:slot(T, I) of
<a name="3480"></a> 3480:	      '$end_of_table' when number(Count) -&gt;
 3481:		  io:format("~n"),
 3482:		  ok;
 3483:	      '$end_of_table' -&gt;
 3484:		  ok;
 3485:	       Objs when list(Objs) -&gt;
 3486:		  L = length(Objs),
 3487:		  case catch ets:update_counter(E, L, 1) of
 3488:		      {'EXIT', _} -&gt;
 3489:			  ets:insert(E, {L, 1});
<a name="3490"></a> 3490:		      _ -&gt;
 3491:			  ok
 3492:		  end,
 3493:		  histo(T, E, I+1, One, Count);
 3494:	      Error -&gt;
 3495:		  Error
 3496:	  end.
 3497:
<a name=sum_histogram> 3498:<b>sum_histogram</b></a>(H) -&gt;
 3499:    sum_histogram(H, 0).
<a name="3500"></a> 3500:
<a name=sum_histogram> 3501:<b>sum_histogram</b></a>([{S,N1} | H], N) -&gt;
 3502:    sum_histogram(H, N + S*N1);
<a name=sum_histogram> 3503:<b>sum_histogram</b></a>([], N) -&gt;
 3504:    N.
 3505:
<a name=ave_histogram> 3506:<b>ave_histogram</b></a>(H) -&gt;
 3507:    ave_histogram(H, 0)/sum_histogram(H).
 3508:
<a name=ave_histogram> 3509:<b>ave_histogram</b></a>([{S,N1} | H], N) -&gt;
<a name="3510"></a> 3510:    ave_histogram(H, N + S*S*N1);
<a name=ave_histogram> 3511:<b>ave_histogram</b></a>([], N) -&gt;
 3512:    N.
 3513:
<a name=pps> 3514:<b>pps</b></a>() -&gt;
 3515:    {erlang:ports(), 
 3516:     filter(fun(P) -&gt; erlang:is_process_alive(P) end, processes())}.
</pre>
<hr size=1><i>The transformation of this file (3517 lines) took 0.16 seconds</i><br>
</body>
</html>
