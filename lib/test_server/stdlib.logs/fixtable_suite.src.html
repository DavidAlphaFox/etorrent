<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head><title>/usr/home/jlouis/hacking/test_server/stdlib_test/fixtable_SUITE.erl</title></head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
    1:<i>%% ``The contents of this file are subject to the Erlang Public License,</i>
    2:<i>%% Version 1.1, (the "License"); you may not use this file except in</i>
    3:<i>%% compliance with the License. You should have received a copy of the</i>
    4:<i>%% Erlang Public License along with this software. If not, it can be</i>
    5:<i>%% retrieved via the world wide web at http://www.erlang.org/.</i>
    6:<i>%% </i>
    7:<i>%% Software distributed under the License is distributed on an "AS IS"</i>
    8:<i>%% basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See</i>
    9:<i>%% the License for the specific language governing rights and limitations</i>
<a name="10"></a>   10:<i>%% under the License.</i>
   11:<i>%% </i>
   12:<i>%% The Initial Developer of the Original Code is Ericsson Utvecklings AB.</i>
   13:<i>%% Portions created by Ericsson are Copyright 1999, Ericsson Utvecklings</i>
   14:<i>%% AB. All Rights Reserved.''</i>
   15:<i>%% </i>
   16:<i>%%     $Id$</i>
   17:<i>%%</i>
   18:<i>%%%----------------------------------------------------------------------</i>
   19:<i>%%% Purpose : Tests the safe_fixtable functions in both ets and dets.</i>
<a name="20"></a>   20:<i>%%%----------------------------------------------------------------------</i>
   21:
   22:-<b>module</b>(fixtable_SUITE).
   23:-<b>export</b>([all/1]).
   24:<i>%%% Test cases</i>
   25:-<b>export</b>([multiple_fixes/1, multiple_processes/1,
   26:	 other_process_deletes/1, owner_dies/1,
   27:	 other_process_closes/1,insert_same_key/1]).
   28:-<b>export</b>([init_per_testcase/2, fin_per_testcase/2]).
   29:<i>%%% Internal exports</i>
<a name="30"></a>   30:-<b>export</b>([command_loop/0,start_commander/0]).
   31:
<a name=all>   32:<b>all</b></a>(suite) -&gt; {req, [stdlib],
   33:	       [multiple_fixes, multiple_processes,
   34:		other_process_deletes, owner_dies,
   35:		other_process_closes,insert_same_key]}.
   36:
   37:-<b>include</b>("test_server.hrl").
   38:
   39:<i>%%% I wrote this thinking I would use more than one temporary at a time, but </i>
<a name="40"></a>   40:<i>%%% I wasn't... Well, maybe in the future...</i>
   41:-<b>define</b>(DETS_TEMPORARIES, [tmp1]).
   42:-<b>define</b>(ETS_TEMPORARIES, [gurksmetsmedaljong]).
   43:-<b>define</b>(DETS_TMP1,hd(?DETS_TEMPORARIES)).
   44:-<b>define</b>(ETS_TMP1,hd(?ETS_TEMPORARIES)).
   45:
   46:-<b>define</b>(HELPER_NODE, (atom_to_list(?MODULE) ++ "_helper1")).
   47:
<a name=init_per_testcase>   48:<b>init_per_testcase</b></a>(Func, Config) -&gt;
   49:    PrivDir = ?config(priv_dir,Config),    
<a name="50"></a>   50:    file:make_dir(PrivDir),
   51:    Dog=test_server:timetrap(test_server:seconds(60)),
   52:    [{watchdog, Dog}|Config].
   53:
<a name=fin_per_testcase>   54:<b>fin_per_testcase</b></a>(Func, Config) -&gt;
   55:    Dog=?config(watchdog, Config),
   56:    test_server:timetrap_cancel(Dog),
   57:    lists:foreach(fun(X) -&gt;
   58:			  (catch dets:close(X)),
   59:			  (catch file:delete(dets_filename(X,Config)))
<a name="60"></a>   60:		  end,
   61:		  ?DETS_TEMPORARIES),
   62:    lists:foreach(fun(X) -&gt;
   63:			  (catch ets:delete(X))
   64:		  end,
   65:		  ?ETS_TEMPORARIES).
   66:
   67:
   68:-<b>ifdef</b>(DEBUG).
   69:-<b>define</b>(LOG(X), show(X,?LINE)).
<a name="70"></a>   70:
<a name=show>   71:<b>show</b></a>(Term, Line) -&gt;
   72:    io:format("~p: ~p~n", [Line,Term]),
   73:    Term.
   74:-<b>else</b>.
   75:-<b>define</b>(LOG(X),X).
   76:-<b>endif</b>.
   77:
<a name=insert_same_key>   78:<b>insert_same_key</b></a>(doc) -&gt;
   79:    ["Check correct behaviour if a key is deleted and reinserted during fixation."];
<a name=insert_same_key><a name="80"></a>   80:<b>insert_same_key</b></a>(suite) -&gt;
   81:    [];
<a name=insert_same_key>   82:<b>insert_same_key</b></a>(Config) when list(Config) -&gt;
   83:    ?line {ok,Dets1} = dets:open_file(?DETS_TMP1,
   84:			       [{file, dets_filename(?DETS_TMP1,Config)}]),
   85:    ?line Ets1 = ets:new(ets,[]),
   86:    ?line insert_same_key(Dets1,dets,Config),
   87:    ?line insert_same_key(Ets1,ets,Config),
   88:    ?line ets:insert(Ets1,{1,2}),
   89:    ?line 1 = ets:info(Ets1,size),
<a name="90"></a>   90:    ?line dets:insert(Dets1,{1,2}),
   91:    ?line 1 = dets:info(Dets1,size),
   92:    ?line dets:close(Dets1),
   93:    ?line (catch file:delete(dets_filename(Dets1,Config))),
   94:    ?line ets:delete(Ets1),
   95:    ?line {ok,Dets2} = dets:open_file(?DETS_TMP1,
   96:			       [{type,bag},{file, dets_filename(?DETS_TMP1,Config)}]),
   97:    ?line Ets2 = ets:new(ets,[bag]),
   98:    ?line insert_same_key(Dets2,dets,Config),
   99:    ?line insert_same_key(Ets2,ets,Config),
<a name="100"></a>  100:    ?line ets:insert(Ets2,{1,2}),
  101:    ?line 2 = ets:info(Ets2,size),
  102:    ?line ets:insert(Ets2,{1,2}),
  103:    ?line 2 = ets:info(Ets2,size),
  104:    ?line dets:insert(Dets2,{1,2}),
  105:    ?line 2 = dets:info(Dets2,size),
  106:    ?line dets:insert(Dets2,{1,2}),
  107:    ?line 2 = dets:info(Dets2,size),
  108:    ?line dets:close(Dets2),
  109:    ?line (catch file:delete(dets_filename(Dets2,Config))),
<a name="110"></a>  110:    ?line ets:delete(Ets2),
  111:    ?line {ok,Dets3} = dets:open_file(?DETS_TMP1,
  112:			       [{type,duplicate_bag},
  113:				{file, dets_filename(?DETS_TMP1,Config)}]),
  114:    ?line Ets3 = ets:new(ets,[duplicate_bag]),
  115:    ?line insert_same_key(Dets3,dets,Config),
  116:    ?line insert_same_key(Ets3,ets,Config),
  117:    ?line ets:insert(Ets3,{1,2}),
  118:    ?line 2 = ets:info(Ets3,size),
  119:    ?line ets:insert(Ets3,{1,2}),
<a name="120"></a>  120:    ?line 3 = ets:info(Ets3,size),
  121:    ?line dets:insert(Dets3,{1,2}),
  122:    ?line 2 = dets:info(Dets3,size),
  123:    ?line dets:insert(Dets3,{1,2}),
  124:    ?line 3 = dets:info(Dets3,size),
  125:    ?line dets:close(Dets3),
  126:    ?line (catch file:delete(dets_filename(Dets3,Config))),
  127:    ?line ets:delete(Ets3),
  128:    ok.
  129:
<a name=insert_same_key><a name="130"></a>  130:<b>insert_same_key</b></a>(Tab,Mod,_Config) -&gt;
  131:    ?line Mod:insert(Tab,{1,1}),
  132:    ?line Mod:insert(Tab,{1,2}),
  133:    ?line Mod:insert(Tab,{2,2}),
  134:    ?line Mod:insert(Tab,{2,2}),
  135:    ?line Mod:safe_fixtable(Tab,true),
  136:    ?line Mod:delete(Tab,1),
  137:    ?line Mod:insert(Tab,{1,1}),
  138:    ?line Expect = case Mod:info(Tab,type) of
  139:	      bag -&gt;
<a name="140"></a>  140:		  Mod:insert(Tab,{1,2}),
  141:		  2;
  142:	      _ -&gt; 
  143:		  1
  144:	  end,
  145:    ?line Mod:delete(Tab,2),
  146:    ?line Mod:safe_fixtable(Tab,false),
  147:    ?line case Mod:info(Tab,size) of
  148:	      Expect -&gt;
  149:		  ok;
<a name="150"></a>  150:	      _ -&gt; 
  151:		  exit({size_field_wrong,{Mod,Mod:info(Tab)}})
  152:	  end.
  153:    
  154:    
  155:
  156:
<a name=owner_dies>  157:<b>owner_dies</b></a>(doc) -&gt;
  158:    ["Check correct behaviour if the table owner dies."];
<a name=owner_dies>  159:<b>owner_dies</b></a>(suite) -&gt;
<a name="160"></a>  160:    [];
<a name=owner_dies>  161:<b>owner_dies</b></a>(Config) when list(Config) -&gt;
  162:    ?line P1 = start_commander(),
  163:    ?line Ets1 = command(P1,{ets,new,[ets,[]]}),
  164:    ?line command(P1,{ets,safe_fixtable,[Ets1,true]}),
  165:    ?line {_,[{P1,1}]} = ets:info(Ets1, safe_fixed),
  166:    ?line stop_commander(P1),
  167:    ?line undefined = ets:info(Ets1, safe_fixed),
  168:    ?line P2 = start_commander(),
  169:    ?line Ets2 = command(P2,{ets,new,[ets,[public]]}),
<a name="170"></a>  170:    ?line command(P2,{ets,safe_fixtable,[Ets2,true]}),
  171:    ?line ets:safe_fixtable(Ets2,true),
  172:    ?line true = ets:info(Ets2, fixed),
  173:    ?line {_,[{_,1},{_,1}]} = ets:info(Ets2, safe_fixed),
  174:    ?line stop_commander(P2),
  175:    ?line undefined = ets:info(Ets2, safe_fixed),
  176:    ?line undefined = ets:info(Ets2, fixed),
  177:    ?line P3 = start_commander(),
  178:    ?line {ok,Dets} = ?LOG(command(P3, {dets, open_file, 
  179:					[?DETS_TMP1,
<a name="180"></a>  180:					 [{file, 
  181:					   dets_filename(?DETS_TMP1,
  182:							 Config)}]]})),
  183:    ?line command(P3, {dets, safe_fixtable, [Dets, true]}),
  184:    ?line {_,[{P3,1}]} = dets:info(Dets, safe_fixed),
  185:    ?line true = dets:info(Dets, fixed),
  186:    ?line stop_commander(P3),
  187:    ?line false = dets:info(Dets, safe_fixed),
  188:    ?line undefined = dets:info(Dets, fixed),
  189:    ?line P4 = start_commander(),
<a name="190"></a>  190:    ?line {ok,Dets} = command(P4, {dets, open_file, 
  191:			     [?DETS_TMP1,
  192:			      [{file, dets_filename(?DETS_TMP1,Config)}]]}),
  193:    ?line {ok,Dets} = dets:open_file(?DETS_TMP1,
  194:			       [{file, dets_filename(?DETS_TMP1,Config)}]),
  195:    ?line false = dets:info(Dets, safe_fixed),
  196:    ?line command(P4, {dets, safe_fixtable, [Dets, true]}),
  197:    ?line dets:safe_fixtable(Dets, true),
  198:    ?line {_,[{_,1},{_,1}]} = dets:info(Dets, safe_fixed),
  199:    ?line dets:safe_fixtable(Dets, true),
<a name="200"></a>  200:    ?line stop_commander(P4),
  201:    ?line S = self(),
  202:    ?line {_,[{S,2}]} = dets:info(Dets, safe_fixed),
  203:    ?line true = dets:info(Dets, fixed),
  204:    ?line dets:close(Dets),
  205:    ?line undefined = dets:info(Dets, fixed),
  206:    ?line undefined = dets:info(Dets, safe_fixed),
  207:    ok.
  208:   
  209:
<a name=other_process_closes><a name="210"></a>  210:<b>other_process_closes</b></a>(doc) -&gt;
  211:    ["When another process closes an dets table, different "
  212:     "things should happen depending on if it has opened it before."];
  213:
<a name=other_process_closes>  214:<b>other_process_closes</b></a>(suite) -&gt;
  215:    [];
  216:
<a name=other_process_closes>  217:<b>other_process_closes</b></a>(Config) when list(Config) -&gt;
  218:    ?line {ok,Dets} = dets:open_file(?DETS_TMP1,
  219:			       [{file, dets_filename(tmp1,Config)}]),
<a name="220"></a>  220:    ?line P2 = start_commander(),
  221:    ?line dets:safe_fixtable(Dets,true),
  222:    ?line S = self(),
  223:    ?line {_,[{S,1}]} = dets:info(Dets, safe_fixed),
  224:    ?line command(P2,{dets, safe_fixtable, [Dets, true]}),
  225:    ?line {_,[_,_]} = dets:info(Dets, safe_fixed),
  226:    ?line {error, not_owner} = command(P2,{dets, close, [Dets]}),
  227:    ?line {_,[_,_]} = dets:info(Dets, safe_fixed),
  228:    ?line command(P2,{dets, open_file,[?DETS_TMP1,
  229:				 [{file, 
<a name="230"></a>  230:				   dets_filename(?DETS_TMP1, Config)}]]}),
  231:    ?line {_,[_,_]} = dets:info(Dets, safe_fixed),
  232:    ?line command(P2,{dets, close, [Dets]}),
  233:    ?line stop_commander(P2),
  234:    ?line {_,[{S,1}]} = dets:info(Dets, safe_fixed),
  235:    ?line true = dets:info(Dets,fixed),
  236:    ?line dets:close(Dets),
  237:    ?line undefined = dets:info(Dets,fixed),
  238:    ?line undefined = dets:info(Dets, safe_fixed),
  239:    ok.
<a name="240"></a>  240:    
<a name=other_process_deletes>  241:<b>other_process_deletes</b></a>(doc) -&gt;
  242:    ["Check that fixtable structures are cleaned up if another process "
  243:     "deletes an ets table"];
<a name=other_process_deletes>  244:<b>other_process_deletes</b></a>(suite) -&gt;
  245:    [];
<a name=other_process_deletes>  246:<b>other_process_deletes</b></a>(Config) when list(Config) -&gt;
  247:    ?line Ets = ets:new(ets,[public]),
  248:    ?line P = start_commander(),
  249:    ?line ets:safe_fixtable(Ets,true),
<a name="250"></a>  250:    ?line ets:safe_fixtable(Ets,true),
  251:    ?line true = ets:info(Ets, fixed),
  252:    ?line {_,L} = ets:info(Ets, safe_fixed),
  253:    ?line command(P,{ets,delete,[Ets]}),
  254:    ?line stop_commander(P),
  255:    ?line undefined = ets:info(Ets, fixed),
  256:    ?line undefined = ets:info(Ets, safe_fixed),
  257:    ok.
  258:
<a name=multiple_fixes>  259:<b>multiple_fixes</b></a>(doc) -&gt;
<a name="260"></a>  260:    ["Check that multiple safe_fixtable keeps the reference counter."];
<a name=multiple_fixes>  261:<b>multiple_fixes</b></a>(suite) -&gt;
  262:    [];
<a name=multiple_fixes>  263:<b>multiple_fixes</b></a>(Config) when list(Config) -&gt;
  264:    ?line {ok,Dets} = dets:open_file(?DETS_TMP1,
  265:			       [{file, dets_filename(?DETS_TMP1,Config)}]),
  266:    ?line Ets = ets:new(ets,[]),
  267:    ?line multiple_fixes(Dets,dets,Config),
  268:    ?line multiple_fixes(Ets,ets,Config),
  269:    ?line dets:close(Dets),
<a name="270"></a>  270:    ok.
  271:
<a name=multiple_fixes>  272:<b>multiple_fixes</b></a>(Tab, Mod, Config) -&gt;
  273:    ?line false = Mod:info(Tab,fixed),
  274:    ?line false = Mod:info(Tab, safe_fixed),
  275:    ?line Mod:safe_fixtable(Tab, true),
  276:    ?line true = Mod:info(Tab,fixed),
  277:    ?line S = self(),
  278:    ?line {_,[{S,1}]} = Mod:info(Tab, safe_fixed),
  279:    ?line Mod:safe_fixtable(Tab, true),
<a name="280"></a>  280:    ?line Mod:safe_fixtable(Tab, true),
  281:    ?line {_,[{S,3}]} = Mod:info(Tab, safe_fixed),
  282:    ?line true = Mod:info(Tab,fixed),
  283:    ?line Mod:safe_fixtable(Tab, false),
  284:    ?line {_,[{S,2}]} = Mod:info(Tab, safe_fixed),
  285:    ?line true = Mod:info(Tab,fixed),
  286:    ?line Mod:safe_fixtable(Tab, false),
  287:    ?line {_,[{S,1}]} = Mod:info(Tab, safe_fixed),
  288:    ?line true = Mod:info(Tab,fixed),
  289:    ?line Mod:safe_fixtable(Tab, false),
<a name="290"></a>  290:    ?line false = Mod:info(Tab, safe_fixed),
  291:    ?line false = Mod:info(Tab,fixed).
  292:
<a name=multiple_processes>  293:<b>multiple_processes</b></a>(doc) -&gt;
  294:    ["Check that multiple safe_fixtable across processes are reference "
  295:     "counted OK"];
<a name=multiple_processes>  296:<b>multiple_processes</b></a>(suite) -&gt;
  297:    [];
<a name=multiple_processes>  298:<b>multiple_processes</b></a>(Config) when list(Config) -&gt;
  299:    ?line {ok,Dets} = dets:open_file(?DETS_TMP1,[{file, 
<a name="300"></a>  300:					    dets_filename(?DETS_TMP1,
  301:							  Config)}]),
  302:    ?line Ets = ets:new(ets,[public]),
  303:    ?line multiple_processes(Dets,dets,Config),
  304:    ?line multiple_processes(Ets,ets,Config),
  305:    ok.
  306:
<a name=multiple_processes>  307:<b>multiple_processes</b></a>(Tab, Mod, Config) -&gt;
  308:    ?line io:format("Mod = ~p\n", [Mod]),
  309:    ?line P1 = start_commander(),
<a name="310"></a>  310:    ?line P2 = start_commander(),
  311:    ?line false = Mod:info(Tab,fixed),
  312:    ?line false = Mod:info(Tab, safe_fixed),
  313:    ?line command(P1, {Mod, safe_fixtable, [Tab,true]}),
  314:    ?line true = Mod:info(Tab,fixed),
  315:    ?line {_,[{P1,1}]} = Mod:info(Tab, safe_fixed),
  316:    ?line command(P2, {Mod, safe_fixtable, [Tab,true]}),
  317:    ?line true = Mod:info(Tab,fixed),
  318:    ?line {_,L} = Mod:info(Tab,safe_fixed),
  319:    ?line true = (lists:sort(L) == lists:sort([{P1,1},{P2,1}])),
<a name="320"></a>  320:    ?line command(P2, {Mod, safe_fixtable, [Tab,true]}),
  321:    ?line {_,L2} = Mod:info(Tab,safe_fixed),
  322:    ?line true = (lists:sort(L2) == lists:sort([{P1,1},{P2,2}])),
  323:    ?line command(P2, {Mod, safe_fixtable, [Tab,false]}),
  324:    ?line true = Mod:info(Tab,fixed),
  325:    ?line {_,L3} = Mod:info(Tab,safe_fixed),
  326:    ?line true = (lists:sort(L3) == lists:sort([{P1,1},{P2,1}])),
  327:    ?line command(P2, {Mod, safe_fixtable, [Tab,false]}),
  328:    ?line true = Mod:info(Tab,fixed),
  329:    ?line {_,[{P1,1}]} = Mod:info(Tab, safe_fixed),
<a name="330"></a>  330:    ?line stop_commander(P1),
  331:    ?line receive after 1000 -&gt; ok end,
  332:    ?line false = Mod:info(Tab,fixed),
  333:    ?line false = Mod:info(Tab, safe_fixed),
  334:    ?line command(P2, {Mod, safe_fixtable, [Tab,true]}),
  335:    ?line true = Mod:info(Tab,fixed),
  336:    ?line {_,[{P2,1}]} = Mod:info(Tab, safe_fixed),
  337:    case Mod of
  338:	dets -&gt;
  339:	    ?line dets:close(Tab);
<a name="340"></a>  340:	ets -&gt;
  341:	    ?line ets:delete(Tab)
  342:    end,
  343:    ?line stop_commander(P2),
  344:    ?line receive after 1000 -&gt; ok end,
  345:    ?line undefined = Mod:info(Tab, safe_fixed),
  346:    ok.
  347:    
  348:    
  349:
<a name="350"></a>  350:<i>%%% Helpers</i>
<a name=dets_filename>  351:<b>dets_filename</b></a>(Base, Config) when atom(Base) -&gt;
  352:    dets_filename(atom_to_list(Base) ++ ".dat", Config);
<a name=dets_filename>  353:<b>dets_filename</b></a>(Basename, Config) -&gt;
  354:    PrivDir = ?config(priv_dir,Config),
  355:    filename:join(PrivDir, Basename).
  356:
<a name=command_loop>  357:<b>command_loop</b></a>() -&gt;
  358:    receive 
  359:	{From, command, {M,F,A}} -&gt;
<a name="360"></a>  360:	    Res = (catch apply(M, F, A)),
  361:	    From ! {self(), Res},
  362:	    command_loop();
  363:	die -&gt;
  364:	    ok
  365:    end.
  366:
<a name=start_commander>  367:<b>start_commander</b></a>() -&gt;
  368:    spawn(?MODULE, command_loop, []).
  369:
<a name=stop_commander><a name="370"></a>  370:<b>stop_commander</b></a>(Pid) -&gt;
  371:    process_flag(trap_exit, true),
  372:    link(Pid),
  373:    Pid ! die,
  374:    receive
  375:	{'EXIT',Pid,_} -&gt;
  376:	    true
  377:    after 5000 -&gt;
  378:	    exit(stop_timeout)
  379:    end.
<a name="380"></a>  380:
<a name=command>  381:<b>command</b></a>(Pid,MFA) -&gt;
  382:    Pid ! {self(), command, MFA},
  383:    receive
  384:	{Pid, Res} -&gt;
  385:	    Res
  386:    after 20000 -&gt;
  387:	    exit(command_timeout)
  388:    end.
  389:
<a name="390"></a>  390:
  391:
</pre>
<hr size=1><i>The transformation of this file (392 lines) took 0.01 seconds</i><br>
</body>
</html>
