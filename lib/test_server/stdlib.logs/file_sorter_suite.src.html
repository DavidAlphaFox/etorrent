<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head><title>/usr/home/jlouis/hacking/test_server/stdlib_test/file_sorter_SUITE.erl</title></head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
    1:<i>%% ``The contents of this file are subject to the Erlang Public License,</i>
    2:<i>%% Version 1.1, (the "License"); you may not use this file except in</i>
    3:<i>%% compliance with the License. You should have received a copy of the</i>
    4:<i>%% Erlang Public License along with this software. If not, it can be</i>
    5:<i>%% retrieved via the world wide web at http://www.erlang.org/.</i>
    6:<i>%% </i>
    7:<i>%% Software distributed under the License is distributed on an "AS IS"</i>
    8:<i>%% basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See</i>
    9:<i>%% the License for the specific language governing rights and limitations</i>
<a name="10"></a>   10:<i>%% under the License.</i>
   11:<i>%% </i>
   12:<i>%% The Initial Developer of the Original Code is Ericsson Utvecklings AB.</i>
   13:<i>%% Portions created by Ericsson are Copyright 1999, Ericsson Utvecklings</i>
   14:<i>%% AB. All Rights Reserved.''</i>
   15:<i>%% </i>
   16:<i>%%     $Id $</i>
   17:<i>%%</i>
   18:-<b>module</b>(file_sorter_SUITE).
   19:
<a name="20"></a>   20:<i>%-define(debug, true).</i>
   21:
   22:-<b>ifdef</b>(debug).
   23:-<b>define</b>(format(S, A), io:format(S, A)).
   24:-<b>define</b>(line, put(line, ?LINE), ).
   25:-<b>define</b>(config(X,Y), foo).
   26:-<b>define</b>(t,test_server).
   27:-<b>define</b>(privdir(_), "./file_sorter_SUITE_priv").
   28:-<b>else</b>.
   29:-<b>include</b>("test_server.hrl").
<a name="30"></a>   30:-<b>define</b>(format(S, A), ok).
   31:-<b>define</b>(privdir(Conf), ?config(priv_dir, Conf)).
   32:-<b>endif</b>.
   33:
   34:-<b>export</b>([all/1, basic/1, badarg/1, 
   35:	 term_sort/1, term_keysort/1,
   36:	 binary_term_sort/1, binary_term_keysort/1,
   37:	 binary_sort/1, 
   38:	 term_merge/1, term_keymerge/1, 
   39:	 binary_term_merge/1, binary_term_keymerge/1,
<a name="40"></a>   40:	 binary_merge/1,
   41:	 term_check/1, term_keycheck/1,
   42:	 binary_term_check/1, binary_term_keycheck/1,
   43:	 binary_check/1,
   44:	 inout/1, misc/1, many/1]).
   45:
   46:-<b>export</b>([init_per_testcase/2, fin_per_testcase/2]).
   47:
<a name=init_per_testcase>   48:<b>init_per_testcase</b></a>(_Case, Config) -&gt;
   49:    Dog=?t:timetrap(?t:minutes(2)),
<a name="50"></a>   50:    [{watchdog, Dog}|Config].
   51:
<a name=fin_per_testcase>   52:<b>fin_per_testcase</b></a>(_Case, Config) -&gt;
   53:    Dog=?config(watchdog, Config),
   54:    test_server:timetrap_cancel(Dog),
   55:    ok.
   56:
<a name=all>   57:<b>all</b></a>(suite) -&gt;
   58:    {req,[stdlib,kernel],
   59:     [basic, badarg, 
<a name="60"></a>   60:      term_sort, term_keysort, 
   61:      binary_term_sort, binary_term_keysort, 
   62:      binary_sort, 
   63:      term_merge, term_keymerge, 
   64:      binary_term_merge, binary_term_keymerge,
   65:      binary_merge,
   66:      term_check, binary_term_keycheck,
   67:      binary_term_check, binary_term_keycheck,
   68:      binary_check,
   69:      inout, misc, many]}.
<a name="70"></a>   70:
<a name=basic>   71:<b>basic</b></a>(doc) -&gt;
   72:    ["Basic test case."];
<a name=basic>   73:<b>basic</b></a>(suite) -&gt; 
   74:    [];
<a name=basic>   75:<b>basic</b></a>(Config) when list(Config) -&gt;
   76:    Fmt = binary,
   77:    Arg = {format,Fmt},
   78:    Foo = outfile(foo, Config),
   79:    P0 = pps(),
<a name="80"></a>   80:
   81:    ?line F1s = [F1] = to_files([[]], Fmt, Config),
   82:    ?line ok = file_sorter:sort(F1),
   83:    ?line [] = from_files(F1, Fmt),
   84:    ?line ok = file_sorter:keysort(17, F1),
   85:    ?line [] = from_files(F1, Fmt),
   86:    ?line ok = file_sorter:merge(F1s, Foo),
   87:    ?line [] = from_files(Foo, Fmt),
   88:    ?line delete_files(Foo),
   89:    ?line ok = file_sorter:keymerge(17, F1s, Foo),
<a name="90"></a>   90:    ?line [] = from_files(Foo, Fmt),
   91:    ?line delete_files([Foo | F1s]),
   92:
   93:    ?line [F2] = to_files([[foo,bar]], Fmt, Config),
   94:    ?line ok = file_sorter:sort([F2], F2, Arg),
   95:    ?line [bar,foo] = from_files(F2, Fmt),
   96:    ?line delete_files(F2),
   97:
   98:    ?line Fs1 = to_files([[foo],[bar]], Fmt, Config),
   99:    ?line ok = file_sorter:sort(Fs1, Foo, Arg),
<a name="100"></a>  100:    ?line [bar,foo] = from_files(Foo, Fmt),
  101:    ?line delete_files(Foo),
  102:    ?line ok = file_sorter:merge(Fs1, Foo, Arg),
  103:    ?line [bar,foo] = from_files(Foo, Fmt),
  104:    ?line delete_files([Foo | Fs1]),
  105:
  106:    ?line Fmt2 = binary_term,
  107:    ?line Arg2 = {format, Fmt2},
  108:    ?line [F3] = to_files([[{foo,1},{bar,2}]], Fmt2, Config),
  109:    ?line ok = file_sorter:keysort([2], [F3], F3, Arg2),
<a name="110"></a>  110:    ?line [{foo,1},{bar,2}] = from_files(F3, Fmt2),
  111:    ?line delete_files(F3),
  112:
  113:    ?line Fs2 = to_files([[{foo,1}],[{bar,2}]], Fmt2, Config),
  114:    ?line ok = file_sorter:keysort(1, Fs2, Foo, Arg2),
  115:    ?line [{bar,2},{foo,1}] = from_files(Foo, Fmt2),
  116:    ?line delete_files(Foo),
  117:    ?line ok = file_sorter:keymerge(1, Fs2, Foo, Arg2),
  118:    ?line [{bar,2},{foo,1}] = from_files(Foo, Fmt2),
  119:    ?line delete_files([Foo | Fs2]),
<a name="120"></a>  120:
  121:    ?line true = P0 == pps(),
  122:
  123:    ok.
  124:
<a name=badarg>  125:<b>badarg</b></a>(doc) -&gt;
  126:    ["Call functions with bad arguments."];
<a name=badarg>  127:<b>badarg</b></a>(suite) -&gt; 
  128:    [];
<a name=badarg>  129:<b>badarg</b></a>(Config) when list(Config) -&gt;
<a name="130"></a>  130:    PrivDir = ?privdir(Config),
  131:    BadFile = filename:join(PrivDir, "not_a_file"),
  132:    ABadFile = filename:absname(BadFile),
  133:    ?line file:delete(BadFile),
  134:    ?line {error,{file_error,ABadFile,enoent}} = 
  135:	file_sorter:sort(BadFile),
  136:    ?line {'EXIT', {{badarg, {flipp}}, _}} = 
  137:	(catch file_sorter:sort({flipp})),
  138:    ?line {error,{file_error,ABadFile,enoent}} = 
  139:	file_sorter:keysort(1, BadFile),
<a name="140"></a>  140:    ?line {'EXIT', {{badarg, {flipp}}, _}} = 
  141:	(catch file_sorter:keysort(1, {flipp})),
  142:
  143:    ?line {'EXIT', {{badarg, {flipp}}, _}} = 
  144:	(catch file_sorter:merge([{flipp}],foo)),
  145:    ?line {error,{file_error,ABadFile,enoent}} = 
  146:	file_sorter:keymerge(1,[BadFile],foo),
  147:    ?line {'EXIT', {{badarg, {flipp}}, _}} = 
  148:	(catch file_sorter:keymerge(1,[{flipp}],foo)),
  149:    ?line {'EXIT', {{badarg, _}, _}} = 
<a name="150"></a>  150:	(catch file_sorter:merge(fun(X) -&gt; X end, foo)),
  151:    ?line {'EXIT', {{badarg, _}, _}} = 
  152:	(catch file_sorter:keymerge(1, fun(X) -&gt; X end, foo)),
  153:
  154:    ?line {error,{file_error,ABadFile,enoent}} = 
  155:	file_sorter:check(BadFile),
  156:    ?line {'EXIT', {{badarg, {flipp}}, _}} = 
  157:	(catch file_sorter:check({flipp})),
  158:    ?line {error,{file_error,ABadFile,enoent}} = 
  159:	file_sorter:keycheck(1, BadFile),
<a name="160"></a>  160:    ?line {'EXIT', {{badarg, {flipp}}, _}} = 
  161:	(catch file_sorter:keycheck(1, {flipp})),
  162:    ?line {'EXIT', {{badarg, {flipp}}, _}} = 
  163:	(catch file_sorter:check([{flipp}],foo)),
  164:    ?line {'EXIT', {{badarg, {flipp}}, _}} = 
  165:	(catch file_sorter:keycheck(1,[{flipp}],foo)),
  166:    ?line {'EXIT', {{badarg, _}, _}} = 
  167:	(catch file_sorter:check(fun(X) -&gt; X end, foo)),
  168:    ?line {'EXIT', {{badarg, _}, _}} = 
  169:	(catch file_sorter:keycheck(1, fun(X) -&gt; X end, foo)),
<a name="170"></a>  170:
  171:    ?line Fs = to_files([[1,2,3]], binary_term, Config),
  172:    ?line {'EXIT', {{badarg, flipp}, _}} = 
  173:	(catch file_sorter:check(Fs ++ flipp, [])),
  174:    [F] = Fs,
  175:    ?line {error,{not_a_directory,F}} = 
  176:        file_sorter:sort(Fs, foo, {tmpdir,F}),
  177:    {error,{file_error,ABadFile,enoent}} = 
  178:	file_sorter:sort(Fs, foo, {tmpdir,BadFile}),
  179:    ?line delete_files(Fs),
<a name="180"></a>  180:
  181:    ?line {'EXIT', {{badarg, bad}, _}} = 
  182:	(catch file_sorter:check([], [{format,term} | bad])),
  183:    ?line {'EXIT', {{badarg, [{flipp}]}, _}} = 
  184:	(catch file_sorter:check([{flipp}])),
  185:    ?line {'EXIT', {{badarg, {flipp}}, _}} = 
  186:	(catch file_sorter:keycheck(1, {flipp})),
  187:    ?line {'EXIT', {{badarg, [{flipp}]}, _}} = 
  188:	(catch file_sorter:keycheck(2, [{flipp}])),
  189:    ?line {error,{file_error,_,eisdir}} = file_sorter:keycheck(1, []),
<a name="190"></a>  190:    ?line {'EXIT', {{badarg, kp}, _}} = (catch file_sorter:keycheck(kp, [])),
  191:    ?line {'EXIT', {{badarg, kp}, _}} = 
  192:	(catch file_sorter:keycheck([1, kp], [])),
  193:    ?line {'EXIT', {{badarg, kp}, _}} = 
  194:	(catch file_sorter:keycheck([1 | kp], [])),
  195:    ?line {'EXIT', {{badarg, []}, _}} = (catch file_sorter:keycheck([], [])),
  196:    ?line {'EXIT', {{badarg, {format, foo}}, _}} = 
  197:	(catch file_sorter:check([], {format,foo})),
  198:    ?line {'EXIT', {{badarg, not_an_option}, _}} = 
  199:	(catch file_sorter:keycheck(7, [], [not_an_option])),
<a name="200"></a>  200:    ?line {'EXIT', {{badarg, format}, _}} = 
  201:	(catch file_sorter:keycheck(1, [], [{format, binary}])),
  202:    ?line {'EXIT', {{badarg, order}, _}} = 
  203:	(catch file_sorter:keycheck(1, [], [{order, fun compare/2}])),
  204:
  205:    ?line do_badarg(fun(I, O) -&gt; file_sorter:sort(I, O) end,
  206:		    fun(Kp, I, O) -&gt; file_sorter:keysort(Kp, I, O) end,
  207:		    BadFile),
  208:    ?line do_badarg_opt(fun(I, O, X) -&gt; file_sorter:sort(I, O, X) end,
  209:			fun(Kp, I, O, X) -&gt; file_sorter:keysort(Kp, I, O, X) 
<a name="210"></a>  210:			end),
  211:    ?line do_badarg(fun(I, O) -&gt; file_sorter:merge(I, O) end,
  212:		    fun(Kp, I, O) -&gt; file_sorter:keymerge(Kp, I, O) end, 
  213:		    BadFile),
  214:    ?line do_badarg_opt(fun(I, O, X) -&gt; file_sorter:merge(I, O, X) end,
  215:			fun(Kp, I, O, X) -&gt; file_sorter:keymerge(Kp, I, O, X) 
  216:			end).
  217:
<a name=do_badarg>  218:<b>do_badarg</b></a>(F, KF, BadFile) -&gt;
  219:    [Char | _] = BadFile,
<a name="220"></a>  220:    AFlipp = filename:absname(flipp),
  221:    ?line {error,{file_error,AFlipp,enoent}} = F([flipp | flopp], foo),
  222:    ?line {'EXIT', {{badarg, {foo,bar}}, _}} = (catch F([], {foo,bar})),
  223:    ?line {'EXIT', {{badarg, Char}, _}} = (catch F(BadFile, [])),
  224:    ?line {'EXIT', {{badarg, {flipp}}, _}} = (catch F({flipp}, [])),
  225:
  226:    ?line {'EXIT', {{badarg, Char}, _}} = (catch KF(1, BadFile, [])),
  227:    ?line {'EXIT', {{badarg, {flipp}}, _}} = (catch KF(1, {flipp}, [])),
  228:    ?line {error,{file_error,AFlipp,enoent}} = 
  229:	KF(2, [flipp | flopp], foo),
<a name="230"></a>  230:    ?line {'EXIT', {{badarg, {foo,bar}}, _}} = (catch KF(1, [], {foo,bar})),
  231:    ?line {'EXIT', {{badarg, kp}, _}} = (catch KF(kp, [], foo)),
  232:    ?line {'EXIT', {{badarg, kp}, _}} = (catch KF([1, kp], [], foo)),
  233:    ?line {'EXIT', {{badarg, kp}, _}} = (catch KF([1 | kp], [], foo)),
  234:    ?line {'EXIT', {{badarg, []}, _}} = (catch KF([], [], foo)),
  235:    ok.
  236:
<a name=do_badarg_opt>  237:<b>do_badarg_opt</b></a>(F, KF) -&gt;
  238:    AFlipp = filename:absname(flipp),
  239:    ?line {error,{file_error,AFlipp,enoent}} = 
<a name="240"></a>  240:	   F([flipp | flopp], foo, []),
  241:    ?line {'EXIT', {{badarg, {flipp}}, _}} = (catch F([{flipp}], foo, [])),
  242:    ?line {'EXIT', {{badarg, {out,put}}, _}} = (catch F([], {out,put}, [])),
  243:    ?line {'EXIT', {{badarg, not_an_option}, _}} = 
  244:	(catch F([], foo, [not_an_option])),
  245:    ?line {'EXIT', {{badarg, {format, foo}}, _}} = 
  246:	   (catch F([], foo, {format,foo})),
  247:    ?line {'EXIT', {{badarg, {size,foo}}, _}} = (catch F([], foo, {size,foo})),
  248:
  249:    ?line {'EXIT', {{badarg, {size, 0}}, _}} = (catch F([], foo, {size,0})),
<a name="250"></a>  250:    ?line {'EXIT', {{badarg, {size, 1 bsl 35}}, _}} = 
  251:	(catch F([], foo, {size,1 bsl 35})),
  252:    ?line {'EXIT', {{badarg, {no_files, foo}}, _}} = 
  253:	(catch F([], foo, {no_files,foo})),
  254:    ?line {'EXIT', {{badarg, {no_files, 1}}, _}} = 
  255:	(catch F([], foo, {no_files,1})),
  256:    ?line {'EXIT', {{badarg, 1}, _}} = (catch F([], foo, {tmpdir,1})),
  257:    ?line {'EXIT', {{badarg, {order,1}}, _}} = (catch F([], foo, {order,1})),
  258:    ?line {'EXIT', {{badarg, {compressed, flopp}}, _}} = 
  259:	   (catch F([], foo, {compressed,flopp})),
<a name="260"></a>  260:    ?line {'EXIT', {{badarg, {unique,flopp}}, _}} = 
  261:	   (catch F([], foo, {unique,flopp})),
  262:    ?line {'EXIT', {{badarg, {header,foo}}, _}} = 
  263:	(catch F([], foo, {header,foo})),
  264:    ?line {'EXIT', {{badarg, {header, 0}}, _}} = 
  265:	(catch F([], foo, {header,0})),
  266:    ?line {'EXIT', {{badarg, {header, 1 bsl 35}}, _}} = 
  267:	(catch F([], foo, {header,1 bsl 35})),
  268:    ?line {'EXIT', {{badarg, header}, _}} = 
  269:	(catch F([], foo, [{header,1},{format,term}])),
<a name="270"></a>  270:
  271:    ?line {'EXIT', {{badarg, not_an_option}, _}} = 
  272:	(catch KF(7, [], foo, [not_an_option])),
  273:    ?line {'EXIT', {{badarg,format}, _}} = 
  274:	(catch KF(1, [], foo, [{format, binary}])),
  275:    ?line {'EXIT', {{badarg, order}, _}} = 
  276:	(catch KF(1, [], foo, [{order, fun compare/2}])),
  277:    ?line {'EXIT', {{badarg, {flipp}}, _}} = 
  278:	(catch KF(2, [{flipp}], foo,[])),
  279:    ?line {error,{file_error,AFlipp,enoent}} = 
<a name="280"></a>  280:	KF(2, [flipp | flopp], foo,[]),
  281:    ?line {'EXIT', {{badarg, {out, put}}, _}} = 
  282:	(catch KF(1, [], {out,put}, [])),
  283:    ?line {'EXIT', {{badarg, kp}, _}} = (catch KF(kp, [], foo, [])),
  284:    ?line {'EXIT', {{badarg, kp}, _}} = (catch KF([1, kp], [], foo, [])),
  285:    ?line {'EXIT', {{badarg, kp}, _}} = (catch KF([1 | kp], [], foo, [])),
  286:    ok.
  287:
<a name=term_sort>  288:<b>term_sort</b></a>(doc) -&gt;
  289:    ["Sort terms on files."];
<a name=term_sort><a name="290"></a>  290:<b>term_sort</b></a>(suite) -&gt;
  291:    [];
<a name=term_sort>  292:<b>term_sort</b></a>(Config) when list(Config) -&gt;
  293:    ?line sort(term, [{compressed,false}], Config),
  294:    ?line sort(term, [{order, fun compare/2}], Config),
  295:    ?line sort(term, [{order, ascending}, {compressed,true}], Config),
  296:    ?line sort(term, [{order, descending}], Config),
  297:    ok.
  298:
<a name=term_keysort>  299:<b>term_keysort</b></a>(doc) -&gt;
<a name="300"></a>  300:    ["Keysort terms on files."];
<a name=term_keysort>  301:<b>term_keysort</b></a>(suite) -&gt;
  302:    [];
<a name=term_keysort>  303:<b>term_keysort</b></a>(Config) when list(Config) -&gt;
  304:    ?line keysort(term, [{tmpdir, ""}], Config),
  305:    ?line keysort(term, [{order,descending}], Config),
  306:    ok.
  307:
<a name=binary_term_sort>  308:<b>binary_term_sort</b></a>(doc) -&gt;
  309:    ["Sort binary terms on files."];
<a name=binary_term_sort><a name="310"></a>  310:<b>binary_term_sort</b></a>(suite) -&gt;
  311:    [];
<a name=binary_term_sort>  312:<b>binary_term_sort</b></a>(Config) when list(Config) -&gt;
  313:    PrivDir = ?privdir(Config),
  314:    ?line sort({2, binary_term}, [], Config),
  315:    ?line sort(binary_term, [{tmpdir, list_to_atom(PrivDir)}], Config),
  316:    ?line sort(binary_term, [{tmpdir,PrivDir}], Config),
  317:    ?line sort({3,binary_term}, [{order, fun compare/2}], Config),
  318:    ?line sort(binary_term, [{order, fun compare/2}], Config),
  319:    ?line sort(binary_term, [{order,descending}], Config),
<a name="320"></a>  320:    ok.
  321:
<a name=binary_term_keysort>  322:<b>binary_term_keysort</b></a>(doc) -&gt;
  323:    ["Keysort binary terms on files."];
<a name=binary_term_keysort>  324:<b>binary_term_keysort</b></a>(suite) -&gt;
  325:    [];
<a name=binary_term_keysort>  326:<b>binary_term_keysort</b></a>(Config) when list(Config) -&gt;
  327:    ?line keysort({3, binary_term}, [], Config),
  328:    ?line keysort(binary_term, [], Config),
  329:    ?line keysort(binary_term, [{order,descending}], Config),
<a name="330"></a>  330:    ok.
  331:
<a name=binary_sort>  332:<b>binary_sort</b></a>(doc) -&gt;
  333:    ["Sort binaries on files."];
<a name=binary_sort>  334:<b>binary_sort</b></a>(suite) -&gt;
  335:    [];
<a name=binary_sort>  336:<b>binary_sort</b></a>(Config) when list(Config) -&gt;
  337:    PrivDir = ?privdir(Config),
  338:    ?line sort({2, binary}, [], Config),
  339:    ?line sort(binary, [{tmpdir, list_to_atom(PrivDir)}], Config),
<a name="340"></a>  340:    ?line sort(binary, [{tmpdir,PrivDir}], Config),
  341:    ?line sort({3,binary}, [{order, fun compare/2}], Config),
  342:    ?line sort(binary, [{order, fun compare/2}], Config),
  343:    ?line sort(binary, [{order,descending}], Config),
  344:    ok.
  345:
<a name=term_merge>  346:<b>term_merge</b></a>(doc) -&gt;
  347:    ["Merge terms on files."];
<a name=term_merge>  348:<b>term_merge</b></a>(suite) -&gt;
  349:    [];
<a name=term_merge><a name="350"></a>  350:<b>term_merge</b></a>(Config) when list(Config) -&gt;
  351:    ?line merge(term, [{order, fun compare/2}], Config),
  352:    ?line merge(term, [{order, ascending}, {compressed,true}], Config),
  353:    ?line merge(term, [{order, descending}, {compressed,false}], Config),
  354:    ok.
  355:
<a name=term_keymerge>  356:<b>term_keymerge</b></a>(doc) -&gt;
  357:    ["Keymerge terms on files."];
<a name=term_keymerge>  358:<b>term_keymerge</b></a>(suite) -&gt;
  359:    [];
<a name=term_keymerge><a name="360"></a>  360:<b>term_keymerge</b></a>(Config) when list(Config) -&gt;
  361:    ?line keymerge(term, [], Config),
  362:    ?line keymerge(term, [{order, descending}], Config),
  363:    ok.
  364:
<a name=binary_term_merge>  365:<b>binary_term_merge</b></a>(doc) -&gt;
  366:    ["Merge binary terms on files."];
<a name=binary_term_merge>  367:<b>binary_term_merge</b></a>(suite) -&gt;
  368:    [];
<a name=binary_term_merge>  369:<b>binary_term_merge</b></a>(Config) when list(Config) -&gt;
<a name="370"></a>  370:    ?line merge(binary_term, [], Config),
  371:    ?line merge({7, binary_term}, [], Config),
  372:    ?line merge({3, binary_term}, [{order, fun compare/2}], Config),
  373:    ok.
  374:
<a name=binary_term_keymerge>  375:<b>binary_term_keymerge</b></a>(doc) -&gt;
  376:    ["Keymerge binary terms on files."];
<a name=binary_term_keymerge>  377:<b>binary_term_keymerge</b></a>(suite) -&gt;
  378:    [];
<a name=binary_term_keymerge>  379:<b>binary_term_keymerge</b></a>(Config) when list(Config) -&gt;
<a name="380"></a>  380:    ?line keymerge({3, binary_term}, [], Config),
  381:    ?line keymerge(binary_term, [], Config),
  382:    ok.
  383:
<a name=binary_merge>  384:<b>binary_merge</b></a>(doc) -&gt;
  385:    ["Merge binaries on files."];
<a name=binary_merge>  386:<b>binary_merge</b></a>(suite) -&gt;
  387:    [];
<a name=binary_merge>  388:<b>binary_merge</b></a>(Config) when list(Config) -&gt;
  389:    ?line merge(binary, [], Config),
<a name="390"></a>  390:    ?line merge({7, binary}, [], Config),
  391:    ?line merge({3, binary}, [{order, fun compare/2}], Config),
  392:    ok.
  393:
<a name=term_check>  394:<b>term_check</b></a>(doc) -&gt;
  395:    ["Check terms on files."];
<a name=term_check>  396:<b>term_check</b></a>(suite) -&gt;
  397:    [];
<a name=term_check>  398:<b>term_check</b></a>(Config) when list(Config) -&gt;
  399:    ?line check(term, Config),
<a name="400"></a>  400:    ok.
  401:
<a name=binary_term_check>  402:<b>binary_term_check</b></a>(doc) -&gt;
  403:    ["Check binary terms on files."];
<a name=binary_term_check>  404:<b>binary_term_check</b></a>(suite) -&gt;
  405:    [];
<a name=binary_term_check>  406:<b>binary_term_check</b></a>(Config) when list(Config) -&gt;
  407:    ?line check(binary_term, Config),
  408:    ok.
  409:
<a name=term_keycheck><a name="410"></a>  410:<b>term_keycheck</b></a>(doc) -&gt;
  411:    ["Keycheck terms on files."];
<a name=term_keycheck>  412:<b>term_keycheck</b></a>(suite) -&gt;
  413:    [];
<a name=term_keycheck>  414:<b>term_keycheck</b></a>(Config) when list(Config) -&gt;
  415:    ?line keycheck(term, Config),
  416:    ok.
  417:
<a name=binary_term_keycheck>  418:<b>binary_term_keycheck</b></a>(doc) -&gt;
  419:    ["Keycheck binary terms on files."];
<a name=binary_term_keycheck><a name="420"></a>  420:<b>binary_term_keycheck</b></a>(suite) -&gt;
  421:    [];
<a name=binary_term_keycheck>  422:<b>binary_term_keycheck</b></a>(Config) when list(Config) -&gt;
  423:    ?line keycheck(binary_term, Config),
  424:    ok.
  425:
<a name=binary_check>  426:<b>binary_check</b></a>(doc) -&gt;
  427:    ["Check binary terms on files."];
<a name=binary_check>  428:<b>binary_check</b></a>(suite) -&gt;
  429:    [];
<a name=binary_check><a name="430"></a>  430:<b>binary_check</b></a>(Config) when list(Config) -&gt;
  431:    ?line check(binary, Config),
  432:    ok.
  433:
<a name=inout>  434:<b>inout</b></a>(doc) -&gt;
  435:    ["Funs as input or output."];
<a name=inout>  436:<b>inout</b></a>(suite) -&gt;
  437:    [];
<a name=inout>  438:<b>inout</b></a>(Config) when list(Config) -&gt;
  439:    BTF = {format, binary_term},
<a name="440"></a>  440:    Foo = outfile(foo, Config),
  441:
  442:    %% Input is fun.
  443:    End = fun(read) -&gt; end_of_input end,
  444:
  445:    IF1 = fun(read) -&gt; {[1,7,5], End} end,
  446:    ?line ok = file_sorter:sort(IF1, Foo, [{format, term}]),
  447:    %% 'close' is called, but the return value is caught and ignored.
  448:    IF2 = fun(read) -&gt; {[1,2,3], fun(close) -&gt; throw(ignored) end} end,
  449:    ?line {error, bad_object} = file_sorter:sort(IF2, Foo, BTF),
<a name="450"></a>  450:
  451:    IF3 = fun(no_match) -&gt; foo end,
  452:    ?line {'EXIT', {{{function_clause, _}, _}, _}} = 
  453:	(catch file_sorter:sort(IF3, Foo)),
  454:    IF4 = fun(read) -&gt; throw(my_message) end,
  455:    ?line my_message = (catch file_sorter:sort(IF4, Foo)),
  456:    IF5 = fun(read) -&gt; {error, my_error} end,
  457:    ?line {error, my_error} = file_sorter:sort(IF5, Foo),
  458:
  459:    %% Output is fun.
<a name="460"></a>  460:    ?line {error, bad_object} = 
  461:	file_sorter:sort(IF2, fun(close) -&gt; ignored end, BTF),
  462:    Args = [{format, term}],
  463:    ?line {error, bad_object} = 
  464:       file_sorter:keysort(1, IF2, fun(close) -&gt; ignored end, Args),
  465:    OF1 = fun(close) -&gt; fine; (L) when list(L) -&gt; fun(close) -&gt; nice end end,
  466:    ?line nice = file_sorter:sort(IF1, OF1, Args),
  467:    OF2 = fun(_) -&gt; my_return end,
  468:    ?line my_return = file_sorter:sort(IF1, OF2, Args),
  469:    OF3 = fun(_) -&gt; throw(my_message) end,
<a name="470"></a>  470:    ?line my_message = (catch file_sorter:sort(IF1, OF3, Args)),
  471:    OF4 = fun(no_match) -&gt; foo end,
  472:    ?line {'EXIT', {{{function_clause, _}, _}, _}} = 
  473:	(catch file_sorter:sort(IF1, OF4, Args)),
  474:
  475:    ?line P0 = pps(),
  476:    ?line Fs1 = to_files([[3,1,2,5,4], [8,3,10]], term, Config),
  477:    ?line error = file_sorter:sort(Fs1, fun(_) -&gt; error end, Args),
  478:    ?line delete_files(Fs1),
  479:
<a name="480"></a>  480:    ?line true = P0 == pps(),
  481:
  482:    %% Passing a value from the input functions to the output functions.
  483:    IFV1 = fun(read) -&gt; {end_of_input, 17} end,
  484:    OFV1 = fun({value, Value}) -&gt; ofv(Value, []) end,
  485:    ?line {17, []} == file_sorter:sort(IFV1, OFV1, Args),
  486:
  487:    ok.
  488:
<a name=ofv>  489:<b>ofv</b></a>(Value, A) -&gt;
<a name="490"></a>  490:    fun(close) -&gt; 
  491:	    {Value, lists:append(lists:reverse(A))};
  492:       (L) when list(L) -&gt;
  493:	    ofv(Value, [L | A])
  494:    end.
  495:
<a name=many>  496:<b>many</b></a>(doc) -&gt;
  497:    ["Many temporary files."];
<a name=many>  498:<b>many</b></a>(suite) -&gt;
  499:    [];
<a name=many><a name="500"></a>  500:<b>many</b></a>(Config) when list(Config) -&gt;
  501:    Foo = outfile(foo, Config),
  502:    PrivDir = ?privdir(Config),
  503:    P0 = pps(),
  504:
  505:    Args = [{format, term}],
  506:    L1 = lists:map(fun(I) -&gt; {one, two, three, I} end, lists:seq(1,1000)),
  507:    L2 = lists:map(fun(I) -&gt; {four, five, six, I} end, lists:seq(1,1000)),
  508:    ?line Fs2 = to_files([L1, L2], term, Config),
  509:    ?line ok = file_sorter:sort(Fs2, Foo, [{size,1000} | Args]),
<a name="510"></a>  510:    ?line R = lists:sort(L1++L2),
  511:    ?line true = R == from_files(Foo, term),
  512:    ?line true = 2000 == length(R),
  513:    ?line ok = file_sorter:sort(Fs2, Foo, [{no_files,4},{size,1000} | Args]),
  514:    ?line true = R == from_files(Foo, term),
  515:    ?line ok = 
  516:	file_sorter:sort(Fs2, Foo, 
  517:			 [{no_files,4},{size,1000},{order,descending} | Args]),
  518:    ?line true = lists:reverse(R) == from_files(Foo, term),
  519:    ?line ok = 
<a name="520"></a>  520:	file_sorter:sort(Fs2, Foo, 
  521:			 [{no_files,4},{size,1000},
  522:			  {order,fun compare/2} | Args]),
  523:    ?line true = R == from_files(Foo, term),
  524:    ?line ok = file_sorter:keysort(4, Fs2, Foo, 
  525:				   [{no_files,4},{size,1000} | Args]),
  526:    ?line RK = lists:keysort(4, L1++L2),
  527:    ?line true = RK == from_files(Foo, term),
  528:    ?line delete_files(Foo),
  529:    ?line ok = 
<a name="530"></a>  530:	file_sorter:keysort(4, Fs2, Foo, 
  531:		      [{no_files,4},{size,1000},{order,descending} | Args]),
  532:    ?line true = lists:reverse(RK) == from_files(Foo, term),
  533:    ?line delete_files(Foo),
  534:    ?line ok = file_sorter:keysort(4, Fs2, Foo, 
  535:				   [{size,500},{order,descending} | Args]),
  536:    ?line true = lists:reverse(RK) == from_files(Foo, term),
  537:    ?line delete_files(Foo),
  538:    ?line error = file_sorter:sort(Fs2, fun(_) -&gt; error end, 
  539:				   [{tmpdir, PrivDir}, {no_files,3}, 
<a name="540"></a>  540:				    {size,10000} | Args]),
  541:
  542:    TmpDir = filename:join(PrivDir, "tmpdir"),
  543:    file:del_dir(TmpDir),
  544:    ?line ok = file:make_dir(TmpDir),
  545:    ?line case os:type() of
  546:	      {unix, _} -&gt;
  547:		  ?line ok = file:change_mode(TmpDir, 8#0000),
  548:		  ?line {error, {file_error, _,_}} = 
  549:		      file_sorter:sort(Fs2, fun(_M) -&gt; foo end, 
<a name="550"></a>  550:				       [{no_files,3},{size,10000},
  551:					{tmpdir,TmpDir} | Args]);
  552:	      _ -&gt;
  553:		  true
  554:	  end,
  555:    ?line ok = file:del_dir(TmpDir),
  556:    delete_files(Fs2),
  557:    ?line true = P0 == pps(),
  558:    ok.
  559:
<a name=misc><a name="560"></a>  560:<b>misc</b></a>(doc) -&gt;
  561:    ["Some other tests."];
<a name=misc>  562:<b>misc</b></a>(suite) -&gt;
  563:    [];
<a name=misc>  564:<b>misc</b></a>(Config) when list(Config) -&gt;
  565:    BTF = {format, binary_term},
  566:    Foo = outfile(foo, Config),
  567:    FFoo = filename:absname(Foo),
  568:    P0 = pps(),
  569:
<a name="570"></a>  570:    ?line [File] = Fs1 = to_files([[1,3,2]], term, Config),
  571:    ?line ok = file:write_file(Foo,&lt;&lt;&gt;&gt;),
  572:    ?line case os:type() of
  573:	      {unix, _} -&gt;
  574:		  ok = file:change_mode(Foo, 8#0000),
  575:		  {error,{file_error,FFoo,eacces}} = 
  576:		      file_sorter:sort(Fs1, Foo, {format,term});
  577:	      _ -&gt;
  578:		  true
  579:	  end,
<a name="580"></a>  580:    ?line file:delete(Foo),
  581:    ?line NoBytes = 16, % RAM memory will never get this big, or?
  582:    ?line ALot = (1 bsl (NoBytes*8)) - 1,
  583:    ?line ok = file:write_file(File, &lt;&lt;ALot:NoBytes/unit:8,"foobar"&gt;&gt;),
  584:    FFile = filename:absname(File),
  585:    ?line {error, {bad_object,FFile}} = 
  586:	file_sorter:sort(Fs1, Foo, [BTF, {header, 20}]),
  587:    ?line ok = file:write_file(File, &lt;&lt;30:32,"foobar"&gt;&gt;),
  588:    ?line {error, {premature_eof, FFile}} = file_sorter:sort(Fs1, Foo, BTF),
  589:    ?line ok = file:write_file(File, &lt;&lt;6:32,"foobar"&gt;&gt;),
<a name="590"></a>  590:    ?line {error, {bad_object,FFile}} = file_sorter:sort(Fs1, Foo, BTF),
  591:    ?line case os:type() of
  592:	      {unix, _} -&gt;
  593:		  ok = file:change_mode(File, 8#0000),
  594:		  {error, {file_error,FFile,eacces}} = 
  595:		      file_sorter:sort(Fs1, Foo),
  596:		  {error, {file_error,FFile,eacces}} = 
  597:		      file_sorter:sort(Fs1, Foo, {format, binary_term});
  598:	      _ -&gt;
  599:		  true
<a name="600"></a>  600:	  end,
  601:    ?line delete_files(Fs1),
  602:    ?line true = P0 == pps(),
  603:
  604:    %% bigger than chunksize
  605:    ?line E1 = &lt;&lt;32000:32, 10:256000&gt;&gt;,
  606:    ?line E2 = &lt;&lt;32000:32, 5:256000&gt;&gt;,
  607:    ?line E3 = &lt;&lt;32000:32, 8:256000&gt;&gt;,
  608:    ?line ok = file:write_file(Foo, [E1, E2, E3]),
  609:    ?line ok = file_sorter:sort([Foo], Foo, [{format,binary},{size,10000}]),
<a name="610"></a>  610:    ?line ok = file_sorter:sort([Foo], Foo, [{format,fun(X) -&gt; X end},
  611:					     {size,10000}]),
  612:    ?line Es = list_to_binary([E2,E3,E1]),
  613:    ?line {ok, Es} = file:read_file(Foo),
  614:    ?line delete_files(Foo),
  615:    ?line true = P0 == pps(),
  616:
  617:    %% keysort more than one element
  618:    L = [{c,1,a},{c,2,b},{c,3,c},{b,1,c},{b,2,b},{b,3,a},{a,1,a},{a,2,b},
  619:	 {a,3,c}],
<a name="620"></a>  620:    ?line Fs2 = to_files([L], binary_term, Config),
  621:    ?line ok = file_sorter:keysort([2,3], Fs2, Foo, {format, binary_term}),
  622:    ?line KS2_1 = from_files(Foo, binary_term),
  623:    ?line KS2_2 = lists:keysort(2,lists:keysort(3, L)),
  624:    ?line true = KS2_1 == KS2_2,
  625:    ?line ok = file_sorter:keysort([2,3,1], Fs2, Foo, {format, binary_term}),
  626:    ?line KS3_1 = from_files(Foo, binary_term),
  627:    ?line KS3_2 = lists:keysort(2, lists:keysort(3,lists:keysort(1, L))),
  628:    ?line true = KS3_1 == KS3_2,
  629:    ?line delete_files([Foo | Fs2]),
<a name="630"></a>  630:    ?line true = P0 == pps(),
  631:
  632:    %% bigger than chunksize
  633:    %% Assumes that CHUNKSIZE = 16384. Illustrates that the Last argument
  634:    %% of merge_files/5 is necessary. 
  635:    ?line EP1 = erlang:make_tuple(2728,foo),
  636:    ?line EP2 = lists:duplicate(2729,qqq),
  637:    ?line LL = [EP1, EP2, EP1, EP2, EP1, EP2],
  638:    ?line Fs3 = to_files([LL], binary, Config),
  639:    ?line ok = file_sorter:sort(Fs3, Foo, [{format,binary}, {unique,true}]),
<a name="640"></a>  640:    ?line [EP1,EP2] = from_files(Foo, binary),
  641:    ?line delete_files(Foo),
  642:    ?line ok = file_sorter:sort(Fs3, Foo, 
  643:				[{format,binary_term}, {unique,true}, 
  644:				 {size,30000}]),
  645:    ?line [EP1,EP2] = from_files(Foo, binary_term),
  646:    ?line delete_files([Foo | Fs3]),
  647:
  648:    ?line true = P0 == pps(),
  649:
<a name="650"></a>  650:    ?line BE1 = &lt;&lt;20000:32, 17:160000&gt;&gt;,
  651:    ?line BE2 = &lt;&lt;20000:32, 1717:160000&gt;&gt;,
  652:    ?line ok = file:write_file(Foo, [BE1,BE2,BE1,BE2]),
  653:    ?line ok = file_sorter:sort([Foo], Foo, [{format,binary},
  654:					     {size,10000},
  655:					     {unique,true}]),
  656:    ?line BEs = list_to_binary([BE1, BE2]),
  657:    ?line {ok, BEs} = file:read_file(Foo),
  658:    ?line delete_files(Foo),
  659:    ?line true = P0 == pps(),
<a name="660"></a>  660:
  661:    ?line Fs4 = to_files([[7,4,1]], binary_term, Config),
  662:    ?line {error, {bad_term, _}} = file_sorter:sort(Fs4, Foo, {format, term}),
  663:    ?line delete_files([Foo | Fs4]),
  664:    ?line true = P0 == pps(),
  665:
  666:    ok.
  667:
  668:<i>%%% </i>
  669:<i>%%% Utilities.</i>
<a name="670"></a>  670:<i>%%% </i>
  671:
<a name=sort>  672:<b>sort</b></a>(Fmt, XArgs, Config) -&gt;
  673:    Args = make_args(Fmt, [{size,5} | XArgs]),
  674:    TmpArgs = [{tmpdir,?privdir(Config)} | Args],
  675:    Foo = outfile(foo, Config),
  676:
  677:    %% Input is a fun. Output is a fun.
  678:    ?line [] = file_sorter:sort(input([], 2, Fmt), output([], Fmt), Args),
  679:    ?line L1 = [3,1,2,5,4],
<a name="680"></a>  680:    ?line S1 = file_sorter:sort(input(L1, 2, Fmt), output([], Fmt), TmpArgs),
  681:    ?line true = rev(lists:sort(L1), TmpArgs) == S1,
  682:
  683:    %% Input is a file. Output is a fun.
  684:    ?line [] = file_sorter:sort([], output([], Fmt), Args),
  685:    ?line L2 = [3,1,2,5,4],
  686:    ?line Fs1 = to_files([L2], Fmt, Config),
  687:    ?line S2 = file_sorter:sort(Fs1, output([], Fmt), TmpArgs),
  688:    ?line true = rev(lists:sort(L2), TmpArgs) == S2,
  689:    ?line delete_files(Fs1),
<a name="690"></a>  690:
  691:    %% Input is a file. Output is a file
  692:    ?line ok = file_sorter:sort([], Foo, Args),
  693:    ?line [] = from_files(Foo, Fmt),
  694:    ?line delete_files(Foo),
  695:    ?line ok = file_sorter:sort([], Foo, [{unique,true} | Args]),
  696:    ?line [] = from_files(Foo, Fmt),
  697:    ?line delete_files(Foo),
  698:    ?line L3 = [3,1,2,5,4,6],
  699:    ?line Fs2 = to_files([L3], Fmt, Config),
<a name="700"></a>  700:    ?line ok = file_sorter:sort(Fs2, Foo, Args),
  701:    ?line true = rev(lists:sort(L3), Args) == from_files(Foo, Fmt),
  702:    ?line delete_files([Foo | Fs2]),
  703:    ?line L4 = [1,3,4,1,2,5,4,5,6],
  704:    ?line Fs3 = to_files([L4], Fmt, Config),
  705:    ?line ok = file_sorter:sort(Fs3, Foo, Args++[{unique,true}, 
  706:						 {size,100000}]),
  707:    ?line true = rev(lists:usort(L4), Args) == from_files(Foo, Fmt),
  708:    ?line delete_files(Foo),
  709:    ?line ok = file_sorter:sort(Fs3, Foo, Args++[{unique,true}]),
<a name="710"></a>  710:    ?line true = rev(lists:usort(L4), Args) == from_files(Foo, Fmt),
  711:    ?line delete_files([Foo | Fs3]),
  712:
  713:    %% Input is a fun. Output is a file.
  714:    ?line ok = file_sorter:sort(input([], 2, Fmt), Foo, Args),
  715:    ?line [] = from_files(Foo, Fmt),
  716:    ?line delete_files(Foo),
  717:    ?line L5 = [3,1,2,5,4,7],
  718:    ?line ok = file_sorter:sort(input(L5, 2, Fmt), Foo, Args),
  719:    ?line true = rev(lists:sort(L5), Args) == from_files(Foo, Fmt),
<a name="720"></a>  720:    ?line delete_files(Foo),
  721:    ok.
  722:
<a name=keysort>  723:<b>keysort</b></a>(Fmt, XArgs, Config) -&gt;
  724:    Args = make_args(Fmt, [{size,50}, {no_files, 2} | XArgs]),
  725:    TmpArgs = Args ++ [{tmpdir,?privdir(Config)}],
  726:    Foo = outfile(foo, Config),
  727:
  728:    %% Input is files. Output is a file.
  729:    ?line ok = file_sorter:keysort(2, [], Foo, Args),
<a name="730"></a>  730:    ?line [] = from_files(Foo, Fmt),
  731:    ?line delete_files(Foo),
  732:    ?line ok = file_sorter:keysort(2, [], Foo, [{unique,true} | Args]),
  733:    ?line [] = from_files(Foo, Fmt),
  734:    ?line delete_files(Foo),
  735:    ?line L0 = [{a,2},{a,1},{a,2},{a,2},{a,1},{a,2},{a,2},{a,3}],
  736:    ?line Fs0 = to_files([L0], Fmt, Config),
  737:    ?line ok = 
  738:	file_sorter:keysort(1, Fs0, Foo, Args ++ [{unique,true},
  739:						  {size,100000}]),
<a name="740"></a>  740:    ?line S = rev([{a,2},{a,1},{a,2},{a,1},{a,2},{a,3}], Args),
  741:    ?line true = S == from_files(Foo, Fmt),
  742:    ?line delete_files(Foo),
  743:    ?line ok = file_sorter:keysort(1, Fs0, Foo, Args ++ [{unique,true}]),
  744:    ?line true = S == from_files(Foo, Fmt),
  745:    ?line delete_files([Foo | Fs0]),
  746:    ?line L11 = [{a,1,x4},{b,2,x4},{c,3,x4}],
  747:    ?line L21 = [{a,1,x3},{b,2,x3},{c,3,x3}],
  748:    ?line L31 = [{a,1,x2},{b,2,x2},{c,3,x2}],
  749:    ?line L41 = [{a,1,x1},{b,2,x1},{c,3,x1}],
<a name="750"></a>  750:    ?line All = [L11, L21, L31, L41],
  751:    ?line AllFlat = lists:append(All),
  752:    ?line Sorted = rev(lists:keysort(2, AllFlat), Args),
  753:    ?line Fs1 = to_files(All, Fmt, Config),
  754:    ?line ok = file_sorter:keysort(2, Fs1, Foo, Args),
  755:    ?line true = Sorted == from_files(Foo, Fmt),
  756:    ?line delete_files(Foo),
  757:
  758:    %% Input is files. Output is a fun.
  759:    ?line [] = file_sorter:keysort(2, [], output([], Fmt), Args),
<a name="760"></a>  760:    ?line KS1 = file_sorter:keysort(2, Fs1, output([], Fmt), TmpArgs),
  761:    ?line true = Sorted == KS1,
  762:    ?line delete_files(Fs1),
  763:
  764:    %% Input is a fun. Output is a file.
  765:    ?line ok = file_sorter:keysort(2, input([], 2, Fmt), Foo, Args),
  766:    ?line [] = from_files(Foo, Fmt),
  767:    ?line delete_files(Foo),
  768:    ?line ok = file_sorter:keysort(2, input(AllFlat, 4, Fmt), Foo, Args),
  769:    ?line true = Sorted == from_files(Foo,  Fmt),
<a name="770"></a>  770:    ?line delete_files(Foo),
  771:
  772:    %% Input is a fun. Output is a fun.
  773:    ?line [] = file_sorter:keysort(2, input([], 2, Fmt), output([], Fmt),Args),
  774:    ?line KS2 = 
  775:	file_sorter:keysort(2, input(AllFlat, 4, Fmt), output([], Fmt), 
  776:			    TmpArgs),
  777:    ?line true = Sorted == KS2,
  778:    ok.
  779:
<a name=merge><a name="780"></a>  780:<b>merge</b></a>(Fmt, XArgs, Config) -&gt;
  781:    Args = make_args(Fmt, [{size,5} | XArgs]),
  782:    Foo = outfile(foo, Config),
  783:
  784:    %% Input is a file. Output is a fun.
  785:    ?line [] = file_sorter:merge([], output([], Fmt), Args),
  786:    ?line L2 = [[1,3,5],[2,4,5]],
  787:    ?line Fs1 = to_files(L2, Fmt, Config),
  788:    ?line S2 = file_sorter:sort(Fs1, output([], Fmt), Args),
  789:    ?line true = rev(lists:sort(lists:append(L2)), Args) == S2,
<a name="790"></a>  790:    ?line delete_files(Fs1),
  791:
  792:    %% Input is a file. Output is a file
  793:    ?line ok = file_sorter:merge([], Foo, Args),
  794:    ?line [] = from_files(Foo, Fmt),
  795:    ?line delete_files(Foo),
  796:    ?line ok = file_sorter:merge([], Foo, [{unique,true} | Args]),
  797:    ?line [] = from_files(Foo, Fmt),
  798:    ?line delete_files(Foo),
  799:    ?line L31 = [1,2,3],
<a name="800"></a>  800:    ?line L32 = [2,3,4],
  801:    ?line L33 = [4,5,6],
  802:    ?line L3r = [L31, L32, L33],
  803:    ?line L3 = [rev(L31,Args), rev(L32,Args), rev(L33,Args)],
  804:    ?line Fs2 = to_files(L3, Fmt, Config),
  805:    ?line ok = file_sorter:merge(Fs2, Foo, Args),
  806:    ?line true = rev(lists:merge(L3r), Args) == from_files(Foo, Fmt),
  807:    ?line ok = file_sorter:merge(Fs2, Foo, Args++[{unique,true}, 
  808:						  {size,100000}]),
  809:    ?line true = rev(lists:umerge(L3r), Args) == from_files(Foo, Fmt),
<a name="810"></a>  810:    ?line delete_files(Foo),
  811:    ?line ok = file_sorter:merge(Fs2, Foo, Args++[{unique,true}]),
  812:    ?line true = rev(lists:umerge(L3r), Args) == from_files(Foo, Fmt),
  813:    ?line delete_files([Foo | Fs2]),
  814:
  815:    ok.
  816:
<a name=keymerge>  817:<b>keymerge</b></a>(Fmt, XArgs, Config) -&gt;
  818:    Args = make_args(Fmt, [{size,50}, {no_files, 2} | XArgs]),
  819:    Foo = outfile(foo, Config),
<a name="820"></a>  820:
  821:    %% Input is files. Output is a file.
  822:    ?line ok = file_sorter:keymerge(2, [], Foo, Args),
  823:    ?line [] = from_files(Foo, Fmt),
  824:    ?line delete_files(Foo),
  825:    ?line ok = file_sorter:keymerge(2, [], Foo, [{unique,true} | Args]),
  826:    ?line [] = from_files(Foo, Fmt),
  827:    ?line delete_files(Foo),
  828:    ?line L0 = [rev([{a,1},{a,2}], Args), rev([{a,2},{a,1},{a,3}], Args)],
  829:    ?line Fs0 = to_files(L0, Fmt, Config),
<a name="830"></a>  830:    ?line ok = file_sorter:keymerge(1, Fs0, Foo, Args ++ [{unique,true}]),
  831:    ?line S1 = rev([{a,1},{a,2},{a,1},{a,3}], Args),
  832:    ?line true = S1 == from_files(Foo, Fmt),
  833:    ?line delete_files(Foo),
  834:    ?line ok = file_sorter:keymerge(1, Fs0, Foo, Args ++ [{unique,false}]),
  835:    ?line S2 = rev([{a,1},{a,2},{a,2},{a,1},{a,3}], Args),
  836:    ?line true = S2 == from_files(Foo, Fmt),
  837:    ?line delete_files([Foo | Fs0]),
  838:    ?line L11 = [{a,1,x4},{b,2,x4},{c,3,x4}],
  839:    ?line L21 = [{a,1,x3},{b,2,x3},{c,3,x3}],
<a name="840"></a>  840:    ?line L31 = [{a,1,x2},{b,2,x2},{c,3,x2}],
  841:    ?line L41 = [{a,1,x1},{b,2,x1},{c,3,x1}],
  842:    ?line All = 
  843:	[rev(L11, Args), rev(L21, Args), rev(L31, Args), rev(L41, Args)],
  844:    ?line Merged1 = lists:keymerge(2, L11, L21),
  845:    ?line Merged2 = lists:keymerge(2, L31, L41),
  846:    ?line Merged = rev(lists:keymerge(2, Merged1, Merged2), Args),
  847:    ?line Fs1 = to_files(All, Fmt, Config),
  848:    ?line ok = file_sorter:keymerge(2, Fs1, Foo, Args),
  849:    ?line true = Merged == from_files(Foo, Fmt),
<a name="850"></a>  850:    ?line delete_files(Foo),
  851:
  852:    %% Input is files. Output is a fun.
  853:    ?line [] = file_sorter:keysort(2, [], output([], Fmt), Args),
  854:    ?line KS1 = file_sorter:keymerge(2, Fs1, output([], Fmt), Args),
  855:    ?line true = Merged == KS1,
  856:    ?line delete_files([Foo | Fs1]),
  857:
  858:    ?line L2 = [[{a,1}],[{a,2}],[{a,3}],[{a,4}],[{a,5}],[{a,6}],[{a,7}]],
  859:    ?line Fs2 = to_files(L2, Fmt, Config),
<a name="860"></a>  860:    ?line M = file_sorter:keymerge(1, Fs2, output([], Fmt), Args),
  861:    ?line true = M == rev(lists:append(L2), Args),
  862:    ?line delete_files(Fs2),
  863:
  864:    ok.
  865:
<a name=check>  866:<b>check</b></a>(Fmt, Config) -&gt;
  867:    Args0 = make_args(Fmt, [{size,5}]),
  868:    Args = Args0 ++ [{tmpdir,?privdir(Config)}],
  869:
<a name="870"></a>  870:    Fun = fun compare/2,
  871:
  872:    L1 = [3,1,2,5,4],
  873:    [F1_0] = Fs1 = to_files([L1], Fmt, Config),
  874:    F1 = filename:absname(F1_0),
  875:    ?line {ok, [{F1,2,1}]} = file_sorter:check(Fs1, Args),
  876:    ?line {ok, [{F1,2,1}]} = file_sorter:check(Fs1, [{order,Fun} | Args]),
  877:    ?line {ok, [{F1,2,1}]} = file_sorter:check(Fs1, [{unique,true} | Args]),
  878:    ?line {ok, [{F1,2,1}]} = 
  879:	file_sorter:check(Fs1, [{order,Fun},{unique,true} | Args]),
<a name="880"></a>  880:    ?line {ok, [{F1,3,2}]} = 
  881:	file_sorter:check(Fs1, [{order,descending} | Args]),
  882:    ?line {ok, [{F1,3,2}]} = 
  883:	file_sorter:check(Fs1, [{unique,true},{order,descending} | Args]),
  884:    ?line delete_files(Fs1),
  885:    
  886:    L2 = [[1,2,2,3,3,4,5,5],[5,5,4,3,3,2,2,1]],
  887:    [F2_0,F3_0] = Fs2 = to_files(L2, Fmt, Config),
  888:    F2 = filename:absname(F2_0),
  889:    F3 = filename:absname(F3_0),
<a name="890"></a>  890:    ?line {ok, [{F3,3,4}]} = file_sorter:check(Fs2, Args),
  891:    ?line {ok, [{F3,3,4}]} = file_sorter:check(Fs2, [{order,Fun} | Args]),
  892:    ?line {ok, [{F2,3,2},{F3,2,5}]} = 
  893:	file_sorter:check(Fs2, [{unique, true} | Args]),
  894:    ?line {ok, [{F2,3,2},{F3,2,5}]} = 
  895:	file_sorter:check(Fs2, [{order,Fun},{unique, true} | Args]),
  896:    ?line {ok, [{F2,2,2}]} = 
  897:	file_sorter:check(Fs2, [{order,descending} | Args]),
  898:    ?line {ok, [{F2,2,2},{F3,2,5}]} = 
  899:	file_sorter:check(Fs2, [{unique,true},{order,descending} | Args]),
<a name="900"></a>  900:    ?line delete_files(Fs2),
  901:    
  902:    L3 = [1,2,3,4],
  903:    ?line Fs3 = to_files([L3], Fmt, Config),
  904:    ?line {ok, []} = file_sorter:check(Fs3, [{unique,true} | Args]),
  905:    ?line {ok, []} = 
  906:	file_sorter:check(Fs3, [{unique,true},{order,Fun} | Args]),
  907:    ?line delete_files(Fs3),
  908:
  909:    %% big objects
<a name="910"></a>  910:    ?line T1 = erlang:make_tuple(10000,foo),
  911:    ?line T2 = erlang:make_tuple(10000,bar),
  912:    ?line L4 = [T1,T2],
  913:    ?line [FF_0] = Fs4 = to_files([L4], Fmt, Config),
  914:    FF = filename:absname(FF_0),
  915:    ?line {ok, [{FF,2,T2}]} = file_sorter:check(Fs4, [{unique,true} | Args]),
  916:    ?line delete_files(Fs4),
  917:
  918:    ok.
  919:
<a name=keycheck><a name="920"></a>  920:<b>keycheck</b></a>(Fmt, Config) -&gt;
  921:    Args0 = make_args(Fmt, [{size,5}]),
  922:    Args = Args0 ++ [{tmpdir,?privdir(Config)}],
  923:
  924:    ?line L1 = [[{a,1},{b,2}], [{c,2},{b,1},{a,3}]],
  925:    ?line [F1_0,F2_0] = Fs1 = to_files(L1, Fmt, Config),
  926:    F1 = filename:absname(F1_0),
  927:    F2 = filename:absname(F2_0),
  928:    ?line {ok, [{F2,2,{b,1}}]} = file_sorter:keycheck(1, Fs1, Args),
  929:    ?line {ok, [{F2,2,{b,1}}]} = 
<a name="930"></a>  930:	file_sorter:keycheck(1, Fs1, [{unique,true} | Args]),
  931:    ?line {ok, [{F1,2,{b,2}}]} = 
  932:	file_sorter:keycheck(1, Fs1, [{order,descending},{unique,true} | Args]),
  933:    ?line delete_files(Fs1),
  934:    
  935:    L2 = [[{a,1},{a,2},{a,2},{b,2}], [{c,2},{b,1},{b,2},{b,2},{a,3}]],
  936:    ?line [F3_0,F4_0] = Fs2 = to_files(L2, Fmt, Config),
  937:    F3 = filename:absname(F3_0),
  938:    F4 = filename:absname(F4_0),
  939:    ?line {ok, [{F4,2,{b,1}}]} = file_sorter:keycheck(1, Fs2, Args),
<a name="940"></a>  940:    ?line {ok, [{F3,3,{a,2}},{F4,2,{b,1}}]} = 
  941:	file_sorter:keycheck(1, Fs2, [{unique,true} | Args]),
  942:    ?line {ok, [{F3,4,{b,2}}]} = 
  943:	file_sorter:keycheck(1, Fs2, [{order,descending} | Args]),
  944:    ?line {ok, [{F3,3,{a,2}},{F4,4,{b,2}}]} = 
  945:	file_sorter:keycheck(1, Fs2, 
  946:			     [{order,descending},{unique,true} | Args]),
  947:    ?line delete_files(Fs2),
  948:    
  949:    ok.
<a name="950"></a>  950:
<a name=rev>  951:<b>rev</b></a>(L, Args) -&gt;
  952:    case lists:member({order, descending}, Args) of
  953:	true -&gt;
  954:	    lists:reverse(L);
  955:	false -&gt;
  956:	    L
  957:    end.
  958:
<a name=make_args>  959:<b>make_args</b></a>({HL, Fmt}, Args) -&gt;
<a name="960"></a>  960:    make_args(Fmt, [{header, HL} | Args]);
<a name=make_args>  961:<b>make_args</b></a>(Fmt, Args) -&gt;
  962:    [{format, Fmt} | Args].
  963:
<a name=compare>  964:<b>compare</b></a>(X, Y) -&gt;
  965:    X =&lt; Y.
  966:
  967:-<b>define</b>(CHUNKSIZE, 8096).
  968:
<a name=pps>  969:<b>pps</b></a>() -&gt;
<a name="970"></a>  970:    erlang:ports().
  971:
<a name=input>  972:<b>input</b></a>(L, N, term) -&gt;
  973:    input(L, N);
<a name=input>  974:<b>input</b></a>(L, N, {_HL, Format}) when Format == binary_term; Format == binary -&gt;
  975:    binput(L, N);
<a name=input>  976:<b>input</b></a>(L, N, Format) when Format == binary_term; Format == binary -&gt;
  977:    binput(L, N).
  978:
<a name=binput>  979:<b>binput</b></a>(L, N) -&gt;
<a name="980"></a>  980:    Bs = lists:map(fun(T) -&gt; term_to_binary(T) end, L),
  981:    input(Bs, N).
  982:
<a name=input>  983:<b>input</b></a>(L, N) -&gt;
  984:    fun(close) -&gt;
  985:	    ok;
  986:       (read) -&gt;
  987:	    case L of
  988:		[] -&gt; end_of_input;
  989:		_ -&gt;
<a name="990"></a>  990:		    R = lists:sublist(L, N),
  991:		    NL = lists:nthtail(length(R), L),
  992:		    {R, input(NL, N)}
  993:	    end
  994:    end.
  995:
<a name=output>  996:<b>output</b></a>(L, term) -&gt;
  997:    output(L);
<a name=output>  998:<b>output</b></a>(L, {_HL, Format}) when Format == binary_term; Format == binary -&gt;
  999:    boutput(L);
<a name=output><a name="1000"></a> 1000:<b>output</b></a>(L, Format) when Format == binary_term; Format == binary -&gt;
 1001:    boutput(L).
 1002:
<a name=output> 1003:<b>output</b></a>(A) -&gt;
 1004:    fun(close) -&gt; 
 1005:	    lists:append(lists:reverse(A));
 1006:       (L) when list(L) -&gt;
 1007:	    output([L | A])
 1008:    end.
 1009:
<a name=boutput><a name="1010"></a> 1010:<b>boutput</b></a>(A) -&gt;
 1011:    fun(close) -&gt; 
 1012:	    Bs = lists:append(lists:reverse(A)),
 1013:	    lists:map(fun(B) -&gt; binary_to_term(B) end, Bs);
 1014:       (L) when list(L) -&gt;
 1015:	    boutput([L | A])
 1016:    end.
 1017:
<a name=outfile> 1018:<b>outfile</b></a>(Name, Config) -&gt;
 1019:    list_to_atom(filename:join(?privdir(Config), Name)).
<a name="1020"></a> 1020:
 1021:<i>%% [[term()]] -&gt; [filename()]</i>
<a name=to_files> 1022:<b>to_files</b></a>(Lists, term, Config) -&gt;
 1023:    terms_to_files(Lists, Config);
<a name=to_files> 1024:<b>to_files</b></a>(Lists, Format, Config) when Format == binary_term; 
 1025:				     Format == binary -&gt;
 1026:    bins_to_files(Lists, 4, Config);
<a name=to_files> 1027:<b>to_files</b></a>(Lists, {HL, Format}, Config) when Format == binary_term; 
 1028:					   Format == binary -&gt;
 1029:    bins_to_files(Lists, HL, Config).
<a name="1030"></a> 1030:
 1031:<i>%% [[term()]] -&gt; [filename()]</i>
<a name=terms_to_files> 1032:<b>terms_to_files</b></a>(Lists, Config) -&gt;
 1033:    PrivDir = ?privdir(Config),
 1034:    terms_to_files(Lists, PrivDir, 1).
 1035:
<a name=terms_to_files> 1036:<b>terms_to_files</b></a>([L | Ls], PrivDir, N) -&gt;
 1037:    F = lists:concat([?MODULE, '_', N]),
 1038:    File = filename:join(PrivDir, F),
 1039:    {ok, Fd} = file:open(File, [write]),
<a name="1040"></a> 1040:    write_terms(Fd, L),
 1041:    file:close(Fd),
 1042:    [list_to_atom(File) | terms_to_files(Ls, PrivDir, N+1)];
<a name=terms_to_files> 1043:<b>terms_to_files</b></a>([], _PrivDir, _N) -&gt;
 1044:    [].
 1045:
<a name=write_terms> 1046:<b>write_terms</b></a>(Fd, [T | Ts]) -&gt;
 1047:    io:format(Fd, "~p.~n", [T]),
 1048:    write_terms(Fd, Ts);
<a name=write_terms> 1049:<b>write_terms</b></a>(_Fd, []) -&gt;
<a name="1050"></a> 1050:    ok.
 1051:
 1052:<i>%% [[term()]] -&gt; [filename()]</i>
<a name=bins_to_files> 1053:<b>bins_to_files</b></a>(Lists, HL, Config) -&gt;
 1054:    PrivDir = ?privdir(Config),
 1055:    bins_to_files(Lists, PrivDir, 1, HL).
 1056:
<a name=bins_to_files> 1057:<b>bins_to_files</b></a>([L | Fs], PrivDir, N, HL) -&gt;
 1058:    F = lists:concat([?MODULE, '_', N]),
 1059:    File = filename:join(PrivDir, F),
<a name="1060"></a> 1060:    {ok, Fd} = file:open(File, [raw,binary,write]),
 1061:    write_bins(Fd, L, HL),
 1062:    file:close(Fd),
 1063:    [list_to_atom(File) | bins_to_files(Fs, PrivDir, N+1, HL)];
<a name=bins_to_files> 1064:<b>bins_to_files</b></a>([], _PrivDir, _N, _HL) -&gt;
 1065:    [].
 1066:
<a name=write_bins> 1067:<b>write_bins</b></a>(Fd, [T | Ts], HL) -&gt;
 1068:    B = term_to_binary(T),
 1069:    Sz = size(B),
<a name="1070"></a> 1070:    ok = file:write(Fd, [&lt;&lt;Sz:HL/unit:8&gt;&gt;, B]),
 1071:    write_bins(Fd, Ts, HL);
<a name=write_bins> 1072:<b>write_bins</b></a>(_Fd, [], _HL) -&gt;
 1073:    ok.
 1074:
 1075:<i>%% [filename()] -&gt; [[term()]] or filename() -&gt; [term()]</i>
<a name=from_files> 1076:<b>from_files</b></a>(Files, term) -&gt;
 1077:    terms_from_files(Files);
<a name=from_files> 1078:<b>from_files</b></a>(Files, Format) when Format == binary_term; Format == binary -&gt;
 1079:    bins_from_files(Files, 4);
<a name=from_files><a name="1080"></a> 1080:<b>from_files</b></a>(Files, {HL, Format}) when Format == binary_term; Format == binary -&gt;
 1081:    bins_from_files(Files, HL).
 1082:
 1083:<i>%% [filename()] -&gt; [[term()]] or filename() -&gt; [term()]</i>
<a name=terms_from_files> 1084:<b>terms_from_files</b></a>(File) when atom(File) -&gt;
 1085:    [Terms] = terms_from_files([File]),
 1086:    Terms;
<a name=terms_from_files> 1087:<b>terms_from_files</b></a>(Files) -&gt;
 1088:    lists:map(fun(F) -&gt; terms_from_file(F) end, Files).
 1089:
<a name=terms_from_file><a name="1090"></a> 1090:<b>terms_from_file</b></a>(File) -&gt;
 1091:    {ok, Fd} = file:open(File, [read,compressed]),
 1092:    terms_from_file(Fd, []).
 1093:
<a name=terms_from_file> 1094:<b>terms_from_file</b></a>(Fd, L) -&gt;
 1095:    case io:read(Fd, '') of
 1096:	{ok, Term} -&gt;
 1097:	    terms_from_file(Fd, [Term | L]);
 1098:	eof -&gt;
 1099:	    file:close(Fd),
<a name="1100"></a> 1100:	    lists:reverse(L)
 1101:    end.
 1102:
 1103:<i>%% [filename()] -&gt; [[term()]]</i>
<a name=bins_from_files> 1104:<b>bins_from_files</b></a>(File, HL) when atom(File) -&gt;
 1105:    [Bins] = bins_from_files([File], HL),
 1106:    Bins;
<a name=bins_from_files> 1107:<b>bins_from_files</b></a>(Files, HL) -&gt;
 1108:    lists:map(fun(F) -&gt; collect(F, HL) end, Files).
 1109:
<a name=delete_files><a name="1110"></a> 1110:<b>delete_files</b></a>(File) when atom(File) -&gt;
 1111:    file:delete(File);
<a name=delete_files> 1112:<b>delete_files</b></a>(Files) -&gt;
 1113:    lists:foreach(fun(F) -&gt; file:delete(F) end, Files).
 1114:
 1115:<i>%%%</i>
 1116:<i>%%% Collects binaries converted to terms in a list. Not very efficient.</i>
 1117:<i>%%%</i>
<a name=collect> 1118:<b>collect</b></a>(F, HL) -&gt;
 1119:    {ok, Fd} = file:open(F, [read, binary, raw, compressed]),
<a name="1120"></a> 1120:    R = (catch c(Fd, &lt;&lt;&gt;&gt;, 0, ?CHUNKSIZE, HL, [])),
 1121:    file:close(Fd),
 1122:    R.
 1123:
<a name=c> 1124:<b>c</b></a>(Fd, Bin0, Size0, NoBytes, HL, L) -&gt;
 1125:    case file:read(Fd, NoBytes) of
 1126:	{ok, Bin} -&gt;
 1127:	    Size = Size0 + size(Bin),
 1128:	    NBin = list_to_binary([Bin0, Bin]),
 1129:	    c1(Fd, NBin, Size, HL, L);
<a name="1130"></a> 1130:	eof when Size0 == 0 -&gt;
 1131:	    lists:reverse(L);
 1132:        eof -&gt;
 1133:	    test_server:fail({error, premature_eof});
 1134:	Error -&gt;
 1135:	    test_server:fail(Error)
 1136:    end.
 1137:
<a name=c1> 1138:<b>c1</b></a>(Fd, B, BinSize, HL, L) -&gt; 
 1139:    case B of 
<a name="1140"></a> 1140:	&lt;&lt;Size:HL/unit:8, Bin/binary&gt;&gt; -&gt;
 1141:	    if 
 1142:		Size &gt; BinSize - HL, Size &gt; ?CHUNKSIZE -&gt;
 1143:		    c(Fd, B, BinSize, Size + HL, HL, L);
 1144:		Size &gt; BinSize - HL -&gt;
 1145:		    c(Fd, B, BinSize, ?CHUNKSIZE, HL, L);
 1146:		true -&gt;
 1147:		    &lt;&lt;BinTerm:Size/binary, R/binary&gt;&gt; = Bin,	    
 1148:		    E = case catch binary_to_term(BinTerm) of
 1149:			    Term -&gt;
<a name="1150"></a> 1150:				Term;
 1151:			    _Error -&gt;
 1152:				test_server:fail({error, bad_object})
 1153:			end,
 1154:		    NBinSize = BinSize - HL - Size,
 1155:		    c1(Fd, R, NBinSize, HL, [E | L])
 1156:	    end;
 1157:	_ -&gt;
 1158:	    c(Fd, B, BinSize, ?CHUNKSIZE, HL, L)
 1159:    end.
</pre>
<hr size=1><i>The transformation of this file (1160 lines) took 0.06 seconds</i><br>
</body>
</html>
