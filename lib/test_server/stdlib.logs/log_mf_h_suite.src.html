<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head><title>/usr/home/jlouis/hacking/test_server/stdlib_test/log_mf_h_SUITE.erl</title></head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
    1:<i>%% ``The contents of this file are subject to the Erlang Public License,</i>
    2:<i>%% Version 1.1, (the "License"); you may not use this file except in</i>
    3:<i>%% compliance with the License. You should have received a copy of the</i>
    4:<i>%% Erlang Public License along with this software. If not, it can be</i>
    5:<i>%% retrieved via the world wide web at http://www.erlang.org/.</i>
    6:<i>%% </i>
    7:<i>%% Software distributed under the License is distributed on an "AS IS"</i>
    8:<i>%% basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See</i>
    9:<i>%% the License for the specific language governing rights and limitations</i>
<a name="10"></a>   10:<i>%% under the License.</i>
   11:<i>%% </i>
   12:<i>%% The Initial Developer of the Original Code is Ericsson Utvecklings AB.</i>
   13:<i>%% Portions created by Ericsson are Copyright 1999, Ericsson Utvecklings</i>
   14:<i>%% AB. All Rights Reserved.''</i>
   15:<i>%% </i>
   16:<i>%%     $Id$</i>
   17:<i>%%</i>
   18:-<b>module</b>(log_mf_h_SUITE).
   19:
<a name="20"></a>   20:-<b>include</b>("test_server.hrl").
   21:
   22:-<b>export</b>([all/1, test/1]).
   23:
<a name=all>   24:<b>all</b></a>(suite) -&gt; {req,[stdlib],[test]}.
   25:
   26:
   27:<i>%%-----------------------------------------------------------------</i>
   28:<i>%% This is actually very basic tests, maybe we could test some more</i>
   29:<i>%% in the future...</i>
<a name="30"></a>   30:<i>%%-----------------------------------------------------------------</i>
<a name=test>   31:<b>test</b></a>(suite) -&gt; [];
<a name=test>   32:<b>test</b></a>(Config) when list(Config) -&gt;
   33:    ?line {ok, Pid} = gen_event:start_link(),
   34:    ?line PrivDir = ?config(priv_dir, Config),
   35:    Log1 = PrivDir ++ "/log1",
   36:    ?line ok = file:make_dir(Log1),
   37:    Args1 = log_mf_h:init(Log1, 500, 3),
   38:    gen_event:add_handler(Pid, log_mf_h, Args1),
   39:    generate(Pid, 200),
<a name="40"></a>   40:    {ok, Files} = file:list_dir(Log1),
   41:    ?line true = lists:member("1", Files),
   42:    ?line true = lists:member("index", Files),
   43:    ?line false = lists:member("2", Files),
   44:    generate(Pid, 2500),
   45:    %% The documentation doesn't guarantee that syncing one request
   46:    %% causes all previous ones to be finished too, but that seems to
   47:    %% be the case. We need to be sure that the files exist when we
   48:    %% look for them with 'list_dir'.
   49:    gen_event:sync_notify(Pid, "end"),
<a name="50"></a>   50:    {ok, Files2} = file:list_dir(Log1),
   51:    ?line true = lists:member("1", Files2),
   52:    ?line true = lists:member("2", Files2),
   53:    ?line true = lists:member("3", Files2),
   54:    ?line false = lists:member("4", Files2),
   55:    ?line true = lists:member("index", Files2),
   56:    ?line {ok, {Size1,regular,_,_,_,_,_}} = file:file_info(Log1 ++ "/1"),
   57:    ?line if Size1 &gt; 500 -&gt; test_server:fail({too_big, Size1});
   58:	     true -&gt; ok end,
   59:    ?line {ok, {Size2,regular,_,_,_,_,_}} = file:file_info(Log1 ++ "/2"),
<a name="60"></a>   60:    ?line if Size2 &gt; 500 -&gt; test_server:fail({too_big, Size2});
   61:	     true -&gt; ok end,
   62:    ?line {ok, {Size3,regular,_,_,_,_,_}} = file:file_info(Log1 ++ "/3"),
   63:    ?line if Size3 &gt; 500 -&gt; test_server:fail({too_big, Size3});
   64:	     true -&gt; ok end,
   65:    gen_event:delete_handler(Pid, log_mf_h, []),
   66:    ?line {ok, Index} = read_index_file(Log1),
   67:    gen_event:add_handler(Pid, log_mf_h, Args1),    
   68:    X = if Index == 3 -&gt; 1; true -&gt; Index + 1 end,
   69:    ?line {ok, X} = read_index_file(Log1).
<a name="70"></a>   70:    
   71:
<a name=generate>   72:<b>generate</b></a>(Pid, Bytes) when Bytes &gt; 32 -&gt;
   73:    gen_event:notify(Pid, make_list(32, [])),
   74:    generate(Pid, Bytes - 32);
<a name=generate>   75:<b>generate</b></a>(Pid, _) -&gt; ok.
   76:
<a name=make_list>   77:<b>make_list</b></a>(0, Res) -&gt;  Res;
<a name=make_list>   78:<b>make_list</b></a>(N, Res) -&gt; make_list(N-1, [67 | Res]).
   79:
<a name="80"></a>   80:
<a name=read_index_file>   81:<b>read_index_file</b></a>(Dir) -&gt;
   82:    case file:rawopen(Dir ++ "/index", read) of
   83:	{ok, Fd} -&gt;
   84:	    case catch file:read(Fd, 1) of
   85:		{ok, [Index]} -&gt; {ok, Index};
   86:		_ -&gt; error
   87:	    end;
   88:	_ -&gt; error
   89:    end.
<a name="90"></a>   90:
</pre>
<hr size=1><i>The transformation of this file (91 lines) took 0.01 seconds</i><br>
</body>
</html>
