<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head><title>/usr/home/jlouis/hacking/test_server/stdlib_test/proc_lib_SUITE.erl</title></head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
    1:<i>%% ``The contents of this file are subject to the Erlang Public License,</i>
    2:<i>%% Version 1.1, (the "License"); you may not use this file except in</i>
    3:<i>%% compliance with the License. You should have received a copy of the</i>
    4:<i>%% Erlang Public License along with this software. If not, it can be</i>
    5:<i>%% retrieved via the world wide web at http://www.erlang.org/.</i>
    6:<i>%% </i>
    7:<i>%% Software distributed under the License is distributed on an "AS IS"</i>
    8:<i>%% basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See</i>
    9:<i>%% the License for the specific language governing rights and limitations</i>
<a name="10"></a>   10:<i>%% under the License.</i>
   11:<i>%% </i>
   12:<i>%% The Initial Developer of the Original Code is Ericsson Utvecklings AB.</i>
   13:<i>%% Portions created by Ericsson are Copyright 1999, Ericsson Utvecklings</i>
   14:<i>%% AB. All Rights Reserved.''</i>
   15:<i>%% </i>
   16:<i>%%     $Id$</i>
   17:<i>%%</i>
   18:-<b>module</b>(proc_lib_SUITE).
   19:
<a name="20"></a>   20:<i>%%</i>
   21:<i>%% Define to run outside of test server</i>
   22:<i>%%</i>
   23:<i>%%-define(STANDALONE,1).</i>
   24:
   25:-<b>export</b>([all/1, crash/1, sync_start/1, sync_start_nolink/1, sync_start_link/1,
   26:         spawn_opt/1,
   27:	 sp1/0, sp2/0, sp3/1, sp4/2, sp5/1]).
   28:
   29:-<b>export</b>([init/1,
<a name="30"></a>   30:	 handle_event/2, handle_call/2, handle_info/2,
   31:	 terminate/2]).
   32:
   33:
   34:-<b>ifdef</b>(STANDALONE).
   35:-<b>define</b>(line, noop, ).
   36:-<b>else</b>.
   37:-<b>include</b>("test_server.hrl").
   38:-<b>endif</b>.
   39:
<a name=all><a name="40"></a>   40:<b>all</b></a>(suite) -&gt; {req,[stdlib],[crash, sync_start, spawn_opt]}.
   41:
   42:<i>%%-----------------------------------------------------------------</i>
   43:<i>%% We don't have to test that spwn and spawn_link actually spawns</i>
   44:<i>%% new processes - if they don't we can't run this suite!</i>
   45:<i>%% But we want to test that start and start_link really is</i>
   46:<i>%% synchronous, and we want to test that the crash report is ok.</i>
   47:<i>%%-----------------------------------------------------------------</i>
<a name=crash>   48:<b>crash</b></a>(suite) -&gt; [];
<a name=crash>   49:<b>crash</b></a>(Config) when list(Config) -&gt;
<a name="50"></a>   50:    error_logger:add_report_handler(?MODULE, self()),
   51:
   52:    Pid = proc_lib:spawn(?MODULE, sp1, []),
   53:    Pid ! die,
   54:    ?line [PidRep, []] = receive
   55:		       {crash_report, Pid, Report} -&gt; Report
   56:		   after 2000 -&gt; test_server:fail(no_crash_report)
   57:		   end,
   58:    ?line {value, {initial_call,{?MODULE,sp1,[]}}} =
   59:	lists:keysearch(initial_call, 1, PidRep),
<a name="60"></a>   60:    Self = self(),
   61:    ?line {value, {ancestors,[Self]}} =
   62:	lists:keysearch(ancestors, 1, PidRep),
   63:    ?line {value, {error_info,die}} =
   64:	lists:keysearch(error_info, 1, PidRep),
   65:
   66:    F = fun sp1/0,
   67:    Pid1 = proc_lib:spawn(node(), F),
   68:    Pid1 ! die,
   69:    ?line [PidRep1, []] = receive
<a name="70"></a>   70:		       {crash_report, Pid1, Report1} -&gt; Report1
   71:		   after 2000 -&gt; test_server:fail(no_crash_report)
   72:		   end,
   73:    ?line {value, {initial_call,F}} =
   74:	lists:keysearch(initial_call, 1, PidRep1),
   75:    ?line {value, {ancestors,[Self]}} =
   76:	lists:keysearch(ancestors, 1, PidRep1),
   77:    ?line {value, {error_info,die}} =
   78:	lists:keysearch(error_info, 1, PidRep1),
   79:
<a name="80"></a>   80:    Pid2 = proc_lib:spawn(?MODULE, sp2, []),
   81:    test_server:sleep(100),
   82:    ?line {?MODULE,sp2,[]} = proc_lib:initial_call(Pid2),
   83:    Pid2 ! die,
   84:    ?line [Pid2Rep, [{neighbour, LinkRep}]] =
   85:	receive
   86:	    {crash_report, Pid2, Report2} -&gt; Report2
   87:	after 2000 -&gt; test_server:fail(no_crash_report)
   88:	end,
   89:    ?line {value, {initial_call,{?MODULE,sp2,[]}}} =
<a name="90"></a>   90:	lists:keysearch(initial_call, 1, Pid2Rep),
   91:    ?line {value, {ancestors,[Self]}} =
   92:	lists:keysearch(ancestors, 1, Pid2Rep),
   93:    ?line {value, {error_info,die}} =
   94:	lists:keysearch(error_info, 1, Pid2Rep),
   95:    ?line {value, {initial_call,{?MODULE,sp1,[]}}} =
   96:	lists:keysearch(initial_call, 1, LinkRep),
   97:    ok.
   98:
<a name=sync_start>   99:<b>sync_start</b></a>(suite) -&gt; [sync_start_nolink, sync_start_link].
<a name="100"></a>  100:
<a name=sync_start_nolink>  101:<b>sync_start_nolink</b></a>(suite) -&gt; [];
<a name=sync_start_nolink>  102:<b>sync_start_nolink</b></a>(Config) when list(Config) -&gt;
  103:    _Pid = spawn_link(?MODULE, sp5, [self()]),
  104:    receive
  105:	{sync_started, F} -&gt; 
  106:	    exit(F, kill),
  107:	    test_server:fail(async_start)
  108:    after 1000 -&gt; ok
  109:    end,
<a name="110"></a>  110:    receive
  111:	{Pid2, init} -&gt;
  112:	    Pid2 ! go_on
  113:    end,
  114:    receive
  115:	{sync_started, _} -&gt; ok
  116:    after 1000 -&gt;
  117:	    exit(Pid2, kill),
  118:	    test_server:fail(no_sync_start)
  119:    end,
<a name="120"></a>  120:    ok.
  121:    
<a name=sync_start_link>  122:<b>sync_start_link</b></a>(suite) -&gt; [];
<a name=sync_start_link>  123:<b>sync_start_link</b></a>(Config) when list(Config) -&gt;
  124:    _Pid = spawn_link(?MODULE, sp3, [self()]),
  125:    receive
  126:	{sync_started, _} -&gt; test_server:fail(async_start)
  127:    after 1000 -&gt; ok
  128:    end,
  129:    receive
<a name="130"></a>  130:	{Pid2, init} -&gt;
  131:	    Pid2 ! go_on
  132:    end,
  133:    receive
  134:	{sync_started, _} -&gt; ok
  135:    after 1000 -&gt; test_server:fail(no_sync_start)
  136:    end,
  137:    ok.
  138:    
<a name=spawn_opt>  139:<b>spawn_opt</b></a>(suite) -&gt; [];
<a name=spawn_opt><a name="140"></a>  140:<b>spawn_opt</b></a>(Config) when list(Config) -&gt;
  141:    F = fun sp1/0,
  142:    Pid = proc_lib:spawn_opt(F, [{priority,low}]),
  143:    test_server:sleep(100),
  144:    true = (F == proc_lib:initial_call(Pid)),
  145:    true = (F == proc_lib:translate_initial_call(Pid)),
  146:    Pid ! die,
  147:
  148:    Pid1 = proc_lib:spawn_opt(node(), F, [{priority,low}]),
  149:    test_server:sleep(100),
<a name="150"></a>  150:    true = (F == proc_lib:initial_call(Pid1)),
  151:    true = (F == proc_lib:translate_initial_call(Pid1)),
  152:    Pid1 ! die,
  153:    ok.
  154:
  155:
<a name=sp1>  156:<b>sp1</b></a>() -&gt;
  157:    receive 
  158:	die -&gt; exit(die);
  159:	_ -&gt; sp1()
<a name="160"></a>  160:    end.
  161:
<a name=sp2>  162:<b>sp2</b></a>() -&gt;
  163:    _Pid = proc_lib:spawn_link(?MODULE, sp1, []),
  164:    receive 
  165:	die -&gt; exit(die);
  166:	_ -&gt; sp1()
  167:    end.
  168:
<a name=sp3>  169:<b>sp3</b></a>(Tester) -&gt;
<a name="170"></a>  170:    Pid = proc_lib:start_link(?MODULE, sp4, [self(), Tester]),
  171:    Tester ! {sync_started, Pid}.
  172:
<a name=sp5>  173:<b>sp5</b></a>(Tester) -&gt;
  174:    Pid = proc_lib:start(?MODULE, sp4, [self(), Tester]),
  175:    Tester ! {sync_started, Pid}.
  176:
<a name=sp4>  177:<b>sp4</b></a>(Parent, Tester) -&gt;
  178:    Tester ! {self(), init},
  179:    receive
<a name="180"></a>  180:	go_on -&gt; ok
  181:    end,
  182:    proc_lib:init_ack(Parent, self()).
  183:
  184:<i>%%-----------------------------------------------------------------</i>
  185:<i>%% The error_logger handler used.</i>
  186:<i>%%-----------------------------------------------------------------</i>
<a name=init>  187:<b>init</b></a>(Tester) -&gt;
  188:    {ok, Tester}.
  189:    
<a name=handle_event><a name="190"></a>  190:<b>handle_event</b></a>({error_report, _GL, {Pid, crash_report, Report}}, Tester) -&gt;
  191:    Tester ! {crash_report, Pid, Report},
  192:    {ok, Tester};
<a name=handle_event>  193:<b>handle_event</b></a>(_Event, State) -&gt;
  194:    {ok, State}.
  195:
<a name=handle_info>  196:<b>handle_info</b></a>(_, State) -&gt;
  197:    {ok, State}.
  198:
<a name=handle_call>  199:<b>handle_call</b></a>(_Query, State) -&gt; {ok, {error, bad_query}, State}.
<a name="200"></a>  200:
<a name=terminate>  201:<b>terminate</b></a>(_Reason, State) -&gt;
  202:    State.
  203:
  204:
  205:
  206:
</pre>
<hr size=1><i>The transformation of this file (207 lines) took 0.01 seconds</i><br>
</body>
</html>
