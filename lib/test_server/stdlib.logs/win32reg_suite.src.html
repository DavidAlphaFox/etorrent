<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head><title>/usr/home/jlouis/hacking/test_server/stdlib_test/win32reg_SUITE.erl</title></head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
    1:<i>%% ``The contents of this file are subject to the Erlang Public License,</i>
    2:<i>%% Version 1.1, (the "License"); you may not use this file except in</i>
    3:<i>%% compliance with the License. You should have received a copy of the</i>
    4:<i>%% Erlang Public License along with this software. If not, it can be</i>
    5:<i>%% retrieved via the world wide web at http://www.erlang.org/.</i>
    6:<i>%% </i>
    7:<i>%% Software distributed under the License is distributed on an "AS IS"</i>
    8:<i>%% basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See</i>
    9:<i>%% the License for the specific language governing rights and limitations</i>
<a name="10"></a>   10:<i>%% under the License.</i>
   11:<i>%% </i>
   12:<i>%% The Initial Developer of the Original Code is Ericsson Utvecklings AB.</i>
   13:<i>%% Portions created by Ericsson are Copyright 1999, Ericsson Utvecklings</i>
   14:<i>%% AB. All Rights Reserved.''</i>
   15:<i>%% </i>
   16:<i>%%     $Id$</i>
   17:<i>%%</i>
   18:-<b>module</b>(win32reg_SUITE).
   19:
<a name="20"></a>   20:-<b>export</b>([all/1,long/1,evil_write/1]).
   21:-<b>export</b>([ostype/1,fini/1]).
   22:
   23:-<b>include</b>("test_server.hrl").
   24:
<a name=all>   25:<b>all</b></a>(suite) -&gt;
   26:    [{conf,ostype,[long,evil_write],fini}].
   27:
<a name=ostype>   28:<b>ostype</b></a>(Config) when is_list(Config) -&gt;
   29:    case os:type() of
<a name="30"></a>   30:	{win32, _} -&gt;
   31:	    Config;
   32:	_ -&gt;
   33:	    {skip,"Doesn't run on UNIX."}
   34:    end.
<a name=fini>   35:<b>fini</b></a>(Config) when is_list(Config) -&gt;
   36:    Config.
   37:
<a name=long>   38:<b>long</b></a>(doc) -&gt; "Test long keys and entries (OTP-3446).";
<a name=long>   39:<b>long</b></a>(Config) when list(Config) -&gt;
<a name="40"></a>   40:    ?line Dog = test_server:timetrap(test_server:seconds(10)),
   41:
   42:    ?line LongKey = "software\\" ++
   43:	lists:flatten(lists:duplicate(10, "..\\software\\")) ++
   44:	"Ericsson\\Erlang",
   45:    ?line {ok,Reg} = win32reg:open([read,write]),
   46:    ?line ok = win32reg:change_key(Reg, "\\hklm"),
   47:    ?line ok = win32reg:change_key(Reg, LongKey),
   48:    ?line {ok,ErlangKey} = win32reg:current_key(Reg),
   49:    io:format("Erlang key: ~s", [ErlangKey]),
<a name="50"></a>   50:
   51:    %% Write a long value and read it back.
   52:    ?line TestKey = "test_key",
   53:    ?line LongValue = lists:concat(["This is a long value generated by the test case ",?MODULE,":long/1. "|lists:duplicate(128, "a")]),
   54:    ?line ok = win32reg:set_value(Reg, TestKey, LongValue),
   55:    ?line {ok,LongValue} = win32reg:value(Reg, TestKey),
   56:
   57:    %% Done.
   58:
   59:    ?line ok = win32reg:close(Reg),
<a name="60"></a>   60:    ?line test_server:timetrap_cancel(Dog),
   61:    ok.
   62:
<a name=evil_write>   63:<b>evil_write</b></a>(Config) when list(Config) -&gt;
   64:    ?line Dog = test_server:timetrap(test_server:seconds(10)),
   65:
   66:    ?line Key = "Software\\Ericsson\\Erlang",
   67:    ?line {ok,Reg} = win32reg:open([read,write]),
   68:    ?line ok = win32reg:change_key(Reg, "\\hklm"),
   69:    ?line ok = win32reg:change_key(Reg, Key),
<a name="70"></a>   70:    ?line {ok,ErlangKey} = win32reg:current_key(Reg),
   71:    io:format("Erlang key: ~s", [ErlangKey]),
   72:
   73:    %% Write keys with different length and read it back.
   74:    ?line TestKey = "test_key " ++ lists:duplicate(128, $a),
   75:    evil_write_1(Reg, TestKey),
   76:
   77:    %% Done.
   78:    ?line ok = win32reg:close(Reg),
   79:    ?line test_server:timetrap_cancel(Dog),
<a name="80"></a>   80:    ok.
   81:
<a name=evil_write_1>   82:<b>evil_write_1</b></a>(Reg, [_|[_|_]=Key]=Key0) -&gt;
   83:    ?line io:format("Key = ~p\n", [Key0]),
   84:    ?line ok = win32reg:set_value(Reg, Key0, "A good value for me"),
   85:    ?line {ok,Val} = win32reg:value(Reg, Key0),
   86:    ?line ok = win32reg:delete_value(Reg, Key0),
   87:    evil_write_1(Reg, Key);
<a name=evil_write_1>   88:<b>evil_write_1</b></a>(_, [_]) -&gt; ok.
</pre>
<hr size=1><i>The transformation of this file (89 lines) took 0.01 seconds</i><br>
</body>
</html>
