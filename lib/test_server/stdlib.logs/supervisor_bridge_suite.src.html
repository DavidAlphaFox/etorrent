<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head><title>/usr/home/jlouis/hacking/test_server/stdlib_test/supervisor_bridge_SUITE.erl</title></head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
    1:<i>%% ``The contents of this file are subject to the Erlang Public License,</i>
    2:<i>%% Version 1.1, (the "License"); you may not use this file except in</i>
    3:<i>%% compliance with the License. You should have received a copy of the</i>
    4:<i>%% Erlang Public License along with this software. If not, it can be</i>
    5:<i>%% retrieved via the world wide web at http://www.erlang.org/.</i>
    6:<i>%% </i>
    7:<i>%% Software distributed under the License is distributed on an "AS IS"</i>
    8:<i>%% basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See</i>
    9:<i>%% the License for the specific language governing rights and limitations</i>
<a name="10"></a>   10:<i>%% under the License.</i>
   11:<i>%% </i>
   12:<i>%% The Initial Developer of the Original Code is Ericsson Utvecklings AB.</i>
   13:<i>%% Portions created by Ericsson are Copyright 1999, Ericsson Utvecklings</i>
   14:<i>%% AB. All Rights Reserved.''</i>
   15:<i>%% </i>
   16:<i>%%     $Id$</i>
   17:<i>%%</i>
   18:-<b>module</b>(supervisor_bridge_SUITE).
   19:-<b>export</b>([all/1,starting/1,mini_terminate/1,mini_die/1,badstart/1]).
<a name="20"></a>   20:-<b>export</b>([client/1,init/1,internal_loop_init/1,terminate/2]).
   21:
   22:-<b>include</b>("test_server.hrl").
   23:-<b>define</b>(bridge_name,supervisor_bridge_SUITE_server).
   24:-<b>define</b>(work_bridge_name,work_supervisor_bridge_SUITE_server).
   25:
   26:<i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
   27:
<a name=all>   28:<b>all</b></a>(suite) -&gt; {req,[stdlib],[starting,mini_terminate,mini_die,badstart]}.
   29:
<a name="30"></a>   30:<i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
   31:
<a name=starting>   32:<b>starting</b></a>(suite) -&gt; [];
<a name=starting>   33:<b>starting</b></a>(Config) when list(Config) -&gt;
   34:    process_flag(trap_exit,true),
   35:
   36:    ?line ignore = start(1),
   37:    ?line {error,testing} = start(2),
   38:    ok.
   39:
<a name="40"></a>   40:<i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
   41:
<a name=mini_terminate>   42:<b>mini_terminate</b></a>(suite) -&gt; [];
<a name=mini_terminate>   43:<b>mini_terminate</b></a>(Config) when list(Config) -&gt;
   44:    miniappl(1),
   45:    ok.
   46:
<a name=mini_die>   47:<b>mini_die</b></a>(suite) -&gt; [];
<a name=mini_die>   48:<b>mini_die</b></a>(Config) when list(Config) -&gt;
   49:    miniappl(2),
<a name="50"></a>   50:    ok.
   51:
<a name=miniappl>   52:<b>miniappl</b></a>(N) -&gt;
   53:    process_flag(trap_exit,true),
   54:    ?line {ok,Server} = start(3),
   55:    ?line Client = spawn_link(?MODULE,client,[N]),
   56:    ?line Handle = test_server:timetrap(2000),
   57:    ?line miniappl_loop(Client,Server),
   58:    ?line test_server:timetrap_cancel(Handle).
   59:
<a name=miniappl_loop><a name="60"></a>   60:<b>miniappl_loop</b></a>([],[]) -&gt;
   61:    ok;
<a name=miniappl_loop>   62:<b>miniappl_loop</b></a>(Client,Server) -&gt;
   63:    io:format("Client ~p, Server ~p\n",[Client,Server]),
   64:    receive
   65:	{'EXIT',Client,_} -&gt;
   66:	    ?line miniappl_loop([],Server);
   67:	{'EXIT',Server,killed} -&gt; %% terminate
   68:	    ?line miniappl_loop(Client,[]);
   69:	{'EXIT',Server,died} -&gt; %% die
<a name="70"></a>   70:	    ?line miniappl_loop(Client,[]);
   71:	{dying,Reason} -&gt;
   72:	    ?line miniappl_loop(Client,Server);
   73:	Other -&gt;
   74:	    ?line exit({failed,Other})
   75:    end.
   76:
   77:<i>%%%%%%%%%%%%%%%%%%%%</i>
   78:<i>% Client</i>
   79:
<a name=client><a name="80"></a>   80:<b>client</b></a>(N) -&gt;
   81:    io:format("Client starting...\n"),
   82:    ok = public_request(),
   83:    case N of
   84:	1 -&gt; public_kill();
   85:	2 -&gt; ?work_bridge_name ! die
   86:    end,
   87:    io:format("Killed server, terminating client...\n"),
   88:    exit(fine).
   89:
<a name="90"></a>   90:<i>%%%%%%%%%%%%%%%%%%%%</i>
   91:<i>% Non compliant server</i>
   92:
<a name=start>   93:<b>start</b></a>(N) -&gt;
   94:    supervisor_bridge:start_link({local,?bridge_name},?MODULE,N).
   95:
<a name=public_request>   96:<b>public_request</b></a>() -&gt;
   97:    ?work_bridge_name ! {non_compliant_message,self()},
   98:    io:format("Client waiting for answer...\n"),
   99:    receive
<a name="100"></a>  100:	non_compliant_answer -&gt;
  101:	    ok
  102:    end,
  103:    io:format("Client got answer...\n").
  104:
<a name=public_kill>  105:<b>public_kill</b></a>() -&gt;
  106:    %% This func knows about supervisor_bridge
  107:    exit(whereis(?work_bridge_name),kill).
  108:
<a name=init>  109:<b>init</b></a>(1) -&gt;
<a name="110"></a>  110:    ignore;
<a name=init>  111:<b>init</b></a>(2) -&gt;
  112:    {error,testing};
<a name=init>  113:<b>init</b></a>(3) -&gt;
  114:    %% This func knows about supervisor_bridge
  115:    InternalPid = spawn_link(?MODULE,internal_loop_init,[[]]),
  116:    {ok,InternalPid,self()}.
  117:
<a name=internal_loop_init>  118:<b>internal_loop_init</b></a>(Parent) -&gt;
  119:    register(?work_bridge_name,self()),
<a name="120"></a>  120:    internal_loop({Parent,self()}).
  121:
<a name=internal_loop>  122:<b>internal_loop</b></a>(State) -&gt;
  123:    receive
  124:	{non_compliant_message,From} -&gt;
  125:	    io:format("Got request from ~p\n",[From]),
  126:	    From ! non_compliant_answer,
  127:	    internal_loop(State);
  128:	die -&gt;
  129:	    exit(died)
<a name="130"></a>  130:    end.
  131:
<a name=terminate>  132:<b>terminate</b></a>(Reason,{Parent,Worker}) -&gt;
  133:    %% This func knows about supervisor_bridge
  134:    io:format("Terminating bridge...\n"),
  135:    exit(kill,Worker),
  136:    Parent ! {dying,Reason},
  137:    anything.
  138:
  139:<i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="140"></a>  140:
<a name=badstart>  141:<b>badstart</b></a>(suite) -&gt; [];
<a name=badstart>  142:<b>badstart</b></a>(doc) -&gt; "Test various bad ways of starting a supervisor bridge.";
<a name=badstart>  143:<b>badstart</b></a>(Config) when list(Config) -&gt;
  144:    %% Various bad arguments.
  145:
  146:    ?line {'EXIT',_} =
  147:	(catch supervisor_bridge:start_link({xxx,?bridge_name},?MODULE,1)),
  148:    ?line {'EXIT',_} =
  149:	(catch supervisor_bridge:start_link({local,"foo"},?MODULE,1)),
<a name="150"></a>  150:    ?line {'EXIT',_} =
  151:	(catch supervisor_bridge:start_link(?bridge_name,?MODULE,1)),
  152:    ?line [] = test_server:messages_get(),	% No messages waiting
  153:
  154:    %% Already started.
  155:
  156:    ?line process_flag(trap_exit, true),
  157:    ?line {ok,Pid} =
  158:	supervisor_bridge:start_link({local,?bridge_name},?MODULE,3),
  159:    ?line {error,{already_started,Pid}} =
<a name="160"></a>  160:	supervisor_bridge:start_link({local,?bridge_name},?MODULE,3),
  161:    ?line public_kill(),
  162:    ?line receive after 1 -&gt; ok end,		% Allow time for 'EXIT' message
  163:						% to be received.
  164:    ?line [{'EXIT', Pid, killed}] = test_server:messages_get(),
  165:    ok.
  166:
  167:<i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
</pre>
<hr size=1><i>The transformation of this file (168 lines) took 0.01 seconds</i><br>
</body>
</html>
